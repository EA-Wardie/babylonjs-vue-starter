{"ast":null,"code":"import \"core-js/modules/es.object.define-property.js\";\nimport { __extends } from \"tslib\";\nimport { Vector2 } from \"../Maths/math.vector.js\";\nimport { Texture } from \"../Materials/Textures/texture.js\";\nimport { PostProcessRenderEffect } from \"../PostProcesses/RenderPipeline/postProcessRenderEffect.js\";\nimport { CircleOfConfusionPostProcess } from \"./circleOfConfusionPostProcess.js\";\nimport { DepthOfFieldBlurPostProcess } from \"./depthOfFieldBlurPostProcess.js\";\nimport { DepthOfFieldMergePostProcess } from \"./depthOfFieldMergePostProcess.js\";\n/**\n * Specifies the level of max blur that should be applied when using the depth of field effect\n */\n\nexport var DepthOfFieldEffectBlurLevel;\n\n(function (DepthOfFieldEffectBlurLevel) {\n  /**\n   * Subtle blur\n   */\n  DepthOfFieldEffectBlurLevel[DepthOfFieldEffectBlurLevel[\"Low\"] = 0] = \"Low\";\n  /**\n   * Medium blur\n   */\n\n  DepthOfFieldEffectBlurLevel[DepthOfFieldEffectBlurLevel[\"Medium\"] = 1] = \"Medium\";\n  /**\n   * Large blur\n   */\n\n  DepthOfFieldEffectBlurLevel[DepthOfFieldEffectBlurLevel[\"High\"] = 2] = \"High\";\n})(DepthOfFieldEffectBlurLevel || (DepthOfFieldEffectBlurLevel = {}));\n/**\n * The depth of field effect applies a blur to objects that are closer or further from where the camera is focusing.\n */\n\n\nvar DepthOfFieldEffect =\n/** @class */\nfunction (_super) {\n  __extends(DepthOfFieldEffect, _super);\n  /**\n   * Creates a new instance DepthOfFieldEffect\n   * @param scene The scene the effect belongs to.\n   * @param depthTexture The depth texture of the scene to compute the circle of confusion.This must be set in order for this to function but may be set after initialization if needed.\n   * @param blurLevel\n   * @param pipelineTextureType The type of texture to be used when performing the post processing.\n   * @param blockCompilation If compilation of the shader should not be done in the constructor. The updateEffect method can be used to compile the shader at a later time. (default: false)\n   */\n\n\n  function DepthOfFieldEffect(scene, depthTexture, blurLevel, pipelineTextureType, blockCompilation) {\n    if (blurLevel === void 0) {\n      blurLevel = DepthOfFieldEffectBlurLevel.Low;\n    }\n\n    if (pipelineTextureType === void 0) {\n      pipelineTextureType = 0;\n    }\n\n    if (blockCompilation === void 0) {\n      blockCompilation = false;\n    }\n\n    var _this = _super.call(this, scene.getEngine(), \"depth of field\", function () {\n      return _this._effects;\n    }, true) || this;\n    /**\n     * @hidden Internal post processes in depth of field effect\n     */\n\n\n    _this._effects = []; // Circle of confusion value for each pixel is used to determine how much to blur that pixel\n\n    _this._circleOfConfusion = new CircleOfConfusionPostProcess(\"circleOfConfusion\", depthTexture, 1, null, Texture.BILINEAR_SAMPLINGMODE, scene.getEngine(), false, pipelineTextureType, blockCompilation); // Create a pyramid of blurred images (eg. fullSize 1/4 blur, half size 1/2 blur, quarter size 3/4 blur, eith size 4/4 blur)\n    // Blur the image but do not blur on sharp far to near distance changes to avoid bleeding artifacts\n    // See section 2.6.2 http://fileadmin.cs.lth.se/cs/education/edan35/lectures/12dof.pdf\n\n    _this._depthOfFieldBlurY = [];\n    _this._depthOfFieldBlurX = [];\n    var blurCount = 1;\n    var kernelSize = 15;\n\n    switch (blurLevel) {\n      case DepthOfFieldEffectBlurLevel.High:\n        {\n          blurCount = 3;\n          kernelSize = 51;\n          break;\n        }\n\n      case DepthOfFieldEffectBlurLevel.Medium:\n        {\n          blurCount = 2;\n          kernelSize = 31;\n          break;\n        }\n\n      default:\n        {\n          kernelSize = 15;\n          blurCount = 1;\n          break;\n        }\n    }\n\n    var adjustedKernelSize = kernelSize / Math.pow(2, blurCount - 1);\n    var ratio = 1.0;\n\n    for (var i = 0; i < blurCount; i++) {\n      var blurY = new DepthOfFieldBlurPostProcess(\"vertical blur\", scene, new Vector2(0, 1.0), adjustedKernelSize, ratio, null, _this._circleOfConfusion, i == 0 ? _this._circleOfConfusion : null, Texture.BILINEAR_SAMPLINGMODE, scene.getEngine(), false, pipelineTextureType, blockCompilation);\n      blurY.autoClear = false;\n      ratio = 0.75 / Math.pow(2, i);\n      var blurX = new DepthOfFieldBlurPostProcess(\"horizontal blur\", scene, new Vector2(1.0, 0), adjustedKernelSize, ratio, null, _this._circleOfConfusion, null, Texture.BILINEAR_SAMPLINGMODE, scene.getEngine(), false, pipelineTextureType, blockCompilation);\n      blurX.autoClear = false;\n\n      _this._depthOfFieldBlurY.push(blurY);\n\n      _this._depthOfFieldBlurX.push(blurX);\n    } // Set all post processes on the effect.\n\n\n    _this._effects = [_this._circleOfConfusion];\n\n    for (var i = 0; i < _this._depthOfFieldBlurX.length; i++) {\n      _this._effects.push(_this._depthOfFieldBlurY[i]);\n\n      _this._effects.push(_this._depthOfFieldBlurX[i]);\n    } // Merge blurred images with original image based on circleOfConfusion\n\n\n    _this._dofMerge = new DepthOfFieldMergePostProcess(\"dofMerge\", _this._circleOfConfusion, _this._circleOfConfusion, _this._depthOfFieldBlurX, ratio, null, Texture.BILINEAR_SAMPLINGMODE, scene.getEngine(), false, pipelineTextureType, blockCompilation);\n    _this._dofMerge.autoClear = false;\n\n    _this._effects.push(_this._dofMerge);\n\n    return _this;\n  }\n\n  Object.defineProperty(DepthOfFieldEffect.prototype, \"focalLength\", {\n    get: function get() {\n      return this._circleOfConfusion.focalLength;\n    },\n\n    /**\n     * The focal the length of the camera used in the effect in scene units/1000 (eg. millimeter)\n     */\n    set: function set(value) {\n      this._circleOfConfusion.focalLength = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DepthOfFieldEffect.prototype, \"fStop\", {\n    get: function get() {\n      return this._circleOfConfusion.fStop;\n    },\n\n    /**\n     * F-Stop of the effect's camera. The diameter of the resulting aperture can be computed by lensSize/fStop. (default: 1.4)\n     */\n    set: function set(value) {\n      this._circleOfConfusion.fStop = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DepthOfFieldEffect.prototype, \"focusDistance\", {\n    get: function get() {\n      return this._circleOfConfusion.focusDistance;\n    },\n\n    /**\n     * Distance away from the camera to focus on in scene units/1000 (eg. millimeter). (default: 2000)\n     */\n    set: function set(value) {\n      this._circleOfConfusion.focusDistance = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DepthOfFieldEffect.prototype, \"lensSize\", {\n    get: function get() {\n      return this._circleOfConfusion.lensSize;\n    },\n\n    /**\n     * Max lens size in scene units/1000 (eg. millimeter). Standard cameras are 50mm. (default: 50) The diameter of the resulting aperture can be computed by lensSize/fStop.\n     */\n    set: function set(value) {\n      this._circleOfConfusion.lensSize = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Get the current class name of the current effect\n   * @returns \"DepthOfFieldEffect\"\n   */\n\n  DepthOfFieldEffect.prototype.getClassName = function () {\n    return \"DepthOfFieldEffect\";\n  };\n\n  Object.defineProperty(DepthOfFieldEffect.prototype, \"depthTexture\", {\n    /**\n     * Depth texture to be used to compute the circle of confusion. This must be set here or in the constructor in order for the post process to function.\n     */\n    set: function set(value) {\n      this._circleOfConfusion.depthTexture = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Disposes each of the internal effects for a given camera.\n   * @param camera The camera to dispose the effect on.\n   */\n\n  DepthOfFieldEffect.prototype.disposeEffects = function (camera) {\n    for (var effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\n      this._effects[effectIndex].dispose(camera);\n    }\n  };\n  /**\n   * @hidden Internal\n   */\n\n\n  DepthOfFieldEffect.prototype._updateEffects = function () {\n    for (var effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\n      this._effects[effectIndex].updateEffect();\n    }\n  };\n  /**\n   * Internal\n   * @returns if all the contained post processes are ready.\n   * @hidden\n   */\n\n\n  DepthOfFieldEffect.prototype._isReady = function () {\n    for (var effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\n      if (!this._effects[effectIndex].isReady()) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  return DepthOfFieldEffect;\n}(PostProcessRenderEffect);\n\nexport { DepthOfFieldEffect };","map":{"version":3,"mappings":"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","names":["Vector2","Texture","PostProcessRenderEffect","CircleOfConfusionPostProcess","DepthOfFieldBlurPostProcess","DepthOfFieldMergePostProcess","DepthOfFieldEffectBlurLevel","__extends","scene","depthTexture","blurLevel","pipelineTextureType","blockCompilation","Low","_super","getEngine","_this","_effects","_circleOfConfusion","BILINEAR_SAMPLINGMODE","_depthOfFieldBlurY","_depthOfFieldBlurX","blurCount","kernelSize","High","Medium","adjustedKernelSize","Math","pow","ratio","i","blurY","autoClear","blurX","push","length","_dofMerge","Object","DepthOfFieldEffect","focalLength","value","fStop","focusDistance","lensSize","camera","effectIndex","dispose","updateEffect","isReady"],"sourceRoot":"","sources":["../../../../../lts/core/generated/PostProcesses/depthOfFieldEffect.ts"],"sourcesContent":["import type { Nullable } from \"../types\";\r\nimport { Vector2 } from \"../Maths/math.vector\";\r\nimport type { Camera } from \"../Cameras/camera\";\r\nimport { Texture } from \"../Materials/Textures/texture\";\r\nimport type { RenderTargetTexture } from \"../Materials/Textures/renderTargetTexture\";\r\nimport type { PostProcess } from \"./postProcess\";\r\nimport { PostProcessRenderEffect } from \"../PostProcesses/RenderPipeline/postProcessRenderEffect\";\r\nimport { CircleOfConfusionPostProcess } from \"./circleOfConfusionPostProcess\";\r\nimport { DepthOfFieldBlurPostProcess } from \"./depthOfFieldBlurPostProcess\";\r\nimport { DepthOfFieldMergePostProcess } from \"./depthOfFieldMergePostProcess\";\r\nimport type { Scene } from \"../scene\";\r\n\r\n/**\r\n * Specifies the level of max blur that should be applied when using the depth of field effect\r\n */\r\nexport enum DepthOfFieldEffectBlurLevel {\r\n    /**\r\n     * Subtle blur\r\n     */\r\n    Low,\r\n    /**\r\n     * Medium blur\r\n     */\r\n    Medium,\r\n    /**\r\n     * Large blur\r\n     */\r\n    High,\r\n}\r\n/**\r\n * The depth of field effect applies a blur to objects that are closer or further from where the camera is focusing.\r\n */\r\nexport class DepthOfFieldEffect extends PostProcessRenderEffect {\r\n    private _circleOfConfusion: CircleOfConfusionPostProcess;\r\n    /**\r\n     * @hidden Internal, blurs from high to low\r\n     */\r\n    public _depthOfFieldBlurX: Array<DepthOfFieldBlurPostProcess>;\r\n    private _depthOfFieldBlurY: Array<DepthOfFieldBlurPostProcess>;\r\n    private _dofMerge: Nullable<DepthOfFieldMergePostProcess>;\r\n\r\n    /**\r\n     * @hidden Internal post processes in depth of field effect\r\n     */\r\n    public _effects: Array<PostProcess> = [];\r\n\r\n    /**\r\n     * The focal the length of the camera used in the effect in scene units/1000 (eg. millimeter)\r\n     */\r\n    public set focalLength(value: number) {\r\n        this._circleOfConfusion.focalLength = value;\r\n    }\r\n    public get focalLength() {\r\n        return this._circleOfConfusion.focalLength;\r\n    }\r\n    /**\r\n     * F-Stop of the effect's camera. The diameter of the resulting aperture can be computed by lensSize/fStop. (default: 1.4)\r\n     */\r\n    public set fStop(value: number) {\r\n        this._circleOfConfusion.fStop = value;\r\n    }\r\n    public get fStop() {\r\n        return this._circleOfConfusion.fStop;\r\n    }\r\n    /**\r\n     * Distance away from the camera to focus on in scene units/1000 (eg. millimeter). (default: 2000)\r\n     */\r\n    public set focusDistance(value: number) {\r\n        this._circleOfConfusion.focusDistance = value;\r\n    }\r\n    public get focusDistance() {\r\n        return this._circleOfConfusion.focusDistance;\r\n    }\r\n    /**\r\n     * Max lens size in scene units/1000 (eg. millimeter). Standard cameras are 50mm. (default: 50) The diameter of the resulting aperture can be computed by lensSize/fStop.\r\n     */\r\n    public set lensSize(value: number) {\r\n        this._circleOfConfusion.lensSize = value;\r\n    }\r\n    public get lensSize() {\r\n        return this._circleOfConfusion.lensSize;\r\n    }\r\n\r\n    /**\r\n     * Creates a new instance DepthOfFieldEffect\r\n     * @param scene The scene the effect belongs to.\r\n     * @param depthTexture The depth texture of the scene to compute the circle of confusion.This must be set in order for this to function but may be set after initialization if needed.\r\n     * @param blurLevel\r\n     * @param pipelineTextureType The type of texture to be used when performing the post processing.\r\n     * @param blockCompilation If compilation of the shader should not be done in the constructor. The updateEffect method can be used to compile the shader at a later time. (default: false)\r\n     */\r\n    constructor(\r\n        scene: Scene,\r\n        depthTexture: Nullable<RenderTargetTexture>,\r\n        blurLevel: DepthOfFieldEffectBlurLevel = DepthOfFieldEffectBlurLevel.Low,\r\n        pipelineTextureType = 0,\r\n        blockCompilation = false\r\n    ) {\r\n        super(\r\n            scene.getEngine(),\r\n            \"depth of field\",\r\n            () => {\r\n                return this._effects;\r\n            },\r\n            true\r\n        );\r\n        // Circle of confusion value for each pixel is used to determine how much to blur that pixel\r\n        this._circleOfConfusion = new CircleOfConfusionPostProcess(\r\n            \"circleOfConfusion\",\r\n            depthTexture,\r\n            1,\r\n            null,\r\n            Texture.BILINEAR_SAMPLINGMODE,\r\n            scene.getEngine(),\r\n            false,\r\n            pipelineTextureType,\r\n            blockCompilation\r\n        );\r\n\r\n        // Create a pyramid of blurred images (eg. fullSize 1/4 blur, half size 1/2 blur, quarter size 3/4 blur, eith size 4/4 blur)\r\n        // Blur the image but do not blur on sharp far to near distance changes to avoid bleeding artifacts\r\n        // See section 2.6.2 http://fileadmin.cs.lth.se/cs/education/edan35/lectures/12dof.pdf\r\n        this._depthOfFieldBlurY = [];\r\n        this._depthOfFieldBlurX = [];\r\n        let blurCount = 1;\r\n        let kernelSize = 15;\r\n        switch (blurLevel) {\r\n            case DepthOfFieldEffectBlurLevel.High: {\r\n                blurCount = 3;\r\n                kernelSize = 51;\r\n                break;\r\n            }\r\n            case DepthOfFieldEffectBlurLevel.Medium: {\r\n                blurCount = 2;\r\n                kernelSize = 31;\r\n                break;\r\n            }\r\n            default: {\r\n                kernelSize = 15;\r\n                blurCount = 1;\r\n                break;\r\n            }\r\n        }\r\n        const adjustedKernelSize = kernelSize / Math.pow(2, blurCount - 1);\r\n        let ratio = 1.0;\r\n        for (let i = 0; i < blurCount; i++) {\r\n            const blurY = new DepthOfFieldBlurPostProcess(\r\n                \"vertical blur\",\r\n                scene,\r\n                new Vector2(0, 1.0),\r\n                adjustedKernelSize,\r\n                ratio,\r\n                null,\r\n                this._circleOfConfusion,\r\n                i == 0 ? this._circleOfConfusion : null,\r\n                Texture.BILINEAR_SAMPLINGMODE,\r\n                scene.getEngine(),\r\n                false,\r\n                pipelineTextureType,\r\n                blockCompilation\r\n            );\r\n            blurY.autoClear = false;\r\n            ratio = 0.75 / Math.pow(2, i);\r\n            const blurX = new DepthOfFieldBlurPostProcess(\r\n                \"horizontal blur\",\r\n                scene,\r\n                new Vector2(1.0, 0),\r\n                adjustedKernelSize,\r\n                ratio,\r\n                null,\r\n                this._circleOfConfusion,\r\n                null,\r\n                Texture.BILINEAR_SAMPLINGMODE,\r\n                scene.getEngine(),\r\n                false,\r\n                pipelineTextureType,\r\n                blockCompilation\r\n            );\r\n            blurX.autoClear = false;\r\n            this._depthOfFieldBlurY.push(blurY);\r\n            this._depthOfFieldBlurX.push(blurX);\r\n        }\r\n\r\n        // Set all post processes on the effect.\r\n        this._effects = [this._circleOfConfusion];\r\n        for (let i = 0; i < this._depthOfFieldBlurX.length; i++) {\r\n            this._effects.push(this._depthOfFieldBlurY[i]);\r\n            this._effects.push(this._depthOfFieldBlurX[i]);\r\n        }\r\n\r\n        // Merge blurred images with original image based on circleOfConfusion\r\n        this._dofMerge = new DepthOfFieldMergePostProcess(\r\n            \"dofMerge\",\r\n            this._circleOfConfusion,\r\n            this._circleOfConfusion,\r\n            this._depthOfFieldBlurX,\r\n            ratio,\r\n            null,\r\n            Texture.BILINEAR_SAMPLINGMODE,\r\n            scene.getEngine(),\r\n            false,\r\n            pipelineTextureType,\r\n            blockCompilation\r\n        );\r\n        this._dofMerge.autoClear = false;\r\n        this._effects.push(this._dofMerge);\r\n    }\r\n\r\n    /**\r\n     * Get the current class name of the current effect\r\n     * @returns \"DepthOfFieldEffect\"\r\n     */\r\n    public getClassName(): string {\r\n        return \"DepthOfFieldEffect\";\r\n    }\r\n\r\n    /**\r\n     * Depth texture to be used to compute the circle of confusion. This must be set here or in the constructor in order for the post process to function.\r\n     */\r\n    public set depthTexture(value: RenderTargetTexture) {\r\n        this._circleOfConfusion.depthTexture = value;\r\n    }\r\n\r\n    /**\r\n     * Disposes each of the internal effects for a given camera.\r\n     * @param camera The camera to dispose the effect on.\r\n     */\r\n    public disposeEffects(camera: Camera) {\r\n        for (let effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\r\n            this._effects[effectIndex].dispose(camera);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @hidden Internal\r\n     */\r\n    public _updateEffects() {\r\n        for (let effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\r\n            this._effects[effectIndex].updateEffect();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Internal\r\n     * @returns if all the contained post processes are ready.\r\n     * @hidden\r\n     */\r\n    public _isReady() {\r\n        for (let effectIndex = 0; effectIndex < this._effects.length; effectIndex++) {\r\n            if (!this._effects[effectIndex].isReady()) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}