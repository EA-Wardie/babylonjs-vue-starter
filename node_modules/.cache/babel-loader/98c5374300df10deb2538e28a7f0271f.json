{"ast":null,"code":"import _typeof from \"/home/ea/Development/Babylon/red/node_modules/@babel/runtime/helpers/esm/typeof.js\";\nimport \"core-js/modules/es.object.define-property.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport \"core-js/modules/es.array.for-each.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.array.splice.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.string.iterator.js\";\nimport \"core-js/modules/web.dom-collections.iterator.js\";\nimport \"core-js/modules/web.url.js\";\nimport \"core-js/modules/web.url-search-params.js\";\nimport \"core-js/modules/es.array-buffer.is-view.js\";\nimport \"core-js/modules/es.array-buffer.constructor.js\";\nimport \"core-js/modules/es.array-buffer.slice.js\";\nimport \"core-js/modules/es.typed-array.float32-array.js\";\nimport \"core-js/modules/es.typed-array.at.js\";\nimport \"core-js/modules/es.typed-array.copy-within.js\";\nimport \"core-js/modules/es.typed-array.every.js\";\nimport \"core-js/modules/es.typed-array.fill.js\";\nimport \"core-js/modules/es.typed-array.filter.js\";\nimport \"core-js/modules/es.typed-array.find.js\";\nimport \"core-js/modules/es.typed-array.find-index.js\";\nimport \"core-js/modules/es.typed-array.for-each.js\";\nimport \"core-js/modules/es.typed-array.includes.js\";\nimport \"core-js/modules/es.typed-array.index-of.js\";\nimport \"core-js/modules/es.typed-array.iterator.js\";\nimport \"core-js/modules/es.typed-array.join.js\";\nimport \"core-js/modules/es.typed-array.last-index-of.js\";\nimport \"core-js/modules/es.typed-array.map.js\";\nimport \"core-js/modules/es.typed-array.reduce.js\";\nimport \"core-js/modules/es.typed-array.reduce-right.js\";\nimport \"core-js/modules/es.typed-array.reverse.js\";\nimport \"core-js/modules/es.typed-array.set.js\";\nimport \"core-js/modules/es.typed-array.slice.js\";\nimport \"core-js/modules/es.typed-array.some.js\";\nimport \"core-js/modules/es.typed-array.sort.js\";\nimport \"core-js/modules/es.typed-array.subarray.js\";\nimport \"core-js/modules/es.typed-array.to-locale-string.js\";\nimport \"core-js/modules/es.typed-array.to-string.js\";\nimport \"core-js/modules/es.number.constructor.js\";\nimport \"core-js/modules/es.typed-array.uint8-array.js\";\nimport \"core-js/modules/es.string.substr.js\";\nimport \"core-js/modules/es.array.index-of.js\";\nimport \"core-js/modules/es.array.last-index-of.js\";\nimport \"core-js/modules/es.array.is-array.js\";\nimport \"core-js/modules/es.array.map.js\";\nimport { __awaiter, __extends, __generator } from \"tslib\";\nimport { Engine } from \"../Engines/engine.js\";\nimport { VertexBuffer } from \"../Buffers/buffer.js\";\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture.js\";\nimport { Texture } from \"../Materials/Textures/texture.js\";\nimport { DataBuffer } from \"../Buffers/dataBuffer.js\";\nimport { Tools } from \"../Misc/tools.js\";\nimport { Observable } from \"../Misc/observable.js\";\nimport { CreateImageDataArrayBufferViews, GetEnvInfo, UploadEnvSpherical } from \"../Misc/environmentTextureTools.js\";\nimport { Logger } from \"../Misc/logger.js\";\nimport { ThinEngine } from \"./thinEngine.js\";\nimport { EngineStore } from \"./engineStore.js\";\nimport { ShaderCodeInliner } from \"./Processors/shaderCodeInliner.js\";\nimport { WebGL2ShaderProcessor } from \"../Engines/WebGL/webGL2ShaderProcessors.js\";\nimport { RenderTargetWrapper } from \"./renderTargetWrapper.js\";\nimport { NativeDataStream } from \"./Native/nativeDataStream.js\";\nimport { RuntimeError, ErrorCodes } from \"../Misc/error.js\";\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture.js\";\nvar onNativeObjectInitialized = new Observable();\n\nif (typeof self !== \"undefined\" && !Object.prototype.hasOwnProperty.call(self, \"_native\")) {\n  var __native_1;\n\n  Object.defineProperty(self, \"_native\", {\n    get: function get() {\n      return __native_1;\n    },\n    set: function set(value) {\n      __native_1 = value;\n\n      if (__native_1) {\n        onNativeObjectInitialized.notifyObservers(__native_1);\n      }\n    }\n  });\n}\n/**\n * Returns _native only after it has been defined by BabylonNative.\n * @hidden\n */\n\n\nexport function AcquireNativeObjectAsync() {\n  return new Promise(function (resolve) {\n    if (typeof _native === \"undefined\") {\n      onNativeObjectInitialized.addOnce(function (nativeObject) {\n        return resolve(nativeObject);\n      });\n    } else {\n      resolve(_native);\n    }\n  });\n}\n/**\n * Registers a constructor on the _native object. See NativeXRFrame for an example.\n * @param typeName\n * @param constructor\n * @hidden\n */\n\nexport function RegisterNativeTypeAsync(typeName, constructor) {\n  return __awaiter(this, void 0, void 0, function () {\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , AcquireNativeObjectAsync()];\n\n        case 1:\n          _a.sent()[typeName] = constructor;\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n\nvar NativePipelineContext =\n/** @class */\nfunction () {\n  function NativePipelineContext(engine) {\n    // TODO: async should be true?\n    this.isAsync = false;\n    this.isReady = false;\n    this._valueCache = {};\n    this.engine = engine;\n  }\n\n  NativePipelineContext.prototype._getVertexShaderCode = function () {\n    return null;\n  };\n\n  NativePipelineContext.prototype._getFragmentShaderCode = function () {\n    return null;\n  }; // TODO: what should this do?\n\n\n  NativePipelineContext.prototype._handlesSpectorRebuildCallback = function (onCompiled) {\n    throw new Error(\"Not implemented\");\n  };\n\n  NativePipelineContext.prototype._fillEffectInformation = function (effect, uniformBuffersNames, uniformsNames, uniforms, samplerList, samplers, attributesNames, attributes) {\n    var engine = this.engine;\n\n    if (engine.supportsUniformBuffers) {\n      for (var name_1 in uniformBuffersNames) {\n        effect.bindUniformBlock(name_1, uniformBuffersNames[name_1]);\n      }\n    }\n\n    var effectAvailableUniforms = this.engine.getUniforms(this, uniformsNames);\n    effectAvailableUniforms.forEach(function (uniform, index) {\n      uniforms[uniformsNames[index]] = uniform;\n    });\n    this._uniforms = uniforms;\n    var index;\n\n    for (index = 0; index < samplerList.length; index++) {\n      var sampler = effect.getUniform(samplerList[index]);\n\n      if (sampler == null) {\n        samplerList.splice(index, 1);\n        index--;\n      }\n    }\n\n    samplerList.forEach(function (name, index) {\n      samplers[name] = index;\n    });\n    attributes.push.apply(attributes, engine.getAttributes(this, attributesNames));\n  };\n  /**\n   * Release all associated resources.\n   **/\n\n\n  NativePipelineContext.prototype.dispose = function () {\n    this._uniforms = {};\n  };\n  /**\n   * @param uniformName\n   * @param matrix\n   * @hidden\n   */\n\n\n  NativePipelineContext.prototype._cacheMatrix = function (uniformName, matrix) {\n    var cache = this._valueCache[uniformName];\n    var flag = matrix.updateFlag;\n\n    if (cache !== undefined && cache === flag) {\n      return false;\n    }\n\n    this._valueCache[uniformName] = flag;\n    return true;\n  };\n  /**\n   * @param uniformName\n   * @param x\n   * @param y\n   * @hidden\n   */\n\n\n  NativePipelineContext.prototype._cacheFloat2 = function (uniformName, x, y) {\n    var cache = this._valueCache[uniformName];\n\n    if (!cache) {\n      cache = [x, y];\n      this._valueCache[uniformName] = cache;\n      return true;\n    }\n\n    var changed = false;\n\n    if (cache[0] !== x) {\n      cache[0] = x;\n      changed = true;\n    }\n\n    if (cache[1] !== y) {\n      cache[1] = y;\n      changed = true;\n    }\n\n    return changed;\n  };\n  /**\n   * @param uniformName\n   * @param x\n   * @param y\n   * @param z\n   * @hidden\n   */\n\n\n  NativePipelineContext.prototype._cacheFloat3 = function (uniformName, x, y, z) {\n    var cache = this._valueCache[uniformName];\n\n    if (!cache) {\n      cache = [x, y, z];\n      this._valueCache[uniformName] = cache;\n      return true;\n    }\n\n    var changed = false;\n\n    if (cache[0] !== x) {\n      cache[0] = x;\n      changed = true;\n    }\n\n    if (cache[1] !== y) {\n      cache[1] = y;\n      changed = true;\n    }\n\n    if (cache[2] !== z) {\n      cache[2] = z;\n      changed = true;\n    }\n\n    return changed;\n  };\n  /**\n   * @param uniformName\n   * @param x\n   * @param y\n   * @param z\n   * @param w\n   * @hidden\n   */\n\n\n  NativePipelineContext.prototype._cacheFloat4 = function (uniformName, x, y, z, w) {\n    var cache = this._valueCache[uniformName];\n\n    if (!cache) {\n      cache = [x, y, z, w];\n      this._valueCache[uniformName] = cache;\n      return true;\n    }\n\n    var changed = false;\n\n    if (cache[0] !== x) {\n      cache[0] = x;\n      changed = true;\n    }\n\n    if (cache[1] !== y) {\n      cache[1] = y;\n      changed = true;\n    }\n\n    if (cache[2] !== z) {\n      cache[2] = z;\n      changed = true;\n    }\n\n    if (cache[3] !== w) {\n      cache[3] = w;\n      changed = true;\n    }\n\n    return changed;\n  };\n  /**\n   * Sets an integer value on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param value Value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setInt = function (uniformName, value) {\n    var cache = this._valueCache[uniformName];\n\n    if (cache !== undefined && cache === value) {\n      return;\n    }\n\n    if (this.engine.setInt(this._uniforms[uniformName], value)) {\n      this._valueCache[uniformName] = value;\n    }\n  };\n  /**\n   * Sets a int2 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First int in int2.\n   * @param y Second int in int2.\n   */\n\n\n  NativePipelineContext.prototype.setInt2 = function (uniformName, x, y) {\n    if (this._cacheFloat2(uniformName, x, y)) {\n      if (!this.engine.setInt2(this._uniforms[uniformName], x, y)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a int3 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First int in int3.\n   * @param y Second int in int3.\n   * @param z Third int in int3.\n   */\n\n\n  NativePipelineContext.prototype.setInt3 = function (uniformName, x, y, z) {\n    if (this._cacheFloat3(uniformName, x, y, z)) {\n      if (!this.engine.setInt3(this._uniforms[uniformName], x, y, z)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a int4 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First int in int4.\n   * @param y Second int in int4.\n   * @param z Third int in int4.\n   * @param w Fourth int in int4.\n   */\n\n\n  NativePipelineContext.prototype.setInt4 = function (uniformName, x, y, z, w) {\n    if (this._cacheFloat4(uniformName, x, y, z, w)) {\n      if (!this.engine.setInt4(this._uniforms[uniformName], x, y, z, w)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets an int array on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setIntArray = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setIntArray(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an int array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setIntArray2 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setIntArray2(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an int array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setIntArray3 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setIntArray3(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an int array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setIntArray4 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setIntArray4(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an float array on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setFloatArray = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setFloatArray(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an float array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setFloatArray2 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setFloatArray2(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an float array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setFloatArray3 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setFloatArray3(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an float array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setFloatArray4 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setFloatArray4(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an array on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setArray = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setArray(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setArray2 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setArray2(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   * @returns this effect.\n   */\n\n\n  NativePipelineContext.prototype.setArray3 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setArray3(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets an array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\n   * @param uniformName Name of the variable.\n   * @param array array to be set.\n   */\n\n\n  NativePipelineContext.prototype.setArray4 = function (uniformName, array) {\n    this._valueCache[uniformName] = null;\n    this.engine.setArray4(this._uniforms[uniformName], array);\n  };\n  /**\n   * Sets matrices on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param matrices matrices to be set.\n   */\n\n\n  NativePipelineContext.prototype.setMatrices = function (uniformName, matrices) {\n    if (!matrices) {\n      return;\n    }\n\n    this._valueCache[uniformName] = null;\n    this.engine.setMatrices(this._uniforms[uniformName], matrices);\n  };\n  /**\n   * Sets matrix on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param matrix matrix to be set.\n   */\n\n\n  NativePipelineContext.prototype.setMatrix = function (uniformName, matrix) {\n    if (this._cacheMatrix(uniformName, matrix)) {\n      if (!this.engine.setMatrices(this._uniforms[uniformName], matrix.toArray())) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a 3x3 matrix on a uniform variable. (Specified as [1,2,3,4,5,6,7,8,9] will result in [1,2,3][4,5,6][7,8,9] matrix)\n   * @param uniformName Name of the variable.\n   * @param matrix matrix to be set.\n   */\n\n\n  NativePipelineContext.prototype.setMatrix3x3 = function (uniformName, matrix) {\n    this._valueCache[uniformName] = null;\n    this.engine.setMatrix3x3(this._uniforms[uniformName], matrix);\n  };\n  /**\n   * Sets a 2x2 matrix on a uniform variable. (Specified as [1,2,3,4] will result in [1,2][3,4] matrix)\n   * @param uniformName Name of the variable.\n   * @param matrix matrix to be set.\n   */\n\n\n  NativePipelineContext.prototype.setMatrix2x2 = function (uniformName, matrix) {\n    this._valueCache[uniformName] = null;\n    this.engine.setMatrix2x2(this._uniforms[uniformName], matrix);\n  };\n  /**\n   * Sets a float on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param value value to be set.\n   * @returns this effect.\n   */\n\n\n  NativePipelineContext.prototype.setFloat = function (uniformName, value) {\n    var cache = this._valueCache[uniformName];\n\n    if (cache !== undefined && cache === value) {\n      return;\n    }\n\n    if (this.engine.setFloat(this._uniforms[uniformName], value)) {\n      this._valueCache[uniformName] = value;\n    }\n  };\n  /**\n   * Sets a boolean on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param bool value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setBool = function (uniformName, bool) {\n    var cache = this._valueCache[uniformName];\n\n    if (cache !== undefined && cache === bool) {\n      return;\n    }\n\n    if (this.engine.setInt(this._uniforms[uniformName], bool ? 1 : 0)) {\n      this._valueCache[uniformName] = bool ? 1 : 0;\n    }\n  };\n  /**\n   * Sets a Vector2 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param vector2 vector2 to be set.\n   */\n\n\n  NativePipelineContext.prototype.setVector2 = function (uniformName, vector2) {\n    if (this._cacheFloat2(uniformName, vector2.x, vector2.y)) {\n      if (!this.engine.setFloat2(this._uniforms[uniformName], vector2.x, vector2.y)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a float2 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First float in float2.\n   * @param y Second float in float2.\n   */\n\n\n  NativePipelineContext.prototype.setFloat2 = function (uniformName, x, y) {\n    if (this._cacheFloat2(uniformName, x, y)) {\n      if (!this.engine.setFloat2(this._uniforms[uniformName], x, y)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a Vector3 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param vector3 Value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setVector3 = function (uniformName, vector3) {\n    if (this._cacheFloat3(uniformName, vector3.x, vector3.y, vector3.z)) {\n      if (!this.engine.setFloat3(this._uniforms[uniformName], vector3.x, vector3.y, vector3.z)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a float3 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First float in float3.\n   * @param y Second float in float3.\n   * @param z Third float in float3.\n   */\n\n\n  NativePipelineContext.prototype.setFloat3 = function (uniformName, x, y, z) {\n    if (this._cacheFloat3(uniformName, x, y, z)) {\n      if (!this.engine.setFloat3(this._uniforms[uniformName], x, y, z)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a Vector4 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param vector4 Value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setVector4 = function (uniformName, vector4) {\n    if (this._cacheFloat4(uniformName, vector4.x, vector4.y, vector4.z, vector4.w)) {\n      if (!this.engine.setFloat4(this._uniforms[uniformName], vector4.x, vector4.y, vector4.z, vector4.w)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a float4 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param x First float in float4.\n   * @param y Second float in float4.\n   * @param z Third float in float4.\n   * @param w Fourth float in float4.\n   * @returns this effect.\n   */\n\n\n  NativePipelineContext.prototype.setFloat4 = function (uniformName, x, y, z, w) {\n    if (this._cacheFloat4(uniformName, x, y, z, w)) {\n      if (!this.engine.setFloat4(this._uniforms[uniformName], x, y, z, w)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a Color3 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param color3 Value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setColor3 = function (uniformName, color3) {\n    if (this._cacheFloat3(uniformName, color3.r, color3.g, color3.b)) {\n      if (!this.engine.setFloat3(this._uniforms[uniformName], color3.r, color3.g, color3.b)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a Color4 on a uniform variable.\n   * @param uniformName Name of the variable.\n   * @param color3 Value to be set.\n   * @param alpha Alpha value to be set.\n   */\n\n\n  NativePipelineContext.prototype.setColor4 = function (uniformName, color3, alpha) {\n    if (this._cacheFloat4(uniformName, color3.r, color3.g, color3.b, alpha)) {\n      if (!this.engine.setFloat4(this._uniforms[uniformName], color3.r, color3.g, color3.b, alpha)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n  /**\n   * Sets a Color4 on a uniform variable\n   * @param uniformName defines the name of the variable\n   * @param color4 defines the value to be set\n   */\n\n\n  NativePipelineContext.prototype.setDirectColor4 = function (uniformName, color4) {\n    if (this._cacheFloat4(uniformName, color4.r, color4.g, color4.b, color4.a)) {\n      if (!this.engine.setFloat4(this._uniforms[uniformName], color4.r, color4.g, color4.b, color4.a)) {\n        this._valueCache[uniformName] = null;\n      }\n    }\n  };\n\n  return NativePipelineContext;\n}();\n\nvar NativeRenderTargetWrapper =\n/** @class */\nfunction (_super) {\n  __extends(NativeRenderTargetWrapper, _super);\n\n  function NativeRenderTargetWrapper(isMulti, isCube, size, engine) {\n    var _this = _super.call(this, isMulti, isCube, size, engine) || this;\n\n    _this.__framebuffer = null;\n    _this.__framebufferDepthStencil = null;\n    _this._engine = engine;\n    return _this;\n  }\n\n  Object.defineProperty(NativeRenderTargetWrapper.prototype, \"_framebuffer\", {\n    get: function get() {\n      return this.__framebuffer;\n    },\n    set: function set(framebuffer) {\n      if (this.__framebuffer) {\n        this._engine._releaseFramebufferObjects(this.__framebuffer);\n      }\n\n      this.__framebuffer = framebuffer;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(NativeRenderTargetWrapper.prototype, \"_framebufferDepthStencil\", {\n    get: function get() {\n      return this.__framebufferDepthStencil;\n    },\n    set: function set(framebufferDepthStencil) {\n      if (this.__framebufferDepthStencil) {\n        this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil);\n      }\n\n      this.__framebufferDepthStencil = framebufferDepthStencil;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  NativeRenderTargetWrapper.prototype.dispose = function (disposeOnlyFramebuffers) {\n    if (disposeOnlyFramebuffers === void 0) {\n      disposeOnlyFramebuffers = false;\n    }\n\n    this._framebuffer = null;\n    this._framebufferDepthStencil = null;\n\n    _super.prototype.dispose.call(this, disposeOnlyFramebuffers);\n  };\n\n  return NativeRenderTargetWrapper;\n}(RenderTargetWrapper);\n/**\n * Container for accessors for natively-stored mesh data buffers.\n */\n\n\nvar NativeDataBuffer =\n/** @class */\nfunction (_super) {\n  __extends(NativeDataBuffer, _super);\n\n  function NativeDataBuffer() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  return NativeDataBuffer;\n}(DataBuffer);\n/** @hidden */\n\n\nvar CommandBufferEncoder =\n/** @class */\nfunction () {\n  function CommandBufferEncoder(_engine) {\n    this._engine = _engine;\n    this._pending = new Array();\n    this._isCommandBufferScopeActive = false;\n    this._commandStream = NativeEngine._createNativeDataStream();\n\n    this._engine.setCommandDataStream(this._commandStream);\n  }\n\n  CommandBufferEncoder.prototype.beginCommandScope = function () {\n    if (this._isCommandBufferScopeActive) {\n      throw new Error(\"Command scope already active.\");\n    }\n\n    this._isCommandBufferScopeActive = true;\n  };\n\n  CommandBufferEncoder.prototype.endCommandScope = function () {\n    if (!this._isCommandBufferScopeActive) {\n      throw new Error(\"Command scope is not active.\");\n    }\n\n    this._isCommandBufferScopeActive = false;\n\n    this._submit();\n  };\n\n  CommandBufferEncoder.prototype.startEncodingCommand = function (command) {\n    this._commandStream.writeNativeData(command);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsUInt32 = function (commandArg) {\n    this._commandStream.writeUint32(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsUInt32s = function (commandArg) {\n    this._commandStream.writeUint32Array(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsInt32 = function (commandArg) {\n    this._commandStream.writeInt32(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsInt32s = function (commandArg) {\n    this._commandStream.writeInt32Array(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsFloat32 = function (commandArg) {\n    this._commandStream.writeFloat32(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsFloat32s = function (commandArg) {\n    this._commandStream.writeFloat32Array(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.encodeCommandArgAsNativeData = function (commandArg) {\n    this._commandStream.writeNativeData(commandArg);\n\n    this._pending.push(commandArg);\n  };\n\n  CommandBufferEncoder.prototype.finishEncodingCommand = function () {\n    if (!this._isCommandBufferScopeActive) {\n      this._submit();\n    }\n  };\n\n  CommandBufferEncoder.prototype._submit = function () {\n    this._engine.submitCommands();\n\n    this._pending.length = 0;\n  };\n\n  return CommandBufferEncoder;\n}();\n/** @hidden */\n\n\nvar NativeEngine =\n/** @class */\nfunction (_super) {\n  __extends(NativeEngine, _super);\n\n  function NativeEngine(options) {\n    if (options === void 0) {\n      options = {};\n    }\n\n    var _this = _super.call(this, null, false, undefined, options.adaptToDeviceRatio) || this;\n\n    _this._engine = new _native.Engine();\n    _this._camera = _native.Camera ? new _native.Camera() : null;\n    _this._commandBufferEncoder = new CommandBufferEncoder(_this._engine);\n    _this._boundBuffersVertexArray = null;\n    _this._currentDepthTest = _native.Engine.DEPTH_TEST_LEQUAL;\n    _this._stencilTest = false;\n    _this._stencilMask = 255;\n    _this._stencilFunc = 519;\n    _this._stencilFuncRef = 0;\n    _this._stencilFuncMask = 255;\n    _this._stencilOpStencilFail = 7680;\n    _this._stencilOpDepthFail = 7680;\n    _this._stencilOpStencilDepthPass = 7681;\n    _this._zOffset = 0;\n    _this._zOffsetUnits = 0;\n    _this._depthWrite = true;\n\n    if (_native.Engine.PROTOCOL_VERSION !== NativeEngine.PROTOCOL_VERSION) {\n      throw new Error(\"Protocol version mismatch: \".concat(_native.Engine.PROTOCOL_VERSION, \" (Native) !== \").concat(NativeEngine.PROTOCOL_VERSION, \" (JS)\"));\n    }\n\n    _this._webGLVersion = 2;\n    _this.disableUniformBuffers = true; // TODO: Initialize this more correctly based on the hardware capabilities.\n    // Init caps\n\n    _this._caps = {\n      maxTexturesImageUnits: 16,\n      maxVertexTextureImageUnits: 16,\n      maxCombinedTexturesImageUnits: 32,\n      maxTextureSize: 512,\n      maxCubemapTextureSize: 512,\n      maxRenderTextureSize: 512,\n      maxVertexAttribs: 16,\n      maxVaryingVectors: 16,\n      maxFragmentUniformVectors: 16,\n      maxVertexUniformVectors: 16,\n      standardDerivatives: true,\n      astc: null,\n      pvrtc: null,\n      etc1: null,\n      etc2: null,\n      bptc: null,\n      maxAnisotropy: 16,\n      uintIndices: true,\n      fragmentDepthSupported: false,\n      highPrecisionShaderSupported: true,\n      colorBufferFloat: false,\n      textureFloat: true,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloat: false,\n      textureHalfFloatLinearFiltering: false,\n      textureHalfFloatRender: false,\n      textureLOD: true,\n      drawBuffersExtension: false,\n      depthTextureExtension: false,\n      vertexArrayObject: true,\n      instancedArrays: false,\n      supportOcclusionQuery: false,\n      canUseTimestampForTimerQuery: false,\n      blendMinMax: false,\n      maxMSAASamples: 1,\n      canUseGLInstanceID: true,\n      canUseGLVertexID: true,\n      supportComputeShaders: false,\n      supportSRGBBuffers: true,\n      supportTransformFeedbacks: false,\n      textureMaxLevel: false\n    };\n    _this._features = {\n      forceBitmapOverHTMLImageElement: false,\n      supportRenderAndCopyToLodForFloatTextures: false,\n      supportDepthStencilTexture: false,\n      supportShadowSamplers: false,\n      uniformBufferHardCheckMatrix: false,\n      allowTexturePrefiltering: false,\n      trackUbosInFrame: false,\n      checkUbosContentBeforeUpload: false,\n      supportCSM: false,\n      basisNeedsPOT: false,\n      support3DTextures: false,\n      needTypeSuffixInShaderConstants: false,\n      supportMSAA: false,\n      supportSSAO2: false,\n      supportExtendedTextureFormats: false,\n      supportSwitchCaseInShader: false,\n      supportSyncTextureRead: false,\n      needsInvertingBitmap: true,\n      useUBOBindingCache: true,\n      needShaderCodeInlining: true,\n      needToAlwaysBindUniformBuffers: false,\n      supportRenderPasses: true,\n      _collectUbosUpdatedInFrame: false\n    };\n    Tools.Log(\"Babylon Native (v\" + Engine.Version + \") launched\");\n\n    Tools.LoadScript = function (scriptUrl, onSuccess, onError, scriptId) {\n      Tools.LoadFile(scriptUrl, function (data) {\n        Function(data).apply(null);\n\n        if (onSuccess) {\n          onSuccess();\n        }\n      }, undefined, undefined, false, function (request, exception) {\n        if (onError) {\n          onError(\"LoadScript Error\", exception);\n        }\n      });\n    }; // Wrappers\n\n\n    if (typeof URL === \"undefined\") {\n      window.URL = {\n        createObjectURL: function createObjectURL() {},\n        revokeObjectURL: function revokeObjectURL() {}\n      };\n    }\n\n    if (typeof Blob === \"undefined\") {\n      window.Blob = function (v) {\n        return v;\n      };\n    } // Currently we do not fully configure the ThinEngine on construction of NativeEngine.\n    // Setup resolution scaling based on display settings.\n\n\n    var devicePixelRatio = window ? window.devicePixelRatio || 1.0 : 1.0;\n    _this._hardwareScalingLevel = options.adaptToDeviceRatio ? devicePixelRatio : 1.0;\n\n    _this.resize();\n\n    var currentDepthFunction = _this.getDepthFunction();\n\n    if (currentDepthFunction) {\n      _this.setDepthFunction(currentDepthFunction);\n    } // Shader processor\n\n\n    _this._shaderProcessor = new WebGL2ShaderProcessor();\n\n    _this.onNewSceneAddedObservable.add(function (scene) {\n      var originalRender = scene.render;\n\n      scene.render = function () {\n        var args = [];\n\n        for (var _i = 0; _i < arguments.length; _i++) {\n          args[_i] = arguments[_i];\n        }\n\n        _this._commandBufferEncoder.beginCommandScope();\n\n        originalRender.apply(scene, args);\n\n        _this._commandBufferEncoder.endCommandScope();\n      };\n    });\n\n    return _this;\n  }\n\n  NativeEngine.prototype.getHardwareScalingLevel = function () {\n    return this._engine.getHardwareScalingLevel();\n  };\n\n  NativeEngine.prototype.setHardwareScalingLevel = function (level) {\n    this._engine.setHardwareScalingLevel(level);\n  };\n\n  NativeEngine.prototype.dispose = function () {\n    _super.prototype.dispose.call(this);\n\n    if (this._boundBuffersVertexArray) {\n      this._deleteVertexArray(this._boundBuffersVertexArray);\n    }\n\n    this._engine.dispose();\n  };\n  /** @hidden */\n\n\n  NativeEngine._createNativeDataStream = function () {\n    return new NativeDataStream();\n  };\n  /**\n   * Can be used to override the current requestAnimationFrame requester.\n   * @param bindedRenderFunction\n   * @param requester\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\n    // Use the provided requestAnimationFrame, unless the requester is the window. In that case, we will default to the Babylon Native version of requestAnimationFrame.\n    if (requester.requestAnimationFrame && requester !== window) {\n      requester.requestAnimationFrame(bindedRenderFunction);\n    } else {\n      this._engine.requestAnimationFrame(bindedRenderFunction);\n    }\n\n    return 0;\n  };\n  /**\n   * Override default engine behavior.\n   * @param framebuffer\n   */\n\n\n  NativeEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      if (this._currentFramebuffer) {\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER);\n\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer);\n\n        this._commandBufferEncoder.finishEncodingCommand();\n      }\n\n      if (framebuffer) {\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER);\n\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(framebuffer);\n\n        this._commandBufferEncoder.finishEncodingCommand();\n      }\n\n      this._currentFramebuffer = framebuffer;\n    }\n  };\n  /**\n   * Gets host document\n   * @returns the host document object\n   */\n\n\n  NativeEngine.prototype.getHostDocument = function () {\n    return null;\n  };\n\n  NativeEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\n    if (stencil === void 0) {\n      stencil = false;\n    }\n\n    if (this.useReverseDepthBuffer) {\n      throw new Error(\"reverse depth buffer is not currently implemented\");\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(backBuffer && color ? 1 : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.r : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.g : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.b : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.a : 1);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(depth ? 1 : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(1);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(stencil ? 1 : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(0);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n\n  NativeEngine.prototype.createIndexBuffer = function (indices, updateable) {\n    var data = this._normalizeIndexData(indices);\n\n    var buffer = new NativeDataBuffer();\n    buffer.references = 1;\n    buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n\n    if (data.byteLength) {\n      buffer.nativeIndexBuffer = this._engine.createIndexBuffer(data.buffer, data.byteOffset, data.byteLength, buffer.is32Bits, updateable !== null && updateable !== void 0 ? updateable : false);\n    }\n\n    return buffer;\n  };\n\n  NativeEngine.prototype.createVertexBuffer = function (vertices, updateable) {\n    var data = ArrayBuffer.isView(vertices) ? vertices : new Float32Array(vertices);\n    var buffer = new NativeDataBuffer();\n    buffer.references = 1;\n\n    if (data.byteLength) {\n      buffer.nativeVertexBuffer = this._engine.createVertexBuffer(data.buffer, data.byteOffset, data.byteLength, updateable !== null && updateable !== void 0 ? updateable : false);\n    }\n\n    return buffer;\n  };\n\n  NativeEngine.prototype._recordVertexArrayObject = function (vertexArray, vertexBuffers, indexBuffer, effect) {\n    if (indexBuffer) {\n      this._engine.recordIndexBuffer(vertexArray, indexBuffer.nativeIndexBuffer);\n    }\n\n    var attributes = effect.getAttributesNames();\n\n    for (var index = 0; index < attributes.length; index++) {\n      var location_1 = effect.getAttributeLocation(index);\n\n      if (location_1 >= 0) {\n        var kind = attributes[index];\n        var vertexBuffer = vertexBuffers[kind];\n\n        if (vertexBuffer) {\n          var buffer = vertexBuffer.getBuffer();\n\n          if (buffer) {\n            this._engine.recordVertexBuffer(vertexArray, buffer.nativeVertexBuffer, location_1, vertexBuffer.byteOffset, vertexBuffer.byteStride, vertexBuffer.getSize(), this._getNativeAttribType(vertexBuffer.type), vertexBuffer.normalized, vertexBuffer.getInstanceDivisor());\n          }\n        }\n      }\n    }\n  };\n\n  NativeEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\n    if (this._boundBuffersVertexArray) {\n      this._deleteVertexArray(this._boundBuffersVertexArray);\n    }\n\n    this._boundBuffersVertexArray = this._engine.createVertexArray();\n\n    this._recordVertexArrayObject(this._boundBuffersVertexArray, vertexBuffers, indexBuffer, effect);\n\n    this.bindVertexArrayObject(this._boundBuffersVertexArray);\n  };\n\n  NativeEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\n    var vertexArray = this._engine.createVertexArray();\n\n    this._recordVertexArrayObject(vertexArray, vertexBuffers, indexBuffer, effect);\n\n    return vertexArray;\n  };\n\n  NativeEngine.prototype._deleteVertexArray = function (vertexArray) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(vertexArray);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n\n  NativeEngine.prototype.bindVertexArrayObject = function (vertexArray) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(vertexArray);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n\n  NativeEngine.prototype.releaseVertexArrayObject = function (vertexArray) {\n    this._deleteVertexArray(vertexArray);\n  };\n\n  NativeEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\n    var nativePipelineContext = pipelineContext;\n    return this._engine.getAttributes(nativePipelineContext.nativeProgram, attributesNames);\n  };\n  /**\n   * Draw a list of indexed primitives\n   * @param fillMode defines the primitive to use\n   * @param indexStart defines the starting index\n   * @param indexCount defines the number of index to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  NativeEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this._drawCalls.addCount(1, false); // TODO: Make this implementation more robust like core Engine version.\n    // Render\n    //var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    //var mult = this._uintIndicesCurrentlySet ? 4 : 2;\n    // if (instancesCount) {\n    //     this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    // } else {\n\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(fillMode);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(indexStart);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(indexCount);\n\n    this._commandBufferEncoder.finishEncodingCommand(); // }\n\n  };\n  /**\n   * Draw a list of unindexed primitives\n   * @param fillMode defines the primitive to use\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  NativeEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this._drawCalls.addCount(1, false); // TODO: Make this implementation more robust like core Engine version.\n    // if (instancesCount) {\n    //     this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    // } else {\n\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(fillMode);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(verticesStart);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(verticesCount);\n\n    this._commandBufferEncoder.finishEncodingCommand(); // }\n\n  };\n\n  NativeEngine.prototype.createPipelineContext = function () {\n    return new NativePipelineContext(this);\n  };\n\n  NativeEngine.prototype.createMaterialContext = function () {\n    return undefined;\n  };\n\n  NativeEngine.prototype.createDrawContext = function () {\n    return undefined;\n  };\n\n  NativeEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rawVertexSourceCode, rawFragmentSourceCode, rebuildRebind, defines, transformFeedbackVaryings) {\n    var nativePipelineContext = pipelineContext;\n\n    if (createAsRaw) {\n      nativePipelineContext.nativeProgram = this.createRawShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      nativePipelineContext.nativeProgram = this.createShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n  };\n  /**\n   * @param pipelineContext\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\n    // TODO: support async shader compilcation\n    return true;\n  };\n  /**\n   * @param pipelineContext\n   * @param action\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\n    // TODO: support async shader compilcation\n    action();\n  };\n\n  NativeEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    throw new Error(\"Not Supported\");\n  };\n\n  NativeEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    this.onBeforeShaderCompilationObservable.notifyObservers(this);\n    var vertexInliner = new ShaderCodeInliner(vertexCode);\n    vertexInliner.processCode();\n    vertexCode = vertexInliner.code;\n    var fragmentInliner = new ShaderCodeInliner(fragmentCode);\n    fragmentInliner.processCode();\n    fragmentCode = fragmentInliner.code;\n    vertexCode = ThinEngine._ConcatenateShader(vertexCode, defines);\n    fragmentCode = ThinEngine._ConcatenateShader(fragmentCode, defines);\n\n    var program = this._engine.createProgram(vertexCode, fragmentCode);\n\n    this.onAfterShaderCompilationObservable.notifyObservers(this);\n    return program;\n  };\n  /**\n   * Inline functions in shader code that are marked to be inlined\n   * @param code code to inline\n   * @returns inlined code\n   */\n\n\n  NativeEngine.prototype.inlineShaderCode = function (code) {\n    var sci = new ShaderCodeInliner(code);\n    sci.debug = false;\n    sci.processCode();\n    return sci.code;\n  };\n\n  NativeEngine.prototype._setProgram = function (program) {\n    if (this._currentProgram !== program) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(program);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n\n      this._currentProgram = program;\n    }\n  };\n\n  NativeEngine.prototype._deletePipelineContext = function (pipelineContext) {\n    var nativePipelineContext = pipelineContext;\n\n    if (nativePipelineContext && nativePipelineContext.nativeProgram) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(nativePipelineContext.nativeProgram);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n    }\n  };\n\n  NativeEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\n    var nativePipelineContext = pipelineContext;\n    return this._engine.getUniforms(nativePipelineContext.nativeProgram, uniformsNames);\n  };\n\n  NativeEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\n    // TODO\n    throw new Error(\"Not Implemented\");\n  };\n\n  NativeEngine.prototype.bindSamplers = function (effect) {\n    var nativePipelineContext = effect.getPipelineContext();\n\n    this._setProgram(nativePipelineContext.nativeProgram); // TODO: share this with engine?\n\n\n    var samplers = effect.getSamplers();\n\n    for (var index = 0; index < samplers.length; index++) {\n      var uniform = effect.getUniform(samplers[index]);\n\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n\n    this._currentEffect = null;\n  };\n\n  NativeEngine.prototype.setMatrix = function (uniform, matrix) {\n    if (!uniform) {\n      return;\n    }\n\n    var matrixArray = matrix.toArray();\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrixArray);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n\n  NativeEngine.prototype.getRenderWidth = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n\n    return this._engine.getRenderWidth();\n  };\n\n  NativeEngine.prototype.getRenderHeight = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n\n    return this._engine.getRenderHeight();\n  };\n\n  NativeEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\n    this._cachedViewport = viewport;\n\n    this._engine.setViewPort(viewport.x, viewport.y, viewport.width, viewport.height);\n  };\n\n  NativeEngine.prototype.setState = function (culling, zOffset, force, reverseSide, cullBackFaces, stencil, zOffsetUnits) {\n    var _a, _b;\n\n    if (zOffset === void 0) {\n      zOffset = 0;\n    }\n\n    if (reverseSide === void 0) {\n      reverseSide = false;\n    }\n\n    if (zOffsetUnits === void 0) {\n      zOffsetUnits = 0;\n    }\n\n    this._zOffset = zOffset;\n    this._zOffsetUnits = zOffsetUnits;\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(culling ? 1 : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(zOffset);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(zOffsetUnits);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(((_b = (_a = this.cullBackFaces) !== null && _a !== void 0 ? _a : cullBackFaces) !== null && _b !== void 0 ? _b : true) ? 1 : 0);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(reverseSide ? 1 : 0);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Gets the client rect of native canvas.  Needed for InputManager.\n   * @returns a client rectangle\n   */\n\n\n  NativeEngine.prototype.getInputElementClientRect = function () {\n    var rect = {\n      bottom: this.getRenderHeight(),\n      height: this.getRenderHeight(),\n      left: 0,\n      right: this.getRenderWidth(),\n      top: 0,\n      width: this.getRenderWidth(),\n      x: 0,\n      y: 0,\n      toJSON: function toJSON() {}\n    };\n    return rect;\n  };\n  /**\n   * Set the z offset Factor to apply to current rendering\n   * @param value defines the offset to apply\n   */\n\n\n  NativeEngine.prototype.setZOffset = function (value) {\n    if (value !== this._zOffset) {\n      this._zOffset = value;\n\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET);\n\n      this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer ? -value : value);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n    }\n  };\n  /**\n   * Gets the current value of the zOffset Factor\n   * @returns the current zOffset Factor state\n   */\n\n\n  NativeEngine.prototype.getZOffset = function () {\n    return this._zOffset;\n  };\n  /**\n   * Set the z offset Units to apply to current rendering\n   * @param value defines the offset to apply\n   */\n\n\n  NativeEngine.prototype.setZOffsetUnits = function (value) {\n    if (value !== this._zOffsetUnits) {\n      this._zOffsetUnits = value;\n\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS);\n\n      this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer ? -value : value);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n    }\n  };\n  /**\n   * Gets the current value of the zOffset Units\n   * @returns the current zOffset Units state\n   */\n\n\n  NativeEngine.prototype.getZOffsetUnits = function () {\n    return this._zOffsetUnits;\n  };\n  /**\n   * Enable or disable depth buffering\n   * @param enable defines the state to set\n   */\n\n\n  NativeEngine.prototype.setDepthBuffer = function (enable) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(enable ? this._currentDepthTest : _native.Engine.DEPTH_TEST_ALWAYS);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Gets a boolean indicating if depth writing is enabled\n   * @returns the current depth writing state\n   */\n\n\n  NativeEngine.prototype.getDepthWrite = function () {\n    return this._depthWrite;\n  };\n\n  NativeEngine.prototype.getDepthFunction = function () {\n    switch (this._currentDepthTest) {\n      case _native.Engine.DEPTH_TEST_NEVER:\n        return 512;\n\n      case _native.Engine.DEPTH_TEST_ALWAYS:\n        return 519;\n\n      case _native.Engine.DEPTH_TEST_GREATER:\n        return 516;\n\n      case _native.Engine.DEPTH_TEST_GEQUAL:\n        return 518;\n\n      case _native.Engine.DEPTH_TEST_NOTEQUAL:\n        return 517;\n\n      case _native.Engine.DEPTH_TEST_EQUAL:\n        return 514;\n\n      case _native.Engine.DEPTH_TEST_LESS:\n        return 513;\n\n      case _native.Engine.DEPTH_TEST_LEQUAL:\n        return 515;\n    }\n\n    return null;\n  };\n\n  NativeEngine.prototype.setDepthFunction = function (depthFunc) {\n    var nativeDepthFunc = 0;\n\n    switch (depthFunc) {\n      case 512:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_NEVER;\n        break;\n\n      case 519:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_ALWAYS;\n        break;\n\n      case 516:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_GREATER;\n        break;\n\n      case 518:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_GEQUAL;\n        break;\n\n      case 517:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_NOTEQUAL;\n        break;\n\n      case 514:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_EQUAL;\n        break;\n\n      case 513:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_LESS;\n        break;\n\n      case 515:\n        nativeDepthFunc = _native.Engine.DEPTH_TEST_LEQUAL;\n        break;\n    }\n\n    this._currentDepthTest = nativeDepthFunc;\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Enable or disable depth writing\n   * @param enable defines the state to set\n   */\n\n\n  NativeEngine.prototype.setDepthWrite = function (enable) {\n    this._depthWrite = enable;\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(enable));\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Enable or disable color writing\n   * @param enable defines the state to set\n   */\n\n\n  NativeEngine.prototype.setColorWrite = function (enable) {\n    this._colorWrite = enable;\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(enable));\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Gets a boolean indicating if color writing is enabled\n   * @returns the current color writing state\n   */\n\n\n  NativeEngine.prototype.getColorWrite = function () {\n    return this._colorWrite;\n  };\n\n  NativeEngine.prototype.applyStencil = function () {\n    this._setStencil(this._stencilMask, this._getStencilOpFail(this._stencilOpStencilFail), this._getStencilDepthFail(this._stencilOpDepthFail), this._getStencilDepthPass(this._stencilOpStencilDepthPass), this._getStencilFunc(this._stencilFunc), this._stencilFuncRef);\n  };\n\n  NativeEngine.prototype._setStencil = function (mask, stencilOpFail, depthOpFail, depthOpPass, func, ref) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(mask);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(stencilOpFail);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(depthOpFail);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(depthOpPass);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(func);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(ref);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n  /**\n   * Enable or disable the stencil buffer\n   * @param enable defines if the stencil buffer must be enabled or disabled\n   */\n\n\n  NativeEngine.prototype.setStencilBuffer = function (enable) {\n    this._stencilTest = enable;\n\n    if (enable) {\n      this.applyStencil();\n    } else {\n      this._setStencil(255, _native.Engine.STENCIL_OP_FAIL_S_KEEP, _native.Engine.STENCIL_OP_FAIL_Z_KEEP, _native.Engine.STENCIL_OP_PASS_Z_KEEP, _native.Engine.STENCIL_TEST_ALWAYS, 0);\n    }\n  };\n  /**\n   * Gets a boolean indicating if stencil buffer is enabled\n   * @returns the current stencil buffer state\n   */\n\n\n  NativeEngine.prototype.getStencilBuffer = function () {\n    return this._stencilTest;\n  };\n  /**\n   * Gets the current stencil operation when stencil passes\n   * @returns a number defining stencil operation to use when stencil passes\n   */\n\n\n  NativeEngine.prototype.getStencilOperationPass = function () {\n    return this._stencilOpStencilDepthPass;\n  };\n  /**\n   * Sets the stencil operation to use when stencil passes\n   * @param operation defines the stencil operation to use when stencil passes\n   */\n\n\n  NativeEngine.prototype.setStencilOperationPass = function (operation) {\n    this._stencilOpStencilDepthPass = operation;\n    this.applyStencil();\n  };\n  /**\n   * Sets the current stencil mask\n   * @param mask defines the new stencil mask to use\n   */\n\n\n  NativeEngine.prototype.setStencilMask = function (mask) {\n    this._stencilMask = mask;\n    this.applyStencil();\n  };\n  /**\n   * Sets the current stencil function\n   * @param stencilFunc defines the new stencil function to use\n   */\n\n\n  NativeEngine.prototype.setStencilFunction = function (stencilFunc) {\n    this._stencilFunc = stencilFunc;\n    this.applyStencil();\n  };\n  /**\n   * Sets the current stencil reference\n   * @param reference defines the new stencil reference to use\n   */\n\n\n  NativeEngine.prototype.setStencilFunctionReference = function (reference) {\n    this._stencilFuncRef = reference;\n    this.applyStencil();\n  };\n  /**\n   * Sets the current stencil mask\n   * @param mask defines the new stencil mask to use\n   */\n\n\n  NativeEngine.prototype.setStencilFunctionMask = function (mask) {\n    this._stencilFuncMask = mask;\n  };\n  /**\n   * Sets the stencil operation to use when stencil fails\n   * @param operation defines the stencil operation to use when stencil fails\n   */\n\n\n  NativeEngine.prototype.setStencilOperationFail = function (operation) {\n    this._stencilOpStencilFail = operation;\n    this.applyStencil();\n  };\n  /**\n   * Sets the stencil operation to use when depth fails\n   * @param operation defines the stencil operation to use when depth fails\n   */\n\n\n  NativeEngine.prototype.setStencilOperationDepthFail = function (operation) {\n    this._stencilOpDepthFail = operation;\n    this.applyStencil();\n  };\n  /**\n   * Gets the current stencil mask\n   * @returns a number defining the new stencil mask to use\n   */\n\n\n  NativeEngine.prototype.getStencilMask = function () {\n    return this._stencilMask;\n  };\n  /**\n   * Gets the current stencil function\n   * @returns a number defining the stencil function to use\n   */\n\n\n  NativeEngine.prototype.getStencilFunction = function () {\n    return this._stencilFunc;\n  };\n  /**\n   * Gets the current stencil reference value\n   * @returns a number defining the stencil reference value to use\n   */\n\n\n  NativeEngine.prototype.getStencilFunctionReference = function () {\n    return this._stencilFuncRef;\n  };\n  /**\n   * Gets the current stencil mask\n   * @returns a number defining the stencil mask to use\n   */\n\n\n  NativeEngine.prototype.getStencilFunctionMask = function () {\n    return this._stencilFuncMask;\n  };\n  /**\n   * Gets the current stencil operation when stencil fails\n   * @returns a number defining stencil operation to use when stencil fails\n   */\n\n\n  NativeEngine.prototype.getStencilOperationFail = function () {\n    return this._stencilOpStencilFail;\n  };\n  /**\n   * Gets the current stencil operation when depth fails\n   * @returns a number defining stencil operation to use when depth fails\n   */\n\n\n  NativeEngine.prototype.getStencilOperationDepthFail = function () {\n    return this._stencilOpDepthFail;\n  };\n  /**\n   * Sets alpha constants used by some alpha blending modes\n   * @param r defines the red component\n   * @param g defines the green component\n   * @param b defines the blue component\n   * @param a defines the alpha component\n   */\n\n\n  NativeEngine.prototype.setAlphaConstants = function (r, g, b, a) {\n    throw new Error(\"Setting alpha blend constant color not yet implemented.\");\n  };\n  /**\n   * Sets the current alpha mode\n   * @param mode defines the mode to use (one of the BABYLON.undefined)\n   * @param noDepthWriteChange defines if depth writing state should remains unchanged (false by default)\n   * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\n   */\n\n\n  NativeEngine.prototype.setAlphaMode = function (mode, noDepthWriteChange) {\n    if (noDepthWriteChange === void 0) {\n      noDepthWriteChange = false;\n    }\n\n    if (this._alphaMode === mode) {\n      return;\n    }\n\n    var nativeMode = this._getNativeAlphaMode(mode);\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(nativeMode);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    if (!noDepthWriteChange) {\n      this.setDepthWrite(mode === 0);\n    }\n\n    this._alphaMode = mode;\n  };\n  /**\n   * Gets the current alpha mode\n   * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\n   * @returns the current alpha mode\n   */\n\n\n  NativeEngine.prototype.getAlphaMode = function () {\n    return this._alphaMode;\n  };\n\n  NativeEngine.prototype.setInt = function (uniform, _int) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsInt32(_int);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    return this.setFloatArray(uniform, new Float32Array(array));\n  };\n\n  NativeEngine.prototype.setArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    return this.setFloatArray2(uniform, new Float32Array(array));\n  };\n\n  NativeEngine.prototype.setArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    return this.setFloatArray3(uniform, new Float32Array(array));\n  };\n\n  NativeEngine.prototype.setArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    return this.setFloatArray4(uniform, new Float32Array(array));\n  };\n\n  NativeEngine.prototype.setMatrices = function (uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrices);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrix);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrix);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(value);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(z);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(z);\n\n    this._commandBufferEncoder.encodeCommandArgAsFloat32(w);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n\n    return true;\n  };\n\n  NativeEngine.prototype.setColor3 = function (uniform, color3) {\n    if (!uniform) {\n      return false;\n    }\n\n    this.setFloat3(uniform, color3.r, color3.g, color3.b);\n    return true;\n  };\n\n  NativeEngine.prototype.setColor4 = function (uniform, color3, alpha) {\n    if (!uniform) {\n      return false;\n    }\n\n    this.setFloat4(uniform, color3.r, color3.g, color3.b, alpha);\n    return true;\n  };\n\n  NativeEngine.prototype.wipeCaches = function (bruteForce) {\n    if (this.preventCacheWipeBetweenFrames) {\n      return;\n    }\n\n    this.resetTextureCache();\n    this._currentEffect = null;\n\n    if (bruteForce) {\n      this._currentProgram = null;\n\n      this._stencilStateComposer.reset();\n\n      this._depthCullingState.reset();\n\n      this._alphaState.reset();\n    }\n\n    this._cachedVertexBuffers = null;\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n  };\n\n  NativeEngine.prototype._createTexture = function () {\n    return this._engine.createTexture();\n  };\n\n  NativeEngine.prototype._deleteTexture = function (texture) {\n    if (texture) {\n      this._engine.deleteTexture(texture);\n    }\n  };\n  /**\n   * Update the content of a dynamic texture\n   * @param texture defines the texture to update\n   * @param canvas defines the canvas containing the source\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param premulAlpha defines if alpha is stored as premultiplied\n   * @param format defines the format of the data\n   */\n\n\n  NativeEngine.prototype.updateDynamicTexture = function (texture, canvas, invertY, premulAlpha, format) {\n    if (premulAlpha === void 0) {\n      premulAlpha = false;\n    }\n\n    if (premulAlpha === void 0) {\n      premulAlpha = false;\n    }\n\n    if (!!texture && !!texture._hardwareTexture) {\n      var source = canvas.getCanvasTexture();\n      var destination = texture._hardwareTexture.underlyingResource;\n\n      this._engine.copyTexture(destination, source);\n\n      texture.isReady = true;\n    }\n  };\n\n  NativeEngine.prototype.createDynamicTexture = function (width, height, generateMipMaps, samplingMode) {\n    // it's not possible to create 0x0 texture sized. Many bgfx methods assume texture size is at least 1x1(best case).\n    // Worst case is getting a crash/assert.\n    width = Math.max(width, 1);\n    height = Math.max(height, 1);\n    return this.createRawTexture(new Uint8Array(width * height * 4), width, height, 5, false, false, samplingMode);\n  };\n\n  NativeEngine.prototype.createVideoElement = function (constraints) {\n    // create native object depending on stream. Only NativeCamera is supported for now.\n    if (this._camera) {\n      return this._camera.createVideo(constraints);\n    }\n\n    return null;\n  };\n\n  NativeEngine.prototype.updateVideoTexture = function (texture, video, invertY) {\n    if (texture && texture._hardwareTexture && this._camera) {\n      var webGLTexture = texture._hardwareTexture.underlyingResource;\n\n      this._camera.updateVideoTexture(webGLTexture, video, invertY);\n    }\n  };\n\n  NativeEngine.prototype.createRawTexture = function (data, width, height, format, generateMipMaps, invertY, samplingMode, compression, type) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (type === void 0) {\n      type = 0;\n    }\n\n    var texture = new InternalTexture(this, InternalTextureSource.Raw);\n    texture.format = format;\n    texture.generateMipMaps = generateMipMaps;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = texture.baseWidth;\n    texture.height = texture.baseHeight;\n    texture._compression = compression;\n    texture.type = type;\n    this.updateRawTexture(texture, data, format, invertY, compression, type);\n\n    if (texture._hardwareTexture) {\n      var webGLTexture = texture._hardwareTexture.underlyingResource;\n\n      var filter = this._getNativeSamplingMode(samplingMode);\n\n      this._setTextureSampling(webGLTexture, filter);\n    }\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n\n  NativeEngine.prototype.createRawTexture2DArray = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    var texture = new InternalTexture(this, InternalTextureSource.Raw2DArray);\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.baseDepth = depth;\n    texture.width = width;\n    texture.height = height;\n    texture.depth = depth;\n    texture.format = format;\n    texture.type = textureType;\n    texture.generateMipMaps = generateMipMaps;\n    texture.samplingMode = samplingMode;\n    texture.is2DArray = true;\n\n    if (texture._hardwareTexture) {\n      var webGLTexture = texture._hardwareTexture.underlyingResource;\n\n      this._engine.loadRawTexture2DArray(webGLTexture, data, width, height, depth, this._getNativeTextureFormat(format, textureType), generateMipMaps, invertY);\n\n      var filter = this._getNativeSamplingMode(samplingMode);\n\n      this._setTextureSampling(webGLTexture, filter);\n    }\n\n    texture.isReady = true;\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n\n  NativeEngine.prototype.updateRawTexture = function (texture, bufferView, format, invertY, compression, type) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (type === void 0) {\n      type = 0;\n    }\n\n    if (!texture) {\n      return;\n    }\n\n    if (bufferView && texture._hardwareTexture) {\n      var underlyingResource = texture._hardwareTexture.underlyingResource;\n\n      this._engine.loadRawTexture(underlyingResource, bufferView, texture.width, texture.height, this._getNativeTextureFormat(format, type), texture.generateMipMaps, texture.invertY);\n    }\n\n    texture.isReady = true;\n  }; // TODO: Refactor to share more logic with babylon.engine.ts version.\n\n  /**\n   * Usually called from Texture.ts.\n   * Passed information to create a WebGLTexture\n   * @param url defines a value which contains one of the following:\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\n   * @param scene needed for loading to the correct scene\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\n   * @param onLoad optional callback to be called upon successful completion\n   * @param onError optional callback to be called upon failure\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\n   * @param forcedExtension defines the extension to use to pick the right loader\n   * @param mimeType defines an optional mime type\n   * @param loaderOptions options to be passed to the loader\n   * @param creationFlags\n   * @param useSRGBBuffer\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\n   */\n\n\n  NativeEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions, creationFlags, useSRGBBuffer) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    if (useSRGBBuffer === void 0) {\n      useSRGBBuffer = false;\n    }\n\n    url = url || \"\";\n    var fromData = url.substr(0, 5) === \"data:\"; //const fromBlob = url.substr(0, 5) === \"blob:\";\n\n    var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    var originalUrl = url;\n\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    } // establish the file extension, if possible\n\n\n    var lastDot = url.lastIndexOf(\".\");\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    var loader = null;\n\n    for (var _i = 0, _a = Engine._TextureLoaders; _i < _a.length; _i++) {\n      var availableLoader = _a[_i];\n\n      if (availableLoader.canLoad(extension)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n\n    if (scene) {\n      scene._addPendingData(texture);\n    }\n\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n    texture._useSRGBBuffer = this._getUseSRGBBuffer(useSRGBBuffer, noMipmap);\n\n    if (!this.doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n\n    var onLoadObserver = null;\n\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n\n    var onInternalError = function onInternalError(message, exception) {\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n\n        if (EngineStore.UseFallbackTexture) {\n          _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\n        }\n\n        if (onError) {\n          onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(\"Failed to load \".concat(url, \", falling back to \").concat(originalUrl));\n\n        _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\n      }\n    }; // processing for non-image formats\n\n\n    if (loader) {\n      throw new Error(\"Loading textures from IInternalTextureLoader not yet implemented.\");\n    } else {\n      var onload_1 = function onload_1(data) {\n        if (!texture._hardwareTexture) {\n          if (scene) {\n            scene._removePendingData(texture);\n          }\n\n          return;\n        }\n\n        var underlyingResource = texture._hardwareTexture.underlyingResource;\n\n        _this._engine.loadTexture(underlyingResource, data, !noMipmap, invertY, useSRGBBuffer, function () {\n          texture.baseWidth = _this._engine.getTextureWidth(underlyingResource);\n          texture.baseHeight = _this._engine.getTextureHeight(underlyingResource);\n          texture.width = texture.baseWidth;\n          texture.height = texture.baseHeight;\n          texture.isReady = true;\n\n          var filter = _this._getNativeSamplingMode(samplingMode);\n\n          _this._setTextureSampling(underlyingResource, filter);\n\n          if (scene) {\n            scene._removePendingData(texture);\n          }\n\n          texture.onLoadedObservable.notifyObservers(texture);\n          texture.onLoadedObservable.clear();\n        }, function () {\n          throw new Error(\"Could not load a native texture.\");\n        });\n      };\n\n      if (fromData && buffer) {\n        if (buffer instanceof ArrayBuffer) {\n          onload_1(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          onload_1(buffer);\n        } else if (typeof buffer === \"string\") {\n          onload_1(new Uint8Array(Tools.DecodeBase64(buffer)));\n        } else {\n          throw new Error(\"Unsupported buffer type\");\n        }\n      } else {\n        if (isBase64) {\n          onload_1(new Uint8Array(Tools.DecodeBase64(url)));\n        } else {\n          this._loadFile(url, function (data) {\n            return onload_1(new Uint8Array(data));\n          }, undefined, undefined, true, function (request, exception) {\n            onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n          });\n        }\n      }\n    }\n\n    return texture;\n  };\n  /**\n   * Wraps an external native texture in a Babylon texture.\n   * @param texture defines the external texture\n   * @returns the babylon internal texture\n   */\n\n\n  NativeEngine.prototype.wrapNativeTexture = function (texture) {\n    // Currently native is using the WebGL wrapper\n    var hardwareTexture = new WebGLHardwareTexture(texture, this._gl);\n    var internalTexture = new InternalTexture(this, InternalTextureSource.Unknown, true);\n    internalTexture._hardwareTexture = hardwareTexture;\n    internalTexture.isReady = true;\n    return internalTexture;\n  };\n  /**\n   * Wraps an external web gl texture in a Babylon texture.\n   * @returns the babylon internal texture\n   */\n\n\n  NativeEngine.prototype.wrapWebGLTexture = function () {\n    throw new Error(\"wrapWebGLTexture is not supported, use wrapNativeTexture instead.\");\n  };\n\n  NativeEngine.prototype._createDepthStencilTexture = function (size, options, rtWrapper) {\n    var nativeRTWrapper = rtWrapper;\n    var texture = new InternalTexture(this, InternalTextureSource.DepthStencil);\n    var width = size.width || size;\n    var height = size.height || size;\n\n    var framebuffer = this._engine.createFrameBuffer(texture._hardwareTexture.underlyingResource, width, height, _native.Engine.TEXTURE_FORMAT_RGBA8, false, true, false);\n\n    nativeRTWrapper._framebufferDepthStencil = framebuffer;\n    return texture;\n  };\n  /**\n   * @param framebuffer\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._releaseFramebufferObjects = function (framebuffer) {\n    if (framebuffer) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(framebuffer);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n    }\n  };\n  /** @hidden */\n\n  /**\n   * Engine abstraction for loading and creating an image bitmap from a given source string.\n   * @param imageSource source to load the image from.\n   * @param options An object that sets options for the image's extraction.\n   * @returns ImageBitmap\n   */\n\n\n  NativeEngine.prototype._createImageBitmapFromSource = function (imageSource, options) {\n    var _this = this;\n\n    var promise = new Promise(function (resolve, reject) {\n      var image = _this.createCanvasImage();\n\n      image.onload = function () {\n        try {\n          var imageBitmap = _this._engine.createImageBitmap(image);\n\n          resolve(imageBitmap);\n        } catch (error) {\n          reject(\"Error loading image \".concat(image.src, \" with exception: \").concat(error));\n        }\n      };\n\n      image.onerror = function (error) {\n        reject(\"Error loading image \".concat(image.src, \" with exception: \").concat(error));\n      };\n\n      image.src = imageSource;\n    });\n    return promise;\n  };\n  /**\n   * Engine abstraction for createImageBitmap\n   * @param image source for image\n   * @param options An object that sets options for the image's extraction.\n   * @returns ImageBitmap\n   */\n\n\n  NativeEngine.prototype.createImageBitmap = function (image, options) {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      if (Array.isArray(image)) {\n        var arr = image;\n\n        if (arr.length) {\n          var image_1 = _this._engine.createImageBitmap(arr[0]);\n\n          if (image_1) {\n            resolve(image_1);\n            return;\n          }\n        }\n      }\n\n      reject(\"Unsupported data for createImageBitmap.\");\n    });\n  };\n  /**\n   * Resize an image and returns the image data as an uint8array\n   * @param image image to resize\n   * @param bufferWidth destination buffer width\n   * @param bufferHeight destination buffer height\n   * @returns an uint8array containing RGBA values of bufferWidth * bufferHeight size\n   */\n\n\n  NativeEngine.prototype.resizeImageBitmap = function (image, bufferWidth, bufferHeight) {\n    return this._engine.resizeImageBitmap(image, bufferWidth, bufferHeight);\n  };\n  /**\n   * Creates a cube texture\n   * @param rootUrl defines the url where the files to load is located\n   * @param scene defines the current scene\n   * @param files defines the list of files to load (1 per face)\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated (false by default)\n   * @param onLoad defines an optional callback raised when the texture is loaded\n   * @param onError defines an optional callback raised if there is an issue to load the texture\n   * @param format defines the format of the data\n   * @param forcedExtension defines the extension to use to pick the right loader\n   * @param createPolynomials if a polynomial sphere should be created for the cube texture\n   * @param lodScale defines the scale applied to environment texture. This manages the range of LOD level used for IBL according to the roughness\n   * @param lodOffset defines the offset applied to environment texture. This manages first LOD level used for IBL according to the roughness\n   * @param fallback defines texture to use while falling back when (compressed) texture file not found.\n   * @param loaderOptions options to be passed to the loader\n   * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\n   * @returns the cube texture as an InternalTexture\n   */\n\n\n  NativeEngine.prototype.createCubeTexture = function (rootUrl, scene, files, noMipmap, onLoad, onError, format, forcedExtension, createPolynomials, lodScale, lodOffset, fallback, loaderOptions, useSRGBBuffer) {\n    var _this = this;\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    if (createPolynomials === void 0) {\n      createPolynomials = false;\n    }\n\n    if (lodScale === void 0) {\n      lodScale = 0;\n    }\n\n    if (lodOffset === void 0) {\n      lodOffset = 0;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (useSRGBBuffer === void 0) {\n      useSRGBBuffer = false;\n    }\n\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Cube);\n    texture.isCube = true;\n    texture.url = rootUrl;\n    texture.generateMipMaps = !noMipmap;\n    texture._lodGenerationScale = lodScale;\n    texture._lodGenerationOffset = lodOffset;\n\n    if (!this._doNotHandleContextLost) {\n      texture._extension = forcedExtension;\n      texture._files = files;\n    }\n\n    var lastDot = rootUrl.lastIndexOf(\".\");\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? rootUrl.substring(lastDot).toLowerCase() : \"\"; // TODO: use texture loader to load env files?\n\n    if (extension === \".env\") {\n      var onloaddata_1 = function onloaddata_1(data) {\n        var info = GetEnvInfo(data);\n        texture.width = info.width;\n        texture.height = info.width;\n        UploadEnvSpherical(texture, info);\n        var specularInfo = info.specular;\n\n        if (!specularInfo) {\n          throw new Error(\"Nothing else parsed so far\");\n        }\n\n        texture._lodGenerationScale = specularInfo.lodGenerationScale;\n        var imageData = CreateImageDataArrayBufferViews(data, info);\n        texture.format = 5;\n        texture.type = 0;\n        texture.generateMipMaps = true;\n        texture.getEngine().updateTextureSamplingMode(Texture.TRILINEAR_SAMPLINGMODE, texture);\n        texture._isRGBD = true;\n        texture.invertY = true;\n\n        _this._engine.loadCubeTextureWithMips(texture._hardwareTexture.underlyingResource, imageData, false, useSRGBBuffer, function () {\n          texture.isReady = true;\n\n          if (onLoad) {\n            onLoad();\n          }\n        }, function () {\n          throw new Error(\"Could not load a native cube texture.\");\n        });\n      };\n\n      if (files && files.length === 6) {\n        throw new Error(\"Multi-file loading not allowed on env files.\");\n      } else {\n        var onInternalError = function onInternalError(request, exception) {\n          if (onError && request) {\n            onError(request.status + \" \" + request.statusText, exception);\n          }\n        };\n\n        this._loadFile(rootUrl, function (data) {\n          return onloaddata_1(new Uint8Array(data));\n        }, undefined, undefined, true, onInternalError);\n      }\n    } else {\n      if (!files || files.length !== 6) {\n        throw new Error(\"Cannot load cubemap because 6 files were not defined\");\n      } // Reorder from [+X, +Y, +Z, -X, -Y, -Z] to [+X, -X, +Y, -Y, +Z, -Z].\n\n\n      var reorderedFiles = [files[0], files[3], files[1], files[4], files[2], files[5]];\n      Promise.all(reorderedFiles.map(function (file) {\n        return Tools.LoadFileAsync(file).then(function (data) {\n          return new Uint8Array(data);\n        });\n      })).then(function (data) {\n        return new Promise(function (resolve, reject) {\n          _this._engine.loadCubeTexture(texture._hardwareTexture.underlyingResource, data, !noMipmap, true, useSRGBBuffer, resolve, reject);\n        });\n      }).then(function () {\n        texture.isReady = true;\n\n        if (onLoad) {\n          onLoad();\n        }\n      }, function (error) {\n        if (onError) {\n          onError(\"Failed to load cubemap: \".concat(error.message), error);\n        }\n      });\n    }\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n  /**\n   * @param isMulti\n   * @param isCube\n   * @param size\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._createHardwareRenderTargetWrapper = function (isMulti, isCube, size) {\n    var rtWrapper = new NativeRenderTargetWrapper(isMulti, isCube, size, this);\n\n    this._renderTargetWrapperCache.push(rtWrapper);\n\n    return rtWrapper;\n  };\n\n  NativeEngine.prototype.createRenderTargetTexture = function (size, options) {\n    var rtWrapper = this._createHardwareRenderTargetWrapper(false, false, size);\n\n    var fullOptions = {};\n\n    if (options !== undefined && _typeof(options) === \"object\") {\n      fullOptions.generateMipMaps = options.generateMipMaps;\n      fullOptions.generateDepthBuffer = options.generateDepthBuffer === undefined ? true : options.generateDepthBuffer;\n      fullOptions.generateStencilBuffer = fullOptions.generateDepthBuffer && options.generateStencilBuffer;\n      fullOptions.type = options.type === undefined ? 0 : options.type;\n      fullOptions.samplingMode = options.samplingMode === undefined ? 3 : options.samplingMode;\n      fullOptions.format = options.format === undefined ? 5 : options.format;\n    } else {\n      fullOptions.generateMipMaps = options;\n      fullOptions.generateDepthBuffer = true;\n      fullOptions.generateStencilBuffer = false;\n      fullOptions.type = 0;\n      fullOptions.samplingMode = 3;\n      fullOptions.format = 5;\n    }\n\n    if (fullOptions.type === 1 && !this._caps.textureFloatLinearFiltering) {\n      // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    } else if (fullOptions.type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\n      // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    }\n\n    var texture = new InternalTexture(this, InternalTextureSource.RenderTarget);\n    var width = size.width || size;\n    var height = size.height || size;\n\n    if (fullOptions.type === 1 && !this._caps.textureFloat) {\n      fullOptions.type = 0;\n      Logger.Warn(\"Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type\");\n    }\n\n    var framebuffer = this._engine.createFrameBuffer(texture._hardwareTexture.underlyingResource, width, height, this._getNativeTextureFormat(fullOptions.format, fullOptions.type), fullOptions.generateStencilBuffer ? true : false, fullOptions.generateDepthBuffer, fullOptions.generateMipMaps ? true : false);\n\n    rtWrapper._framebuffer = framebuffer;\n    rtWrapper._generateDepthBuffer = fullOptions.generateDepthBuffer;\n    rtWrapper._generateStencilBuffer = fullOptions.generateStencilBuffer ? true : false;\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = width;\n    texture.height = height;\n    texture.isReady = true;\n    texture.samples = 1;\n    texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\n    texture.samplingMode = fullOptions.samplingMode;\n    texture.type = fullOptions.type;\n    texture.format = fullOptions.format;\n\n    this._internalTexturesCache.push(texture);\n\n    rtWrapper.setTextures(texture);\n    return rtWrapper;\n  };\n\n  NativeEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture) {\n    if (texture._hardwareTexture) {\n      var filter = this._getNativeSamplingMode(samplingMode);\n\n      this._setTextureSampling(texture._hardwareTexture.underlyingResource, filter);\n    }\n\n    texture.samplingMode = samplingMode;\n  };\n\n  NativeEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport) {\n    var nativeRTWrapper = texture;\n\n    if (faceIndex) {\n      throw new Error(\"Cuboid frame buffers are not yet supported in NativeEngine.\");\n    }\n\n    if (requiredWidth || requiredHeight) {\n      throw new Error(\"Required width/height for frame buffers not yet supported in NativeEngine.\");\n    }\n\n    if (forceFullscreenViewport) {//Not supported yet but don't stop rendering\n    }\n\n    if (nativeRTWrapper._framebufferDepthStencil) {\n      this._bindUnboundFramebuffer(nativeRTWrapper._framebufferDepthStencil);\n    } else {\n      this._bindUnboundFramebuffer(nativeRTWrapper._framebuffer);\n    }\n  };\n\n  NativeEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\n    // NOTE: Disabling mipmap generation is not yet supported in NativeEngine.\n    if (disableGenerateMipMaps === void 0) {\n      disableGenerateMipMaps = false;\n    }\n\n    if (onBeforeUnbind) {\n      onBeforeUnbind();\n    }\n\n    this._bindUnboundFramebuffer(null);\n  };\n\n  NativeEngine.prototype.createDynamicVertexBuffer = function (data) {\n    return this.createVertexBuffer(data, true);\n  };\n\n  NativeEngine.prototype.updateDynamicIndexBuffer = function (indexBuffer, indices, offset) {\n    if (offset === void 0) {\n      offset = 0;\n    }\n\n    var buffer = indexBuffer;\n\n    var data = this._normalizeIndexData(indices);\n\n    buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n\n    this._engine.updateDynamicIndexBuffer(buffer.nativeIndexBuffer, data.buffer, data.byteOffset, data.byteLength, offset);\n  };\n\n  NativeEngine.prototype.updateDynamicVertexBuffer = function (vertexBuffer, verticies, byteOffset, byteLength) {\n    var buffer = vertexBuffer;\n    var data = ArrayBuffer.isView(verticies) ? verticies : new Float32Array(verticies);\n\n    this._engine.updateDynamicVertexBuffer(buffer.nativeVertexBuffer, data.buffer, data.byteOffset + (byteOffset !== null && byteOffset !== void 0 ? byteOffset : 0), byteLength !== null && byteLength !== void 0 ? byteLength : data.byteLength);\n  }; // TODO: Refactor to share more logic with base Engine implementation.\n\n\n  NativeEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\n    if (isPartOfTextureArray === void 0) {\n      isPartOfTextureArray = false;\n    }\n\n    if (depthStencilTexture === void 0) {\n      depthStencilTexture = false;\n    }\n\n    var uniform = this._boundUniforms[channel];\n\n    if (!uniform) {\n      return false;\n    } // Not ready?\n\n\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n\n        this._setTextureCore(uniform, null);\n      }\n\n      return false;\n    } // Video\n\n\n    if (texture.video) {\n      this._activeChannel = channel;\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n\n    var internalTexture;\n\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n\n    this._activeChannel = channel;\n\n    if (!internalTexture || !internalTexture._hardwareTexture) {\n      return false;\n    }\n\n    this._setTextureWrapMode(internalTexture._hardwareTexture.underlyingResource, this._getAddressMode(texture.wrapU), this._getAddressMode(texture.wrapV), this._getAddressMode(texture.wrapR));\n\n    this._updateAnisotropicLevel(texture);\n\n    this._setTextureCore(uniform, internalTexture._hardwareTexture.underlyingResource);\n\n    return true;\n  }; // filter is a NativeFilter.XXXX value.\n\n\n  NativeEngine.prototype._setTextureSampling = function (texture, filter) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(texture);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(filter);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  }; // addressModes are NativeAddressMode.XXXX values.\n\n\n  NativeEngine.prototype._setTextureWrapMode = function (texture, addressModeU, addressModeV, addressModeW) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(texture);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeU);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeV);\n\n    this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeW);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  };\n\n  NativeEngine.prototype._setTextureCore = function (uniform, texture) {\n    this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform);\n\n    this._commandBufferEncoder.encodeCommandArgAsNativeData(texture);\n\n    this._commandBufferEncoder.finishEncodingCommand();\n  }; // TODO: Share more of this logic with the base implementation.\n  // TODO: Rename to match naming in base implementation once refactoring allows different parameters.\n\n\n  NativeEngine.prototype._updateAnisotropicLevel = function (texture) {\n    var internalTexture = texture.getInternalTexture();\n    var value = texture.anisotropicFilteringLevel;\n\n    if (!internalTexture || !internalTexture._hardwareTexture) {\n      return;\n    }\n\n    if (internalTexture._cachedAnisotropicFilteringLevel !== value) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(internalTexture._hardwareTexture.underlyingResource);\n\n      this._commandBufferEncoder.encodeCommandArgAsUInt32(value);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n\n      internalTexture._cachedAnisotropicFilteringLevel = value;\n    }\n  }; // Returns a NativeAddressMode.XXX value.\n\n\n  NativeEngine.prototype._getAddressMode = function (wrapMode) {\n    switch (wrapMode) {\n      case 1:\n        return _native.Engine.ADDRESS_MODE_WRAP;\n\n      case 0:\n        return _native.Engine.ADDRESS_MODE_CLAMP;\n\n      case 2:\n        return _native.Engine.ADDRESS_MODE_MIRROR;\n\n      default:\n        throw new Error(\"Unexpected wrap mode: \" + wrapMode + \".\");\n    }\n  };\n  /**\n   * @param channel\n   * @param texture\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._bindTexture = function (channel, texture) {\n    var uniform = this._boundUniforms[channel];\n\n    if (!uniform) {\n      return;\n    }\n\n    if (texture && texture._hardwareTexture) {\n      var underlyingResource = texture._hardwareTexture.underlyingResource;\n\n      this._setTextureCore(uniform, underlyingResource);\n    }\n  };\n\n  NativeEngine.prototype._deleteBuffer = function (buffer) {\n    if (buffer.nativeIndexBuffer) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(buffer.nativeIndexBuffer);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n\n      delete buffer.nativeIndexBuffer;\n    }\n\n    if (buffer.nativeVertexBuffer) {\n      this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER);\n\n      this._commandBufferEncoder.encodeCommandArgAsNativeData(buffer.nativeVertexBuffer);\n\n      this._commandBufferEncoder.finishEncodingCommand();\n\n      delete buffer.nativeVertexBuffer;\n    }\n  };\n  /**\n   * Create a canvas\n   * @param width width\n   * @param height height\n   * @return ICanvas interface\n   */\n\n\n  NativeEngine.prototype.createCanvas = function (width, height) {\n    if (!_native.Canvas) {\n      throw new Error(\"Native Canvas plugin not available.\");\n    }\n\n    var canvas = new _native.Canvas();\n    canvas.width = width;\n    canvas.height = height;\n    return canvas;\n  };\n  /**\n   * Create an image to use with canvas\n   * @return IImage interface\n   */\n\n\n  NativeEngine.prototype.createCanvasImage = function () {\n    if (!_native.Canvas) {\n      throw new Error(\"Native Canvas plugin not available.\");\n    }\n\n    var image = new _native.Image();\n    return image;\n  };\n  /**\n   * Update a portion of an internal texture\n   * @param texture defines the texture to update\n   * @param imageData defines the data to store into the texture\n   * @param xOffset defines the x coordinates of the update rectangle\n   * @param yOffset defines the y coordinates of the update rectangle\n   * @param width defines the width of the update rectangle\n   * @param height defines the height of the update rectangle\n   * @param faceIndex defines the face index if texture is a cube (0 by default)\n   * @param lod defines the lod level to update (0 by default)\n   * @param generateMipMaps defines whether to generate mipmaps or not\n   */\n\n\n  NativeEngine.prototype.updateTextureData = function (texture, imageData, xOffset, yOffset, width, height, faceIndex, lod, generateMipMaps) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    if (generateMipMaps === void 0) {\n      generateMipMaps = false;\n    }\n\n    throw new Error(\"updateTextureData not implemented.\");\n  };\n  /**\n   * @param texture\n   * @param internalFormat\n   * @param width\n   * @param height\n   * @param data\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadCompressedDataToTextureDirectly not implemented.\");\n  };\n  /**\n   * @param texture\n   * @param imageData\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadDataToTextureDirectly not implemented.\");\n  };\n  /**\n   * @param texture\n   * @param imageData\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\n  };\n  /**\n   * @param texture\n   * @param image\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  NativeEngine.prototype._uploadImageToTexture = function (texture, image, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\n  }; // JavaScript-to-Native conversion helper functions.\n\n\n  NativeEngine.prototype._getNativeSamplingMode = function (samplingMode) {\n    switch (samplingMode) {\n      case 1:\n        return _native.Engine.TEXTURE_NEAREST_NEAREST;\n\n      case 2:\n        return _native.Engine.TEXTURE_LINEAR_LINEAR;\n\n      case 3:\n        return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;\n\n      case 4:\n        return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;\n\n      case 5:\n        return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;\n\n      case 6:\n        return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;\n\n      case 7:\n        return _native.Engine.TEXTURE_NEAREST_LINEAR;\n\n      case 8:\n        return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;\n\n      case 9:\n        return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;\n\n      case 10:\n        return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;\n\n      case 11:\n        return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;\n\n      case 12:\n        return _native.Engine.TEXTURE_LINEAR_NEAREST;\n\n      default:\n        throw new Error(\"Unsupported sampling mode: \".concat(samplingMode, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getStencilFunc = function (func) {\n    switch (func) {\n      case 513:\n        return _native.Engine.STENCIL_TEST_LESS;\n\n      case 515:\n        return _native.Engine.STENCIL_TEST_LEQUAL;\n\n      case 514:\n        return _native.Engine.STENCIL_TEST_EQUAL;\n\n      case 518:\n        return _native.Engine.STENCIL_TEST_GEQUAL;\n\n      case 516:\n        return _native.Engine.STENCIL_TEST_GREATER;\n\n      case 517:\n        return _native.Engine.STENCIL_TEST_NOTEQUAL;\n\n      case 512:\n        return _native.Engine.STENCIL_TEST_NEVER;\n\n      case 519:\n        return _native.Engine.STENCIL_TEST_ALWAYS;\n\n      default:\n        throw new Error(\"Unsupported stencil func mode: \".concat(func, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getStencilOpFail = function (opFail) {\n    switch (opFail) {\n      case 7680:\n        return _native.Engine.STENCIL_OP_FAIL_S_KEEP;\n\n      case 0:\n        return _native.Engine.STENCIL_OP_FAIL_S_ZERO;\n\n      case 7681:\n        return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;\n\n      case 7682:\n        return _native.Engine.STENCIL_OP_FAIL_S_INCR;\n\n      case 7683:\n        return _native.Engine.STENCIL_OP_FAIL_S_DECR;\n\n      case 5386:\n        return _native.Engine.STENCIL_OP_FAIL_S_INVERT;\n\n      case 34055:\n        return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;\n\n      case 34056:\n        return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;\n\n      default:\n        throw new Error(\"Unsupported stencil OpFail mode: \".concat(opFail, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getStencilDepthFail = function (depthFail) {\n    switch (depthFail) {\n      case 7680:\n        return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;\n\n      case 0:\n        return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;\n\n      case 7681:\n        return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;\n\n      case 7682:\n        return _native.Engine.STENCIL_OP_FAIL_Z_INCR;\n\n      case 7683:\n        return _native.Engine.STENCIL_OP_FAIL_Z_DECR;\n\n      case 5386:\n        return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;\n\n      case 34055:\n        return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;\n\n      case 34056:\n        return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;\n\n      default:\n        throw new Error(\"Unsupported stencil depthFail mode: \".concat(depthFail, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getStencilDepthPass = function (opPass) {\n    switch (opPass) {\n      case 7680:\n        return _native.Engine.STENCIL_OP_PASS_Z_KEEP;\n\n      case 0:\n        return _native.Engine.STENCIL_OP_PASS_Z_ZERO;\n\n      case 7681:\n        return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;\n\n      case 7682:\n        return _native.Engine.STENCIL_OP_PASS_Z_INCR;\n\n      case 7683:\n        return _native.Engine.STENCIL_OP_PASS_Z_DECR;\n\n      case 5386:\n        return _native.Engine.STENCIL_OP_PASS_Z_INVERT;\n\n      case 34055:\n        return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;\n\n      case 34056:\n        return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;\n\n      default:\n        throw new Error(\"Unsupported stencil opPass mode: \".concat(opPass, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getNativeTextureFormat = function (format, type) {\n    if (format == 4 && type == 0) {\n      return _native.Engine.TEXTURE_FORMAT_RGB8;\n    } else if (format == 5 && type == 0) {\n      return _native.Engine.TEXTURE_FORMAT_RGBA8;\n    } else if (format == 5 && type == 1) {\n      return _native.Engine.TEXTURE_FORMAT_RGBA32F;\n    } else {\n      throw new RuntimeError(\"Unsupported texture format or type: format \".concat(format, \", type \").concat(type, \".\"), ErrorCodes.UnsupportedTextureError);\n    }\n  };\n\n  NativeEngine.prototype._getNativeAlphaMode = function (mode) {\n    switch (mode) {\n      case 0:\n        return _native.Engine.ALPHA_DISABLE;\n\n      case 1:\n        return _native.Engine.ALPHA_ADD;\n\n      case 2:\n        return _native.Engine.ALPHA_COMBINE;\n\n      case 3:\n        return _native.Engine.ALPHA_SUBTRACT;\n\n      case 4:\n        return _native.Engine.ALPHA_MULTIPLY;\n\n      case 5:\n        return _native.Engine.ALPHA_MAXIMIZED;\n\n      case 6:\n        return _native.Engine.ALPHA_ONEONE;\n\n      case 7:\n        return _native.Engine.ALPHA_PREMULTIPLIED;\n\n      case 8:\n        return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;\n\n      case 9:\n        return _native.Engine.ALPHA_INTERPOLATE;\n\n      case 10:\n        return _native.Engine.ALPHA_SCREENMODE;\n\n      default:\n        throw new Error(\"Unsupported alpha mode: \".concat(mode, \".\"));\n    }\n  };\n\n  NativeEngine.prototype._getNativeAttribType = function (type) {\n    switch (type) {\n      case VertexBuffer.BYTE:\n        return _native.Engine.ATTRIB_TYPE_INT8;\n\n      case VertexBuffer.UNSIGNED_BYTE:\n        return _native.Engine.ATTRIB_TYPE_UINT8;\n\n      case VertexBuffer.SHORT:\n        return _native.Engine.ATTRIB_TYPE_INT16;\n\n      case VertexBuffer.UNSIGNED_SHORT:\n        return _native.Engine.ATTRIB_TYPE_UINT16;\n\n      case VertexBuffer.FLOAT:\n        return _native.Engine.ATTRIB_TYPE_FLOAT;\n\n      default:\n        throw new Error(\"Unsupported attribute type: \".concat(type, \".\"));\n    }\n  };\n\n  NativeEngine.prototype.getFontOffset = function (font) {\n    // TODO\n    var result = {\n      ascent: 0,\n      height: 0,\n      descent: 0\n    };\n    return result;\n  }; // This must match the protocol version in NativeEngine.cpp\n\n\n  NativeEngine.PROTOCOL_VERSION = 5;\n  return NativeEngine;\n}(Engine);\n\nexport { NativeEngine };","map":{"version":3,"mappings":"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","names":["Engine","VertexBuffer","InternalTexture","InternalTextureSource","Texture","DataBuffer","Tools","Observable","CreateImageDataArrayBufferViews","GetEnvInfo","UploadEnvSpherical","Logger","ThinEngine","EngineStore","ShaderCodeInliner","WebGL2ShaderProcessor","RenderTargetWrapper","NativeDataStream","RuntimeError","ErrorCodes","WebGLHardwareTexture","onNativeObjectInitialized","self","Object","prototype","hasOwnProperty","call","__native_1","defineProperty","get","set","value","notifyObservers","AcquireNativeObjectAsync","Promise","resolve","_native","addOnce","nativeObject","RegisterNativeTypeAsync","typeName","constructor","_a","engine","NativePipelineContext","onCompiled","Error","effect","uniformBuffersNames","uniformsNames","uniforms","samplerList","samplers","attributesNames","attributes","supportsUniformBuffers","name_1","bindUniformBlock","effectAvailableUniforms","getUniforms","forEach","uniform","index","_uniforms","length","sampler","getUniform","splice","name","push","apply","getAttributes","uniformName","matrix","cache","_valueCache","flag","updateFlag","undefined","x","y","changed","z","w","setInt","_cacheFloat2","setInt2","_cacheFloat3","setInt3","_cacheFloat4","setInt4","array","setIntArray","setIntArray2","setIntArray3","setIntArray4","setFloatArray","setFloatArray2","setFloatArray3","setFloatArray4","setArray","setArray2","setArray3","setArray4","matrices","setMatrices","_cacheMatrix","toArray","setMatrix3x3","setMatrix2x2","setFloat","bool","vector2","setFloat2","vector3","setFloat3","vector4","setFloat4","color3","r","g","b","alpha","color4","a","__extends","isMulti","isCube","size","_super","_this","_engine","NativeRenderTargetWrapper","__framebuffer","framebuffer","_releaseFramebufferObjects","__framebufferDepthStencil","framebufferDepthStencil","disposeOnlyFramebuffers","_framebuffer","_framebufferDepthStencil","dispose","Array","_commandStream","NativeEngine","_createNativeDataStream","setCommandDataStream","CommandBufferEncoder","_isCommandBufferScopeActive","_submit","command","writeNativeData","commandArg","writeUint32","writeUint32Array","writeInt32","writeInt32Array","writeFloat32","writeFloat32Array","_pending","submitCommands","options","adaptToDeviceRatio","Camera","DEPTH_TEST_LEQUAL","PROTOCOL_VERSION","concat","_webGLVersion","disableUniformBuffers","_caps","maxTexturesImageUnits","maxVertexTextureImageUnits","maxCombinedTexturesImageUnits","maxTextureSize","maxCubemapTextureSize","maxRenderTextureSize","maxVertexAttribs","maxVaryingVectors","maxFragmentUniformVectors","maxVertexUniformVectors","standardDerivatives","astc","pvrtc","etc1","etc2","bptc","maxAnisotropy","uintIndices","fragmentDepthSupported","highPrecisionShaderSupported","colorBufferFloat","textureFloat","textureFloatLinearFiltering","textureFloatRender","textureHalfFloat","textureHalfFloatLinearFiltering","textureHalfFloatRender","textureLOD","drawBuffersExtension","depthTextureExtension","vertexArrayObject","instancedArrays","supportOcclusionQuery","canUseTimestampForTimerQuery","blendMinMax","maxMSAASamples","canUseGLInstanceID","canUseGLVertexID","supportComputeShaders","supportSRGBBuffers","supportTransformFeedbacks","textureMaxLevel","_features","forceBitmapOverHTMLImageElement","supportRenderAndCopyToLodForFloatTextures","supportDepthStencilTexture","supportShadowSamplers","uniformBufferHardCheckMatrix","allowTexturePrefiltering","trackUbosInFrame","checkUbosContentBeforeUpload","supportCSM","basisNeedsPOT","support3DTextures","needTypeSuffixInShaderConstants","supportMSAA","supportSSAO2","supportExtendedTextureFormats","supportSwitchCaseInShader","supportSyncTextureRead","needsInvertingBitmap","useUBOBindingCache","needShaderCodeInlining","needToAlwaysBindUniformBuffers","supportRenderPasses","_collectUbosUpdatedInFrame","Log","Version","LoadScript","scriptUrl","onSuccess","onError","scriptId","LoadFile","data","Function","request","exception","URL","window","createObjectURL","revokeObjectURL","Blob","v","devicePixelRatio","_hardwareScalingLevel","resize","currentDepthFunction","getDepthFunction","setDepthFunction","_shaderProcessor","onNewSceneAddedObservable","add","scene","originalRender","render","args","_commandBufferEncoder","beginCommandScope","endCommandScope","getHardwareScalingLevel","level","setHardwareScalingLevel","_boundBuffersVertexArray","_deleteVertexArray","bindedRenderFunction","requester","requestAnimationFrame","_currentFramebuffer","startEncodingCommand","COMMAND_UNBINDFRAMEBUFFER","encodeCommandArgAsNativeData","finishEncodingCommand","COMMAND_BINDFRAMEBUFFER","color","backBuffer","depth","stencil","useReverseDepthBuffer","COMMAND_CLEAR","encodeCommandArgAsUInt32","encodeCommandArgAsFloat32","indices","updateable","_normalizeIndexData","buffer","NativeDataBuffer","references","is32Bits","BYTES_PER_ELEMENT","byteLength","nativeIndexBuffer","createIndexBuffer","byteOffset","vertices","ArrayBuffer","isView","Float32Array","nativeVertexBuffer","createVertexBuffer","vertexArray","vertexBuffers","indexBuffer","recordIndexBuffer","getAttributesNames","location_1","getAttributeLocation","kind","vertexBuffer","getBuffer","recordVertexBuffer","byteStride","getSize","_getNativeAttribType","type","normalized","getInstanceDivisor","createVertexArray","_recordVertexArrayObject","bindVertexArrayObject","COMMAND_DELETEVERTEXARRAY","COMMAND_BINDVERTEXARRAY","pipelineContext","nativePipelineContext","nativeProgram","fillMode","indexStart","indexCount","instancesCount","_drawCalls","addCount","COMMAND_DRAWINDEXED","verticesStart","verticesCount","COMMAND_DRAW","vertexSourceCode","fragmentSourceCode","createAsRaw","rawVertexSourceCode","rawFragmentSourceCode","rebuildRebind","defines","transformFeedbackVaryings","createRawShaderProgram","createShaderProgram","action","vertexCode","fragmentCode","context","onBeforeShaderCompilationObservable","vertexInliner","processCode","code","fragmentInliner","_ConcatenateShader","program","createProgram","onAfterShaderCompilationObservable","sci","debug","_currentProgram","COMMAND_SETPROGRAM","COMMAND_DELETEPROGRAM","blockName","getPipelineContext","_setProgram","getSamplers","_boundUniforms","_currentEffect","matrixArray","COMMAND_SETMATRIX","encodeCommandArgAsFloat32s","useScreen","_currentRenderTarget","width","getRenderWidth","height","getRenderHeight","viewport","requiredWidth","requiredHeight","_cachedViewport","setViewPort","culling","zOffset","force","reverseSide","cullBackFaces","zOffsetUnits","_zOffset","_zOffsetUnits","COMMAND_SETSTATE","_b","rect","bottom","left","right","top","toJSON","COMMAND_SETZOFFSET","COMMAND_SETZOFFSETUNITS","enable","COMMAND_SETDEPTHTEST","_currentDepthTest","DEPTH_TEST_ALWAYS","_depthWrite","DEPTH_TEST_NEVER","DEPTH_TEST_GREATER","DEPTH_TEST_GEQUAL","DEPTH_TEST_NOTEQUAL","DEPTH_TEST_EQUAL","DEPTH_TEST_LESS","depthFunc","nativeDepthFunc","COMMAND_SETDEPTHWRITE","Number","_colorWrite","COMMAND_SETCOLORWRITE","_setStencil","_stencilMask","_getStencilOpFail","_stencilOpStencilFail","_getStencilDepthFail","_stencilOpDepthFail","_getStencilDepthPass","_stencilOpStencilDepthPass","_getStencilFunc","_stencilFunc","_stencilFuncRef","mask","stencilOpFail","depthOpFail","depthOpPass","func","ref","COMMAND_SETSTENCIL","_stencilTest","applyStencil","STENCIL_OP_FAIL_S_KEEP","STENCIL_OP_FAIL_Z_KEEP","STENCIL_OP_PASS_Z_KEEP","STENCIL_TEST_ALWAYS","operation","stencilFunc","reference","_stencilFuncMask","mode","noDepthWriteChange","_alphaMode","nativeMode","_getNativeAlphaMode","COMMAND_SETBLENDMODE","setDepthWrite","int","COMMAND_SETINT","encodeCommandArgAsInt32","COMMAND_SETINTARRAY","encodeCommandArgAsInt32s","COMMAND_SETINTARRAY2","COMMAND_SETINTARRAY3","COMMAND_SETINTARRAY4","COMMAND_SETFLOATARRAY","COMMAND_SETFLOATARRAY2","COMMAND_SETFLOATARRAY3","COMMAND_SETFLOATARRAY4","COMMAND_SETMATRICES","COMMAND_SETMATRIX3X3","COMMAND_SETMATRIX2X2","COMMAND_SETFLOAT","COMMAND_SETFLOAT2","COMMAND_SETFLOAT3","COMMAND_SETFLOAT4","bruteForce","preventCacheWipeBetweenFrames","resetTextureCache","_stencilStateComposer","reset","_depthCullingState","_alphaState","_cachedVertexBuffers","_cachedIndexBuffer","_cachedEffectForVertexBuffers","createTexture","texture","deleteTexture","canvas","invertY","premulAlpha","format","_hardwareTexture","source","getCanvasTexture","destination","underlyingResource","copyTexture","isReady","generateMipMaps","samplingMode","Math","max","createRawTexture","Uint8Array","constraints","_camera","createVideo","video","webGLTexture","updateVideoTexture","compression","Raw","baseWidth","baseHeight","_compression","updateRawTexture","filter","_getNativeSamplingMode","_setTextureSampling","_internalTexturesCache","textureType","Raw2DArray","baseDepth","is2DArray","loadRawTexture2DArray","_getNativeTextureFormat","bufferView","loadRawTexture","url","noMipmap","onLoad","fallback","forcedExtension","mimeType","loaderOptions","creationFlags","useSRGBBuffer","fromData","substr","isBase64","indexOf","Url","originalUrl","_transformTextureUrl","lastDot","lastIndexOf","extension","substring","toLowerCase","loader","_TextureLoaders","_i","availableLoader","canLoad","_addPendingData","_useSRGBBuffer","_getUseSRGBBuffer","doNotHandleContextLost","_buffer","onLoadObserver","onLoadedObservable","onInternalError","message","_removePendingData","remove","UseFallbackTexture","FallbackTexture","Warn","onload_1","loadTexture","getTextureWidth","getTextureHeight","clear","DecodeBase64","_loadFile","responseURL","hardwareTexture","_gl","internalTexture","Unknown","rtWrapper","nativeRTWrapper","DepthStencil","createFrameBuffer","TEXTURE_FORMAT_RGBA8","COMMAND_DELETEFRAMEBUFFER","imageSource","promise","reject","image","createCanvasImage","onload","imageBitmap","createImageBitmap","error","src","onerror","isArray","arr","image_1","bufferWidth","bufferHeight","resizeImageBitmap","rootUrl","files","createPolynomials","lodScale","lodOffset","Cube","_lodGenerationScale","_lodGenerationOffset","_doNotHandleContextLost","_extension","_files","onloaddata_1","info","specularInfo","specular","lodGenerationScale","imageData","getEngine","updateTextureSamplingMode","TRILINEAR_SAMPLINGMODE","_isRGBD","loadCubeTextureWithMips","status","statusText","reorderedFiles","all","map","file","LoadFileAsync","then","loadCubeTexture","_renderTargetWrapperCache","_createHardwareRenderTargetWrapper","fullOptions","generateDepthBuffer","generateStencilBuffer","RenderTarget","_generateDepthBuffer","_generateStencilBuffer","samples","setTextures","faceIndex","forceFullscreenViewport","_bindUnboundFramebuffer","disableGenerateMipMaps","onBeforeUnbind","offset","updateDynamicIndexBuffer","verticies","updateDynamicVertexBuffer","channel","isPartOfTextureArray","depthStencilTexture","_boundTexturesCache","_activeChannel","_setTextureCore","update","delayLoadState","delayLoad","getInternalTexture","emptyCubeTexture","is3D","emptyTexture3D","emptyTexture2DArray","emptyTexture","_setTextureWrapMode","_getAddressMode","wrapU","wrapV","wrapR","_updateAnisotropicLevel","COMMAND_SETTEXTURESAMPLING","addressModeU","addressModeV","addressModeW","COMMAND_SETTEXTUREWRAPMODE","COMMAND_SETTEXTURE","anisotropicFilteringLevel","_cachedAnisotropicFilteringLevel","COMMAND_SETTEXTUREANISOTROPICLEVEL","wrapMode","ADDRESS_MODE_WRAP","ADDRESS_MODE_CLAMP","ADDRESS_MODE_MIRROR","COMMAND_DELETEINDEXBUFFER","COMMAND_DELETEVERTEXBUFFER","Canvas","Image","xOffset","yOffset","lod","internalFormat","TEXTURE_NEAREST_NEAREST","TEXTURE_LINEAR_LINEAR","TEXTURE_LINEAR_LINEAR_MIPLINEAR","TEXTURE_NEAREST_NEAREST_MIPNEAREST","TEXTURE_NEAREST_LINEAR_MIPNEAREST","TEXTURE_NEAREST_LINEAR_MIPLINEAR","TEXTURE_NEAREST_LINEAR","TEXTURE_NEAREST_NEAREST_MIPLINEAR","TEXTURE_LINEAR_NEAREST_MIPNEAREST","TEXTURE_LINEAR_NEAREST_MIPLINEAR","TEXTURE_LINEAR_LINEAR_MIPNEAREST","TEXTURE_LINEAR_NEAREST","STENCIL_TEST_LESS","STENCIL_TEST_LEQUAL","STENCIL_TEST_EQUAL","STENCIL_TEST_GEQUAL","STENCIL_TEST_GREATER","STENCIL_TEST_NOTEQUAL","STENCIL_TEST_NEVER","opFail","STENCIL_OP_FAIL_S_ZERO","STENCIL_OP_FAIL_S_REPLACE","STENCIL_OP_FAIL_S_INCR","STENCIL_OP_FAIL_S_DECR","STENCIL_OP_FAIL_S_INVERT","STENCIL_OP_FAIL_S_INCRSAT","STENCIL_OP_FAIL_S_DECRSAT","depthFail","STENCIL_OP_FAIL_Z_ZERO","STENCIL_OP_FAIL_Z_REPLACE","STENCIL_OP_FAIL_Z_INCR","STENCIL_OP_FAIL_Z_DECR","STENCIL_OP_FAIL_Z_INVERT","STENCIL_OP_FAIL_Z_INCRSAT","STENCIL_OP_FAIL_Z_DECRSAT","opPass","STENCIL_OP_PASS_Z_ZERO","STENCIL_OP_PASS_Z_REPLACE","STENCIL_OP_PASS_Z_INCR","STENCIL_OP_PASS_Z_DECR","STENCIL_OP_PASS_Z_INVERT","STENCIL_OP_PASS_Z_INCRSAT","STENCIL_OP_PASS_Z_DECRSAT","TEXTURE_FORMAT_RGB8","TEXTURE_FORMAT_RGBA32F","UnsupportedTextureError","ALPHA_DISABLE","ALPHA_ADD","ALPHA_COMBINE","ALPHA_SUBTRACT","ALPHA_MULTIPLY","ALPHA_MAXIMIZED","ALPHA_ONEONE","ALPHA_PREMULTIPLIED","ALPHA_PREMULTIPLIED_PORTERDUFF","ALPHA_INTERPOLATE","ALPHA_SCREENMODE","BYTE","ATTRIB_TYPE_INT8","UNSIGNED_BYTE","ATTRIB_TYPE_UINT8","SHORT","ATTRIB_TYPE_INT16","UNSIGNED_SHORT","ATTRIB_TYPE_UINT16","FLOAT","ATTRIB_TYPE_FLOAT","font","result","ascent","descent"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Engines/nativeEngine.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\n/* eslint-disable @typescript-eslint/naming-convention */\r\nimport type { Nullable, IndicesArray, DataArray } from \"../types\";\r\nimport { Engine } from \"../Engines/engine\";\r\nimport { VertexBuffer } from \"../Buffers/buffer\";\r\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture\";\r\nimport type { IInternalTextureLoader } from \"../Materials/Textures/internalTextureLoader\";\r\nimport { Texture } from \"../Materials/Textures/texture\";\r\nimport type { BaseTexture } from \"../Materials/Textures/baseTexture\";\r\nimport type { VideoTexture } from \"../Materials/Textures/videoTexture\";\r\nimport type { RenderTargetTexture } from \"../Materials/Textures/renderTargetTexture\";\r\nimport type { Effect } from \"../Materials/effect\";\r\nimport { DataBuffer } from \"../Buffers/dataBuffer\";\r\nimport { Tools } from \"../Misc/tools\";\r\nimport type { Observer } from \"../Misc/observable\";\r\nimport { Observable } from \"../Misc/observable\";\r\nimport type { EnvironmentTextureSpecularInfoV1 } from \"../Misc/environmentTextureTools\";\r\nimport { CreateImageDataArrayBufferViews, GetEnvInfo, UploadEnvSpherical } from \"../Misc/environmentTextureTools\";\r\nimport type { Scene } from \"../scene\";\r\nimport type { RenderTargetCreationOptions, TextureSize, DepthTextureCreationOptions } from \"../Materials/Textures/textureCreationOptions\";\r\nimport type { IPipelineContext } from \"./IPipelineContext\";\r\nimport type { IMatrixLike, IVector2Like, IVector3Like, IVector4Like, IColor3Like, IColor4Like, IViewportLike } from \"../Maths/math.like\";\r\nimport { Logger } from \"../Misc/logger\";\r\nimport { Constants } from \"./constants\";\r\nimport type { ISceneLike } from \"./thinEngine\";\r\nimport { ThinEngine } from \"./thinEngine\";\r\nimport type { IWebRequest } from \"../Misc/interfaces/iWebRequest\";\r\nimport { EngineStore } from \"./engineStore\";\r\nimport { ShaderCodeInliner } from \"./Processors/shaderCodeInliner\";\r\nimport { WebGL2ShaderProcessor } from \"../Engines/WebGL/webGL2ShaderProcessors\";\r\nimport type { IMaterialContext } from \"./IMaterialContext\";\r\nimport type { IDrawContext } from \"./IDrawContext\";\r\nimport type { ICanvas, IImage } from \"./ICanvas\";\r\nimport type { IStencilState } from \"../States/IStencilState\";\r\nimport { RenderTargetWrapper } from \"./renderTargetWrapper\";\r\nimport type { NativeData } from \"./Native/nativeDataStream\";\r\nimport { NativeDataStream } from \"./Native/nativeDataStream\";\r\nimport type { INative, INativeCamera, INativeEngine } from \"./Native/nativeInterfaces\";\r\nimport { RuntimeError, ErrorCodes } from \"../Misc/error\";\r\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture\";\r\n\r\ndeclare const _native: INative;\r\n\r\nconst onNativeObjectInitialized = new Observable<INative>();\r\nif (typeof self !== \"undefined\" && !Object.prototype.hasOwnProperty.call(self, \"_native\")) {\r\n    let __native: INative;\r\n    Object.defineProperty(self, \"_native\", {\r\n        get: () => __native,\r\n        set: (value: INative) => {\r\n            __native = value;\r\n            if (__native) {\r\n                onNativeObjectInitialized.notifyObservers(__native);\r\n            }\r\n        },\r\n    });\r\n}\r\n\r\n/**\r\n * Returns _native only after it has been defined by BabylonNative.\r\n * @hidden\r\n */\r\nexport function AcquireNativeObjectAsync(): Promise<INative> {\r\n    return new Promise((resolve) => {\r\n        if (typeof _native === \"undefined\") {\r\n            onNativeObjectInitialized.addOnce((nativeObject) => resolve(nativeObject));\r\n        } else {\r\n            resolve(_native);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Registers a constructor on the _native object. See NativeXRFrame for an example.\r\n * @param typeName\r\n * @param constructor\r\n * @hidden\r\n */\r\nexport async function RegisterNativeTypeAsync<Type>(typeName: string, constructor: Type) {\r\n    ((await AcquireNativeObjectAsync()) as any)[typeName] = constructor;\r\n}\r\n\r\nclass NativePipelineContext implements IPipelineContext {\r\n    // TODO: async should be true?\r\n    public isAsync = false;\r\n    public isReady = false;\r\n\r\n    public _getVertexShaderCode(): string | null {\r\n        return null;\r\n    }\r\n\r\n    public _getFragmentShaderCode(): string | null {\r\n        return null;\r\n    }\r\n\r\n    // TODO: what should this do?\r\n    public _handlesSpectorRebuildCallback(onCompiled: (compiledObject: any) => void): void {\r\n        throw new Error(\"Not implemented\");\r\n    }\r\n\r\n    public nativeProgram: any;\r\n\r\n    private _valueCache: { [key: string]: any } = {};\r\n    private _uniforms: { [key: string]: Nullable<WebGLUniformLocation> };\r\n\r\n    public engine: NativeEngine;\r\n    public context?: WebGLRenderingContext;\r\n    public vertexShader?: WebGLShader;\r\n    public fragmentShader?: WebGLShader;\r\n    public isParallelCompiled: boolean;\r\n    public onCompiled?: () => void;\r\n    public transformFeedback?: WebGLTransformFeedback | null;\r\n\r\n    constructor(engine: NativeEngine) {\r\n        this.engine = engine;\r\n    }\r\n\r\n    public _fillEffectInformation(\r\n        effect: Effect,\r\n        uniformBuffersNames: { [key: string]: number },\r\n        uniformsNames: string[],\r\n        uniforms: { [key: string]: Nullable<WebGLUniformLocation> },\r\n        samplerList: string[],\r\n        samplers: { [key: string]: number },\r\n        attributesNames: string[],\r\n        attributes: number[]\r\n    ) {\r\n        const engine = this.engine;\r\n        if (engine.supportsUniformBuffers) {\r\n            for (const name in uniformBuffersNames) {\r\n                effect.bindUniformBlock(name, uniformBuffersNames[name]);\r\n            }\r\n        }\r\n\r\n        const effectAvailableUniforms = this.engine.getUniforms(this, uniformsNames);\r\n        effectAvailableUniforms.forEach((uniform, index) => {\r\n            uniforms[uniformsNames[index]] = uniform;\r\n        });\r\n        this._uniforms = uniforms;\r\n\r\n        let index: number;\r\n        for (index = 0; index < samplerList.length; index++) {\r\n            const sampler = effect.getUniform(samplerList[index]);\r\n            if (sampler == null) {\r\n                samplerList.splice(index, 1);\r\n                index--;\r\n            }\r\n        }\r\n\r\n        samplerList.forEach((name, index) => {\r\n            samplers[name] = index;\r\n        });\r\n\r\n        attributes.push(...engine.getAttributes(this, attributesNames));\r\n    }\r\n\r\n    /**\r\n     * Release all associated resources.\r\n     **/\r\n    public dispose() {\r\n        this._uniforms = {};\r\n    }\r\n\r\n    /**\r\n     * @param uniformName\r\n     * @param matrix\r\n     * @hidden\r\n     */\r\n    public _cacheMatrix(uniformName: string, matrix: IMatrixLike): boolean {\r\n        const cache = this._valueCache[uniformName];\r\n        const flag = matrix.updateFlag;\r\n        if (cache !== undefined && cache === flag) {\r\n            return false;\r\n        }\r\n\r\n        this._valueCache[uniformName] = flag;\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * @param uniformName\r\n     * @param x\r\n     * @param y\r\n     * @hidden\r\n     */\r\n    public _cacheFloat2(uniformName: string, x: number, y: number): boolean {\r\n        let cache = this._valueCache[uniformName];\r\n        if (!cache) {\r\n            cache = [x, y];\r\n            this._valueCache[uniformName] = cache;\r\n            return true;\r\n        }\r\n\r\n        let changed = false;\r\n        if (cache[0] !== x) {\r\n            cache[0] = x;\r\n            changed = true;\r\n        }\r\n        if (cache[1] !== y) {\r\n            cache[1] = y;\r\n            changed = true;\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * @param uniformName\r\n     * @param x\r\n     * @param y\r\n     * @param z\r\n     * @hidden\r\n     */\r\n    public _cacheFloat3(uniformName: string, x: number, y: number, z: number): boolean {\r\n        let cache = this._valueCache[uniformName];\r\n        if (!cache) {\r\n            cache = [x, y, z];\r\n            this._valueCache[uniformName] = cache;\r\n            return true;\r\n        }\r\n\r\n        let changed = false;\r\n        if (cache[0] !== x) {\r\n            cache[0] = x;\r\n            changed = true;\r\n        }\r\n        if (cache[1] !== y) {\r\n            cache[1] = y;\r\n            changed = true;\r\n        }\r\n        if (cache[2] !== z) {\r\n            cache[2] = z;\r\n            changed = true;\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * @param uniformName\r\n     * @param x\r\n     * @param y\r\n     * @param z\r\n     * @param w\r\n     * @hidden\r\n     */\r\n    public _cacheFloat4(uniformName: string, x: number, y: number, z: number, w: number): boolean {\r\n        let cache = this._valueCache[uniformName];\r\n        if (!cache) {\r\n            cache = [x, y, z, w];\r\n            this._valueCache[uniformName] = cache;\r\n            return true;\r\n        }\r\n\r\n        let changed = false;\r\n        if (cache[0] !== x) {\r\n            cache[0] = x;\r\n            changed = true;\r\n        }\r\n        if (cache[1] !== y) {\r\n            cache[1] = y;\r\n            changed = true;\r\n        }\r\n        if (cache[2] !== z) {\r\n            cache[2] = z;\r\n            changed = true;\r\n        }\r\n        if (cache[3] !== w) {\r\n            cache[3] = w;\r\n            changed = true;\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * Sets an integer value on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param value Value to be set.\r\n     */\r\n    public setInt(uniformName: string, value: number): void {\r\n        const cache = this._valueCache[uniformName];\r\n        if (cache !== undefined && cache === value) {\r\n            return;\r\n        }\r\n\r\n        if (this.engine.setInt(this._uniforms[uniformName]!, value)) {\r\n            this._valueCache[uniformName] = value;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a int2 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First int in int2.\r\n     * @param y Second int in int2.\r\n     */\r\n    public setInt2(uniformName: string, x: number, y: number): void {\r\n        if (this._cacheFloat2(uniformName, x, y)) {\r\n            if (!this.engine.setInt2(this._uniforms[uniformName], x, y)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a int3 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First int in int3.\r\n     * @param y Second int in int3.\r\n     * @param z Third int in int3.\r\n     */\r\n    public setInt3(uniformName: string, x: number, y: number, z: number): void {\r\n        if (this._cacheFloat3(uniformName, x, y, z)) {\r\n            if (!this.engine.setInt3(this._uniforms[uniformName], x, y, z)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a int4 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First int in int4.\r\n     * @param y Second int in int4.\r\n     * @param z Third int in int4.\r\n     * @param w Fourth int in int4.\r\n     */\r\n    public setInt4(uniformName: string, x: number, y: number, z: number, w: number): void {\r\n        if (this._cacheFloat4(uniformName, x, y, z, w)) {\r\n            if (!this.engine.setInt4(this._uniforms[uniformName], x, y, z, w)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets an int array on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setIntArray(uniformName: string, array: Int32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setIntArray(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an int array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setIntArray2(uniformName: string, array: Int32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setIntArray2(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an int array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setIntArray3(uniformName: string, array: Int32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setIntArray3(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an int array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setIntArray4(uniformName: string, array: Int32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setIntArray4(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an float array on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setFloatArray(uniformName: string, array: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setFloatArray(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an float array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setFloatArray2(uniformName: string, array: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setFloatArray2(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an float array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setFloatArray3(uniformName: string, array: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setFloatArray3(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an float array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setFloatArray4(uniformName: string, array: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setFloatArray4(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an array on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setArray(uniformName: string, array: number[]): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setArray(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an array 2 on a uniform variable. (Array is specified as single array eg. [1,2,3,4] will result in [[1,2],[3,4]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setArray2(uniformName: string, array: number[]): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setArray2(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an array 3 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6] will result in [[1,2,3],[4,5,6]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     * @returns this effect.\r\n     */\r\n    public setArray3(uniformName: string, array: number[]): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setArray3(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets an array 4 on a uniform variable. (Array is specified as single array eg. [1,2,3,4,5,6,7,8] will result in [[1,2,3,4],[5,6,7,8]] in the shader)\r\n     * @param uniformName Name of the variable.\r\n     * @param array array to be set.\r\n     */\r\n    public setArray4(uniformName: string, array: number[]): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setArray4(this._uniforms[uniformName]!, array);\r\n    }\r\n\r\n    /**\r\n     * Sets matrices on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param matrices matrices to be set.\r\n     */\r\n    public setMatrices(uniformName: string, matrices: Float32Array): void {\r\n        if (!matrices) {\r\n            return;\r\n        }\r\n\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setMatrices(this._uniforms[uniformName]!, matrices);\r\n    }\r\n\r\n    /**\r\n     * Sets matrix on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param matrix matrix to be set.\r\n     */\r\n    public setMatrix(uniformName: string, matrix: IMatrixLike): void {\r\n        if (this._cacheMatrix(uniformName, matrix)) {\r\n            if (!this.engine.setMatrices(this._uniforms[uniformName]!, matrix.toArray() as Float32Array)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a 3x3 matrix on a uniform variable. (Specified as [1,2,3,4,5,6,7,8,9] will result in [1,2,3][4,5,6][7,8,9] matrix)\r\n     * @param uniformName Name of the variable.\r\n     * @param matrix matrix to be set.\r\n     */\r\n    public setMatrix3x3(uniformName: string, matrix: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setMatrix3x3(this._uniforms[uniformName]!, matrix);\r\n    }\r\n\r\n    /**\r\n     * Sets a 2x2 matrix on a uniform variable. (Specified as [1,2,3,4] will result in [1,2][3,4] matrix)\r\n     * @param uniformName Name of the variable.\r\n     * @param matrix matrix to be set.\r\n     */\r\n    public setMatrix2x2(uniformName: string, matrix: Float32Array): void {\r\n        this._valueCache[uniformName] = null;\r\n        this.engine.setMatrix2x2(this._uniforms[uniformName]!, matrix);\r\n    }\r\n\r\n    /**\r\n     * Sets a float on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param value value to be set.\r\n     * @returns this effect.\r\n     */\r\n    public setFloat(uniformName: string, value: number): void {\r\n        const cache = this._valueCache[uniformName];\r\n        if (cache !== undefined && cache === value) {\r\n            return;\r\n        }\r\n\r\n        if (this.engine.setFloat(this._uniforms[uniformName]!, value)) {\r\n            this._valueCache[uniformName] = value;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a boolean on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param bool value to be set.\r\n     */\r\n    public setBool(uniformName: string, bool: boolean): void {\r\n        const cache = this._valueCache[uniformName];\r\n        if (cache !== undefined && cache === bool) {\r\n            return;\r\n        }\r\n\r\n        if (this.engine.setInt(this._uniforms[uniformName]!, bool ? 1 : 0)) {\r\n            this._valueCache[uniformName] = bool ? 1 : 0;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Vector2 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param vector2 vector2 to be set.\r\n     */\r\n    public setVector2(uniformName: string, vector2: IVector2Like): void {\r\n        if (this._cacheFloat2(uniformName, vector2.x, vector2.y)) {\r\n            if (!this.engine.setFloat2(this._uniforms[uniformName]!, vector2.x, vector2.y)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a float2 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First float in float2.\r\n     * @param y Second float in float2.\r\n     */\r\n    public setFloat2(uniformName: string, x: number, y: number): void {\r\n        if (this._cacheFloat2(uniformName, x, y)) {\r\n            if (!this.engine.setFloat2(this._uniforms[uniformName]!, x, y)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Vector3 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param vector3 Value to be set.\r\n     */\r\n    public setVector3(uniformName: string, vector3: IVector3Like): void {\r\n        if (this._cacheFloat3(uniformName, vector3.x, vector3.y, vector3.z)) {\r\n            if (!this.engine.setFloat3(this._uniforms[uniformName]!, vector3.x, vector3.y, vector3.z)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a float3 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First float in float3.\r\n     * @param y Second float in float3.\r\n     * @param z Third float in float3.\r\n     */\r\n    public setFloat3(uniformName: string, x: number, y: number, z: number): void {\r\n        if (this._cacheFloat3(uniformName, x, y, z)) {\r\n            if (!this.engine.setFloat3(this._uniforms[uniformName]!, x, y, z)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Vector4 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param vector4 Value to be set.\r\n     */\r\n    public setVector4(uniformName: string, vector4: IVector4Like): void {\r\n        if (this._cacheFloat4(uniformName, vector4.x, vector4.y, vector4.z, vector4.w)) {\r\n            if (!this.engine.setFloat4(this._uniforms[uniformName]!, vector4.x, vector4.y, vector4.z, vector4.w)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a float4 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param x First float in float4.\r\n     * @param y Second float in float4.\r\n     * @param z Third float in float4.\r\n     * @param w Fourth float in float4.\r\n     * @returns this effect.\r\n     */\r\n    public setFloat4(uniformName: string, x: number, y: number, z: number, w: number): void {\r\n        if (this._cacheFloat4(uniformName, x, y, z, w)) {\r\n            if (!this.engine.setFloat4(this._uniforms[uniformName]!, x, y, z, w)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Color3 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param color3 Value to be set.\r\n     */\r\n    public setColor3(uniformName: string, color3: IColor3Like): void {\r\n        if (this._cacheFloat3(uniformName, color3.r, color3.g, color3.b)) {\r\n            if (!this.engine.setFloat3(this._uniforms[uniformName]!, color3.r, color3.g, color3.b)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Color4 on a uniform variable.\r\n     * @param uniformName Name of the variable.\r\n     * @param color3 Value to be set.\r\n     * @param alpha Alpha value to be set.\r\n     */\r\n    public setColor4(uniformName: string, color3: IColor3Like, alpha: number): void {\r\n        if (this._cacheFloat4(uniformName, color3.r, color3.g, color3.b, alpha)) {\r\n            if (!this.engine.setFloat4(this._uniforms[uniformName]!, color3.r, color3.g, color3.b, alpha)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a Color4 on a uniform variable\r\n     * @param uniformName defines the name of the variable\r\n     * @param color4 defines the value to be set\r\n     */\r\n    public setDirectColor4(uniformName: string, color4: IColor4Like): void {\r\n        if (this._cacheFloat4(uniformName, color4.r, color4.g, color4.b, color4.a)) {\r\n            if (!this.engine.setFloat4(this._uniforms[uniformName]!, color4.r, color4.g, color4.b, color4.a)) {\r\n                this._valueCache[uniformName] = null;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass NativeRenderTargetWrapper extends RenderTargetWrapper {\r\n    public override readonly _engine: NativeEngine;\r\n\r\n    private __framebuffer: Nullable<WebGLFramebuffer> = null;\r\n    private __framebufferDepthStencil: Nullable<WebGLFramebuffer> = null;\r\n\r\n    public get _framebuffer(): Nullable<WebGLFramebuffer> {\r\n        return this.__framebuffer;\r\n    }\r\n\r\n    public set _framebuffer(framebuffer: Nullable<WebGLFramebuffer>) {\r\n        if (this.__framebuffer) {\r\n            this._engine._releaseFramebufferObjects(this.__framebuffer);\r\n        }\r\n        this.__framebuffer = framebuffer;\r\n    }\r\n\r\n    public get _framebufferDepthStencil(): Nullable<WebGLFramebuffer> {\r\n        return this.__framebufferDepthStencil;\r\n    }\r\n\r\n    public set _framebufferDepthStencil(framebufferDepthStencil: Nullable<WebGLFramebuffer>) {\r\n        if (this.__framebufferDepthStencil) {\r\n            this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil);\r\n        }\r\n        this.__framebufferDepthStencil = framebufferDepthStencil;\r\n    }\r\n\r\n    constructor(isMulti: boolean, isCube: boolean, size: TextureSize, engine: NativeEngine) {\r\n        super(isMulti, isCube, size, engine);\r\n        this._engine = engine;\r\n    }\r\n\r\n    public dispose(disposeOnlyFramebuffers = false): void {\r\n        this._framebuffer = null;\r\n        this._framebufferDepthStencil = null;\r\n\r\n        super.dispose(disposeOnlyFramebuffers);\r\n    }\r\n}\r\n\r\n/**\r\n * Container for accessors for natively-stored mesh data buffers.\r\n */\r\nclass NativeDataBuffer extends DataBuffer {\r\n    /**\r\n     * Accessor value used to identify/retrieve a natively-stored index buffer.\r\n     */\r\n    public nativeIndexBuffer?: NativeData;\r\n\r\n    /**\r\n     * Accessor value used to identify/retrieve a natively-stored vertex buffer.\r\n     */\r\n    public nativeVertexBuffer?: NativeData;\r\n}\r\n\r\n/**\r\n * Options to create the Native engine\r\n */\r\nexport interface NativeEngineOptions {\r\n    /**\r\n     * defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    adaptToDeviceRatio?: boolean;\r\n}\r\n\r\n/** @hidden */\r\nclass CommandBufferEncoder {\r\n    private readonly _commandStream: NativeDataStream;\r\n    private readonly _pending = new Array<NativeData>();\r\n    private _isCommandBufferScopeActive = false;\r\n\r\n    public constructor(private readonly _engine: INativeEngine) {\r\n        this._commandStream = NativeEngine._createNativeDataStream();\r\n        this._engine.setCommandDataStream(this._commandStream);\r\n    }\r\n\r\n    public beginCommandScope() {\r\n        if (this._isCommandBufferScopeActive) {\r\n            throw new Error(\"Command scope already active.\");\r\n        }\r\n\r\n        this._isCommandBufferScopeActive = true;\r\n    }\r\n\r\n    public endCommandScope() {\r\n        if (!this._isCommandBufferScopeActive) {\r\n            throw new Error(\"Command scope is not active.\");\r\n        }\r\n\r\n        this._isCommandBufferScopeActive = false;\r\n        this._submit();\r\n    }\r\n\r\n    public startEncodingCommand(command: NativeData) {\r\n        this._commandStream.writeNativeData(command);\r\n    }\r\n\r\n    public encodeCommandArgAsUInt32(commandArg: number) {\r\n        this._commandStream.writeUint32(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsUInt32s(commandArg: Uint32Array) {\r\n        this._commandStream.writeUint32Array(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsInt32(commandArg: number) {\r\n        this._commandStream.writeInt32(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsInt32s(commandArg: Int32Array) {\r\n        this._commandStream.writeInt32Array(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsFloat32(commandArg: number) {\r\n        this._commandStream.writeFloat32(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsFloat32s(commandArg: Float32Array) {\r\n        this._commandStream.writeFloat32Array(commandArg);\r\n    }\r\n\r\n    public encodeCommandArgAsNativeData(commandArg: NativeData) {\r\n        this._commandStream.writeNativeData(commandArg);\r\n        this._pending.push(commandArg);\r\n    }\r\n\r\n    public finishEncodingCommand() {\r\n        if (!this._isCommandBufferScopeActive) {\r\n            this._submit();\r\n        }\r\n    }\r\n\r\n    private _submit() {\r\n        this._engine.submitCommands();\r\n        this._pending.length = 0;\r\n    }\r\n}\r\n\r\n/** @hidden */\r\nexport class NativeEngine extends Engine {\r\n    // This must match the protocol version in NativeEngine.cpp\r\n    private static readonly PROTOCOL_VERSION = 5;\r\n\r\n    private readonly _engine: INativeEngine = new _native.Engine();\r\n    private readonly _camera: Nullable<INativeCamera> = _native.Camera ? new _native.Camera() : null;\r\n\r\n    private readonly _commandBufferEncoder = new CommandBufferEncoder(this._engine);\r\n\r\n    private _boundBuffersVertexArray: any = null;\r\n    private _currentDepthTest: number = _native.Engine.DEPTH_TEST_LEQUAL;\r\n    private _stencilTest = false;\r\n    private _stencilMask: number = 255;\r\n    private _stencilFunc: number = Constants.ALWAYS;\r\n    private _stencilFuncRef: number = 0;\r\n    private _stencilFuncMask: number = 255;\r\n    private _stencilOpStencilFail: number = Constants.KEEP;\r\n    private _stencilOpDepthFail: number = Constants.KEEP;\r\n    private _stencilOpStencilDepthPass: number = Constants.REPLACE;\r\n    private _zOffset: number = 0;\r\n    private _zOffsetUnits: number = 0;\r\n    private _depthWrite: boolean = true;\r\n\r\n    public getHardwareScalingLevel(): number {\r\n        return this._engine.getHardwareScalingLevel();\r\n    }\r\n\r\n    public setHardwareScalingLevel(level: number): void {\r\n        this._engine.setHardwareScalingLevel(level);\r\n    }\r\n\r\n    public constructor(options: NativeEngineOptions = {}) {\r\n        super(null, false, undefined, options.adaptToDeviceRatio);\r\n\r\n        if (_native.Engine.PROTOCOL_VERSION !== NativeEngine.PROTOCOL_VERSION) {\r\n            throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${NativeEngine.PROTOCOL_VERSION} (JS)`);\r\n        }\r\n\r\n        this._webGLVersion = 2;\r\n        this.disableUniformBuffers = true;\r\n\r\n        // TODO: Initialize this more correctly based on the hardware capabilities.\r\n        // Init caps\r\n\r\n        this._caps = {\r\n            maxTexturesImageUnits: 16,\r\n            maxVertexTextureImageUnits: 16,\r\n            maxCombinedTexturesImageUnits: 32,\r\n            maxTextureSize: 512,\r\n            maxCubemapTextureSize: 512,\r\n            maxRenderTextureSize: 512,\r\n            maxVertexAttribs: 16,\r\n            maxVaryingVectors: 16,\r\n            maxFragmentUniformVectors: 16,\r\n            maxVertexUniformVectors: 16,\r\n            standardDerivatives: true,\r\n            astc: null,\r\n            pvrtc: null,\r\n            etc1: null,\r\n            etc2: null,\r\n            bptc: null,\r\n            maxAnisotropy: 16, // TODO: Retrieve this smartly. Currently set to D3D11 maximum allowable value.\r\n            uintIndices: true,\r\n            fragmentDepthSupported: false,\r\n            highPrecisionShaderSupported: true,\r\n            colorBufferFloat: false,\r\n            textureFloat: true,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloat: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            textureHalfFloatRender: false,\r\n            textureLOD: true,\r\n            drawBuffersExtension: false,\r\n            depthTextureExtension: false,\r\n            vertexArrayObject: true,\r\n            instancedArrays: false,\r\n            supportOcclusionQuery: false,\r\n            canUseTimestampForTimerQuery: false,\r\n            blendMinMax: false,\r\n            maxMSAASamples: 1,\r\n            canUseGLInstanceID: true,\r\n            canUseGLVertexID: true,\r\n            supportComputeShaders: false,\r\n            supportSRGBBuffers: true,\r\n            supportTransformFeedbacks: false,\r\n            textureMaxLevel: false,\r\n        };\r\n\r\n        this._features = {\r\n            forceBitmapOverHTMLImageElement: false,\r\n            supportRenderAndCopyToLodForFloatTextures: false,\r\n            supportDepthStencilTexture: false,\r\n            supportShadowSamplers: false,\r\n            uniformBufferHardCheckMatrix: false,\r\n            allowTexturePrefiltering: false,\r\n            trackUbosInFrame: false,\r\n            checkUbosContentBeforeUpload: false,\r\n            supportCSM: false,\r\n            basisNeedsPOT: false,\r\n            support3DTextures: false,\r\n            needTypeSuffixInShaderConstants: false,\r\n            supportMSAA: false,\r\n            supportSSAO2: false,\r\n            supportExtendedTextureFormats: false,\r\n            supportSwitchCaseInShader: false,\r\n            supportSyncTextureRead: false,\r\n            needsInvertingBitmap: true,\r\n            useUBOBindingCache: true,\r\n            needShaderCodeInlining: true,\r\n            needToAlwaysBindUniformBuffers: false,\r\n            supportRenderPasses: true,\r\n            _collectUbosUpdatedInFrame: false,\r\n        };\r\n\r\n        Tools.Log(\"Babylon Native (v\" + Engine.Version + \") launched\");\r\n\r\n        Tools.LoadScript = function (scriptUrl, onSuccess, onError, scriptId) {\r\n            Tools.LoadFile(\r\n                scriptUrl,\r\n                (data) => {\r\n                    Function(data as string).apply(null);\r\n                    if (onSuccess) {\r\n                        onSuccess();\r\n                    }\r\n                },\r\n                undefined,\r\n                undefined,\r\n                false,\r\n                (request, exception) => {\r\n                    if (onError) {\r\n                        onError(\"LoadScript Error\", exception);\r\n                    }\r\n                }\r\n            );\r\n        };\r\n\r\n        // Wrappers\r\n        if (typeof URL === \"undefined\") {\r\n            (window.URL as any) = {\r\n                createObjectURL: function () {},\r\n                revokeObjectURL: function () {},\r\n            };\r\n        }\r\n\r\n        if (typeof Blob === \"undefined\") {\r\n            (window.Blob as any) = function (v: any) {\r\n                return v;\r\n            };\r\n        }\r\n\r\n        // Currently we do not fully configure the ThinEngine on construction of NativeEngine.\r\n        // Setup resolution scaling based on display settings.\r\n        const devicePixelRatio = window ? window.devicePixelRatio || 1.0 : 1.0;\r\n        this._hardwareScalingLevel = options.adaptToDeviceRatio ? devicePixelRatio : 1.0;\r\n        this.resize();\r\n\r\n        const currentDepthFunction = this.getDepthFunction();\r\n        if (currentDepthFunction) {\r\n            this.setDepthFunction(currentDepthFunction);\r\n        }\r\n\r\n        // Shader processor\r\n        this._shaderProcessor = new WebGL2ShaderProcessor();\r\n\r\n        this.onNewSceneAddedObservable.add((scene) => {\r\n            const originalRender = scene.render;\r\n            scene.render = (...args: Parameters<typeof originalRender>) => {\r\n                this._commandBufferEncoder.beginCommandScope();\r\n                originalRender.apply(scene, args);\r\n                this._commandBufferEncoder.endCommandScope();\r\n            };\r\n        });\r\n    }\r\n\r\n    public dispose(): void {\r\n        super.dispose();\r\n        if (this._boundBuffersVertexArray) {\r\n            this._deleteVertexArray(this._boundBuffersVertexArray);\r\n        }\r\n        this._engine.dispose();\r\n    }\r\n\r\n    /** @hidden */\r\n    public static _createNativeDataStream(): NativeDataStream {\r\n        return new NativeDataStream();\r\n    }\r\n\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @param bindedRenderFunction\r\n     * @param requester\r\n     * @hidden\r\n     */\r\n    protected _queueNewFrame(bindedRenderFunction: any, requester?: any): number {\r\n        // Use the provided requestAnimationFrame, unless the requester is the window. In that case, we will default to the Babylon Native version of requestAnimationFrame.\r\n        if (requester.requestAnimationFrame && requester !== window) {\r\n            requester.requestAnimationFrame(bindedRenderFunction);\r\n        } else {\r\n            this._engine.requestAnimationFrame(bindedRenderFunction);\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    /**\r\n     * Override default engine behavior.\r\n     * @param framebuffer\r\n     */\r\n    public _bindUnboundFramebuffer(framebuffer: Nullable<WebGLFramebuffer>) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            if (this._currentFramebuffer) {\r\n                this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER);\r\n                this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer as NativeData);\r\n                this._commandBufferEncoder.finishEncodingCommand();\r\n            }\r\n\r\n            if (framebuffer) {\r\n                this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER);\r\n                this._commandBufferEncoder.encodeCommandArgAsNativeData(framebuffer as NativeData);\r\n                this._commandBufferEncoder.finishEncodingCommand();\r\n            }\r\n\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    public getHostDocument(): Nullable<Document> {\r\n        return null;\r\n    }\r\n\r\n    public clear(color: Nullable<IColor4Like>, backBuffer: boolean, depth: boolean, stencil: boolean = false): void {\r\n        if (this.useReverseDepthBuffer) {\r\n            throw new Error(\"reverse depth buffer is not currently implemented\");\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(backBuffer && color ? 1 : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.r : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.g : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.b : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(color ? color.a : 1);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(depth ? 1 : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(1);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(stencil ? 1 : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(0);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    public createIndexBuffer(indices: IndicesArray, updateable?: boolean): NativeDataBuffer {\r\n        const data = this._normalizeIndexData(indices);\r\n        const buffer = new NativeDataBuffer();\r\n        buffer.references = 1;\r\n        buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\r\n        if (data.byteLength) {\r\n            buffer.nativeIndexBuffer = this._engine.createIndexBuffer(data.buffer, data.byteOffset, data.byteLength, buffer.is32Bits, updateable ?? false);\r\n        }\r\n        return buffer;\r\n    }\r\n\r\n    public createVertexBuffer(vertices: DataArray, updateable?: boolean): NativeDataBuffer {\r\n        const data = ArrayBuffer.isView(vertices) ? vertices : new Float32Array(vertices);\r\n        const buffer = new NativeDataBuffer();\r\n        buffer.references = 1;\r\n        if (data.byteLength) {\r\n            buffer.nativeVertexBuffer = this._engine.createVertexBuffer(data.buffer, data.byteOffset, data.byteLength, updateable ?? false);\r\n        }\r\n        return buffer;\r\n    }\r\n\r\n    protected _recordVertexArrayObject(vertexArray: any, vertexBuffers: { [key: string]: VertexBuffer }, indexBuffer: Nullable<NativeDataBuffer>, effect: Effect): void {\r\n        if (indexBuffer) {\r\n            this._engine.recordIndexBuffer(vertexArray, indexBuffer.nativeIndexBuffer!);\r\n        }\r\n\r\n        const attributes = effect.getAttributesNames();\r\n        for (let index = 0; index < attributes.length; index++) {\r\n            const location = effect.getAttributeLocation(index);\r\n            if (location >= 0) {\r\n                const kind = attributes[index];\r\n                const vertexBuffer = vertexBuffers[kind];\r\n                if (vertexBuffer) {\r\n                    const buffer = vertexBuffer.getBuffer() as Nullable<NativeDataBuffer>;\r\n                    if (buffer) {\r\n                        this._engine.recordVertexBuffer(\r\n                            vertexArray,\r\n                            buffer.nativeVertexBuffer!,\r\n                            location,\r\n                            vertexBuffer.byteOffset,\r\n                            vertexBuffer.byteStride,\r\n                            vertexBuffer.getSize(),\r\n                            this._getNativeAttribType(vertexBuffer.type),\r\n                            vertexBuffer.normalized,\r\n                            vertexBuffer.getInstanceDivisor()\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public bindBuffers(vertexBuffers: { [key: string]: VertexBuffer }, indexBuffer: Nullable<NativeDataBuffer>, effect: Effect): void {\r\n        if (this._boundBuffersVertexArray) {\r\n            this._deleteVertexArray(this._boundBuffersVertexArray);\r\n        }\r\n        this._boundBuffersVertexArray = this._engine.createVertexArray();\r\n        this._recordVertexArrayObject(this._boundBuffersVertexArray, vertexBuffers, indexBuffer, effect);\r\n        this.bindVertexArrayObject(this._boundBuffersVertexArray);\r\n    }\r\n\r\n    public recordVertexArrayObject(vertexBuffers: { [key: string]: VertexBuffer }, indexBuffer: Nullable<NativeDataBuffer>, effect: Effect): WebGLVertexArrayObject {\r\n        const vertexArray = this._engine.createVertexArray();\r\n        this._recordVertexArrayObject(vertexArray, vertexBuffers, indexBuffer, effect);\r\n        return vertexArray;\r\n    }\r\n\r\n    private _deleteVertexArray(vertexArray: unknown) {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(vertexArray as NativeData);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    public bindVertexArrayObject(vertexArray: WebGLVertexArrayObject): void {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(vertexArray as NativeData);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    public releaseVertexArrayObject(vertexArray: WebGLVertexArrayObject) {\r\n        this._deleteVertexArray(vertexArray);\r\n    }\r\n\r\n    public getAttributes(pipelineContext: IPipelineContext, attributesNames: string[]): number[] {\r\n        const nativePipelineContext = pipelineContext as NativePipelineContext;\r\n        return this._engine.getAttributes(nativePipelineContext.nativeProgram, attributesNames);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawElementsType(fillMode: number, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this._drawCalls.addCount(1, false);\r\n\r\n        // TODO: Make this implementation more robust like core Engine version.\r\n\r\n        // Render\r\n        //var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n\r\n        //var mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        // if (instancesCount) {\r\n        //     this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        // } else {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(fillMode);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(indexStart);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(indexCount);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        // }\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawArraysType(fillMode: number, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this._drawCalls.addCount(1, false);\r\n\r\n        // TODO: Make this implementation more robust like core Engine version.\r\n\r\n        // if (instancesCount) {\r\n        //     this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        // } else {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(fillMode);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(verticesStart);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(verticesCount);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        // }\r\n    }\r\n\r\n    public createPipelineContext(): IPipelineContext {\r\n        return new NativePipelineContext(this);\r\n    }\r\n\r\n    public createMaterialContext(): IMaterialContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    public createDrawContext(): IDrawContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    public _preparePipelineContext(\r\n        pipelineContext: IPipelineContext,\r\n        vertexSourceCode: string,\r\n        fragmentSourceCode: string,\r\n        createAsRaw: boolean,\r\n        rawVertexSourceCode: string,\r\n        rawFragmentSourceCode: string,\r\n        rebuildRebind: any,\r\n        defines: Nullable<string>,\r\n        transformFeedbackVaryings: Nullable<string[]>\r\n    ) {\r\n        const nativePipelineContext = pipelineContext as NativePipelineContext;\r\n\r\n        if (createAsRaw) {\r\n            nativePipelineContext.nativeProgram = this.createRawShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        } else {\r\n            nativePipelineContext.nativeProgram = this.createShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @hidden\r\n     */\r\n    public _isRenderingStateCompiled(pipelineContext: IPipelineContext): boolean {\r\n        // TODO: support async shader compilcation\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @param action\r\n     * @hidden\r\n     */\r\n    public _executeWhenRenderingStateIsCompiled(pipelineContext: IPipelineContext, action: () => void) {\r\n        // TODO: support async shader compilcation\r\n        action();\r\n    }\r\n\r\n    public createRawShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): any {\r\n        throw new Error(\"Not Supported\");\r\n    }\r\n\r\n    public createShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        defines: Nullable<string>,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): any {\r\n        this.onBeforeShaderCompilationObservable.notifyObservers(this);\r\n\r\n        const vertexInliner = new ShaderCodeInliner(vertexCode);\r\n        vertexInliner.processCode();\r\n        vertexCode = vertexInliner.code;\r\n\r\n        const fragmentInliner = new ShaderCodeInliner(fragmentCode);\r\n        fragmentInliner.processCode();\r\n        fragmentCode = fragmentInliner.code;\r\n\r\n        vertexCode = ThinEngine._ConcatenateShader(vertexCode, defines);\r\n        fragmentCode = ThinEngine._ConcatenateShader(fragmentCode, defines);\r\n\r\n        const program = this._engine.createProgram(vertexCode, fragmentCode);\r\n        this.onAfterShaderCompilationObservable.notifyObservers(this);\r\n        return program;\r\n    }\r\n\r\n    /**\r\n     * Inline functions in shader code that are marked to be inlined\r\n     * @param code code to inline\r\n     * @returns inlined code\r\n     */\r\n    public inlineShaderCode(code: string): string {\r\n        const sci = new ShaderCodeInliner(code);\r\n        sci.debug = false;\r\n        sci.processCode();\r\n        return sci.code;\r\n    }\r\n\r\n    protected _setProgram(program: WebGLProgram): void {\r\n        if (this._currentProgram !== program) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(program as NativeData);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n            this._currentProgram = program;\r\n        }\r\n    }\r\n\r\n    public _deletePipelineContext(pipelineContext: IPipelineContext): void {\r\n        const nativePipelineContext = pipelineContext as NativePipelineContext;\r\n        if (nativePipelineContext && nativePipelineContext.nativeProgram) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(nativePipelineContext.nativeProgram);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n        }\r\n    }\r\n\r\n    public getUniforms(pipelineContext: IPipelineContext, uniformsNames: string[]): WebGLUniformLocation[] {\r\n        const nativePipelineContext = pipelineContext as NativePipelineContext;\r\n        return this._engine.getUniforms(nativePipelineContext.nativeProgram, uniformsNames);\r\n    }\r\n\r\n    public bindUniformBlock(pipelineContext: IPipelineContext, blockName: string, index: number): void {\r\n        // TODO\r\n        throw new Error(\"Not Implemented\");\r\n    }\r\n\r\n    public bindSamplers(effect: Effect): void {\r\n        const nativePipelineContext = effect.getPipelineContext() as NativePipelineContext;\r\n        this._setProgram(nativePipelineContext.nativeProgram);\r\n\r\n        // TODO: share this with engine?\r\n        const samplers = effect.getSamplers();\r\n        for (let index = 0; index < samplers.length; index++) {\r\n            const uniform = effect.getUniform(samplers[index]);\r\n\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    }\r\n\r\n    public setMatrix(uniform: WebGLUniformLocation, matrix: IMatrixLike): void {\r\n        if (!uniform) {\r\n            return;\r\n        }\r\n\r\n        const matrixArray = matrix.toArray() as Float32Array;\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrixArray);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    public getRenderWidth(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n\r\n        return this._engine.getRenderWidth();\r\n    }\r\n\r\n    public getRenderHeight(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n\r\n        return this._engine.getRenderHeight();\r\n    }\r\n\r\n    public setViewport(viewport: IViewportLike, requiredWidth?: number, requiredHeight?: number): void {\r\n        this._cachedViewport = viewport;\r\n        this._engine.setViewPort(viewport.x, viewport.y, viewport.width, viewport.height);\r\n    }\r\n\r\n    public setState(culling: boolean, zOffset: number = 0, force?: boolean, reverseSide = false, cullBackFaces?: boolean, stencil?: IStencilState, zOffsetUnits: number = 0): void {\r\n        this._zOffset = zOffset;\r\n        this._zOffsetUnits = zOffsetUnits;\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(culling ? 1 : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(zOffset);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(zOffsetUnits);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces ?? cullBackFaces ?? true ? 1 : 0);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(reverseSide ? 1 : 0);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Gets the client rect of native canvas.  Needed for InputManager.\r\n     * @returns a client rectangle\r\n     */\r\n    public getInputElementClientRect(): Nullable<DOMRect> {\r\n        const rect = {\r\n            bottom: this.getRenderHeight(),\r\n            height: this.getRenderHeight(),\r\n            left: 0,\r\n            right: this.getRenderWidth(),\r\n            top: 0,\r\n            width: this.getRenderWidth(),\r\n            x: 0,\r\n            y: 0,\r\n            toJSON: () => {},\r\n        };\r\n        return rect;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Factor to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffset(value: number): void {\r\n        if (value !== this._zOffset) {\r\n            this._zOffset = value;\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET);\r\n            this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer ? -value : value);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Factor\r\n     * @returns the current zOffset Factor state\r\n     */\r\n    public getZOffset(): number {\r\n        return this._zOffset;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Units to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffsetUnits(value: number): void {\r\n        if (value !== this._zOffsetUnits) {\r\n            this._zOffsetUnits = value;\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS);\r\n            this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer ? -value : value);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Units\r\n     * @returns the current zOffset Units state\r\n     */\r\n    public getZOffsetUnits(): number {\r\n        return this._zOffsetUnits;\r\n    }\r\n\r\n    /**\r\n     * Enable or disable depth buffering\r\n     * @param enable defines the state to set\r\n     */\r\n    public setDepthBuffer(enable: boolean): void {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(enable ? this._currentDepthTest : _native.Engine.DEPTH_TEST_ALWAYS);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if depth writing is enabled\r\n     * @returns the current depth writing state\r\n     */\r\n    public getDepthWrite(): boolean {\r\n        return this._depthWrite;\r\n    }\r\n\r\n    public getDepthFunction(): Nullable<number> {\r\n        switch (this._currentDepthTest) {\r\n            case _native.Engine.DEPTH_TEST_NEVER:\r\n                return Constants.NEVER;\r\n            case _native.Engine.DEPTH_TEST_ALWAYS:\r\n                return Constants.ALWAYS;\r\n            case _native.Engine.DEPTH_TEST_GREATER:\r\n                return Constants.GREATER;\r\n            case _native.Engine.DEPTH_TEST_GEQUAL:\r\n                return Constants.GEQUAL;\r\n            case _native.Engine.DEPTH_TEST_NOTEQUAL:\r\n                return Constants.NOTEQUAL;\r\n            case _native.Engine.DEPTH_TEST_EQUAL:\r\n                return Constants.EQUAL;\r\n            case _native.Engine.DEPTH_TEST_LESS:\r\n                return Constants.LESS;\r\n            case _native.Engine.DEPTH_TEST_LEQUAL:\r\n                return Constants.LEQUAL;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    public setDepthFunction(depthFunc: number) {\r\n        let nativeDepthFunc = 0;\r\n        switch (depthFunc) {\r\n            case Constants.NEVER:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_NEVER;\r\n                break;\r\n            case Constants.ALWAYS:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_ALWAYS;\r\n                break;\r\n            case Constants.GREATER:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_GREATER;\r\n                break;\r\n            case Constants.GEQUAL:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_GEQUAL;\r\n                break;\r\n            case Constants.NOTEQUAL:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_NOTEQUAL;\r\n                break;\r\n            case Constants.EQUAL:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_EQUAL;\r\n                break;\r\n            case Constants.LESS:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_LESS;\r\n                break;\r\n            case Constants.LEQUAL:\r\n                nativeDepthFunc = _native.Engine.DEPTH_TEST_LEQUAL;\r\n                break;\r\n        }\r\n\r\n        this._currentDepthTest = nativeDepthFunc;\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Enable or disable depth writing\r\n     * @param enable defines the state to set\r\n     */\r\n    public setDepthWrite(enable: boolean): void {\r\n        this._depthWrite = enable;\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(enable));\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    public setColorWrite(enable: boolean): void {\r\n        this._colorWrite = enable;\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(enable));\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    public getColorWrite(): boolean {\r\n        return this._colorWrite;\r\n    }\r\n\r\n    private applyStencil(): void {\r\n        this._setStencil(\r\n            this._stencilMask,\r\n            this._getStencilOpFail(this._stencilOpStencilFail),\r\n            this._getStencilDepthFail(this._stencilOpDepthFail),\r\n            this._getStencilDepthPass(this._stencilOpStencilDepthPass),\r\n            this._getStencilFunc(this._stencilFunc),\r\n            this._stencilFuncRef\r\n        );\r\n    }\r\n\r\n    private _setStencil(mask: number, stencilOpFail: number, depthOpFail: number, depthOpPass: number, func: number, ref: number) {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(mask);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(stencilOpFail);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(depthOpFail);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(depthOpPass);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(func);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(ref);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    /**\r\n     * Enable or disable the stencil buffer\r\n     * @param enable defines if the stencil buffer must be enabled or disabled\r\n     */\r\n    public setStencilBuffer(enable: boolean): void {\r\n        this._stencilTest = enable;\r\n        if (enable) {\r\n            this.applyStencil();\r\n        } else {\r\n            this._setStencil(\r\n                255,\r\n                _native.Engine.STENCIL_OP_FAIL_S_KEEP,\r\n                _native.Engine.STENCIL_OP_FAIL_Z_KEEP,\r\n                _native.Engine.STENCIL_OP_PASS_Z_KEEP,\r\n                _native.Engine.STENCIL_TEST_ALWAYS,\r\n                0\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if stencil buffer is enabled\r\n     * @returns the current stencil buffer state\r\n     */\r\n    public getStencilBuffer(): boolean {\r\n        return this._stencilTest;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil operation when stencil passes\r\n     * @returns a number defining stencil operation to use when stencil passes\r\n     */\r\n    public getStencilOperationPass(): number {\r\n        return this._stencilOpStencilDepthPass;\r\n    }\r\n\r\n    /**\r\n     * Sets the stencil operation to use when stencil passes\r\n     * @param operation defines the stencil operation to use when stencil passes\r\n     */\r\n    public setStencilOperationPass(operation: number): void {\r\n        this._stencilOpStencilDepthPass = operation;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Sets the current stencil mask\r\n     * @param mask defines the new stencil mask to use\r\n     */\r\n    public setStencilMask(mask: number): void {\r\n        this._stencilMask = mask;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Sets the current stencil function\r\n     * @param stencilFunc defines the new stencil function to use\r\n     */\r\n    public setStencilFunction(stencilFunc: number) {\r\n        this._stencilFunc = stencilFunc;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Sets the current stencil reference\r\n     * @param reference defines the new stencil reference to use\r\n     */\r\n    public setStencilFunctionReference(reference: number) {\r\n        this._stencilFuncRef = reference;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Sets the current stencil mask\r\n     * @param mask defines the new stencil mask to use\r\n     */\r\n    public setStencilFunctionMask(mask: number) {\r\n        this._stencilFuncMask = mask;\r\n    }\r\n\r\n    /**\r\n     * Sets the stencil operation to use when stencil fails\r\n     * @param operation defines the stencil operation to use when stencil fails\r\n     */\r\n    public setStencilOperationFail(operation: number): void {\r\n        this._stencilOpStencilFail = operation;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Sets the stencil operation to use when depth fails\r\n     * @param operation defines the stencil operation to use when depth fails\r\n     */\r\n    public setStencilOperationDepthFail(operation: number): void {\r\n        this._stencilOpDepthFail = operation;\r\n        this.applyStencil();\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil mask\r\n     * @returns a number defining the new stencil mask to use\r\n     */\r\n    public getStencilMask(): number {\r\n        return this._stencilMask;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil function\r\n     * @returns a number defining the stencil function to use\r\n     */\r\n    public getStencilFunction(): number {\r\n        return this._stencilFunc;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil reference value\r\n     * @returns a number defining the stencil reference value to use\r\n     */\r\n    public getStencilFunctionReference(): number {\r\n        return this._stencilFuncRef;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil mask\r\n     * @returns a number defining the stencil mask to use\r\n     */\r\n    public getStencilFunctionMask(): number {\r\n        return this._stencilFuncMask;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil operation when stencil fails\r\n     * @returns a number defining stencil operation to use when stencil fails\r\n     */\r\n    public getStencilOperationFail(): number {\r\n        return this._stencilOpStencilFail;\r\n    }\r\n\r\n    /**\r\n     * Gets the current stencil operation when depth fails\r\n     * @returns a number defining stencil operation to use when depth fails\r\n     */\r\n    public getStencilOperationDepthFail(): number {\r\n        return this._stencilOpDepthFail;\r\n    }\r\n\r\n    /**\r\n     * Sets alpha constants used by some alpha blending modes\r\n     * @param r defines the red component\r\n     * @param g defines the green component\r\n     * @param b defines the blue component\r\n     * @param a defines the alpha component\r\n     */\r\n    public setAlphaConstants(r: number, g: number, b: number, a: number) {\r\n        throw new Error(\"Setting alpha blend constant color not yet implemented.\");\r\n    }\r\n\r\n    /**\r\n     * Sets the current alpha mode\r\n     * @param mode defines the mode to use (one of the BABYLON.Constants.ALPHA_XXX)\r\n     * @param noDepthWriteChange defines if depth writing state should remains unchanged (false by default)\r\n     * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n     */\r\n    public setAlphaMode(mode: number, noDepthWriteChange: boolean = false): void {\r\n        if (this._alphaMode === mode) {\r\n            return;\r\n        }\r\n\r\n        const nativeMode = this._getNativeAlphaMode(mode);\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(nativeMode);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n\r\n        if (!noDepthWriteChange) {\r\n            this.setDepthWrite(mode === Constants.ALPHA_DISABLE);\r\n        }\r\n\r\n        this._alphaMode = mode;\r\n    }\r\n\r\n    /**\r\n     * Gets the current alpha mode\r\n     * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n     * @returns the current alpha mode\r\n     */\r\n    public getAlphaMode(): number {\r\n        return this._alphaMode;\r\n    }\r\n\r\n    public setInt(uniform: WebGLUniformLocation, int: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsInt32(int);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setIntArray(uniform: WebGLUniformLocation, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setIntArray2(uniform: WebGLUniformLocation, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setIntArray3(uniform: WebGLUniformLocation, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setIntArray4(uniform: WebGLUniformLocation, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsInt32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloatArray(uniform: WebGLUniformLocation, array: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloatArray2(uniform: WebGLUniformLocation, array: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloatArray3(uniform: WebGLUniformLocation, array: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloatArray4(uniform: WebGLUniformLocation, array: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(array);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setArray(uniform: WebGLUniformLocation, array: number[]): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        return this.setFloatArray(uniform, new Float32Array(array));\r\n    }\r\n\r\n    public setArray2(uniform: WebGLUniformLocation, array: number[]): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        return this.setFloatArray2(uniform, new Float32Array(array));\r\n    }\r\n\r\n    public setArray3(uniform: WebGLUniformLocation, array: number[]): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        return this.setFloatArray3(uniform, new Float32Array(array));\r\n    }\r\n\r\n    public setArray4(uniform: WebGLUniformLocation, array: number[]): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        return this.setFloatArray4(uniform, new Float32Array(array));\r\n    }\r\n\r\n    public setMatrices(uniform: WebGLUniformLocation, matrices: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrices);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n\r\n        return true;\r\n    }\r\n\r\n    public setMatrix3x3(uniform: WebGLUniformLocation, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrix);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setMatrix2x2(uniform: WebGLUniformLocation, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32s(matrix);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloat(uniform: WebGLUniformLocation, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(value);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloat2(uniform: WebGLUniformLocation, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloat3(uniform: WebGLUniformLocation, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(z);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setFloat4(uniform: WebGLUniformLocation, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(x);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(y);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(z);\r\n        this._commandBufferEncoder.encodeCommandArgAsFloat32(w);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n        return true;\r\n    }\r\n\r\n    public setColor3(uniform: WebGLUniformLocation, color3: IColor3Like): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this.setFloat3(uniform, color3.r, color3.g, color3.b);\r\n        return true;\r\n    }\r\n\r\n    public setColor4(uniform: WebGLUniformLocation, color3: IColor3Like, alpha: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this.setFloat4(uniform, color3.r, color3.g, color3.b, alpha);\r\n        return true;\r\n    }\r\n\r\n    public wipeCaches(bruteForce?: boolean): void {\r\n        if (this.preventCacheWipeBetweenFrames) {\r\n            return;\r\n        }\r\n        this.resetTextureCache();\r\n        this._currentEffect = null;\r\n\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n\r\n            this._stencilStateComposer.reset();\r\n            this._depthCullingState.reset();\r\n            this._alphaState.reset();\r\n        }\r\n\r\n        this._cachedVertexBuffers = null;\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n    }\r\n\r\n    protected _createTexture(): WebGLTexture {\r\n        return this._engine.createTexture();\r\n    }\r\n\r\n    protected _deleteTexture(texture: Nullable<WebGLTexture>): void {\r\n        if (texture) {\r\n            this._engine.deleteTexture(texture);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update the content of a dynamic texture\r\n     * @param texture defines the texture to update\r\n     * @param canvas defines the canvas containing the source\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param premulAlpha defines if alpha is stored as premultiplied\r\n     * @param format defines the format of the data\r\n     */\r\n    public updateDynamicTexture(texture: Nullable<InternalTexture>, canvas: any, invertY: boolean, premulAlpha: boolean = false, format?: number): void {\r\n        if (premulAlpha === void 0) {\r\n            premulAlpha = false;\r\n        }\r\n\r\n        if (!!texture && !!texture._hardwareTexture) {\r\n            const source = canvas.getCanvasTexture();\r\n            const destination = texture._hardwareTexture.underlyingResource;\r\n            this._engine.copyTexture(destination, source);\r\n            texture.isReady = true;\r\n        }\r\n    }\r\n\r\n    public createDynamicTexture(width: number, height: number, generateMipMaps: boolean, samplingMode: number): InternalTexture {\r\n        // it's not possible to create 0x0 texture sized. Many bgfx methods assume texture size is at least 1x1(best case).\r\n        // Worst case is getting a crash/assert.\r\n        width = Math.max(width, 1);\r\n        height = Math.max(height, 1);\r\n        return this.createRawTexture(new Uint8Array(width * height * 4), width, height, Constants.TEXTUREFORMAT_RGBA, false, false, samplingMode);\r\n    }\r\n\r\n    public createVideoElement(constraints: MediaTrackConstraints): any {\r\n        // create native object depending on stream. Only NativeCamera is supported for now.\r\n        if (this._camera) {\r\n            return this._camera.createVideo(constraints);\r\n        }\r\n        return null;\r\n    }\r\n\r\n    public updateVideoTexture(texture: Nullable<InternalTexture>, video: HTMLVideoElement, invertY: boolean): void {\r\n        if (texture && texture._hardwareTexture && this._camera) {\r\n            const webGLTexture = texture._hardwareTexture.underlyingResource;\r\n            this._camera.updateVideoTexture(webGLTexture, video, invertY);\r\n        }\r\n    }\r\n\r\n    public createRawTexture(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        type: number = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        const texture = new InternalTexture(this, InternalTextureSource.Raw);\r\n\r\n        texture.format = format;\r\n        texture.generateMipMaps = generateMipMaps;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = texture.baseWidth;\r\n        texture.height = texture.baseHeight;\r\n        texture._compression = compression;\r\n        texture.type = type;\r\n\r\n        this.updateRawTexture(texture, data, format, invertY, compression, type);\r\n\r\n        if (texture._hardwareTexture) {\r\n            const webGLTexture = texture._hardwareTexture.underlyingResource;\r\n            const filter = this._getNativeSamplingMode(samplingMode);\r\n            this._setTextureSampling(webGLTexture, filter);\r\n        }\r\n\r\n        this._internalTexturesCache.push(texture);\r\n        return texture;\r\n    }\r\n\r\n    public createRawTexture2DArray(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        depth: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        textureType = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        const texture = new InternalTexture(this, InternalTextureSource.Raw2DArray);\r\n\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.baseDepth = depth;\r\n        texture.width = width;\r\n        texture.height = height;\r\n        texture.depth = depth;\r\n        texture.format = format;\r\n        texture.type = textureType;\r\n        texture.generateMipMaps = generateMipMaps;\r\n        texture.samplingMode = samplingMode;\r\n        texture.is2DArray = true;\r\n\r\n        if (texture._hardwareTexture) {\r\n            const webGLTexture = texture._hardwareTexture.underlyingResource;\r\n            this._engine.loadRawTexture2DArray(webGLTexture, data, width, height, depth, this._getNativeTextureFormat(format, textureType), generateMipMaps, invertY);\r\n\r\n            const filter = this._getNativeSamplingMode(samplingMode);\r\n            this._setTextureSampling(webGLTexture, filter);\r\n        }\r\n\r\n        texture.isReady = true;\r\n\r\n        this._internalTexturesCache.push(texture);\r\n        return texture;\r\n    }\r\n\r\n    public updateRawTexture(\r\n        texture: Nullable<InternalTexture>,\r\n        bufferView: Nullable<ArrayBufferView>,\r\n        format: number,\r\n        invertY: boolean,\r\n        compression: Nullable<string> = null,\r\n        type: number = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): void {\r\n        if (!texture) {\r\n            return;\r\n        }\r\n\r\n        if (bufferView && texture._hardwareTexture) {\r\n            const underlyingResource = texture._hardwareTexture.underlyingResource;\r\n            this._engine.loadRawTexture(\r\n                underlyingResource,\r\n                bufferView,\r\n                texture.width,\r\n                texture.height,\r\n                this._getNativeTextureFormat(format, type),\r\n                texture.generateMipMaps,\r\n                texture.invertY\r\n            );\r\n        }\r\n\r\n        texture.isReady = true;\r\n    }\r\n\r\n    // TODO: Refactor to share more logic with babylon.engine.ts version.\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @param creationFlags\r\n     * @param useSRGBBuffer\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    public createTexture(\r\n        url: Nullable<string>,\r\n        noMipmap: boolean,\r\n        invertY: boolean,\r\n        scene: Nullable<ISceneLike>,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,\r\n        onLoad: Nullable<() => void> = null,\r\n        onError: Nullable<(message: string, exception: any) => void> = null,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null,\r\n        mimeType?: string,\r\n        loaderOptions?: any,\r\n        creationFlags?: number,\r\n        useSRGBBuffer = false\r\n    ): InternalTexture {\r\n        url = url || \"\";\r\n        const fromData = url.substr(0, 5) === \"data:\";\r\n        //const fromBlob = url.substr(0, 5) === \"blob:\";\r\n        const isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n\r\n        const texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n\r\n        const originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n\r\n        // establish the file extension, if possible\r\n        const lastDot = url.lastIndexOf(\".\");\r\n        const extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\r\n\r\n        let loader: Nullable<IInternalTextureLoader> = null;\r\n        for (const availableLoader of Engine._TextureLoaders) {\r\n            if (availableLoader.canLoad(extension)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (scene) {\r\n            scene._addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        texture._useSRGBBuffer = this._getUseSRGBBuffer(useSRGBBuffer, noMipmap);\r\n\r\n        if (!this.doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n\r\n        let onLoadObserver: Nullable<Observer<InternalTexture>> = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n\r\n        if (!fallback) {\r\n            this._internalTexturesCache.push(texture);\r\n        }\r\n\r\n        const onInternalError = (message?: string, exception?: any) => {\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\r\n                }\r\n\r\n                if (onError) {\r\n                    onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\r\n                }\r\n            } else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`);\r\n                this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\r\n            }\r\n        };\r\n\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            throw new Error(\"Loading textures from IInternalTextureLoader not yet implemented.\");\r\n        } else {\r\n            const onload = (data: ArrayBufferView) => {\r\n                if (!texture._hardwareTexture) {\r\n                    if (scene) {\r\n                        scene._removePendingData(texture);\r\n                    }\r\n\r\n                    return;\r\n                }\r\n\r\n                const underlyingResource = texture._hardwareTexture.underlyingResource;\r\n\r\n                this._engine.loadTexture(\r\n                    underlyingResource,\r\n                    data,\r\n                    !noMipmap,\r\n                    invertY,\r\n                    useSRGBBuffer,\r\n                    () => {\r\n                        texture.baseWidth = this._engine.getTextureWidth(underlyingResource);\r\n                        texture.baseHeight = this._engine.getTextureHeight(underlyingResource);\r\n                        texture.width = texture.baseWidth;\r\n                        texture.height = texture.baseHeight;\r\n                        texture.isReady = true;\r\n\r\n                        const filter = this._getNativeSamplingMode(samplingMode);\r\n                        this._setTextureSampling(underlyingResource, filter);\r\n\r\n                        if (scene) {\r\n                            scene._removePendingData(texture);\r\n                        }\r\n\r\n                        texture.onLoadedObservable.notifyObservers(texture);\r\n                        texture.onLoadedObservable.clear();\r\n                    },\r\n                    () => {\r\n                        throw new Error(\"Could not load a native texture.\");\r\n                    }\r\n                );\r\n            };\r\n\r\n            if (fromData && buffer) {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    onload(new Uint8Array(buffer));\r\n                } else if (ArrayBuffer.isView(buffer)) {\r\n                    onload(buffer);\r\n                } else if (typeof buffer === \"string\") {\r\n                    onload(new Uint8Array(Tools.DecodeBase64(buffer)));\r\n                } else {\r\n                    throw new Error(\"Unsupported buffer type\");\r\n                }\r\n            } else {\r\n                if (isBase64) {\r\n                    onload(new Uint8Array(Tools.DecodeBase64(url)));\r\n                } else {\r\n                    this._loadFile(\r\n                        url,\r\n                        (data) => onload(new Uint8Array(data as ArrayBuffer)),\r\n                        undefined,\r\n                        undefined,\r\n                        true,\r\n                        (request?: IWebRequest, exception?: any) => {\r\n                            onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                        }\r\n                    );\r\n                }\r\n            }\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * Wraps an external native texture in a Babylon texture.\r\n     * @param texture defines the external texture\r\n     * @returns the babylon internal texture\r\n     */\r\n    wrapNativeTexture(texture: any): InternalTexture {\r\n        // Currently native is using the WebGL wrapper\r\n        const hardwareTexture = new WebGLHardwareTexture(texture, this._gl);\r\n        const internalTexture = new InternalTexture(this, InternalTextureSource.Unknown, true);\r\n        internalTexture._hardwareTexture = hardwareTexture;\r\n        internalTexture.isReady = true;\r\n        return internalTexture;\r\n    }\r\n\r\n    /**\r\n     * Wraps an external web gl texture in a Babylon texture.\r\n     * @returns the babylon internal texture\r\n     */\r\n    wrapWebGLTexture(): InternalTexture {\r\n        throw new Error(\"wrapWebGLTexture is not supported, use wrapNativeTexture instead.\");\r\n    }\r\n\r\n    public _createDepthStencilTexture(size: TextureSize, options: DepthTextureCreationOptions, rtWrapper: RenderTargetWrapper): InternalTexture {\r\n        const nativeRTWrapper = rtWrapper as NativeRenderTargetWrapper;\r\n        const texture = new InternalTexture(this, InternalTextureSource.DepthStencil);\r\n\r\n        const width = (<{ width: number; height: number; layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number; layers?: number }>size).height || <number>size;\r\n\r\n        const framebuffer = this._engine.createFrameBuffer(texture._hardwareTexture!.underlyingResource, width, height, _native.Engine.TEXTURE_FORMAT_RGBA8, false, true, false);\r\n        nativeRTWrapper._framebufferDepthStencil = framebuffer;\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * @param framebuffer\r\n     * @hidden\r\n     */\r\n    public _releaseFramebufferObjects(framebuffer: Nullable<WebGLFramebuffer>): void {\r\n        if (framebuffer) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(framebuffer as NativeData);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    /**\r\n     * Engine abstraction for loading and creating an image bitmap from a given source string.\r\n     * @param imageSource source to load the image from.\r\n     * @param options An object that sets options for the image's extraction.\r\n     * @returns ImageBitmap\r\n     */\r\n    public _createImageBitmapFromSource(imageSource: string, options?: ImageBitmapOptions): Promise<ImageBitmap> {\r\n        const promise = new Promise<ImageBitmap>((resolve, reject) => {\r\n            const image = this.createCanvasImage();\r\n            image.onload = () => {\r\n                try {\r\n                    const imageBitmap = this._engine.createImageBitmap(image);\r\n                    resolve(imageBitmap);\r\n                } catch (error) {\r\n                    reject(`Error loading image ${image.src} with exception: ${error}`);\r\n                }\r\n            };\r\n            image.onerror = (error) => {\r\n                reject(`Error loading image ${image.src} with exception: ${error}`);\r\n            };\r\n\r\n            image.src = imageSource;\r\n        });\r\n\r\n        return promise;\r\n    }\r\n\r\n    /**\r\n     * Engine abstraction for createImageBitmap\r\n     * @param image source for image\r\n     * @param options An object that sets options for the image's extraction.\r\n     * @returns ImageBitmap\r\n     */\r\n    public createImageBitmap(image: ImageBitmapSource, options?: ImageBitmapOptions): Promise<ImageBitmap> {\r\n        return new Promise((resolve, reject) => {\r\n            if (Array.isArray(image)) {\r\n                const arr = <Array<ArrayBufferView>>image;\r\n                if (arr.length) {\r\n                    const image = this._engine.createImageBitmap(arr[0]);\r\n                    if (image) {\r\n                        resolve(image);\r\n                        return;\r\n                    }\r\n                }\r\n            }\r\n            reject(`Unsupported data for createImageBitmap.`);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Resize an image and returns the image data as an uint8array\r\n     * @param image image to resize\r\n     * @param bufferWidth destination buffer width\r\n     * @param bufferHeight destination buffer height\r\n     * @returns an uint8array containing RGBA values of bufferWidth * bufferHeight size\r\n     */\r\n    public resizeImageBitmap(image: ImageBitmap, bufferWidth: number, bufferHeight: number): Uint8Array {\r\n        return this._engine.resizeImageBitmap(image, bufferWidth, bufferHeight);\r\n    }\r\n\r\n    /**\r\n     * Creates a cube texture\r\n     * @param rootUrl defines the url where the files to load is located\r\n     * @param scene defines the current scene\r\n     * @param files defines the list of files to load (1 per face)\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated (false by default)\r\n     * @param onLoad defines an optional callback raised when the texture is loaded\r\n     * @param onError defines an optional callback raised if there is an issue to load the texture\r\n     * @param format defines the format of the data\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param createPolynomials if a polynomial sphere should be created for the cube texture\r\n     * @param lodScale defines the scale applied to environment texture. This manages the range of LOD level used for IBL according to the roughness\r\n     * @param lodOffset defines the offset applied to environment texture. This manages first LOD level used for IBL according to the roughness\r\n     * @param fallback defines texture to use while falling back when (compressed) texture file not found.\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    public createCubeTexture(\r\n        rootUrl: string,\r\n        scene: Nullable<Scene>,\r\n        files: Nullable<string[]>,\r\n        noMipmap?: boolean,\r\n        onLoad: Nullable<(data?: any) => void> = null,\r\n        onError: Nullable<(message?: string, exception?: any) => void> = null,\r\n        format?: number,\r\n        forcedExtension: any = null,\r\n        createPolynomials = false,\r\n        lodScale: number = 0,\r\n        lodOffset: number = 0,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        loaderOptions?: any,\r\n        useSRGBBuffer = false\r\n    ): InternalTexture {\r\n        const texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Cube);\r\n        texture.isCube = true;\r\n        texture.url = rootUrl;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture._lodGenerationScale = lodScale;\r\n        texture._lodGenerationOffset = lodOffset;\r\n\r\n        if (!this._doNotHandleContextLost) {\r\n            texture._extension = forcedExtension;\r\n            texture._files = files;\r\n        }\r\n\r\n        const lastDot = rootUrl.lastIndexOf(\".\");\r\n        const extension = forcedExtension ? forcedExtension : lastDot > -1 ? rootUrl.substring(lastDot).toLowerCase() : \"\";\r\n\r\n        // TODO: use texture loader to load env files?\r\n        if (extension === \".env\") {\r\n            const onloaddata = (data: ArrayBufferView) => {\r\n                const info = GetEnvInfo(data)!;\r\n                texture.width = info.width;\r\n                texture.height = info.width;\r\n\r\n                UploadEnvSpherical(texture, info);\r\n\r\n                const specularInfo = info.specular as EnvironmentTextureSpecularInfoV1;\r\n                if (!specularInfo) {\r\n                    throw new Error(`Nothing else parsed so far`);\r\n                }\r\n\r\n                texture._lodGenerationScale = specularInfo.lodGenerationScale;\r\n                const imageData = CreateImageDataArrayBufferViews(data, info);\r\n\r\n                texture.format = Constants.TEXTUREFORMAT_RGBA;\r\n                texture.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n                texture.generateMipMaps = true;\r\n                texture.getEngine().updateTextureSamplingMode(Texture.TRILINEAR_SAMPLINGMODE, texture);\r\n                texture._isRGBD = true;\r\n                texture.invertY = true;\r\n\r\n                this._engine.loadCubeTextureWithMips(\r\n                    texture._hardwareTexture!.underlyingResource,\r\n                    imageData,\r\n                    false,\r\n                    useSRGBBuffer,\r\n                    () => {\r\n                        texture.isReady = true;\r\n                        if (onLoad) {\r\n                            onLoad();\r\n                        }\r\n                    },\r\n                    () => {\r\n                        throw new Error(\"Could not load a native cube texture.\");\r\n                    }\r\n                );\r\n            };\r\n\r\n            if (files && files.length === 6) {\r\n                throw new Error(`Multi-file loading not allowed on env files.`);\r\n            } else {\r\n                const onInternalError = (request?: IWebRequest, exception?: any) => {\r\n                    if (onError && request) {\r\n                        onError(request.status + \" \" + request.statusText, exception);\r\n                    }\r\n                };\r\n\r\n                this._loadFile(rootUrl, (data) => onloaddata(new Uint8Array(data as ArrayBuffer)), undefined, undefined, true, onInternalError);\r\n            }\r\n        } else {\r\n            if (!files || files.length !== 6) {\r\n                throw new Error(\"Cannot load cubemap because 6 files were not defined\");\r\n            }\r\n\r\n            // Reorder from [+X, +Y, +Z, -X, -Y, -Z] to [+X, -X, +Y, -Y, +Z, -Z].\r\n            const reorderedFiles = [files[0], files[3], files[1], files[4], files[2], files[5]];\r\n            Promise.all(reorderedFiles.map((file) => Tools.LoadFileAsync(file).then((data) => new Uint8Array(data as ArrayBuffer))))\r\n                .then((data) => {\r\n                    return new Promise<void>((resolve, reject) => {\r\n                        this._engine.loadCubeTexture(texture._hardwareTexture!.underlyingResource, data, !noMipmap, true, useSRGBBuffer, resolve, reject);\r\n                    });\r\n                })\r\n                .then(\r\n                    () => {\r\n                        texture.isReady = true;\r\n                        if (onLoad) {\r\n                            onLoad();\r\n                        }\r\n                    },\r\n                    (error) => {\r\n                        if (onError) {\r\n                            onError(`Failed to load cubemap: ${error.message}`, error);\r\n                        }\r\n                    }\r\n                );\r\n        }\r\n\r\n        this._internalTexturesCache.push(texture);\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * @param isMulti\r\n     * @param isCube\r\n     * @param size\r\n     * @hidden\r\n     */\r\n    public _createHardwareRenderTargetWrapper(isMulti: boolean, isCube: boolean, size: TextureSize): RenderTargetWrapper {\r\n        const rtWrapper = new NativeRenderTargetWrapper(isMulti, isCube, size, this);\r\n        this._renderTargetWrapperCache.push(rtWrapper);\r\n        return rtWrapper;\r\n    }\r\n\r\n    public createRenderTargetTexture(size: number | { width: number; height: number }, options: boolean | RenderTargetCreationOptions): RenderTargetWrapper {\r\n        const rtWrapper = this._createHardwareRenderTargetWrapper(false, false, size) as NativeRenderTargetWrapper;\r\n\r\n        const fullOptions: RenderTargetCreationOptions = {};\r\n\r\n        if (options !== undefined && typeof options === \"object\") {\r\n            fullOptions.generateMipMaps = options.generateMipMaps;\r\n            fullOptions.generateDepthBuffer = options.generateDepthBuffer === undefined ? true : options.generateDepthBuffer;\r\n            fullOptions.generateStencilBuffer = fullOptions.generateDepthBuffer && options.generateStencilBuffer;\r\n            fullOptions.type = options.type === undefined ? Constants.TEXTURETYPE_UNSIGNED_INT : options.type;\r\n            fullOptions.samplingMode = options.samplingMode === undefined ? Constants.TEXTURE_TRILINEAR_SAMPLINGMODE : options.samplingMode;\r\n            fullOptions.format = options.format === undefined ? Constants.TEXTUREFORMAT_RGBA : options.format;\r\n        } else {\r\n            fullOptions.generateMipMaps = <boolean>options;\r\n            fullOptions.generateDepthBuffer = true;\r\n            fullOptions.generateStencilBuffer = false;\r\n            fullOptions.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n            fullOptions.samplingMode = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE;\r\n            fullOptions.format = Constants.TEXTUREFORMAT_RGBA;\r\n        }\r\n\r\n        if (fullOptions.type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloatLinearFiltering) {\r\n            // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        } else if (fullOptions.type === Constants.TEXTURETYPE_HALF_FLOAT && !this._caps.textureHalfFloatLinearFiltering) {\r\n            // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        }\r\n        const texture = new InternalTexture(this, InternalTextureSource.RenderTarget);\r\n\r\n        const width = (<{ width: number; height: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number }>size).height || <number>size;\r\n\r\n        if (fullOptions.type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloat) {\r\n            fullOptions.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n            Logger.Warn(\"Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type\");\r\n        }\r\n\r\n        const framebuffer = this._engine.createFrameBuffer(\r\n            texture._hardwareTexture!.underlyingResource,\r\n            width,\r\n            height,\r\n            this._getNativeTextureFormat(fullOptions.format, fullOptions.type),\r\n            fullOptions.generateStencilBuffer ? true : false,\r\n            fullOptions.generateDepthBuffer,\r\n            fullOptions.generateMipMaps ? true : false\r\n        );\r\n\r\n        rtWrapper._framebuffer = framebuffer;\r\n        rtWrapper._generateDepthBuffer = fullOptions.generateDepthBuffer;\r\n        rtWrapper._generateStencilBuffer = fullOptions.generateStencilBuffer ? true : false;\r\n\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = width;\r\n        texture.height = height;\r\n        texture.isReady = true;\r\n        texture.samples = 1;\r\n        texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\r\n        texture.samplingMode = fullOptions.samplingMode;\r\n        texture.type = fullOptions.type;\r\n        texture.format = fullOptions.format;\r\n\r\n        this._internalTexturesCache.push(texture);\r\n        rtWrapper.setTextures(texture);\r\n\r\n        return rtWrapper;\r\n    }\r\n\r\n    public updateTextureSamplingMode(samplingMode: number, texture: InternalTexture): void {\r\n        if (texture._hardwareTexture) {\r\n            const filter = this._getNativeSamplingMode(samplingMode);\r\n            this._setTextureSampling(texture._hardwareTexture.underlyingResource, filter);\r\n        }\r\n        texture.samplingMode = samplingMode;\r\n    }\r\n\r\n    public bindFramebuffer(texture: RenderTargetWrapper, faceIndex?: number, requiredWidth?: number, requiredHeight?: number, forceFullscreenViewport?: boolean): void {\r\n        const nativeRTWrapper = texture as NativeRenderTargetWrapper;\r\n\r\n        if (faceIndex) {\r\n            throw new Error(\"Cuboid frame buffers are not yet supported in NativeEngine.\");\r\n        }\r\n\r\n        if (requiredWidth || requiredHeight) {\r\n            throw new Error(\"Required width/height for frame buffers not yet supported in NativeEngine.\");\r\n        }\r\n\r\n        if (forceFullscreenViewport) {\r\n            //Not supported yet but don't stop rendering\r\n        }\r\n\r\n        if (nativeRTWrapper._framebufferDepthStencil) {\r\n            this._bindUnboundFramebuffer(nativeRTWrapper._framebufferDepthStencil);\r\n        } else {\r\n            this._bindUnboundFramebuffer(nativeRTWrapper._framebuffer);\r\n        }\r\n    }\r\n\r\n    public unBindFramebuffer(texture: RenderTargetWrapper, disableGenerateMipMaps = false, onBeforeUnbind?: () => void): void {\r\n        // NOTE: Disabling mipmap generation is not yet supported in NativeEngine.\r\n\r\n        if (onBeforeUnbind) {\r\n            onBeforeUnbind();\r\n        }\r\n\r\n        this._bindUnboundFramebuffer(null);\r\n    }\r\n\r\n    public createDynamicVertexBuffer(data: DataArray): DataBuffer {\r\n        return this.createVertexBuffer(data, true);\r\n    }\r\n\r\n    public updateDynamicIndexBuffer(indexBuffer: DataBuffer, indices: IndicesArray, offset: number = 0): void {\r\n        const buffer = indexBuffer as NativeDataBuffer;\r\n        const data = this._normalizeIndexData(indices);\r\n        buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\r\n        this._engine.updateDynamicIndexBuffer(buffer.nativeIndexBuffer!, data.buffer, data.byteOffset, data.byteLength, offset);\r\n    }\r\n\r\n    public updateDynamicVertexBuffer(vertexBuffer: DataBuffer, verticies: DataArray, byteOffset?: number, byteLength?: number): void {\r\n        const buffer = vertexBuffer as NativeDataBuffer;\r\n        const data = ArrayBuffer.isView(verticies) ? verticies : new Float32Array(verticies);\r\n        this._engine.updateDynamicVertexBuffer(buffer.nativeVertexBuffer!, data.buffer, data.byteOffset + (byteOffset ?? 0), byteLength ?? data.byteLength);\r\n    }\r\n\r\n    // TODO: Refactor to share more logic with base Engine implementation.\r\n    protected _setTexture(channel: number, texture: Nullable<BaseTexture>, isPartOfTextureArray = false, depthStencilTexture = false): boolean {\r\n        const uniform = this._boundUniforms[channel];\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._setTextureCore(uniform, null);\r\n            }\r\n            return false;\r\n        }\r\n\r\n        // Video\r\n        if ((<VideoTexture>texture).video) {\r\n            this._activeChannel = channel;\r\n            (<VideoTexture>texture).update();\r\n        } else if (texture.delayLoadState === Constants.DELAYLOADSTATE_NOTLOADED) {\r\n            // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n\r\n        let internalTexture: InternalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = (<RenderTargetTexture>texture).depthStencilTexture!;\r\n        } else if (texture.isReady()) {\r\n            internalTexture = <InternalTexture>texture.getInternalTexture();\r\n        } else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        } else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        } else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        } else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n\r\n        if (!internalTexture || !internalTexture._hardwareTexture) {\r\n            return false;\r\n        }\r\n\r\n        this._setTextureWrapMode(\r\n            internalTexture._hardwareTexture.underlyingResource,\r\n            this._getAddressMode(texture.wrapU),\r\n            this._getAddressMode(texture.wrapV),\r\n            this._getAddressMode(texture.wrapR)\r\n        );\r\n        this._updateAnisotropicLevel(texture);\r\n\r\n        this._setTextureCore(uniform, internalTexture._hardwareTexture.underlyingResource);\r\n\r\n        return true;\r\n    }\r\n\r\n    // filter is a NativeFilter.XXXX value.\r\n    private _setTextureSampling(texture: WebGLTexture, filter: number) {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(texture as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(filter);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    // addressModes are NativeAddressMode.XXXX values.\r\n    private _setTextureWrapMode(texture: WebGLTexture, addressModeU: number, addressModeV: number, addressModeW: number) {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(texture as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeU);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeV);\r\n        this._commandBufferEncoder.encodeCommandArgAsUInt32(addressModeW);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    private _setTextureCore(uniform: WebGLUniformLocation, texture: Nullable<WebGLTexture>) {\r\n        this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(uniform as any as NativeData);\r\n        this._commandBufferEncoder.encodeCommandArgAsNativeData(texture as NativeData);\r\n        this._commandBufferEncoder.finishEncodingCommand();\r\n    }\r\n\r\n    // TODO: Share more of this logic with the base implementation.\r\n    // TODO: Rename to match naming in base implementation once refactoring allows different parameters.\r\n    private _updateAnisotropicLevel(texture: BaseTexture) {\r\n        const internalTexture = texture.getInternalTexture();\r\n        const value = texture.anisotropicFilteringLevel;\r\n\r\n        if (!internalTexture || !internalTexture._hardwareTexture) {\r\n            return;\r\n        }\r\n\r\n        if (internalTexture._cachedAnisotropicFilteringLevel !== value) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(internalTexture._hardwareTexture.underlyingResource);\r\n            this._commandBufferEncoder.encodeCommandArgAsUInt32(value);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n            internalTexture._cachedAnisotropicFilteringLevel = value;\r\n        }\r\n    }\r\n\r\n    // Returns a NativeAddressMode.XXX value.\r\n    private _getAddressMode(wrapMode: number): number {\r\n        switch (wrapMode) {\r\n            case Constants.TEXTURE_WRAP_ADDRESSMODE:\r\n                return _native.Engine.ADDRESS_MODE_WRAP;\r\n            case Constants.TEXTURE_CLAMP_ADDRESSMODE:\r\n                return _native.Engine.ADDRESS_MODE_CLAMP;\r\n            case Constants.TEXTURE_MIRROR_ADDRESSMODE:\r\n                return _native.Engine.ADDRESS_MODE_MIRROR;\r\n            default:\r\n                throw new Error(\"Unexpected wrap mode: \" + wrapMode + \".\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param channel\r\n     * @param texture\r\n     * @hidden\r\n     */\r\n    public _bindTexture(channel: number, texture: InternalTexture): void {\r\n        const uniform = this._boundUniforms[channel];\r\n        if (!uniform) {\r\n            return;\r\n        }\r\n        if (texture && texture._hardwareTexture) {\r\n            const underlyingResource = texture._hardwareTexture.underlyingResource;\r\n            this._setTextureCore(uniform, underlyingResource);\r\n        }\r\n    }\r\n\r\n    protected _deleteBuffer(buffer: NativeDataBuffer): void {\r\n        if (buffer.nativeIndexBuffer) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(buffer.nativeIndexBuffer);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n            delete buffer.nativeIndexBuffer;\r\n        }\r\n\r\n        if (buffer.nativeVertexBuffer) {\r\n            this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER);\r\n            this._commandBufferEncoder.encodeCommandArgAsNativeData(buffer.nativeVertexBuffer);\r\n            this._commandBufferEncoder.finishEncodingCommand();\r\n            delete buffer.nativeVertexBuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create a canvas\r\n     * @param width width\r\n     * @param height height\r\n     * @return ICanvas interface\r\n     */\r\n    public createCanvas(width: number, height: number): ICanvas {\r\n        if (!_native.Canvas) {\r\n            throw new Error(\"Native Canvas plugin not available.\");\r\n        }\r\n        const canvas = new _native.Canvas();\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        return canvas;\r\n    }\r\n\r\n    /**\r\n     * Create an image to use with canvas\r\n     * @return IImage interface\r\n     */\r\n    public createCanvasImage(): IImage {\r\n        if (!_native.Canvas) {\r\n            throw new Error(\"Native Canvas plugin not available.\");\r\n        }\r\n        const image = new _native.Image();\r\n        return image;\r\n    }\r\n\r\n    /**\r\n     * Update a portion of an internal texture\r\n     * @param texture defines the texture to update\r\n     * @param imageData defines the data to store into the texture\r\n     * @param xOffset defines the x coordinates of the update rectangle\r\n     * @param yOffset defines the y coordinates of the update rectangle\r\n     * @param width defines the width of the update rectangle\r\n     * @param height defines the height of the update rectangle\r\n     * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n     * @param lod defines the lod level to update (0 by default)\r\n     * @param generateMipMaps defines whether to generate mipmaps or not\r\n     */\r\n    public updateTextureData(\r\n        texture: InternalTexture,\r\n        imageData: ArrayBufferView,\r\n        xOffset: number,\r\n        yOffset: number,\r\n        width: number,\r\n        height: number,\r\n        faceIndex: number = 0,\r\n        lod: number = 0,\r\n        generateMipMaps = false\r\n    ): void {\r\n        throw new Error(\"updateTextureData not implemented.\");\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param internalFormat\r\n     * @param width\r\n     * @param height\r\n     * @param data\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadCompressedDataToTextureDirectly(\r\n        texture: InternalTexture,\r\n        internalFormat: number,\r\n        width: number,\r\n        height: number,\r\n        data: ArrayBufferView,\r\n        faceIndex: number = 0,\r\n        lod: number = 0\r\n    ) {\r\n        throw new Error(\"_uploadCompressedDataToTextureDirectly not implemented.\");\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param imageData\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadDataToTextureDirectly(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0): void {\r\n        throw new Error(\"_uploadDataToTextureDirectly not implemented.\");\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param imageData\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadArrayBufferViewToTexture(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0): void {\r\n        throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param image\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadImageToTexture(texture: InternalTexture, image: HTMLImageElement, faceIndex: number = 0, lod: number = 0) {\r\n        throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\r\n    }\r\n\r\n    // JavaScript-to-Native conversion helper functions.\r\n\r\n    private _getNativeSamplingMode(samplingMode: number): number {\r\n        switch (samplingMode) {\r\n            case Constants.TEXTURE_NEAREST_NEAREST:\r\n                return _native.Engine.TEXTURE_NEAREST_NEAREST;\r\n            case Constants.TEXTURE_LINEAR_LINEAR:\r\n                return _native.Engine.TEXTURE_LINEAR_LINEAR;\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR:\r\n                return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPNEAREST:\r\n                return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPNEAREST:\r\n                return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPLINEAR:\r\n                return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;\r\n            case Constants.TEXTURE_NEAREST_LINEAR:\r\n                return _native.Engine.TEXTURE_NEAREST_LINEAR;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPLINEAR:\r\n                return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPNEAREST:\r\n                return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPLINEAR:\r\n                return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST:\r\n                return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;\r\n            case Constants.TEXTURE_LINEAR_NEAREST:\r\n                return _native.Engine.TEXTURE_LINEAR_NEAREST;\r\n            default:\r\n                throw new Error(`Unsupported sampling mode: ${samplingMode}.`);\r\n        }\r\n    }\r\n\r\n    private _getStencilFunc(func: number): number {\r\n        switch (func) {\r\n            case Constants.LESS:\r\n                return _native.Engine.STENCIL_TEST_LESS;\r\n            case Constants.LEQUAL:\r\n                return _native.Engine.STENCIL_TEST_LEQUAL;\r\n            case Constants.EQUAL:\r\n                return _native.Engine.STENCIL_TEST_EQUAL;\r\n            case Constants.GEQUAL:\r\n                return _native.Engine.STENCIL_TEST_GEQUAL;\r\n            case Constants.GREATER:\r\n                return _native.Engine.STENCIL_TEST_GREATER;\r\n            case Constants.NOTEQUAL:\r\n                return _native.Engine.STENCIL_TEST_NOTEQUAL;\r\n            case Constants.NEVER:\r\n                return _native.Engine.STENCIL_TEST_NEVER;\r\n            case Constants.ALWAYS:\r\n                return _native.Engine.STENCIL_TEST_ALWAYS;\r\n            default:\r\n                throw new Error(`Unsupported stencil func mode: ${func}.`);\r\n        }\r\n    }\r\n\r\n    private _getStencilOpFail(opFail: number): number {\r\n        switch (opFail) {\r\n            case Constants.KEEP:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_KEEP;\r\n            case Constants.ZERO:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_ZERO;\r\n            case Constants.REPLACE:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;\r\n            case Constants.INCR:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_INCR;\r\n            case Constants.DECR:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_DECR;\r\n            case Constants.INVERT:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_INVERT;\r\n            case Constants.INCR_WRAP:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;\r\n            case Constants.DECR_WRAP:\r\n                return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;\r\n            default:\r\n                throw new Error(`Unsupported stencil OpFail mode: ${opFail}.`);\r\n        }\r\n    }\r\n\r\n    private _getStencilDepthFail(depthFail: number): number {\r\n        switch (depthFail) {\r\n            case Constants.KEEP:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;\r\n            case Constants.ZERO:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;\r\n            case Constants.REPLACE:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;\r\n            case Constants.INCR:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_INCR;\r\n            case Constants.DECR:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_DECR;\r\n            case Constants.INVERT:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;\r\n            case Constants.INCR_WRAP:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;\r\n            case Constants.DECR_WRAP:\r\n                return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;\r\n            default:\r\n                throw new Error(`Unsupported stencil depthFail mode: ${depthFail}.`);\r\n        }\r\n    }\r\n\r\n    private _getStencilDepthPass(opPass: number): number {\r\n        switch (opPass) {\r\n            case Constants.KEEP:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_KEEP;\r\n            case Constants.ZERO:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_ZERO;\r\n            case Constants.REPLACE:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;\r\n            case Constants.INCR:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_INCR;\r\n            case Constants.DECR:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_DECR;\r\n            case Constants.INVERT:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_INVERT;\r\n            case Constants.INCR_WRAP:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;\r\n            case Constants.DECR_WRAP:\r\n                return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;\r\n            default:\r\n                throw new Error(`Unsupported stencil opPass mode: ${opPass}.`);\r\n        }\r\n    }\r\n\r\n    private _getNativeTextureFormat(format: number, type: number): number {\r\n        if (format == Constants.TEXTUREFORMAT_RGB && type == Constants.TEXTURETYPE_UNSIGNED_INT) {\r\n            return _native.Engine.TEXTURE_FORMAT_RGB8;\r\n        } else if (format == Constants.TEXTUREFORMAT_RGBA && type == Constants.TEXTURETYPE_UNSIGNED_INT) {\r\n            return _native.Engine.TEXTURE_FORMAT_RGBA8;\r\n        } else if (format == Constants.TEXTUREFORMAT_RGBA && type == Constants.TEXTURETYPE_FLOAT) {\r\n            return _native.Engine.TEXTURE_FORMAT_RGBA32F;\r\n        } else {\r\n            throw new RuntimeError(`Unsupported texture format or type: format ${format}, type ${type}.`, ErrorCodes.UnsupportedTextureError);\r\n        }\r\n    }\r\n\r\n    private _getNativeAlphaMode(mode: number): number {\r\n        switch (mode) {\r\n            case Constants.ALPHA_DISABLE:\r\n                return _native.Engine.ALPHA_DISABLE;\r\n            case Constants.ALPHA_ADD:\r\n                return _native.Engine.ALPHA_ADD;\r\n            case Constants.ALPHA_COMBINE:\r\n                return _native.Engine.ALPHA_COMBINE;\r\n            case Constants.ALPHA_SUBTRACT:\r\n                return _native.Engine.ALPHA_SUBTRACT;\r\n            case Constants.ALPHA_MULTIPLY:\r\n                return _native.Engine.ALPHA_MULTIPLY;\r\n            case Constants.ALPHA_MAXIMIZED:\r\n                return _native.Engine.ALPHA_MAXIMIZED;\r\n            case Constants.ALPHA_ONEONE:\r\n                return _native.Engine.ALPHA_ONEONE;\r\n            case Constants.ALPHA_PREMULTIPLIED:\r\n                return _native.Engine.ALPHA_PREMULTIPLIED;\r\n            case Constants.ALPHA_PREMULTIPLIED_PORTERDUFF:\r\n                return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;\r\n            case Constants.ALPHA_INTERPOLATE:\r\n                return _native.Engine.ALPHA_INTERPOLATE;\r\n            case Constants.ALPHA_SCREENMODE:\r\n                return _native.Engine.ALPHA_SCREENMODE;\r\n            default:\r\n                throw new Error(`Unsupported alpha mode: ${mode}.`);\r\n        }\r\n    }\r\n\r\n    private _getNativeAttribType(type: number): number {\r\n        switch (type) {\r\n            case VertexBuffer.BYTE:\r\n                return _native.Engine.ATTRIB_TYPE_INT8;\r\n            case VertexBuffer.UNSIGNED_BYTE:\r\n                return _native.Engine.ATTRIB_TYPE_UINT8;\r\n            case VertexBuffer.SHORT:\r\n                return _native.Engine.ATTRIB_TYPE_INT16;\r\n            case VertexBuffer.UNSIGNED_SHORT:\r\n                return _native.Engine.ATTRIB_TYPE_UINT16;\r\n            case VertexBuffer.FLOAT:\r\n                return _native.Engine.ATTRIB_TYPE_FLOAT;\r\n            default:\r\n                throw new Error(`Unsupported attribute type: ${type}.`);\r\n        }\r\n    }\r\n\r\n    public getFontOffset(font: string): { ascent: number; height: number; descent: number } {\r\n        // TODO\r\n        const result = { ascent: 0, height: 0, descent: 0 };\r\n        return result;\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}