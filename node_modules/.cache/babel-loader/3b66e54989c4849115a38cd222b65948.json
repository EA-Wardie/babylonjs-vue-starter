{"ast":null,"code":"import _typeof from \"/home/ea/Development/Babylon/red/node_modules/@babel/runtime/helpers/esm/typeof.js\";\nimport \"core-js/modules/es.array.index-of.js\";\nimport \"core-js/modules/es.regexp.constructor.js\";\nimport \"core-js/modules/es.regexp.dot-all.js\";\nimport \"core-js/modules/es.regexp.exec.js\";\nimport \"core-js/modules/es.regexp.sticky.js\";\nimport \"core-js/modules/es.regexp.to-string.js\";\nimport \"core-js/modules/es.regexp.test.js\";\nimport \"core-js/modules/es.parse-int.js\";\nimport \"core-js/modules/es.function.bind.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.object.define-property.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.array-buffer.slice.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.typed-array.uint8-array.js\";\nimport \"core-js/modules/es.typed-array.at.js\";\nimport \"core-js/modules/es.typed-array.copy-within.js\";\nimport \"core-js/modules/es.typed-array.every.js\";\nimport \"core-js/modules/es.typed-array.fill.js\";\nimport \"core-js/modules/es.typed-array.filter.js\";\nimport \"core-js/modules/es.typed-array.find.js\";\nimport \"core-js/modules/es.typed-array.find-index.js\";\nimport \"core-js/modules/es.typed-array.for-each.js\";\nimport \"core-js/modules/es.typed-array.includes.js\";\nimport \"core-js/modules/es.typed-array.index-of.js\";\nimport \"core-js/modules/es.typed-array.iterator.js\";\nimport \"core-js/modules/es.typed-array.join.js\";\nimport \"core-js/modules/es.typed-array.last-index-of.js\";\nimport \"core-js/modules/es.typed-array.map.js\";\nimport \"core-js/modules/es.typed-array.reduce.js\";\nimport \"core-js/modules/es.typed-array.reduce-right.js\";\nimport \"core-js/modules/es.typed-array.reverse.js\";\nimport \"core-js/modules/es.typed-array.set.js\";\nimport \"core-js/modules/es.typed-array.slice.js\";\nimport \"core-js/modules/es.typed-array.some.js\";\nimport \"core-js/modules/es.typed-array.sort.js\";\nimport \"core-js/modules/es.typed-array.subarray.js\";\nimport \"core-js/modules/es.typed-array.to-locale-string.js\";\nimport \"core-js/modules/es.typed-array.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.array.slice.js\";\nimport \"core-js/modules/es.array.splice.js\";\nimport \"core-js/modules/es.typed-array.float32-array.js\";\nimport \"core-js/modules/es.typed-array.uint32-array.js\";\nimport \"core-js/modules/es.typed-array.uint16-array.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.string.substr.js\";\nimport \"core-js/modules/es.array.last-index-of.js\";\nimport \"core-js/modules/es.string.split.js\";\nimport \"core-js/modules/es.array-buffer.constructor.js\";\nimport \"core-js/modules/es.array-buffer.is-view.js\";\nimport \"core-js/modules/es.typed-array.int32-array.js\";\nimport { __awaiter, __generator } from \"tslib\";\n/* eslint-disable @typescript-eslint/no-unused-vars */\n\nimport { EngineStore } from \"./engineStore.js\";\nimport { Effect } from \"../Materials/effect.js\";\nimport { _WarnImport } from \"../Misc/devTools.js\";\nimport { Observable } from \"../Misc/observable.js\";\nimport { DepthCullingState } from \"../States/depthCullingState.js\";\nimport { StencilState } from \"../States/stencilState.js\";\nimport { AlphaState } from \"../States/alphaCullingState.js\";\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture.js\";\nimport { Logger } from \"../Misc/logger.js\";\nimport { IsDocumentAvailable, IsWindowObjectExist } from \"../Misc/domManagement.js\";\nimport { WebGLShaderProcessor } from \"./WebGL/webGLShaderProcessors.js\";\nimport { WebGL2ShaderProcessor } from \"./WebGL/webGL2ShaderProcessors.js\";\nimport { WebGLDataBuffer } from \"../Meshes/WebGL/webGLDataBuffer.js\";\nimport { WebGLPipelineContext } from \"./WebGL/webGLPipelineContext.js\";\nimport { PerformanceConfigurator } from \"./performanceConfigurator.js\";\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture.js\";\nimport { DrawWrapper } from \"../Materials/drawWrapper.js\";\nimport { StencilStateComposer } from \"../States/stencilStateComposer.js\";\nimport { ShaderLanguage } from \"../Materials/shaderLanguage.js\";\n/**\n * Keeps track of all the buffer info used in engine.\n */\n\nvar BufferPointer =\n/** @class */\nfunction () {\n  function BufferPointer() {}\n\n  return BufferPointer;\n}();\n/**\n * The base engine class (root of all engines)\n */\n\n\nvar ThinEngine =\n/** @class */\nfunction () {\n  /**\n   * Creates a new engine\n   * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which already used the WebGL context\n   * @param antialias defines enable antialiasing (default: false)\n   * @param options defines further options to be sent to the getContext() function\n   * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\n   */\n  function ThinEngine(canvasOrContext, antialias, options, adaptToDeviceRatio) {\n    var _this = this;\n    /** @hidden */\n\n\n    this._name = \"WebGL\";\n    /**\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\n     */\n\n    this.forcePOTTextures = false;\n    /**\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\n     */\n\n    this.isFullscreen = false;\n    /**\n     * Gets or sets a boolean indicating if back faces must be culled. If false, front faces are culled instead (true by default)\n     * If non null, this takes precedence over the value from the material\n     */\n\n    this.cullBackFaces = null;\n    /**\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foreground\n     */\n\n    this.renderEvenInBackground = true;\n    /**\n     * Gets or sets a boolean indicating that cache can be kept between frames\n     */\n\n    this.preventCacheWipeBetweenFrames = false;\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\n\n    this.validateShaderPrograms = false;\n    this._useReverseDepthBuffer = false;\n    /**\n     * Indicates if the z range in NDC space is 0..1 (value: true) or -1..1 (value: false)\n     */\n\n    this.isNDCHalfZRange = false;\n    /**\n     * Indicates that the origin of the texture/framebuffer space is the bottom left corner. If false, the origin is top left\n     */\n\n    this.hasOriginBottomLeft = true;\n    /**\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\n     */\n\n    this.disableUniformBuffers = false;\n    /**\n     * An event triggered when the engine is disposed.\n     */\n\n    this.onDisposeObservable = new Observable();\n    this._frameId = 0;\n    /** @hidden */\n\n    this._uniformBuffers = new Array();\n    /** @hidden */\n\n    this._storageBuffers = new Array();\n    /** @hidden */\n\n    this._webGLVersion = 1.0;\n    this._windowIsBackground = false;\n    this._highPrecisionShadersAllowed = true;\n    /** @hidden */\n\n    this._badOS = false;\n    /** @hidden */\n\n    this._badDesktopOS = false;\n    this._renderingQueueLaunched = false;\n    this._activeRenderLoops = new Array(); // Lost context\n\n    /**\n     * Observable signaled when a context lost event is raised\n     */\n\n    this.onContextLostObservable = new Observable();\n    /**\n     * Observable signaled when a context restored event is raised\n     */\n\n    this.onContextRestoredObservable = new Observable();\n    this._contextWasLost = false;\n    /** @hidden */\n\n    this._doNotHandleContextLost = false;\n    /**\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\n     */\n\n    this.disableVertexArrayObjects = false; // States\n\n    /** @hidden */\n\n    this._colorWrite = true;\n    /** @hidden */\n\n    this._colorWriteChanged = true;\n    /** @hidden */\n\n    this._depthCullingState = new DepthCullingState();\n    /** @hidden */\n\n    this._stencilStateComposer = new StencilStateComposer();\n    /** @hidden */\n\n    this._stencilState = new StencilState();\n    /** @hidden */\n\n    this._alphaState = new AlphaState();\n    /** @hidden */\n\n    this._alphaMode = 1;\n    /** @hidden */\n\n    this._alphaEquation = 0; // Cache\n\n    /** @hidden */\n\n    this._internalTexturesCache = new Array();\n    /** @hidden */\n\n    this._renderTargetWrapperCache = new Array();\n    /** @hidden */\n\n    this._activeChannel = 0;\n    this._currentTextureChannel = -1;\n    /** @hidden */\n\n    this._boundTexturesCache = {};\n    this._compiledEffects = {};\n    this._vertexAttribArraysEnabled = [];\n    this._uintIndicesCurrentlySet = false;\n    this._currentBoundBuffer = new Array();\n    /** @hidden */\n\n    this._currentFramebuffer = null;\n    /** @hidden */\n\n    this._dummyFramebuffer = null;\n    this._currentBufferPointers = new Array();\n    this._currentInstanceLocations = new Array();\n    this._currentInstanceBuffers = new Array();\n    this._vaoRecordInProgress = false;\n    this._mustWipeVertexAttributes = false;\n    this._nextFreeTextureSlots = new Array();\n    this._maxSimultaneousTextures = 0;\n    this._activeRequests = new Array();\n    /** @hidden */\n\n    this._adaptToDeviceRatio = false;\n    /** @hidden */\n\n    this._transformTextureUrl = null;\n    /**\n     * Gets information about the current host\n     */\n\n    this.hostInformation = {\n      isMobile: false\n    };\n    /**\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\n     */\n\n    this.premultipliedAlpha = true;\n    /**\n     * Observable event triggered before each texture is initialized\n     */\n\n    this.onBeforeTextureInitObservable = new Observable();\n    /** @hidden */\n\n    this._isWebGPU = false;\n    this._snapshotRenderingMode = 0;\n    this._viewportCached = {\n      x: 0,\n      y: 0,\n      z: 0,\n      w: 0\n    };\n    this._unpackFlipYCached = null;\n    /**\n     * In case you are sharing the context with other applications, it might\n     * be interested to not cache the unpack flip y state to ensure a consistent\n     * value would be set.\n     */\n\n    this.enableUnpackFlipYCached = true;\n    this._boundUniforms = {};\n    var canvas = null;\n    options = options || {};\n    this._creationOptions = options; // Save this off for use in resize().\n\n    this._adaptToDeviceRatio = adaptToDeviceRatio !== null && adaptToDeviceRatio !== void 0 ? adaptToDeviceRatio : false;\n    this._stencilStateComposer.stencilGlobal = this._stencilState;\n    PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\n\n    if (!canvasOrContext) {\n      return;\n    }\n\n    adaptToDeviceRatio = adaptToDeviceRatio || options.adaptToDeviceRatio || false;\n\n    if (canvasOrContext.getContext) {\n      canvas = canvasOrContext;\n      this._renderingCanvas = canvas;\n\n      if (antialias !== undefined) {\n        options.antialias = antialias;\n      }\n\n      if (options.deterministicLockstep === undefined) {\n        options.deterministicLockstep = false;\n      }\n\n      if (options.lockstepMaxSteps === undefined) {\n        options.lockstepMaxSteps = 4;\n      }\n\n      if (options.timeStep === undefined) {\n        options.timeStep = 1 / 60;\n      }\n\n      if (options.preserveDrawingBuffer === undefined) {\n        options.preserveDrawingBuffer = false;\n      }\n\n      if (options.audioEngine === undefined) {\n        options.audioEngine = true;\n      }\n\n      if (options.audioEngineOptions !== undefined && options.audioEngineOptions.audioContext !== undefined) {\n        this._audioContext = options.audioEngineOptions.audioContext;\n      }\n\n      if (options.audioEngineOptions !== undefined && options.audioEngineOptions.audioDestination !== undefined) {\n        this._audioDestination = options.audioEngineOptions.audioDestination;\n      }\n\n      if (options.stencil === undefined) {\n        options.stencil = true;\n      }\n\n      if (options.premultipliedAlpha === false) {\n        this.premultipliedAlpha = false;\n      }\n\n      if (options.xrCompatible === undefined) {\n        options.xrCompatible = true;\n      }\n\n      this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false; // Exceptions\n\n      if (navigator && navigator.userAgent) {\n        // Function to check if running on mobile device\n        this._checkForMobile = function () {\n          var currentUA = navigator.userAgent;\n          _this.hostInformation.isMobile = currentUA.indexOf(\"Mobile\") !== -1 || // Needed for iOS 13+ detection on iPad (inspired by solution from https://stackoverflow.com/questions/9038625/detect-if-device-is-ios)\n          currentUA.indexOf(\"Mac\") !== -1 && IsDocumentAvailable() && \"ontouchend\" in document;\n        }; // Set initial isMobile value\n\n\n        this._checkForMobile(); // Set up event listener to check when window is resized (used to get emulator activation to work properly)\n\n\n        if (IsWindowObjectExist()) {\n          window.addEventListener(\"resize\", this._checkForMobile);\n        }\n\n        var ua = navigator.userAgent;\n\n        for (var _i = 0, _a = ThinEngine.ExceptionList; _i < _a.length; _i++) {\n          var exception = _a[_i];\n          var key = exception.key;\n          var targets = exception.targets;\n          var check = new RegExp(key);\n\n          if (check.test(ua)) {\n            if (exception.capture && exception.captureConstraint) {\n              var capture = exception.capture;\n              var constraint = exception.captureConstraint;\n              var regex = new RegExp(capture);\n              var matches = regex.exec(ua);\n\n              if (matches && matches.length > 0) {\n                var capturedValue = parseInt(matches[matches.length - 1]);\n\n                if (capturedValue >= constraint) {\n                  continue;\n                }\n              }\n            }\n\n            for (var _b = 0, targets_1 = targets; _b < targets_1.length; _b++) {\n              var target = targets_1[_b];\n\n              switch (target) {\n                case \"uniformBuffer\":\n                  this.disableUniformBuffers = true;\n                  break;\n\n                case \"vao\":\n                  this.disableVertexArrayObjects = true;\n                  break;\n              }\n            }\n          }\n        }\n      } // Context lost\n\n\n      if (!this._doNotHandleContextLost) {\n        this._onContextLost = function (evt) {\n          evt.preventDefault();\n          _this._contextWasLost = true;\n          Logger.Warn(\"WebGL context lost.\");\n\n          _this.onContextLostObservable.notifyObservers(_this);\n        };\n\n        this._onContextRestored = function () {\n          _this._restoreEngineAfterContextLost(_this._initGLContext.bind(_this));\n        };\n\n        canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\n        canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\n        options.powerPreference = \"high-performance\";\n      } // Detect if we are running on a faulty buggy desktop OS.\n\n\n      this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\n      if (this._badDesktopOS) {\n        options.xrCompatible = false;\n      } // GL\n\n\n      if (!options.disableWebGL2Support) {\n        try {\n          this._gl = canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options);\n\n          if (this._gl) {\n            this._webGLVersion = 2.0;\n            this._shaderPlatformName = \"WEBGL2\"; // Prevent weird browsers to lie (yeah that happens!)\n\n            if (!this._gl.deleteQuery) {\n              this._webGLVersion = 1.0;\n              this._shaderPlatformName = \"WEBGL1\";\n            }\n          }\n        } catch (e) {// Do nothing\n        }\n      }\n\n      if (!this._gl) {\n        if (!canvas) {\n          throw new Error(\"The provided canvas is null or undefined.\");\n        }\n\n        try {\n          this._gl = canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options);\n        } catch (e) {\n          throw new Error(\"WebGL not supported\");\n        }\n      }\n\n      if (!this._gl) {\n        throw new Error(\"WebGL not supported\");\n      }\n    } else {\n      this._gl = canvasOrContext;\n      this._renderingCanvas = this._gl.canvas;\n\n      if (this._gl.renderbufferStorageMultisample) {\n        this._webGLVersion = 2.0;\n        this._shaderPlatformName = \"WEBGL2\";\n      } else {\n        this._shaderPlatformName = \"WEBGL1\";\n      }\n\n      var attributes = this._gl.getContextAttributes();\n\n      if (attributes) {\n        options.stencil = attributes.stencil;\n      }\n    } // Ensures a consistent color space unpacking of textures cross browser.\n\n\n    this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n    if (options.useHighPrecisionFloats !== undefined) {\n      this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\n    } // Viewport\n\n\n    var devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n    var limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\n    this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\n    this.resize();\n    this._isStencilEnable = options.stencil ? true : false;\n\n    this._initGLContext();\n\n    this._initFeatures(); // Prepare buffer pointers\n\n\n    for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n      this._currentBufferPointers[i] = new BufferPointer();\n    } // Shader processor\n\n\n    this._shaderProcessor = this.webGLVersion > 1 ? new WebGL2ShaderProcessor() : new WebGLShaderProcessor(); // Detect if we are running on a faulty buggy OS.\n\n    this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent); // Starting with iOS 14, we can trust the browser\n    // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\n    // if (matches && matches.length === 2) {\n    //     if (parseInt(matches[1]) >= 14) {\n    //         this._badOS = false;\n    //     }\n    // }\n\n    var versionToLog = \"Babylon.js v\".concat(ThinEngine.Version);\n    console.log(versionToLog + \" - \".concat(this.description)); // Check setAttribute in case of workers\n\n    if (this._renderingCanvas && this._renderingCanvas.setAttribute) {\n      this._renderingCanvas.setAttribute(\"data-engine\", versionToLog);\n    }\n  }\n\n  Object.defineProperty(ThinEngine, \"NpmPackage\", {\n    /**\n     * Returns the current npm package of the sdk\n     */\n    // Not mixed with Version for tooling purpose.\n    get: function get() {\n      return \"babylonjs@5.3.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"Version\", {\n    /**\n     * Returns the current version of the framework\n     */\n    get: function get() {\n      return \"5.3.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"description\", {\n    /**\n     * Returns a string describing the current engine\n     */\n    get: function get() {\n      var description = this.name + this.webGLVersion;\n\n      if (this._caps.parallelShaderCompile) {\n        description += \" - Parallel shader compilation\";\n      }\n\n      return description;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"name\", {\n    /**\n     * Gets or sets the name of the engine\n     */\n    get: function get() {\n      return this._name;\n    },\n    set: function set(value) {\n      this._name = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"version\", {\n    /**\n     * Returns the version of the engine\n     */\n    get: function get() {\n      return this._webGLVersion;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"ShadersRepository\", {\n    /**\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\n     */\n    get: function get() {\n      return Effect.ShadersRepository;\n    },\n    set: function set(value) {\n      Effect.ShadersRepository = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * @param shaderLanguage\n   * @hidden\n   */\n\n  ThinEngine.prototype._getShaderProcessor = function (shaderLanguage) {\n    return this._shaderProcessor;\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"useReverseDepthBuffer\", {\n    /**\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\n     * This can provide greater z depth for distant objects.\n     */\n    get: function get() {\n      return this._useReverseDepthBuffer;\n    },\n    set: function set(useReverse) {\n      if (useReverse === this._useReverseDepthBuffer) {\n        return;\n      }\n\n      this._useReverseDepthBuffer = useReverse;\n\n      if (useReverse) {\n        this._depthCullingState.depthFunc = 518;\n      } else {\n        this._depthCullingState.depthFunc = 515;\n      }\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"frameId\", {\n    /**\n     * Gets the current frame id\n     */\n    get: function get() {\n      return this._frameId;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"supportsUniformBuffers\", {\n    /**\n     * Gets a boolean indicating that the engine supports uniform buffers\n     * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\n     */\n    get: function get() {\n      return this.webGLVersion > 1 && !this.disableUniformBuffers;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Gets the options used for engine creation\n   * @returns EngineOptions object\n   */\n\n  ThinEngine.prototype.getCreationOptions = function () {\n    return this._creationOptions;\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"_shouldUseHighPrecisionShader\", {\n    /** @hidden */\n    get: function get() {\n      return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"needPOTTextures\", {\n    /**\n     * Gets a boolean indicating that only power of 2 textures are supported\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\n     */\n    get: function get() {\n      return this._webGLVersion < 2 || this.forcePOTTextures;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"activeRenderLoops\", {\n    /**\n     * Gets the list of current active render loop functions\n     * @returns an array with the current render loop functions\n     */\n    get: function get() {\n      return this._activeRenderLoops;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"doNotHandleContextLost\", {\n    /**\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\n     */\n    get: function get() {\n      return this._doNotHandleContextLost;\n    },\n    set: function set(value) {\n      this._doNotHandleContextLost = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"_supportsHardwareTextureRescaling\", {\n    get: function get() {\n      return false;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"framebufferDimensionsObject\", {\n    /**\n     * sets the object from which width and height will be taken from when getting render width and height\n     * Will fallback to the gl object\n     * @param dimensions the framebuffer width and height that will be used.\n     */\n    set: function set(dimensions) {\n      this._framebufferDimensionsObject = dimensions;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"currentViewport\", {\n    /**\n     * Gets the current viewport\n     */\n    get: function get() {\n      return this._cachedViewport;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture\", {\n    /**\n     * Gets the default empty texture\n     */\n    get: function get() {\n      if (!this._emptyTexture) {\n        this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture3D\", {\n    /**\n     * Gets the default empty 3D texture\n     */\n    get: function get() {\n      if (!this._emptyTexture3D) {\n        this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture3D;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture2DArray\", {\n    /**\n     * Gets the default empty 2D array texture\n     */\n    get: function get() {\n      if (!this._emptyTexture2DArray) {\n        this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture2DArray;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyCubeTexture\", {\n    /**\n     * Gets the default empty cube texture\n     */\n    get: function get() {\n      if (!this._emptyCubeTexture) {\n        var faceData = new Uint8Array(4);\n        var cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\n        this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\n      }\n\n      return this._emptyCubeTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"isWebGPU\", {\n    /**\n     * Gets a boolean indicating if the engine runs in WebGPU or not.\n     */\n    get: function get() {\n      return this._isWebGPU;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"shaderPlatformName\", {\n    /**\n     * Gets the shader platform name used by the effects.\n     */\n    get: function get() {\n      return this._shaderPlatformName;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"snapshotRendering\", {\n    /**\n     * Enables or disables the snapshot rendering mode\n     * Note that the WebGL engine does not support snapshot rendering so setting the value won't have any effect for this engine\n     */\n    get: function get() {\n      return false;\n    },\n    set: function set(activate) {// WebGL engine does not support snapshot rendering\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"snapshotRenderingMode\", {\n    /**\n     * Gets or sets the snapshot rendering mode\n     */\n    get: function get() {\n      return this._snapshotRenderingMode;\n    },\n    set: function set(mode) {\n      this._snapshotRenderingMode = mode;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Creates a new snapshot at the next frame using the current snapshotRenderingMode\n   */\n\n  ThinEngine.prototype.snapshotRenderingReset = function () {\n    this.snapshotRendering = false;\n  };\n\n  ThinEngine._CreateCanvas = function (width, height) {\n    if (typeof document === \"undefined\") {\n      return new OffscreenCanvas(width, height);\n    }\n\n    var canvas = document.createElement(\"canvas\");\n    canvas.width = width;\n    canvas.height = height;\n    return canvas;\n  };\n  /**\n   * Create a canvas. This method is overridden by other engines\n   * @param width width\n   * @param height height\n   * @return ICanvas interface\n   */\n\n\n  ThinEngine.prototype.createCanvas = function (width, height) {\n    return ThinEngine._CreateCanvas(width, height);\n  };\n  /**\n   * Create an image to use with canvas\n   * @return IImage interface\n   */\n\n\n  ThinEngine.prototype.createCanvasImage = function () {\n    return document.createElement(\"img\");\n  };\n\n  ThinEngine.prototype._restoreEngineAfterContextLost = function (initEngine) {\n    var _this = this; // Adding a timeout to avoid race condition at browser level\n\n\n    setTimeout(function () {\n      return __awaiter(_this, void 0, void 0, function () {\n        var depthTest, depthFunc, depthMask, stencilTest;\n\n        var _a;\n\n        return __generator(this, function (_b) {\n          switch (_b.label) {\n            case 0:\n              this._dummyFramebuffer = null;\n              depthTest = this._depthCullingState.depthTest;\n              depthFunc = this._depthCullingState.depthFunc;\n              depthMask = this._depthCullingState.depthMask;\n              stencilTest = this._stencilState.stencilTest; // Rebuild context\n\n              return [4\n              /*yield*/\n              , initEngine()];\n\n            case 1:\n              // Rebuild context\n              _b.sent(); // Rebuild effects\n\n\n              this._rebuildEffects();\n\n              (_a = this._rebuildComputeEffects) === null || _a === void 0 ? void 0 : _a.call(this); // Rebuild textures\n\n              this._rebuildInternalTextures(); // Rebuild textures\n\n\n              this._rebuildRenderTargetWrappers(); // Rebuild buffers\n\n\n              this._rebuildBuffers(); // Cache\n\n\n              this.wipeCaches(true);\n              this._depthCullingState.depthTest = depthTest;\n              this._depthCullingState.depthFunc = depthFunc;\n              this._depthCullingState.depthMask = depthMask;\n              this._stencilState.stencilTest = stencilTest;\n              Logger.Warn(this.name + \" context successfully restored.\");\n              this.onContextRestoredObservable.notifyObservers(this);\n              this._contextWasLost = false;\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    }, 0);\n  };\n  /**\n   * Shared initialization across engines types.\n   * @param canvas The canvas associated with this instance of the engine.\n   * @param doNotHandleTouchAction Defines that engine should ignore modifying touch action attribute and style\n   * @param audioEngine Defines if an audio engine should be created by default\n   */\n\n\n  ThinEngine.prototype._sharedInit = function (canvas, doNotHandleTouchAction, audioEngine) {\n    this._renderingCanvas = canvas;\n  };\n  /**\n   * @param shaderLanguage\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getShaderProcessingContext = function (shaderLanguage) {\n    return null;\n  };\n\n  ThinEngine.prototype._rebuildInternalTextures = function () {\n    var currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\n\n\n    for (var _i = 0, currentState_1 = currentState; _i < currentState_1.length; _i++) {\n      var internalTexture = currentState_1[_i];\n\n      internalTexture._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._rebuildRenderTargetWrappers = function () {\n    var currentState = this._renderTargetWrapperCache.slice(); // Do a copy because the rebuild will add proxies\n\n\n    for (var _i = 0, currentState_2 = currentState; _i < currentState_2.length; _i++) {\n      var renderTargetWrapper = currentState_2[_i];\n\n      renderTargetWrapper._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._rebuildEffects = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n      effect._pipelineContext = null; // because _prepareEffect will try to dispose this pipeline before recreating it and that would lead to webgl errors\n\n      effect._wasPreviouslyReady = false;\n\n      effect._prepareEffect();\n    }\n\n    Effect.ResetCache();\n  };\n  /**\n   * Gets a boolean indicating if all created effects are ready\n   * @returns true if all effects are ready\n   */\n\n\n  ThinEngine.prototype.areAllEffectsReady = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n\n      if (!effect.isReady()) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  ThinEngine.prototype._rebuildBuffers = function () {\n    // Uniforms\n    for (var _i = 0, _a = this._uniformBuffers; _i < _a.length; _i++) {\n      var uniformBuffer = _a[_i];\n\n      uniformBuffer._rebuild();\n    } // Storage buffers\n\n\n    for (var _b = 0, _c = this._storageBuffers; _b < _c.length; _b++) {\n      var storageBuffer = _c[_b];\n\n      storageBuffer._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._initGLContext = function () {\n    // Caps\n    this._caps = {\n      maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\n      maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\n      maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\n      maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\n      maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\n      maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\n      maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\n      maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\n      maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\n      maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\n      maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\n      parallelShaderCompile: this._gl.getExtension(\"KHR_parallel_shader_compile\") || undefined,\n      standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension(\"OES_standard_derivatives\") !== null,\n      maxAnisotropy: 1,\n      astc: this._gl.getExtension(\"WEBGL_compressed_texture_astc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_astc\"),\n      bptc: this._gl.getExtension(\"EXT_texture_compression_bptc\") || this._gl.getExtension(\"WEBKIT_EXT_texture_compression_bptc\"),\n      s3tc: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc\"),\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      s3tc_srgb: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc_srgb\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc_srgb\"),\n      pvrtc: this._gl.getExtension(\"WEBGL_compressed_texture_pvrtc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_pvrtc\"),\n      etc1: this._gl.getExtension(\"WEBGL_compressed_texture_etc1\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc1\"),\n      etc2: this._gl.getExtension(\"WEBGL_compressed_texture_etc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc\") || this._gl.getExtension(\"WEBGL_compressed_texture_es3_0\"),\n      textureAnisotropicFilterExtension: this._gl.getExtension(\"EXT_texture_filter_anisotropic\") || this._gl.getExtension(\"WEBKIT_EXT_texture_filter_anisotropic\") || this._gl.getExtension(\"MOZ_EXT_texture_filter_anisotropic\"),\n      uintIndices: this._webGLVersion > 1 || this._gl.getExtension(\"OES_element_index_uint\") !== null,\n      fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_frag_depth\") !== null,\n      highPrecisionShaderSupported: false,\n      timerQuery: this._gl.getExtension(\"EXT_disjoint_timer_query_webgl2\") || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\n      supportOcclusionQuery: this._webGLVersion > 1,\n      canUseTimestampForTimerQuery: false,\n      drawBuffersExtension: false,\n      maxMSAASamples: 1,\n      colorBufferFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_float\")),\n      textureFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_float\") ? true : false,\n      textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_half_float\") ? true : false,\n      textureHalfFloatRender: false,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloatLinearFiltering: false,\n      vertexArrayObject: false,\n      instancedArrays: false,\n      textureLOD: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_shader_texture_lod\") ? true : false,\n      blendMinMax: false,\n      multiview: this._gl.getExtension(\"OVR_multiview2\"),\n      oculusMultiview: this._gl.getExtension(\"OCULUS_multiview\"),\n      depthTextureExtension: false,\n      canUseGLInstanceID: this._webGLVersion > 1,\n      canUseGLVertexID: this._webGLVersion > 1,\n      supportComputeShaders: false,\n      supportSRGBBuffers: false,\n      supportTransformFeedbacks: this._webGLVersion > 1,\n      textureMaxLevel: this._webGLVersion > 1\n    }; // Infos\n\n    this._glVersion = this._gl.getParameter(this._gl.VERSION);\n\n    var rendererInfo = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\n\n    if (rendererInfo != null) {\n      this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\n      this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\n    }\n\n    if (!this._glVendor) {\n      this._glVendor = this._gl.getParameter(this._gl.VENDOR) || \"Unknown vendor\";\n    }\n\n    if (!this._glRenderer) {\n      this._glRenderer = this._gl.getParameter(this._gl.RENDERER) || \"Unknown renderer\";\n    } // Constants\n\n\n    if (this._gl.HALF_FLOAT_OES !== 0x8d61) {\n      this._gl.HALF_FLOAT_OES = 0x8d61; // Half floating-point type (16-bit).\n    }\n\n    if (this._gl.RGBA16F !== 0x881a) {\n      this._gl.RGBA16F = 0x881a; // RGBA 16-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.RGBA32F !== 0x8814) {\n      this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.DEPTH24_STENCIL8 !== 35056) {\n      this._gl.DEPTH24_STENCIL8 = 35056;\n    } // Extensions\n\n\n    if (this._caps.timerQuery) {\n      if (this._webGLVersion === 1) {\n        this._gl.getQuery = this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery);\n      }\n\n      this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\n    }\n\n    this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\n    this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension(\"OES_texture_float_linear\") ? true : false;\n    this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\n    this._caps.textureHalfFloatLinearFiltering = this._webGLVersion > 1 || this._caps.textureHalfFloat && this._gl.getExtension(\"OES_texture_half_float_linear\") ? true : false; // Compressed formats\n\n    if (this._caps.astc) {\n      this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR = this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\n    }\n\n    if (this._caps.bptc) {\n      this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT = this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\n    }\n\n    if (this._caps.s3tc_srgb) {\n      this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\n      this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\n    } // Checks if some of the format renders first to allow the use of webgl inspector.\n\n\n    if (this._webGLVersion > 1) {\n      if (this._gl.HALF_FLOAT_OES !== 0x140b) {\n        this._gl.HALF_FLOAT_OES = 0x140b;\n      }\n    }\n\n    this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer(); // Draw buffers\n\n    if (this._webGLVersion > 1) {\n      this._caps.drawBuffersExtension = true;\n      this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\n    } else {\n      var drawBuffersExtension = this._gl.getExtension(\"WEBGL_draw_buffers\");\n\n      if (drawBuffersExtension !== null) {\n        this._caps.drawBuffersExtension = true;\n        this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\n        this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\n\n        for (var i = 0; i < 16; i++) {\n          this._gl[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = drawBuffersExtension[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\n        }\n      }\n    } // Depth Texture\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.depthTextureExtension = true;\n    } else {\n      var depthTextureExtension = this._gl.getExtension(\"WEBGL_depth_texture\");\n\n      if (depthTextureExtension != null) {\n        this._caps.depthTextureExtension = true;\n        this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\n      }\n    } // Vertex array object\n\n\n    if (this.disableVertexArrayObjects) {\n      this._caps.vertexArrayObject = false;\n    } else if (this._webGLVersion > 1) {\n      this._caps.vertexArrayObject = true;\n    } else {\n      var vertexArrayObjectExtension = this._gl.getExtension(\"OES_vertex_array_object\");\n\n      if (vertexArrayObjectExtension != null) {\n        this._caps.vertexArrayObject = true;\n        this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\n      }\n    } // Instances count\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.instancedArrays = true;\n    } else {\n      var instanceExtension = this._gl.getExtension(\"ANGLE_instanced_arrays\");\n\n      if (instanceExtension != null) {\n        this._caps.instancedArrays = true;\n        this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\n        this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\n        this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\n      } else {\n        this._caps.instancedArrays = false;\n      }\n    }\n\n    if (this._gl.getShaderPrecisionFormat) {\n      var vertexhighp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\n\n      var fragmenthighp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\n\n      if (vertexhighp && fragmenthighp) {\n        this._caps.highPrecisionShaderSupported = vertexhighp.precision !== 0 && fragmenthighp.precision !== 0;\n      }\n    }\n\n    if (this._webGLVersion > 1) {\n      this._caps.blendMinMax = true;\n    } else {\n      var blendMinMaxExtension = this._gl.getExtension(\"EXT_blend_minmax\");\n\n      if (blendMinMaxExtension != null) {\n        this._caps.blendMinMax = true;\n        this._gl.MAX = blendMinMaxExtension.MAX_EXT;\n        this._gl.MIN = blendMinMaxExtension.MIN_EXT;\n      }\n    } // sRGB buffers\n    // only run this if not already set to true (in the constructor, for example)\n\n\n    if (!this._caps.supportSRGBBuffers) {\n      if (this._webGLVersion > 1) {\n        this._caps.supportSRGBBuffers = true;\n      } else {\n        var sRGBExtension = this._gl.getExtension(\"EXT_sRGB\");\n\n        if (sRGBExtension != null) {\n          this._caps.supportSRGBBuffers = true;\n          this._gl.SRGB = sRGBExtension.SRGB_EXT;\n          this._gl.SRGB8 = sRGBExtension.SRGB_ALPHA_EXT;\n          this._gl.SRGB8_ALPHA8 = sRGBExtension.SRGB_ALPHA_EXT;\n        }\n      } // take into account the forced state that was provided in options\n      // When the issue in angle/chrome is fixed the flag should be taken into account only when it is explicitly defined\n\n\n      this._caps.supportSRGBBuffers = this._caps.supportSRGBBuffers && !!(this._creationOptions && this._creationOptions.forceSRGBBufferSupportState);\n    } // Depth buffer\n\n\n    this._depthCullingState.depthTest = true;\n    this._depthCullingState.depthFunc = this._gl.LEQUAL;\n    this._depthCullingState.depthMask = true; // Texture maps\n\n    this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\n\n    for (var slot = 0; slot < this._maxSimultaneousTextures; slot++) {\n      this._nextFreeTextureSlots.push(slot);\n    }\n  };\n\n  ThinEngine.prototype._initFeatures = function () {\n    this._features = {\n      forceBitmapOverHTMLImageElement: false,\n      supportRenderAndCopyToLodForFloatTextures: this._webGLVersion !== 1,\n      supportDepthStencilTexture: this._webGLVersion !== 1,\n      supportShadowSamplers: this._webGLVersion !== 1,\n      uniformBufferHardCheckMatrix: false,\n      allowTexturePrefiltering: this._webGLVersion !== 1,\n      trackUbosInFrame: false,\n      checkUbosContentBeforeUpload: false,\n      supportCSM: this._webGLVersion !== 1,\n      basisNeedsPOT: this._webGLVersion === 1,\n      support3DTextures: this._webGLVersion !== 1,\n      needTypeSuffixInShaderConstants: this._webGLVersion !== 1,\n      supportMSAA: this._webGLVersion !== 1,\n      supportSSAO2: this._webGLVersion !== 1,\n      supportExtendedTextureFormats: this._webGLVersion !== 1,\n      supportSwitchCaseInShader: this._webGLVersion !== 1,\n      supportSyncTextureRead: true,\n      needsInvertingBitmap: true,\n      useUBOBindingCache: true,\n      needShaderCodeInlining: false,\n      needToAlwaysBindUniformBuffers: false,\n      supportRenderPasses: false,\n      _collectUbosUpdatedInFrame: false\n    };\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"webGLVersion\", {\n    /**\n     * Gets version of the current webGL context\n     * Keep it for back compat - use version instead\n     */\n    get: function get() {\n      return this._webGLVersion;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Gets a string identifying the name of the class\n   * @returns \"Engine\" string\n   */\n\n  ThinEngine.prototype.getClassName = function () {\n    return \"ThinEngine\";\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"isStencilEnable\", {\n    /**\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\n     */\n    get: function get() {\n      return this._isStencilEnable;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /** @hidden */\n\n  ThinEngine.prototype._prepareWorkingCanvas = function () {\n    if (this._workingCanvas) {\n      return;\n    }\n\n    this._workingCanvas = this.createCanvas(1, 1);\n\n    var context = this._workingCanvas.getContext(\"2d\");\n\n    if (context) {\n      this._workingContext = context;\n    }\n  };\n  /**\n   * Reset the texture cache to empty state\n   */\n\n\n  ThinEngine.prototype.resetTextureCache = function () {\n    for (var key in this._boundTexturesCache) {\n      if (!Object.prototype.hasOwnProperty.call(this._boundTexturesCache, key)) {\n        continue;\n      }\n\n      this._boundTexturesCache[key] = null;\n    }\n\n    this._currentTextureChannel = -1;\n  };\n  /**\n   * Gets an object containing information about the current engine context\n   * @returns an object containing the vendor, the renderer and the version of the current engine context\n   */\n\n\n  ThinEngine.prototype.getInfo = function () {\n    return this.getGlInfo();\n  };\n  /**\n   * Gets an object containing information about the current webGL context\n   * @returns an object containing the vendor, the renderer and the version of the current webGL context\n   */\n\n\n  ThinEngine.prototype.getGlInfo = function () {\n    return {\n      vendor: this._glVendor,\n      renderer: this._glRenderer,\n      version: this._glVersion\n    };\n  };\n  /**\n   * Defines the hardware scaling level.\n   * By default the hardware scaling level is computed from the window device ratio.\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\n   * @param level defines the level to use\n   */\n\n\n  ThinEngine.prototype.setHardwareScalingLevel = function (level) {\n    this._hardwareScalingLevel = level;\n    this.resize();\n  };\n  /**\n   * Gets the current hardware scaling level.\n   * By default the hardware scaling level is computed from the window device ratio.\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\n   * @returns a number indicating the current hardware scaling level\n   */\n\n\n  ThinEngine.prototype.getHardwareScalingLevel = function () {\n    return this._hardwareScalingLevel;\n  };\n  /**\n   * Gets the list of loaded textures\n   * @returns an array containing all loaded textures\n   */\n\n\n  ThinEngine.prototype.getLoadedTexturesCache = function () {\n    return this._internalTexturesCache;\n  };\n  /**\n   * Gets the object containing all engine capabilities\n   * @returns the EngineCapabilities object\n   */\n\n\n  ThinEngine.prototype.getCaps = function () {\n    return this._caps;\n  };\n  /**\n   * stop executing a render loop function and remove it from the execution array\n   * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\n   */\n\n\n  ThinEngine.prototype.stopRenderLoop = function (renderFunction) {\n    if (!renderFunction) {\n      this._activeRenderLoops = [];\n      return;\n    }\n\n    var index = this._activeRenderLoops.indexOf(renderFunction);\n\n    if (index >= 0) {\n      this._activeRenderLoops.splice(index, 1);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._renderLoop = function () {\n    if (!this._contextWasLost) {\n      var shouldRender = true;\n\n      if (!this.renderEvenInBackground && this._windowIsBackground) {\n        shouldRender = false;\n      }\n\n      if (shouldRender) {\n        // Start new frame\n        this.beginFrame();\n\n        for (var index = 0; index < this._activeRenderLoops.length; index++) {\n          var renderFunction = this._activeRenderLoops[index];\n          renderFunction();\n        } // Present\n\n\n        this.endFrame();\n      }\n    }\n\n    if (this._activeRenderLoops.length > 0) {\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    } else {\n      this._renderingQueueLaunched = false;\n    }\n  };\n  /**\n   * Gets the HTML canvas attached with the current webGL context\n   * @returns a HTML canvas\n   */\n\n\n  ThinEngine.prototype.getRenderingCanvas = function () {\n    return this._renderingCanvas;\n  };\n  /**\n   * Gets the audio context specified in engine initialization options\n   * @returns an Audio Context\n   */\n\n\n  ThinEngine.prototype.getAudioContext = function () {\n    return this._audioContext;\n  };\n  /**\n   * Gets the audio destination specified in engine initialization options\n   * @returns an audio destination node\n   */\n\n\n  ThinEngine.prototype.getAudioDestination = function () {\n    return this._audioDestination;\n  };\n  /**\n   * Gets host window\n   * @returns the host window object\n   */\n\n\n  ThinEngine.prototype.getHostWindow = function () {\n    if (!IsWindowObjectExist()) {\n      return null;\n    }\n\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\n      return this._renderingCanvas.ownerDocument.defaultView;\n    }\n\n    return window;\n  };\n  /**\n   * Gets the current render width\n   * @param useScreen defines if screen size must be used (or the current render target if any)\n   * @returns a number defining the current render width\n   */\n\n\n  ThinEngine.prototype.getRenderWidth = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\n  };\n  /**\n   * Gets the current render height\n   * @param useScreen defines if screen size must be used (or the current render target if any)\n   * @returns a number defining the current render height\n   */\n\n\n  ThinEngine.prototype.getRenderHeight = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\n  };\n  /**\n   * Can be used to override the current requestAnimationFrame requester.\n   * @param bindedRenderFunction\n   * @param requester\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\n    return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\n  };\n  /**\n   * Register and execute a render loop. The engine can have more than one render function\n   * @param renderFunction defines the function to continuously execute\n   */\n\n\n  ThinEngine.prototype.runRenderLoop = function (renderFunction) {\n    if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\n      return;\n    }\n\n    this._activeRenderLoops.push(renderFunction);\n\n    if (!this._renderingQueueLaunched) {\n      this._renderingQueueLaunched = true;\n      this._boundRenderFunction = this._renderLoop.bind(this);\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    }\n  };\n  /**\n   * Clear the current render buffer or the current render target (if any is set up)\n   * @param color defines the color to use\n   * @param backBuffer defines if the back buffer must be cleared\n   * @param depth defines if the depth buffer must be cleared\n   * @param stencil defines if the stencil buffer must be cleared\n   */\n\n\n  ThinEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\n    if (stencil === void 0) {\n      stencil = false;\n    }\n\n    var useStencilGlobalOnly = this.stencilStateComposer.useStencilGlobalOnly;\n    this.stencilStateComposer.useStencilGlobalOnly = true; // make sure the stencil mask is coming from the global stencil and not from a material (effect) which would currently be in effect\n\n    this.applyStates();\n    this.stencilStateComposer.useStencilGlobalOnly = useStencilGlobalOnly;\n    var mode = 0;\n\n    if (backBuffer && color) {\n      this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\n\n      mode |= this._gl.COLOR_BUFFER_BIT;\n    }\n\n    if (depth) {\n      if (this.useReverseDepthBuffer) {\n        this._depthCullingState.depthFunc = this._gl.GEQUAL;\n\n        this._gl.clearDepth(0.0);\n      } else {\n        this._gl.clearDepth(1.0);\n      }\n\n      mode |= this._gl.DEPTH_BUFFER_BIT;\n    }\n\n    if (stencil) {\n      this._gl.clearStencil(0);\n\n      mode |= this._gl.STENCIL_BUFFER_BIT;\n    }\n\n    this._gl.clear(mode);\n  };\n  /**\n   * @param x\n   * @param y\n   * @param width\n   * @param height\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._viewport = function (x, y, width, height) {\n    if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\n      this._viewportCached.x = x;\n      this._viewportCached.y = y;\n      this._viewportCached.z = width;\n      this._viewportCached.w = height;\n\n      this._gl.viewport(x, y, width, height);\n    }\n  };\n  /**\n   * Set the WebGL's viewport\n   * @param viewport defines the viewport element to be used\n   * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\n   * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\n   */\n\n\n  ThinEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\n    var width = requiredWidth || this.getRenderWidth();\n    var height = requiredHeight || this.getRenderHeight();\n    var x = viewport.x || 0;\n    var y = viewport.y || 0;\n    this._cachedViewport = viewport;\n\n    this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\n  };\n  /**\n   * Begin a new frame\n   */\n\n\n  ThinEngine.prototype.beginFrame = function () {};\n  /**\n   * Enf the current frame\n   */\n\n\n  ThinEngine.prototype.endFrame = function () {\n    // Force a flush in case we are using a bad OS.\n    if (this._badOS) {\n      this.flushFramebuffer();\n    }\n\n    this._frameId++;\n  };\n  /**\n   * Resize the view according to the canvas' size\n   * @param forceSetSize true to force setting the sizes of the underlying canvas\n   */\n\n\n  ThinEngine.prototype.resize = function (forceSetSize) {\n    if (forceSetSize === void 0) {\n      forceSetSize = false;\n    }\n\n    var width;\n    var height; // Requery hardware scaling level to handle zoomed-in resizing.\n\n    if (this._adaptToDeviceRatio) {\n      var devicePixelRatio_1 = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n      var limitDeviceRatio = this._creationOptions.limitDeviceRatio || devicePixelRatio_1;\n      this._hardwareScalingLevel = this._adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio_1) : 1.0;\n    }\n\n    if (IsWindowObjectExist()) {\n      width = this._renderingCanvas ? this._renderingCanvas.clientWidth || this._renderingCanvas.width : window.innerWidth;\n      height = this._renderingCanvas ? this._renderingCanvas.clientHeight || this._renderingCanvas.height : window.innerHeight;\n    } else {\n      width = this._renderingCanvas ? this._renderingCanvas.width : 100;\n      height = this._renderingCanvas ? this._renderingCanvas.height : 100;\n    }\n\n    this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel, forceSetSize);\n  };\n  /**\n   * Force a specific size of the canvas\n   * @param width defines the new canvas' width\n   * @param height defines the new canvas' height\n   * @param forceSetSize true to force setting the sizes of the underlying canvas\n   * @returns true if the size was changed\n   */\n\n\n  ThinEngine.prototype.setSize = function (width, height, forceSetSize) {\n    if (forceSetSize === void 0) {\n      forceSetSize = false;\n    }\n\n    if (!this._renderingCanvas) {\n      return false;\n    }\n\n    width = width | 0;\n    height = height | 0;\n\n    if (!forceSetSize && this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\n      return false;\n    }\n\n    this._renderingCanvas.width = width;\n    this._renderingCanvas.height = height;\n    return true;\n  };\n  /**\n   * Binds the frame buffer to the specified texture.\n   * @param texture The render target wrapper to render to\n   * @param faceIndex The face of the texture to render to in case of cube texture\n   * @param requiredWidth The width of the target to render to\n   * @param requiredHeight The height of the target to render to\n   * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\n   * @param lodLevel defines the lod level to bind to the frame buffer\n   * @param layer defines the 2d array index to bind to frame buffer to\n   */\n\n\n  ThinEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport, lodLevel, layer) {\n    var _a, _b, _c, _d, _e;\n\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lodLevel === void 0) {\n      lodLevel = 0;\n    }\n\n    if (layer === void 0) {\n      layer = 0;\n    }\n\n    var webglRTWrapper = texture;\n\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    }\n\n    this._currentRenderTarget = texture;\n\n    this._bindUnboundFramebuffer(webglRTWrapper._MSAAFramebuffer ? webglRTWrapper._MSAAFramebuffer : webglRTWrapper._framebuffer);\n\n    var gl = this._gl;\n\n    if (texture.is2DArray) {\n      gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, (_a = texture.texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource, lodLevel, layer);\n    } else if (texture.isCube) {\n      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, (_b = texture.texture._hardwareTexture) === null || _b === void 0 ? void 0 : _b.underlyingResource, lodLevel);\n    }\n\n    var depthStencilTexture = texture._depthStencilTexture;\n\n    if (depthStencilTexture) {\n      var attachment = texture._depthStencilTextureWithStencil ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\n\n      if (texture.is2DArray) {\n        gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, (_c = depthStencilTexture._hardwareTexture) === null || _c === void 0 ? void 0 : _c.underlyingResource, lodLevel, layer);\n      } else if (texture.isCube) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, (_d = depthStencilTexture._hardwareTexture) === null || _d === void 0 ? void 0 : _d.underlyingResource, lodLevel);\n      } else {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, (_e = depthStencilTexture._hardwareTexture) === null || _e === void 0 ? void 0 : _e.underlyingResource, lodLevel);\n      }\n    }\n\n    if (this._cachedViewport && !forceFullscreenViewport) {\n      this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\n    } else {\n      if (!requiredWidth) {\n        requiredWidth = texture.width;\n\n        if (lodLevel) {\n          requiredWidth = requiredWidth / Math.pow(2, lodLevel);\n        }\n      }\n\n      if (!requiredHeight) {\n        requiredHeight = texture.height;\n\n        if (lodLevel) {\n          requiredHeight = requiredHeight / Math.pow(2, lodLevel);\n        }\n      }\n\n      this._viewport(0, 0, requiredWidth, requiredHeight);\n    }\n\n    this.wipeCaches();\n  };\n  /**\n   * Set various states to the webGL context\n   * @param culling defines culling state: true to enable culling, false to disable it\n   * @param zOffset defines the value to apply to zOffset (0 by default)\n   * @param force defines if states must be applied even if cache is up to date\n   * @param reverseSide defines if culling must be reversed (CCW if false, CW if true)\n   * @param cullBackFaces true to cull back faces, false to cull front faces (if culling is enabled)\n   * @param stencil stencil states to set\n   * @param zOffsetUnits defines the value to apply to zOffsetUnits (0 by default)\n   */\n\n\n  ThinEngine.prototype.setState = function (culling, zOffset, force, reverseSide, cullBackFaces, stencil, zOffsetUnits) {\n    var _a, _b;\n\n    if (zOffset === void 0) {\n      zOffset = 0;\n    }\n\n    if (reverseSide === void 0) {\n      reverseSide = false;\n    }\n\n    if (zOffsetUnits === void 0) {\n      zOffsetUnits = 0;\n    } // Culling\n\n\n    if (this._depthCullingState.cull !== culling || force) {\n      this._depthCullingState.cull = culling;\n    } // Cull face\n\n\n    var cullFace = ((_b = (_a = this.cullBackFaces) !== null && _a !== void 0 ? _a : cullBackFaces) !== null && _b !== void 0 ? _b : true) ? this._gl.BACK : this._gl.FRONT;\n\n    if (this._depthCullingState.cullFace !== cullFace || force) {\n      this._depthCullingState.cullFace = cullFace;\n    } // Z offset\n\n\n    this.setZOffset(zOffset);\n    this.setZOffsetUnits(zOffsetUnits); // Front face\n\n    var frontFace = reverseSide ? this._gl.CW : this._gl.CCW;\n\n    if (this._depthCullingState.frontFace !== frontFace || force) {\n      this._depthCullingState.frontFace = frontFace;\n    }\n\n    this._stencilStateComposer.stencilMaterial = stencil;\n  };\n  /**\n   * Set the z offset Factor to apply to current rendering\n   * @param value defines the offset to apply\n   */\n\n\n  ThinEngine.prototype.setZOffset = function (value) {\n    this._depthCullingState.zOffset = this.useReverseDepthBuffer ? -value : value;\n  };\n  /**\n   * Gets the current value of the zOffset Factor\n   * @returns the current zOffset Factor state\n   */\n\n\n  ThinEngine.prototype.getZOffset = function () {\n    var zOffset = this._depthCullingState.zOffset;\n    return this.useReverseDepthBuffer ? -zOffset : zOffset;\n  };\n  /**\n   * Set the z offset Units to apply to current rendering\n   * @param value defines the offset to apply\n   */\n\n\n  ThinEngine.prototype.setZOffsetUnits = function (value) {\n    this._depthCullingState.zOffsetUnits = this.useReverseDepthBuffer ? -value : value;\n  };\n  /**\n   * Gets the current value of the zOffset Units\n   * @returns the current zOffset Units state\n   */\n\n\n  ThinEngine.prototype.getZOffsetUnits = function () {\n    var zOffsetUnits = this._depthCullingState.zOffsetUnits;\n    return this.useReverseDepthBuffer ? -zOffsetUnits : zOffsetUnits;\n  };\n  /**\n   * @param framebuffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\n\n      this._currentFramebuffer = framebuffer;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._currentFrameBufferIsDefaultFrameBuffer = function () {\n    return this._currentFramebuffer === null;\n  };\n  /**\n   * Generates the mipmaps for a texture\n   * @param texture texture to generate the mipmaps for\n   */\n\n\n  ThinEngine.prototype.generateMipmaps = function (texture) {\n    this._bindTextureDirectly(this._gl.TEXTURE_2D, texture, true);\n\n    this._gl.generateMipmap(this._gl.TEXTURE_2D);\n\n    this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n  };\n  /**\n   * Unbind the current render target texture from the webGL context\n   * @param texture defines the render target wrapper to unbind\n   * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\n   * @param onBeforeUnbind defines a function which will be called before the effective unbind\n   */\n\n\n  ThinEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\n    var _a;\n\n    if (disableGenerateMipMaps === void 0) {\n      disableGenerateMipMaps = false;\n    }\n\n    var webglRTWrapper = texture;\n    this._currentRenderTarget = null; // If MSAA, we need to bitblt back to main texture\n\n    var gl = this._gl;\n\n    if (webglRTWrapper._MSAAFramebuffer) {\n      if (texture.isMulti) {\n        // This texture is part of a MRT texture, we need to treat all attachments\n        this.unBindMultiColorAttachmentFramebuffer(texture, disableGenerateMipMaps, onBeforeUnbind);\n        return;\n      }\n\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, webglRTWrapper._MSAAFramebuffer);\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, webglRTWrapper._framebuffer);\n      gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\n    }\n\n    if (((_a = texture.texture) === null || _a === void 0 ? void 0 : _a.generateMipMaps) && !disableGenerateMipMaps && !texture.isCube) {\n      this.generateMipmaps(texture.texture);\n    }\n\n    if (onBeforeUnbind) {\n      if (webglRTWrapper._MSAAFramebuffer) {\n        // Bind the correct framebuffer\n        this._bindUnboundFramebuffer(webglRTWrapper._framebuffer);\n      }\n\n      onBeforeUnbind();\n    }\n\n    this._bindUnboundFramebuffer(null);\n  };\n  /**\n   * Force a webGL flush (ie. a flush of all waiting webGL commands)\n   */\n\n\n  ThinEngine.prototype.flushFramebuffer = function () {\n    this._gl.flush();\n  };\n  /**\n   * Unbind the current render target and bind the default framebuffer\n   */\n\n\n  ThinEngine.prototype.restoreDefaultFramebuffer = function () {\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    } else {\n      this._bindUnboundFramebuffer(null);\n    }\n\n    if (this._cachedViewport) {\n      this.setViewport(this._cachedViewport);\n    }\n\n    this.wipeCaches();\n  }; // VBOs\n\n  /** @hidden */\n\n\n  ThinEngine.prototype._resetVertexBufferBinding = function () {\n    this.bindArrayBuffer(null);\n    this._cachedVertexBuffers = null;\n  };\n  /**\n   * Creates a vertex buffer\n   * @param data the data for the vertex buffer\n   * @returns the new WebGL static buffer\n   */\n\n\n  ThinEngine.prototype.createVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\n  };\n\n  ThinEngine.prototype._createVertexBuffer = function (data, usage) {\n    var vbo = this._gl.createBuffer();\n\n    if (!vbo) {\n      throw new Error(\"Unable to create vertex buffer\");\n    }\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n    this.bindArrayBuffer(dataBuffer);\n\n    if (data instanceof Array) {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), usage);\n    } else {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, data, usage);\n    }\n\n    this._resetVertexBufferBinding();\n\n    dataBuffer.references = 1;\n    return dataBuffer;\n  };\n  /**\n   * Creates a dynamic vertex buffer\n   * @param data the data for the dynamic vertex buffer\n   * @returns the new WebGL dynamic buffer\n   */\n\n\n  ThinEngine.prototype.createDynamicVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\n  };\n\n  ThinEngine.prototype._resetIndexBufferBinding = function () {\n    this.bindIndexBuffer(null);\n    this._cachedIndexBuffer = null;\n  };\n  /**\n   * Creates a new index buffer\n   * @param indices defines the content of the index buffer\n   * @param updatable defines if the index buffer must be updatable\n   * @returns a new webGL buffer\n   */\n\n\n  ThinEngine.prototype.createIndexBuffer = function (indices, updatable) {\n    var vbo = this._gl.createBuffer();\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n\n    if (!vbo) {\n      throw new Error(\"Unable to create index buffer\");\n    }\n\n    this.bindIndexBuffer(dataBuffer);\n\n    var data = this._normalizeIndexData(indices);\n\n    this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\n\n    this._resetIndexBufferBinding();\n\n    dataBuffer.references = 1;\n    dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n    return dataBuffer;\n  };\n\n  ThinEngine.prototype._normalizeIndexData = function (indices) {\n    var bytesPerElement = indices.BYTES_PER_ELEMENT;\n\n    if (bytesPerElement === 2) {\n      return indices;\n    } // Check 32 bit support\n\n\n    if (this._caps.uintIndices) {\n      if (indices instanceof Uint32Array) {\n        return indices;\n      } else {\n        // number[] or Int32Array, check if 32 bit is necessary\n        for (var index = 0; index < indices.length; index++) {\n          if (indices[index] >= 65535) {\n            return new Uint32Array(indices);\n          }\n        }\n\n        return new Uint16Array(indices);\n      }\n    } // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\n\n\n    return new Uint16Array(indices);\n  };\n  /**\n   * Bind a webGL buffer to the webGL context\n   * @param buffer defines the buffer to bind\n   */\n\n\n  ThinEngine.prototype.bindArrayBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this._bindBuffer(buffer, this._gl.ARRAY_BUFFER);\n  };\n  /**\n   * Bind a specific block at a given index in a specific shader program\n   * @param pipelineContext defines the pipeline context to use\n   * @param blockName defines the block name\n   * @param index defines the index where to bind the block\n   */\n\n\n  ThinEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\n    var program = pipelineContext.program;\n\n    var uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\n\n    this._gl.uniformBlockBinding(program, uniformLocation, index);\n  }; // eslint-disable-next-line @typescript-eslint/naming-convention\n\n\n  ThinEngine.prototype.bindIndexBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this._bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\n  };\n\n  ThinEngine.prototype._bindBuffer = function (buffer, target) {\n    if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\n      this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\n\n      this._currentBoundBuffer[target] = buffer;\n    }\n  };\n  /**\n   * update the bound buffer with the given data\n   * @param data defines the data to update\n   */\n\n\n  ThinEngine.prototype.updateArrayBuffer = function (data) {\n    this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n  };\n\n  ThinEngine.prototype._vertexAttribPointer = function (buffer, indx, size, type, normalized, stride, offset) {\n    var pointer = this._currentBufferPointers[indx];\n\n    if (!pointer) {\n      return;\n    }\n\n    var changed = false;\n\n    if (!pointer.active) {\n      changed = true;\n      pointer.active = true;\n      pointer.index = indx;\n      pointer.size = size;\n      pointer.type = type;\n      pointer.normalized = normalized;\n      pointer.stride = stride;\n      pointer.offset = offset;\n      pointer.buffer = buffer;\n    } else {\n      if (pointer.buffer !== buffer) {\n        pointer.buffer = buffer;\n        changed = true;\n      }\n\n      if (pointer.size !== size) {\n        pointer.size = size;\n        changed = true;\n      }\n\n      if (pointer.type !== type) {\n        pointer.type = type;\n        changed = true;\n      }\n\n      if (pointer.normalized !== normalized) {\n        pointer.normalized = normalized;\n        changed = true;\n      }\n\n      if (pointer.stride !== stride) {\n        pointer.stride = stride;\n        changed = true;\n      }\n\n      if (pointer.offset !== offset) {\n        pointer.offset = offset;\n        changed = true;\n      }\n    }\n\n    if (changed || this._vaoRecordInProgress) {\n      this.bindArrayBuffer(buffer);\n\n      this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\n    }\n  };\n  /**\n   * @param indexBuffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._bindIndexBufferWithCache = function (indexBuffer) {\n    if (indexBuffer == null) {\n      return;\n    }\n\n    if (this._cachedIndexBuffer !== indexBuffer) {\n      this._cachedIndexBuffer = indexBuffer;\n      this.bindIndexBuffer(indexBuffer);\n      this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\n    }\n  };\n\n  ThinEngine.prototype._bindVertexBuffersAttributes = function (vertexBuffers, effect, overrideVertexBuffers) {\n    var attributes = effect.getAttributesNames();\n\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.unbindAllAttributes();\n\n    for (var index = 0; index < attributes.length; index++) {\n      var order = effect.getAttributeLocation(index);\n\n      if (order >= 0) {\n        var ai = attributes[index];\n        var vertexBuffer = null;\n\n        if (overrideVertexBuffers) {\n          vertexBuffer = overrideVertexBuffers[ai];\n        }\n\n        if (!vertexBuffer) {\n          vertexBuffer = vertexBuffers[ai];\n        }\n\n        if (!vertexBuffer) {\n          continue;\n        }\n\n        this._gl.enableVertexAttribArray(order);\n\n        if (!this._vaoRecordInProgress) {\n          this._vertexAttribArraysEnabled[order] = true;\n        }\n\n        var buffer = vertexBuffer.getBuffer();\n\n        if (buffer) {\n          this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\n\n          if (vertexBuffer.getIsInstanced()) {\n            this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\n\n            if (!this._vaoRecordInProgress) {\n              this._currentInstanceLocations.push(order);\n\n              this._currentInstanceBuffers.push(buffer);\n            }\n          }\n        }\n      }\n    }\n  };\n  /**\n   * Records a vertex array object\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\n   * @param vertexBuffers defines the list of vertex buffers to store\n   * @param indexBuffer defines the index buffer to store\n   * @param effect defines the effect to store\n   * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\n   * @returns the new vertex array object\n   */\n\n\n  ThinEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect, overrideVertexBuffers) {\n    var vao = this._gl.createVertexArray();\n\n    this._vaoRecordInProgress = true;\n\n    this._gl.bindVertexArray(vao);\n\n    this._mustWipeVertexAttributes = true;\n\n    this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\n\n    this.bindIndexBuffer(indexBuffer);\n    this._vaoRecordInProgress = false;\n\n    this._gl.bindVertexArray(null);\n\n    return vao;\n  };\n  /**\n   * Bind a specific vertex array object\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\n   * @param vertexArrayObject defines the vertex array object to bind\n   * @param indexBuffer defines the index buffer to bind\n   */\n\n\n  ThinEngine.prototype.bindVertexArrayObject = function (vertexArrayObject, indexBuffer) {\n    if (this._cachedVertexArrayObject !== vertexArrayObject) {\n      this._cachedVertexArrayObject = vertexArrayObject;\n\n      this._gl.bindVertexArray(vertexArrayObject);\n\n      this._cachedVertexBuffers = null;\n      this._cachedIndexBuffer = null;\n      this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\n      this._mustWipeVertexAttributes = true;\n    }\n  };\n  /**\n   * Bind webGl buffers directly to the webGL context\n   * @param vertexBuffer defines the vertex buffer to bind\n   * @param indexBuffer defines the index buffer to bind\n   * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\n   * @param vertexStrideSize defines the vertex stride of the vertex buffer\n   * @param effect defines the effect associated with the vertex buffer\n   */\n\n\n  ThinEngine.prototype.bindBuffersDirectly = function (vertexBuffer, indexBuffer, vertexDeclaration, vertexStrideSize, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffer;\n      this._cachedEffectForVertexBuffers = effect;\n      var attributesCount = effect.getAttributesCount();\n\n      this._unbindVertexArrayObject();\n\n      this.unbindAllAttributes();\n      var offset = 0;\n\n      for (var index = 0; index < attributesCount; index++) {\n        if (index < vertexDeclaration.length) {\n          var order = effect.getAttributeLocation(index);\n\n          if (order >= 0) {\n            this._gl.enableVertexAttribArray(order);\n\n            this._vertexAttribArraysEnabled[order] = true;\n\n            this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\n          }\n\n          offset += vertexDeclaration[index] * 4;\n        }\n      }\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n\n  ThinEngine.prototype._unbindVertexArrayObject = function () {\n    if (!this._cachedVertexArrayObject) {\n      return;\n    }\n\n    this._cachedVertexArrayObject = null;\n\n    this._gl.bindVertexArray(null);\n  };\n  /**\n   * Bind a list of vertex buffers to the webGL context\n   * @param vertexBuffers defines the list of vertex buffers to bind\n   * @param indexBuffer defines the index buffer to bind\n   * @param effect defines the effect associated with the vertex buffers\n   * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\n   */\n\n\n  ThinEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect, overrideVertexBuffers) {\n    if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffers;\n      this._cachedEffectForVertexBuffers = effect;\n\n      this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n  /**\n   * Unbind all instance attributes\n   */\n\n\n  ThinEngine.prototype.unbindInstanceAttributes = function () {\n    var boundBuffer;\n\n    for (var i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\n      var instancesBuffer = this._currentInstanceBuffers[i];\n\n      if (boundBuffer != instancesBuffer && instancesBuffer.references) {\n        boundBuffer = instancesBuffer;\n        this.bindArrayBuffer(instancesBuffer);\n      }\n\n      var offsetLocation = this._currentInstanceLocations[i];\n\n      this._gl.vertexAttribDivisor(offsetLocation, 0);\n    }\n\n    this._currentInstanceBuffers.length = 0;\n    this._currentInstanceLocations.length = 0;\n  };\n  /**\n   * Release and free the memory of a vertex array object\n   * @param vao defines the vertex array object to delete\n   */\n\n\n  ThinEngine.prototype.releaseVertexArrayObject = function (vao) {\n    this._gl.deleteVertexArray(vao);\n  };\n  /**\n   * @param buffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._releaseBuffer = function (buffer) {\n    buffer.references--;\n\n    if (buffer.references === 0) {\n      this._deleteBuffer(buffer);\n\n      return true;\n    }\n\n    return false;\n  };\n\n  ThinEngine.prototype._deleteBuffer = function (buffer) {\n    this._gl.deleteBuffer(buffer.underlyingResource);\n  };\n  /**\n   * Update the content of a webGL buffer used with instantiation and bind it to the webGL context\n   * @param instancesBuffer defines the webGL buffer to update and bind\n   * @param data defines the data to store in the buffer\n   * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\n   */\n\n\n  ThinEngine.prototype.updateAndBindInstancesBuffer = function (instancesBuffer, data, offsetLocations) {\n    this.bindArrayBuffer(instancesBuffer);\n\n    if (data) {\n      this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n    }\n\n    if (offsetLocations[0].index !== undefined) {\n      this.bindInstancesBuffer(instancesBuffer, offsetLocations, true);\n    } else {\n      for (var index = 0; index < 4; index++) {\n        var offsetLocation = offsetLocations[index];\n\n        if (!this._vertexAttribArraysEnabled[offsetLocation]) {\n          this._gl.enableVertexAttribArray(offsetLocation);\n\n          this._vertexAttribArraysEnabled[offsetLocation] = true;\n        }\n\n        this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\n\n        this._gl.vertexAttribDivisor(offsetLocation, 1);\n\n        this._currentInstanceLocations.push(offsetLocation);\n\n        this._currentInstanceBuffers.push(instancesBuffer);\n      }\n    }\n  };\n  /**\n   * Bind the content of a webGL buffer used with instantiation\n   * @param instancesBuffer defines the webGL buffer to bind\n   * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\n   * @param computeStride defines Whether to compute the strides from the info or use the default 0\n   */\n\n\n  ThinEngine.prototype.bindInstancesBuffer = function (instancesBuffer, attributesInfo, computeStride) {\n    if (computeStride === void 0) {\n      computeStride = true;\n    }\n\n    this.bindArrayBuffer(instancesBuffer);\n    var stride = 0;\n\n    if (computeStride) {\n      for (var i = 0; i < attributesInfo.length; i++) {\n        var ai = attributesInfo[i];\n        stride += ai.attributeSize * 4;\n      }\n    }\n\n    for (var i = 0; i < attributesInfo.length; i++) {\n      var ai = attributesInfo[i];\n\n      if (ai.index === undefined) {\n        ai.index = this._currentEffect.getAttributeLocationByName(ai.attributeName);\n      }\n\n      if (ai.index < 0) {\n        continue;\n      }\n\n      if (!this._vertexAttribArraysEnabled[ai.index]) {\n        this._gl.enableVertexAttribArray(ai.index);\n\n        this._vertexAttribArraysEnabled[ai.index] = true;\n      }\n\n      this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\n\n      this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\n\n      this._currentInstanceLocations.push(ai.index);\n\n      this._currentInstanceBuffers.push(instancesBuffer);\n    }\n  };\n  /**\n   * Disable the instance attribute corresponding to the name in parameter\n   * @param name defines the name of the attribute to disable\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttributeByName = function (name) {\n    if (!this._currentEffect) {\n      return;\n    }\n\n    var attributeLocation = this._currentEffect.getAttributeLocationByName(name);\n\n    this.disableInstanceAttribute(attributeLocation);\n  };\n  /**\n   * Disable the instance attribute corresponding to the location in parameter\n   * @param attributeLocation defines the attribute location of the attribute to disable\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttribute = function (attributeLocation) {\n    var shouldClean = false;\n    var index;\n\n    while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\n      this._currentInstanceLocations.splice(index, 1);\n\n      this._currentInstanceBuffers.splice(index, 1);\n\n      shouldClean = true;\n      index = this._currentInstanceLocations.indexOf(attributeLocation);\n    }\n\n    if (shouldClean) {\n      this._gl.vertexAttribDivisor(attributeLocation, 0);\n\n      this.disableAttributeByIndex(attributeLocation);\n    }\n  };\n  /**\n   * Disable the attribute corresponding to the location in parameter\n   * @param attributeLocation defines the attribute location of the attribute to disable\n   */\n\n\n  ThinEngine.prototype.disableAttributeByIndex = function (attributeLocation) {\n    this._gl.disableVertexAttribArray(attributeLocation);\n\n    this._vertexAttribArraysEnabled[attributeLocation] = false;\n    this._currentBufferPointers[attributeLocation].active = false;\n  };\n  /**\n   * Send a draw order\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\n   * @param indexStart defines the starting index\n   * @param indexCount defines the number of index to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  ThinEngine.prototype.draw = function (useTriangles, indexStart, indexCount, instancesCount) {\n    this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\n  };\n  /**\n   * Draw a list of points\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  ThinEngine.prototype.drawPointClouds = function (verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\n  };\n  /**\n   * Draw a list of unindexed primitives\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  ThinEngine.prototype.drawUnIndexed = function (useTriangles, verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\n  };\n  /**\n   * Draw a list of indexed primitives\n   * @param fillMode defines the primitive to use\n   * @param indexStart defines the starting index\n   * @param indexCount defines the number of index to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  ThinEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall(); // Render\n\n\n    var drawMode = this._drawMode(fillMode);\n\n    var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    var mult = this._uintIndicesCurrentlySet ? 4 : 2;\n\n    if (instancesCount) {\n      this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    } else {\n      this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\n    }\n  };\n  /**\n   * Draw a list of unindexed primitives\n   * @param fillMode defines the primitive to use\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n\n\n  ThinEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall();\n\n    var drawMode = this._drawMode(fillMode);\n\n    if (instancesCount) {\n      this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    } else {\n      this._gl.drawArrays(drawMode, verticesStart, verticesCount);\n    }\n  };\n\n  ThinEngine.prototype._drawMode = function (fillMode) {\n    switch (fillMode) {\n      // Triangle views\n      case 0:\n        return this._gl.TRIANGLES;\n\n      case 2:\n        return this._gl.POINTS;\n\n      case 1:\n        return this._gl.LINES;\n      // Draw modes\n\n      case 3:\n        return this._gl.POINTS;\n\n      case 4:\n        return this._gl.LINES;\n\n      case 5:\n        return this._gl.LINE_LOOP;\n\n      case 6:\n        return this._gl.LINE_STRIP;\n\n      case 7:\n        return this._gl.TRIANGLE_STRIP;\n\n      case 8:\n        return this._gl.TRIANGLE_FAN;\n\n      default:\n        return this._gl.TRIANGLES;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._reportDrawCall = function () {// Will be implemented by children\n  }; // Shaders\n\n  /**\n   * @param effect\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._releaseEffect = function (effect) {\n    if (this._compiledEffects[effect._key]) {\n      delete this._compiledEffects[effect._key];\n      var pipelineContext = effect.getPipelineContext();\n\n      if (pipelineContext) {\n        this._deletePipelineContext(pipelineContext);\n      }\n    }\n  };\n  /**\n   * @param pipelineContext\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._deletePipelineContext = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (webGLPipelineContext && webGLPipelineContext.program) {\n      webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\n\n      this._gl.deleteProgram(webGLPipelineContext.program);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getGlobalDefines = function (defines) {\n    if (defines) {\n      if (this.isNDCHalfZRange) {\n        defines[\"IS_NDC_HALF_ZRANGE\"] = \"\";\n      } else {\n        delete defines[\"IS_NDC_HALF_ZRANGE\"];\n      }\n\n      if (this.useReverseDepthBuffer) {\n        defines[\"USE_REVERSE_DEPTHBUFFER\"] = \"\";\n      } else {\n        delete defines[\"USE_REVERSE_DEPTHBUFFER\"];\n      }\n\n      return;\n    } else {\n      var s = \"\";\n\n      if (this.isNDCHalfZRange) {\n        s += \"#define IS_NDC_HALF_ZRANGE\";\n      }\n\n      if (this.useReverseDepthBuffer) {\n        if (s) {\n          s += \"\\n\";\n        }\n\n        s += \"#define USE_REVERSE_DEPTHBUFFER\";\n      }\n\n      return s;\n    }\n  };\n  /**\n   * Create a new effect (used to store vertex/fragment shaders)\n   * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\n   * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\n   * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\n   * @param samplers defines an array of string used to represent textures\n   * @param defines defines the string containing the defines to use to compile the shaders\n   * @param fallbacks defines the list of potential fallbacks to use if shader compilation fails\n   * @param onCompiled defines a function to call when the effect creation is successful\n   * @param onError defines a function to call when the effect creation has failed\n   * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\n   * @param shaderLanguage the language the shader is written in (default: GLSL)\n   * @returns the new Effect\n   */\n\n\n  ThinEngine.prototype.createEffect = function (baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, defines, fallbacks, onCompiled, onError, indexParameters, shaderLanguage) {\n    var _a;\n\n    if (shaderLanguage === void 0) {\n      shaderLanguage = ShaderLanguage.GLSL;\n    }\n\n    var vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\n    var fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\n\n    var globalDefines = this._getGlobalDefines();\n\n    var fullDefines = (_a = defines !== null && defines !== void 0 ? defines : attributesNamesOrOptions.defines) !== null && _a !== void 0 ? _a : \"\";\n\n    if (globalDefines) {\n      fullDefines += globalDefines;\n    }\n\n    var name = vertex + \"+\" + fragment + \"@\" + fullDefines;\n\n    if (this._compiledEffects[name]) {\n      var compiledEffect = this._compiledEffects[name];\n\n      if (onCompiled && compiledEffect.isReady()) {\n        onCompiled(compiledEffect);\n      }\n\n      return compiledEffect;\n    }\n\n    var effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters, name, shaderLanguage);\n    this._compiledEffects[name] = effect;\n    return effect;\n  }; // eslint-disable-next-line @typescript-eslint/naming-convention\n\n\n  ThinEngine._ConcatenateShader = function (source, defines, shaderVersion) {\n    if (shaderVersion === void 0) {\n      shaderVersion = \"\";\n    }\n\n    return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\n  };\n\n  ThinEngine.prototype._compileShader = function (source, type, defines, shaderVersion) {\n    return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\n  };\n\n  ThinEngine.prototype._compileRawShader = function (source, type) {\n    var gl = this._gl;\n    var shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\n\n    if (!shader) {\n      var error = gl.NO_ERROR;\n      var tempError = gl.NO_ERROR;\n\n      while ((tempError = gl.getError()) !== gl.NO_ERROR) {\n        error = tempError;\n      }\n\n      throw new Error(\"Something went wrong while creating a gl \".concat(type, \" shader object. gl error=\").concat(error, \", gl isContextLost=\").concat(gl.isContextLost(), \", _contextWasLost=\").concat(this._contextWasLost));\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    return shader;\n  };\n  /**\n   * @param shader\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getShaderSource = function (shader) {\n    return this._gl.getShaderSource(shader);\n  };\n  /**\n   * Directly creates a webGL program\n   * @param pipelineContext  defines the pipeline context to attach to\n   * @param vertexCode defines the vertex shader code to use\n   * @param fragmentCode defines the fragment shader code to use\n   * @param context defines the webGL context to use (if not set, the current one will be used)\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\n   * @returns the new webGL program\n   */\n\n\n  ThinEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n\n    var vertexShader = this._compileRawShader(vertexCode, \"vertex\");\n\n    var fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\n   * Creates a webGL program\n   * @param pipelineContext  defines the pipeline context to attach to\n   * @param vertexCode  defines the vertex shader code to use\n   * @param fragmentCode defines the fragment shader code to use\n   * @param defines defines the string containing the defines to use to compile the shaders\n   * @param context defines the webGL context to use (if not set, the current one will be used)\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\n   * @returns the new webGL program\n   */\n\n\n  ThinEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n    var shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\n\n    var vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\n\n    var fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\n   * Inline functions in shader code that are marked to be inlined\n   * @param code code to inline\n   * @returns inlined code\n   */\n\n\n  ThinEngine.prototype.inlineShaderCode = function (code) {\n    // no inlining needed in the WebGL engine\n    return code;\n  };\n  /**\n   * Creates a new pipeline context\n   * @param shaderProcessingContext defines the shader processing context used during the processing if available\n   * @returns the new pipeline\n   */\n\n\n  ThinEngine.prototype.createPipelineContext = function (shaderProcessingContext) {\n    var pipelineContext = new WebGLPipelineContext();\n    pipelineContext.engine = this;\n\n    if (this._caps.parallelShaderCompile) {\n      pipelineContext.isParallelCompiled = true;\n    }\n\n    return pipelineContext;\n  };\n  /**\n   * Creates a new material context\n   * @returns the new context\n   */\n\n\n  ThinEngine.prototype.createMaterialContext = function () {\n    return undefined;\n  };\n  /**\n   * Creates a new draw context\n   * @returns the new context\n   */\n\n\n  ThinEngine.prototype.createDrawContext = function () {\n    return undefined;\n  };\n\n  ThinEngine.prototype._createShaderProgram = function (pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    var shaderProgram = context.createProgram();\n    pipelineContext.program = shaderProgram;\n\n    if (!shaderProgram) {\n      throw new Error(\"Unable to create program\");\n    }\n\n    context.attachShader(shaderProgram, vertexShader);\n    context.attachShader(shaderProgram, fragmentShader);\n    context.linkProgram(shaderProgram);\n    pipelineContext.context = context;\n    pipelineContext.vertexShader = vertexShader;\n    pipelineContext.fragmentShader = fragmentShader;\n\n    if (!pipelineContext.isParallelCompiled) {\n      this._finalizePipelineContext(pipelineContext);\n    }\n\n    return shaderProgram;\n  };\n\n  ThinEngine.prototype._finalizePipelineContext = function (pipelineContext) {\n    var context = pipelineContext.context;\n    var vertexShader = pipelineContext.vertexShader;\n    var fragmentShader = pipelineContext.fragmentShader;\n    var program = pipelineContext.program;\n    var linked = context.getProgramParameter(program, context.LINK_STATUS);\n\n    if (!linked) {\n      // Get more info\n      // Vertex\n      if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(vertexShader);\n\n        if (log) {\n          pipelineContext.vertexCompilationError = log;\n          throw new Error(\"VERTEX SHADER \" + log);\n        }\n      } // Fragment\n\n\n      if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(fragmentShader);\n\n        if (log) {\n          pipelineContext.fragmentCompilationError = log;\n          throw new Error(\"FRAGMENT SHADER \" + log);\n        }\n      }\n\n      var error = context.getProgramInfoLog(program);\n\n      if (error) {\n        pipelineContext.programLinkError = error;\n        throw new Error(error);\n      }\n    }\n\n    if (this.validateShaderPrograms) {\n      context.validateProgram(program);\n      var validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\n\n      if (!validated) {\n        var error = context.getProgramInfoLog(program);\n\n        if (error) {\n          pipelineContext.programValidationError = error;\n          throw new Error(error);\n        }\n      }\n    }\n\n    context.deleteShader(vertexShader);\n    context.deleteShader(fragmentShader);\n    pipelineContext.vertexShader = undefined;\n    pipelineContext.fragmentShader = undefined;\n\n    if (pipelineContext.onCompiled) {\n      pipelineContext.onCompiled();\n      pipelineContext.onCompiled = undefined;\n    }\n  };\n  /**\n   * @param pipelineContext\n   * @param vertexSourceCode\n   * @param fragmentSourceCode\n   * @param createAsRaw\n   * @param rawVertexSourceCode\n   * @param rawFragmentSourceCode\n   * @param rebuildRebind\n   * @param defines\n   * @param transformFeedbackVaryings\n   * @param key\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rawVertexSourceCode, rawFragmentSourceCode, rebuildRebind, defines, transformFeedbackVaryings, key) {\n    var webGLRenderingState = pipelineContext;\n\n    if (createAsRaw) {\n      webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n\n    webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\n  };\n  /**\n   * @param pipelineContext\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (this._gl.getProgramParameter(webGLPipelineContext.program, this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)) {\n      this._finalizePipelineContext(webGLPipelineContext);\n\n      return true;\n    }\n\n    return false;\n  };\n  /**\n   * @param pipelineContext\n   * @param action\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (!webGLPipelineContext.isParallelCompiled) {\n      action();\n      return;\n    }\n\n    var oldHandler = webGLPipelineContext.onCompiled;\n\n    if (oldHandler) {\n      webGLPipelineContext.onCompiled = function () {\n        oldHandler();\n        action();\n      };\n    } else {\n      webGLPipelineContext.onCompiled = action;\n    }\n  };\n  /**\n   * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\n   * @param pipelineContext defines the pipeline context to use\n   * @param uniformsNames defines the list of uniform names\n   * @returns an array of webGL uniform locations\n   */\n\n\n  ThinEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\n    var results = new Array();\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < uniformsNames.length; index++) {\n      results.push(this._gl.getUniformLocation(webGLPipelineContext.program, uniformsNames[index]));\n    }\n\n    return results;\n  };\n  /**\n   * Gets the list of active attributes for a given webGL program\n   * @param pipelineContext defines the pipeline context to use\n   * @param attributesNames defines the list of attribute names to get\n   * @returns an array of indices indicating the offset of each attribute\n   */\n\n\n  ThinEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\n    var results = [];\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < attributesNames.length; index++) {\n      try {\n        results.push(this._gl.getAttribLocation(webGLPipelineContext.program, attributesNames[index]));\n      } catch (e) {\n        results.push(-1);\n      }\n    }\n\n    return results;\n  };\n  /**\n   * Activates an effect, making it the current one (ie. the one used for rendering)\n   * @param effect defines the effect to activate\n   */\n\n\n  ThinEngine.prototype.enableEffect = function (effect) {\n    effect = effect !== null && DrawWrapper.IsWrapper(effect) ? effect.effect : effect; // get only the effect, we don't need a Wrapper in the WebGL engine\n\n    if (!effect || effect === this._currentEffect) {\n      return;\n    }\n\n    this._stencilStateComposer.stencilMaterial = undefined;\n    effect = effect; // Use program\n\n    this.bindSamplers(effect);\n    this._currentEffect = effect;\n\n    if (effect.onBind) {\n      effect.onBind(effect);\n    }\n\n    if (effect._onBindObservable) {\n      effect._onBindObservable.notifyObservers(effect);\n    }\n  };\n  /**\n   * Set the value of an uniform to a number (int)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param value defines the int number to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setInt = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1i(uniform, value);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a int2\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setInt2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform2i(uniform, x, y);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a int3\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setInt3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform3i(uniform, x, y, z);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a int4\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @param w defines the 4th component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setInt4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform4i(uniform, x, y, z, w);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of int32\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setIntArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1iv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setIntArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2iv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setIntArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3iv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec4)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setIntArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4iv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of number\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    if (array.length < 1) {\n      return false;\n    }\n\n    this._gl.uniform1fv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of number (stored as vec2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2fv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of number (stored as vec3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3fv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of number (stored as vec4)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4fv(uniform, array);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to an array of float32 (stored as matrices)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrices defines the array of float32 to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setMatrices = function (uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix4fv(uniform, false, matrices);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a matrix (3x3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrix defines the Float32Array representing the 3x3 matrix to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix3fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a matrix (2x2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrix defines the Float32Array representing the 2x2 matrix to store\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix2fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a number (float)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param value defines the float number to store\n   * @returns true if the value was transferred\n   */\n\n\n  ThinEngine.prototype.setFloat = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1f(uniform, value);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a vec2\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setFloat2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform2f(uniform, x, y);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a vec3\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setFloat3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform3f(uniform, x, y, z);\n\n    return true;\n  };\n  /**\n   * Set the value of an uniform to a vec4\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @param w defines the 4th component of the value\n   * @returns true if the value was set\n   */\n\n\n  ThinEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform4f(uniform, x, y, z, w);\n\n    return true;\n  }; // States\n\n  /**\n   * Apply all cached states (depth, culling, stencil and alpha)\n   */\n\n\n  ThinEngine.prototype.applyStates = function () {\n    this._depthCullingState.apply(this._gl);\n\n    this._stencilStateComposer.apply(this._gl);\n\n    this._alphaState.apply(this._gl);\n\n    if (this._colorWriteChanged) {\n      this._colorWriteChanged = false;\n      var enable = this._colorWrite;\n\n      this._gl.colorMask(enable, enable, enable, enable);\n    }\n  };\n  /**\n   * Enable or disable color writing\n   * @param enable defines the state to set\n   */\n\n\n  ThinEngine.prototype.setColorWrite = function (enable) {\n    if (enable !== this._colorWrite) {\n      this._colorWriteChanged = true;\n      this._colorWrite = enable;\n    }\n  };\n  /**\n   * Gets a boolean indicating if color writing is enabled\n   * @returns the current color writing state\n   */\n\n\n  ThinEngine.prototype.getColorWrite = function () {\n    return this._colorWrite;\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"depthCullingState\", {\n    /**\n     * Gets the depth culling state manager\n     */\n    get: function get() {\n      return this._depthCullingState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"alphaState\", {\n    /**\n     * Gets the alpha state manager\n     */\n    get: function get() {\n      return this._alphaState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"stencilState\", {\n    /**\n     * Gets the stencil state manager\n     */\n    get: function get() {\n      return this._stencilState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"stencilStateComposer\", {\n    /**\n     * Gets the stencil state composer\n     */\n    get: function get() {\n      return this._stencilStateComposer;\n    },\n    enumerable: false,\n    configurable: true\n  }); // Textures\n\n  /**\n   * Clears the list of texture accessible through engine.\n   * This can help preventing texture load conflict due to name collision.\n   */\n\n  ThinEngine.prototype.clearInternalTexturesCache = function () {\n    this._internalTexturesCache = [];\n  };\n  /**\n   * Force the entire cache to be cleared\n   * You should not have to use this function unless your engine needs to share the webGL context with another engine\n   * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\n   */\n\n\n  ThinEngine.prototype.wipeCaches = function (bruteForce) {\n    if (this.preventCacheWipeBetweenFrames && !bruteForce) {\n      return;\n    }\n\n    this._currentEffect = null;\n    this._viewportCached.x = 0;\n    this._viewportCached.y = 0;\n    this._viewportCached.z = 0;\n    this._viewportCached.w = 0; // Done before in case we clean the attributes\n\n    this._unbindVertexArrayObject();\n\n    if (bruteForce) {\n      this._currentProgram = null;\n      this.resetTextureCache();\n\n      this._stencilStateComposer.reset();\n\n      this._depthCullingState.reset();\n\n      this._depthCullingState.depthFunc = this._gl.LEQUAL;\n\n      this._alphaState.reset();\n\n      this._alphaMode = 1;\n      this._alphaEquation = 0;\n      this._colorWrite = true;\n      this._colorWriteChanged = true;\n      this._unpackFlipYCached = null;\n\n      this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n      this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\n\n      this._mustWipeVertexAttributes = true;\n      this.unbindAllAttributes();\n    }\n\n    this._resetVertexBufferBinding();\n\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n    this.bindIndexBuffer(null);\n  };\n  /**\n   * @param samplingMode\n   * @param generateMipMaps\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getSamplingParameters = function (samplingMode, generateMipMaps) {\n    var gl = this._gl;\n    var magFilter = gl.NEAREST;\n    var minFilter = gl.NEAREST;\n\n    switch (samplingMode) {\n      case 11:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 3:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 8:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 4:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 5:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 6:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 7:\n        magFilter = gl.NEAREST;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 1:\n        magFilter = gl.NEAREST;\n        minFilter = gl.NEAREST;\n        break;\n\n      case 9:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 10:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 2:\n        magFilter = gl.LINEAR;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 12:\n        magFilter = gl.LINEAR;\n        minFilter = gl.NEAREST;\n        break;\n    }\n\n    return {\n      min: minFilter,\n      mag: magFilter\n    };\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._createTexture = function () {\n    var texture = this._gl.createTexture();\n\n    if (!texture) {\n      throw new Error(\"Unable to create texture\");\n    }\n\n    return texture;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._createHardwareTexture = function () {\n    return new WebGLHardwareTexture(this._createTexture(), this._gl);\n  };\n  /**\n   * Creates an internal texture without binding it to a framebuffer\n   * @hidden\n   * @param size defines the size of the texture\n   * @param options defines the options used to create the texture\n   * @param delayGPUTextureCreation true to delay the texture creation the first time it is really needed. false to create it right away\n   * @param source source type of the texture\n   * @returns a new internal texture\n   */\n\n\n  ThinEngine.prototype._createInternalTexture = function (size, options, delayGPUTextureCreation, source) {\n    if (delayGPUTextureCreation === void 0) {\n      delayGPUTextureCreation = true;\n    }\n\n    if (source === void 0) {\n      source = InternalTextureSource.Unknown;\n    }\n\n    var fullOptions = {};\n\n    if (options !== undefined && _typeof(options) === \"object\") {\n      fullOptions.generateMipMaps = options.generateMipMaps;\n      fullOptions.type = options.type === undefined ? 0 : options.type;\n      fullOptions.samplingMode = options.samplingMode === undefined ? 3 : options.samplingMode;\n      fullOptions.format = options.format === undefined ? 5 : options.format;\n    } else {\n      fullOptions.generateMipMaps = options;\n      fullOptions.type = 0;\n      fullOptions.samplingMode = 3;\n      fullOptions.format = 5;\n    }\n\n    if (fullOptions.type === 1 && !this._caps.textureFloatLinearFiltering) {\n      // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    } else if (fullOptions.type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\n      // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    }\n\n    if (fullOptions.type === 1 && !this._caps.textureFloat) {\n      fullOptions.type = 0;\n      Logger.Warn(\"Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE\");\n    }\n\n    var gl = this._gl;\n    var texture = new InternalTexture(this, source);\n    var width = size.width || size;\n    var height = size.height || size;\n    var layers = size.layers || 0;\n\n    var filters = this._getSamplingParameters(fullOptions.samplingMode, fullOptions.generateMipMaps ? true : false);\n\n    var target = layers !== 0 ? gl.TEXTURE_2D_ARRAY : gl.TEXTURE_2D;\n\n    var sizedFormat = this._getRGBABufferInternalSizedFormat(fullOptions.type, fullOptions.format);\n\n    var internalFormat = this._getInternalFormat(fullOptions.format);\n\n    var type = this._getWebGLTextureType(fullOptions.type); // Bind\n\n\n    this._bindTextureDirectly(target, texture);\n\n    if (layers !== 0) {\n      texture.is2DArray = true;\n      gl.texImage3D(target, 0, sizedFormat, width, height, layers, 0, internalFormat, type, null);\n    } else {\n      gl.texImage2D(target, 0, sizedFormat, width, height, 0, internalFormat, type, null);\n    }\n\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, filters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE); // MipMaps\n\n    if (fullOptions.generateMipMaps) {\n      this._gl.generateMipmap(target);\n    }\n\n    this._bindTextureDirectly(target, null);\n\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = width;\n    texture.height = height;\n    texture.depth = layers;\n    texture.isReady = true;\n    texture.samples = 1;\n    texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\n    texture.samplingMode = fullOptions.samplingMode;\n    texture.type = fullOptions.type;\n    texture.format = fullOptions.format;\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n  /**\n   * @param useSRGBBuffer\n   * @param noMipmap\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getUseSRGBBuffer = function (useSRGBBuffer, noMipmap) {\n    // Generating mipmaps for sRGB textures is not supported in WebGL1 so we must disable the support if mipmaps is enabled\n    return useSRGBBuffer && this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU || noMipmap);\n  };\n\n  ThinEngine.prototype._createTextureBase = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, prepareTexture, prepareTextureProcessFunction, buffer, fallback, format, forcedExtension, mimeType, loaderOptions, useSRGBBuffer) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    url = url || \"\";\n    var fromData = url.substr(0, 5) === \"data:\";\n    var fromBlob = url.substr(0, 5) === \"blob:\";\n    var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    var originalUrl = url;\n\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    }\n\n    if (originalUrl !== url) {\n      texture._originalUrl = originalUrl;\n    } // establish the file extension, if possible\n\n\n    var lastDot = url.lastIndexOf(\".\");\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    var loader = null; // Remove query string\n\n    var queryStringIndex = extension.indexOf(\"?\");\n\n    if (queryStringIndex > -1) {\n      extension = extension.split(\"?\")[0];\n    }\n\n    for (var _i = 0, _a = ThinEngine._TextureLoaders; _i < _a.length; _i++) {\n      var availableLoader = _a[_i];\n\n      if (availableLoader.canLoad(extension, mimeType)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n\n    if (scene) {\n      scene._addPendingData(texture);\n    }\n\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n    texture._useSRGBBuffer = this._getUseSRGBBuffer(!!useSRGBBuffer, noMipmap);\n\n    if (!this._doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n\n    var onLoadObserver = null;\n\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n\n    var onInternalError = function onInternalError(message, exception) {\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n\n        if (EngineStore.UseFallbackTexture) {\n          _this._createTextureBase(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, prepareTexture, prepareTextureProcessFunction, buffer, texture);\n        }\n\n        message = (message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\");\n        texture.onErrorObservable.notifyObservers({\n          message: message,\n          exception: exception\n        });\n\n        if (onError) {\n          onError(message, exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(\"Failed to load \".concat(url, \", falling back to \").concat(originalUrl));\n\n        _this._createTextureBase(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, prepareTexture, prepareTextureProcessFunction, buffer, texture, format, forcedExtension, mimeType, loaderOptions, useSRGBBuffer);\n      }\n    }; // processing for non-image formats\n\n\n    if (loader) {\n      var callback_1 = function callback_1(data) {\n        loader.loadData(data, texture, function (width, height, loadMipmap, isCompressed, done, loadFailed) {\n          if (loadFailed) {\n            onInternalError(\"TextureLoader failed to load data\");\n          } else {\n            prepareTexture(texture, extension, scene, {\n              width: width,\n              height: height\n            }, texture.invertY, !loadMipmap, isCompressed, function () {\n              done();\n              return false;\n            }, samplingMode);\n          }\n        }, loaderOptions);\n      };\n\n      if (!buffer) {\n        this._loadFile(url, function (data) {\n          return callback_1(new Uint8Array(data));\n        }, undefined, scene ? scene.offlineProvider : undefined, true, function (request, exception) {\n          onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n        });\n      } else {\n        if (buffer instanceof ArrayBuffer) {\n          callback_1(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          callback_1(buffer);\n        } else {\n          if (onError) {\n            onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\n          }\n        }\n      }\n    } else {\n      var onload_1 = function onload_1(img) {\n        if (fromBlob && !_this._doNotHandleContextLost) {\n          // We need to store the image if we need to rebuild the texture\n          // in case of a webgl context lost\n          texture._buffer = img;\n        }\n\n        prepareTexture(texture, extension, scene, img, texture.invertY, noMipmap, false, prepareTextureProcessFunction, samplingMode);\n      }; // According to the WebGL spec section 6.10, ImageBitmaps must be inverted on creation.\n      // So, we pass imageOrientation to _FileToolsLoadImage() as it may create an ImageBitmap.\n\n\n      if (!fromData || isBase64) {\n        if (buffer && (typeof buffer.decoding === \"string\" || buffer.close)) {\n          onload_1(buffer);\n        } else {\n          ThinEngine._FileToolsLoadImage(url, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType, texture.invertY && this._features.needsInvertingBitmap ? {\n            imageOrientation: \"flipY\"\n          } : undefined);\n        }\n      } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\n        ThinEngine._FileToolsLoadImage(buffer, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType, texture.invertY && this._features.needsInvertingBitmap ? {\n          imageOrientation: \"flipY\"\n        } : undefined);\n      } else if (buffer) {\n        onload_1(buffer);\n      }\n    }\n\n    return texture;\n  };\n  /**\n   * Usually called from Texture.ts.\n   * Passed information to create a WebGLTexture\n   * @param url defines a value which contains one of the following:\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\n   * @param scene needed for loading to the correct scene\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\n   * @param onLoad optional callback to be called upon successful completion\n   * @param onError optional callback to be called upon failure\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\n   * @param forcedExtension defines the extension to use to pick the right loader\n   * @param mimeType defines an optional mime type\n   * @param loaderOptions options to be passed to the loader\n   * @param creationFlags specific flags to use when creating the texture (1 for storage textures, for eg)\n   * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\n   */\n\n\n  ThinEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions, creationFlags, useSRGBBuffer) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    return this._createTextureBase(url, noMipmap, invertY, scene, samplingMode, onLoad, onError, this._prepareWebGLTexture.bind(this), function (potWidth, potHeight, img, extension, texture, continuationCallback) {\n      var gl = _this._gl;\n      var isPot = img.width === potWidth && img.height === potHeight;\n      var internalFormat = format ? _this._getInternalFormat(format, texture._useSRGBBuffer) : extension === \".jpg\" && !texture._useSRGBBuffer ? gl.RGB : texture._useSRGBBuffer ? gl.SRGB8_ALPHA8 : gl.RGBA;\n      var texelFormat = format ? _this._getInternalFormat(format) : extension === \".jpg\" && !texture._useSRGBBuffer ? gl.RGB : gl.RGBA;\n\n      if (texture._useSRGBBuffer && _this.webGLVersion === 1) {\n        texelFormat = internalFormat;\n      }\n\n      if (isPot) {\n        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, img);\n        return false;\n      }\n\n      var maxTextureSize = _this._caps.maxTextureSize;\n\n      if (img.width > maxTextureSize || img.height > maxTextureSize || !_this._supportsHardwareTextureRescaling) {\n        _this._prepareWorkingCanvas();\n\n        if (!_this._workingCanvas || !_this._workingContext) {\n          return false;\n        }\n\n        _this._workingCanvas.width = potWidth;\n        _this._workingCanvas.height = potHeight;\n\n        _this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\n\n        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, _this._workingCanvas);\n        texture.width = potWidth;\n        texture.height = potHeight;\n        return false;\n      } else {\n        // Using shaders when possible to rescale because canvas.drawImage is lossy\n        var source_1 = new InternalTexture(_this, InternalTextureSource.Temp);\n\n        _this._bindTextureDirectly(gl.TEXTURE_2D, source_1, true);\n\n        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, img);\n\n        _this._rescaleTexture(source_1, texture, scene, internalFormat, function () {\n          _this._releaseTexture(source_1);\n\n          _this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n          continuationCallback();\n        });\n      }\n\n      return true;\n    }, buffer, fallback, format, forcedExtension, mimeType, loaderOptions, useSRGBBuffer);\n  };\n  /**\n   * Loads an image as an HTMLImageElement.\n   * @param input url string, ArrayBuffer, or Blob to load\n   * @param onLoad callback called when the image successfully loads\n   * @param onError callback called when the image fails to load\n   * @param offlineProvider offline provider for caching\n   * @param mimeType optional mime type\n   * @param imageBitmapOptions optional the options to use when creating an ImageBitmap\n   * @returns the HTMLImageElement of the loaded image\n   * @hidden\n   */\n\n\n  ThinEngine._FileToolsLoadImage = function (input, onLoad, onError, offlineProvider, mimeType, imageBitmapOptions) {\n    throw _WarnImport(\"FileTools\");\n  };\n  /**\n   * @param source\n   * @param destination\n   * @param scene\n   * @param internalFormat\n   * @param onComplete\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._rescaleTexture = function (source, destination, scene, internalFormat, onComplete) {};\n  /**\n   * Creates a raw texture\n   * @param data defines the data to store in the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param format defines the format of the data\n   * @param generateMipMaps defines if the engine should generate the mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\n   * @param compression defines the compression used (null by default)\n   * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\n   * @returns the raw texture inside an InternalTexture\n   */\n\n\n  ThinEngine.prototype.createRawTexture = function (data, width, height, format, generateMipMaps, invertY, samplingMode, compression, type) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (type === void 0) {\n      type = 0;\n    }\n\n    throw _WarnImport(\"Engine.RawTexture\");\n  };\n  /**\n   * Creates a new raw cube texture\n   * @param data defines the array of data to use to create each face\n   * @param size defines the size of the textures\n   * @param format defines the format of the data\n   * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\n   * @param generateMipMaps  defines if the engine should generate the mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compression used (null by default)\n   * @returns the cube texture as an InternalTexture\n   */\n\n\n  ThinEngine.prototype.createRawCubeTexture = function (data, size, format, type, generateMipMaps, invertY, samplingMode, compression) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    throw _WarnImport(\"Engine.RawTexture\");\n  };\n  /**\n   * Creates a new raw 3D texture\n   * @param data defines the data used to create the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param depth defines the depth of the texture\n   * @param format defines the format of the texture\n   * @param generateMipMaps defines if the engine must generate mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compressed used (can be null)\n   * @param textureType defines the compressed used (can be null)\n   * @returns a new raw 3D texture (stored in an InternalTexture)\n   */\n\n\n  ThinEngine.prototype.createRawTexture3D = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _WarnImport(\"Engine.RawTexture\");\n  };\n  /**\n   * Creates a new raw 2D array texture\n   * @param data defines the data used to create the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param depth defines the number of layers of the texture\n   * @param format defines the format of the texture\n   * @param generateMipMaps defines if the engine must generate mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compressed used (can be null)\n   * @param textureType defines the compressed used (can be null)\n   * @returns a new raw 2D array texture (stored in an InternalTexture)\n   */\n\n\n  ThinEngine.prototype.createRawTexture2DArray = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _WarnImport(\"Engine.RawTexture\");\n  };\n  /**\n   * @param value\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._unpackFlipY = function (value) {\n    if (this._unpackFlipYCached !== value) {\n      this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\n\n      if (this.enableUnpackFlipYCached) {\n        this._unpackFlipYCached = value;\n      }\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getUnpackAlignement = function () {\n    return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\n  };\n\n  ThinEngine.prototype._getTextureTarget = function (texture) {\n    if (texture.isCube) {\n      return this._gl.TEXTURE_CUBE_MAP;\n    } else if (texture.is3D) {\n      return this._gl.TEXTURE_3D;\n    } else if (texture.is2DArray || texture.isMultiview) {\n      return this._gl.TEXTURE_2D_ARRAY;\n    }\n\n    return this._gl.TEXTURE_2D;\n  };\n  /**\n   * Update the sampling mode of a given texture\n   * @param samplingMode defines the required sampling mode\n   * @param texture defines the texture to update\n   * @param generateMipMaps defines whether to generate mipmaps for the texture\n   */\n\n\n  ThinEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture, generateMipMaps) {\n    if (generateMipMaps === void 0) {\n      generateMipMaps = false;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    var filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (generateMipMaps) {\n      texture.generateMipMaps = true;\n\n      this._gl.generateMipmap(target);\n    }\n\n    this._bindTextureDirectly(target, null);\n\n    texture.samplingMode = samplingMode;\n  };\n  /**\n   * Update the dimensions of a texture\n   * @param texture texture to update\n   * @param width new width of the texture\n   * @param height new height of the texture\n   * @param depth new depth of the texture\n   */\n\n\n  ThinEngine.prototype.updateTextureDimensions = function (texture, width, height, depth) {\n    if (depth === void 0) {\n      depth = 1;\n    }\n  };\n  /**\n   * Update the sampling mode of a given texture\n   * @param texture defines the texture to update\n   * @param wrapU defines the texture wrap mode of the u coordinates\n   * @param wrapV defines the texture wrap mode of the v coordinates\n   * @param wrapR defines the texture wrap mode of the r coordinates\n   */\n\n\n  ThinEngine.prototype.updateTextureWrappingMode = function (texture, wrapU, wrapV, wrapR) {\n    if (wrapV === void 0) {\n      wrapV = null;\n    }\n\n    if (wrapR === void 0) {\n      wrapR = null;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    if (wrapU !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\n\n      texture._cachedWrapU = wrapU;\n    }\n\n    if (wrapV !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\n\n      texture._cachedWrapV = wrapV;\n    }\n\n    if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\n\n      texture._cachedWrapR = wrapR;\n    }\n\n    this._bindTextureDirectly(target, null);\n  };\n  /**\n   * @param internalTexture\n   * @param size\n   * @param generateStencil\n   * @param bilinearFiltering\n   * @param comparisonFunction\n   * @param samples\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._setupDepthStencilTexture = function (internalTexture, size, generateStencil, bilinearFiltering, comparisonFunction, samples) {\n    if (samples === void 0) {\n      samples = 1;\n    }\n\n    var width = size.width || size;\n    var height = size.height || size;\n    var layers = size.layers || 0;\n    internalTexture.baseWidth = width;\n    internalTexture.baseHeight = height;\n    internalTexture.width = width;\n    internalTexture.height = height;\n    internalTexture.is2DArray = layers > 0;\n    internalTexture.depth = layers;\n    internalTexture.isReady = true;\n    internalTexture.samples = samples;\n    internalTexture.generateMipMaps = false;\n    internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\n    internalTexture.type = 0;\n    internalTexture._comparisonFunction = comparisonFunction;\n    var gl = this._gl;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    var samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\n\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n    if (comparisonFunction === 0) {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\n    } else {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\n    }\n  };\n  /**\n   * @param texture\n   * @param internalFormat\n   * @param width\n   * @param height\n   * @param data\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    if (texture._useSRGBBuffer) {\n      switch (internalFormat) {\n        case 36492:\n          internalFormat = gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\n          break;\n\n        case 37808:\n          internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\n          break;\n\n        case 33776:\n          if (this._caps.s3tc_srgb) {\n            internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\n          } else {\n            // S3TC sRGB extension not supported\n            texture._useSRGBBuffer = false;\n          }\n\n          break;\n\n        case 33779:\n          if (this._caps.s3tc_srgb) {\n            internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\n          } else {\n            // S3TC sRGB extension not supported\n            texture._useSRGBBuffer = false;\n          }\n\n          break;\n\n        default:\n          // We don't support a sRGB format corresponding to internalFormat, so revert to non sRGB format\n          texture._useSRGBBuffer = false;\n          break;\n      }\n    }\n\n    this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, data);\n  };\n  /**\n   * @param texture\n   * @param imageData\n   * @param faceIndex\n   * @param lod\n   * @param babylonInternalFormat\n   * @param useTextureWidthAndHeight\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod, babylonInternalFormat, useTextureWidthAndHeight) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    if (useTextureWidthAndHeight === void 0) {\n      useTextureWidthAndHeight = false;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    var internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format, texture._useSRGBBuffer) : this._getInternalFormat(babylonInternalFormat, texture._useSRGBBuffer);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    var lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\n    var lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\n    var width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\n    var height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\n    gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\n  };\n  /**\n   * Update a portion of an internal texture\n   * @param texture defines the texture to update\n   * @param imageData defines the data to store into the texture\n   * @param xOffset defines the x coordinates of the update rectangle\n   * @param yOffset defines the y coordinates of the update rectangle\n   * @param width defines the width of the update rectangle\n   * @param height defines the height of the update rectangle\n   * @param faceIndex defines the face index if texture is a cube (0 by default)\n   * @param lod defines the lod level to update (0 by default)\n   * @param generateMipMaps defines whether to generate mipmaps or not\n   */\n\n\n  ThinEngine.prototype.updateTextureData = function (texture, imageData, xOffset, yOffset, width, height, faceIndex, lod, generateMipMaps) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    if (generateMipMaps === void 0) {\n      generateMipMaps = false;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    this._bindTextureDirectly(target, texture, true);\n\n    gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\n\n    if (generateMipMaps) {\n      this._gl.generateMipmap(target);\n    }\n\n    this._bindTextureDirectly(target, null);\n  };\n  /**\n   * @param texture\n   * @param imageData\n   * @param faceIndex\n   * @param lod\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(bindTarget, texture, true);\n\n    this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\n\n    this._bindTextureDirectly(bindTarget, null, true);\n  };\n\n  ThinEngine.prototype._prepareWebGLTextureContinuation = function (texture, scene, noMipmap, isCompressed, samplingMode) {\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    var filters = this._getSamplingParameters(samplingMode, !noMipmap);\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (!noMipmap && !isCompressed) {\n      gl.generateMipmap(gl.TEXTURE_2D);\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, null); // this.resetTextureCache();\n\n\n    if (scene) {\n      scene._removePendingData(texture);\n    }\n\n    texture.onLoadedObservable.notifyObservers(texture);\n    texture.onLoadedObservable.clear();\n  };\n\n  ThinEngine.prototype._prepareWebGLTexture = function (texture, extension, scene, img, invertY, noMipmap, isCompressed, processFunction, samplingMode) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    var maxTextureSize = this.getCaps().maxTextureSize;\n    var potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.width, maxTextureSize) : img.width);\n    var potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.height, maxTextureSize) : img.height);\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    if (!texture._hardwareTexture) {\n      //  this.resetTextureCache();\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      return;\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n    this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\n\n    texture.baseWidth = img.width;\n    texture.baseHeight = img.height;\n    texture.width = potWidth;\n    texture.height = potHeight;\n    texture.isReady = true;\n\n    if (processFunction(potWidth, potHeight, img, extension, texture, function () {\n      _this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n    })) {\n      // Returning as texture needs extra async steps\n      return;\n    }\n\n    this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n  };\n  /**\n   * @param generateStencilBuffer\n   * @param generateDepthBuffer\n   * @param width\n   * @param height\n   * @param samples\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._setupFramebufferDepthAttachments = function (generateStencilBuffer, generateDepthBuffer, width, height, samples) {\n    if (samples === void 0) {\n      samples = 1;\n    }\n\n    var gl = this._gl; // Create the depth/stencil buffer\n\n    if (generateStencilBuffer && generateDepthBuffer) {\n      return this._createRenderBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\n    }\n\n    if (generateDepthBuffer) {\n      var depthFormat = gl.DEPTH_COMPONENT16;\n\n      if (this._webGLVersion > 1) {\n        depthFormat = gl.DEPTH_COMPONENT32F;\n      }\n\n      return this._createRenderBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\n    }\n\n    if (generateStencilBuffer) {\n      return this._createRenderBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\n    }\n\n    return null;\n  };\n  /**\n   * @param width\n   * @param height\n   * @param samples\n   * @param internalFormat\n   * @param msInternalFormat\n   * @param attachment\n   * @param unbindBuffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._createRenderBuffer = function (width, height, samples, internalFormat, msInternalFormat, attachment, unbindBuffer) {\n    if (unbindBuffer === void 0) {\n      unbindBuffer = true;\n    }\n\n    var gl = this._gl;\n    var renderBuffer = gl.createRenderbuffer();\n    gl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\n\n    if (samples > 1 && gl.renderbufferStorageMultisample) {\n      gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\n    } else {\n      gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\n    }\n\n    gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, renderBuffer);\n\n    if (unbindBuffer) {\n      gl.bindRenderbuffer(gl.RENDERBUFFER, null);\n    }\n\n    return renderBuffer;\n  };\n  /**\n   * @param texture\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._releaseTexture = function (texture) {\n    var _a;\n\n    this._deleteTexture((_a = texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource); // Unbind channels\n\n\n    this.unbindAllTextures();\n\n    var index = this._internalTexturesCache.indexOf(texture);\n\n    if (index !== -1) {\n      this._internalTexturesCache.splice(index, 1);\n    } // Integrated fixed lod samplers.\n\n\n    if (texture._lodTextureHigh) {\n      texture._lodTextureHigh.dispose();\n    }\n\n    if (texture._lodTextureMid) {\n      texture._lodTextureMid.dispose();\n    }\n\n    if (texture._lodTextureLow) {\n      texture._lodTextureLow.dispose();\n    } // Integrated irradiance map.\n\n\n    if (texture._irradianceTexture) {\n      texture._irradianceTexture.dispose();\n    }\n  };\n  /**\n   * @param rtWrapper\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._releaseRenderTargetWrapper = function (rtWrapper) {\n    var index = this._renderTargetWrapperCache.indexOf(rtWrapper);\n\n    if (index !== -1) {\n      this._renderTargetWrapperCache.splice(index, 1);\n    }\n  };\n\n  ThinEngine.prototype._deleteTexture = function (texture) {\n    if (texture) {\n      this._gl.deleteTexture(texture);\n    }\n  };\n\n  ThinEngine.prototype._setProgram = function (program) {\n    if (this._currentProgram !== program) {\n      this._gl.useProgram(program);\n\n      this._currentProgram = program;\n    }\n  };\n  /**\n   * Binds an effect to the webGL context\n   * @param effect defines the effect to bind\n   */\n\n\n  ThinEngine.prototype.bindSamplers = function (effect) {\n    var webGLPipelineContext = effect.getPipelineContext();\n\n    this._setProgram(webGLPipelineContext.program);\n\n    var samplers = effect.getSamplers();\n\n    for (var index = 0; index < samplers.length; index++) {\n      var uniform = effect.getUniform(samplers[index]);\n\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n\n    this._currentEffect = null;\n  };\n\n  ThinEngine.prototype._activateCurrentTexture = function () {\n    if (this._currentTextureChannel !== this._activeChannel) {\n      this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\n\n      this._currentTextureChannel = this._activeChannel;\n    }\n  };\n  /**\n   * @param target\n   * @param texture\n   * @param forTextureDataUpdate\n   * @param force\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._bindTextureDirectly = function (target, texture, forTextureDataUpdate, force) {\n    var _a, _b;\n\n    if (forTextureDataUpdate === void 0) {\n      forTextureDataUpdate = false;\n    }\n\n    if (force === void 0) {\n      force = false;\n    }\n\n    var wasPreviouslyBound = false;\n    var isTextureForRendering = texture && texture._associatedChannel > -1;\n\n    if (forTextureDataUpdate && isTextureForRendering) {\n      this._activeChannel = texture._associatedChannel;\n    }\n\n    var currentTextureBound = this._boundTexturesCache[this._activeChannel];\n\n    if (currentTextureBound !== texture || force) {\n      this._activateCurrentTexture();\n\n      if (texture && texture.isMultiview) {\n        //this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\n        console.error(target, texture);\n        throw \"_bindTextureDirectly called with a multiview texture!\";\n      } else {\n        this._gl.bindTexture(target, (_b = (_a = texture === null || texture === void 0 ? void 0 : texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource) !== null && _b !== void 0 ? _b : null);\n      }\n\n      this._boundTexturesCache[this._activeChannel] = texture;\n\n      if (texture) {\n        texture._associatedChannel = this._activeChannel;\n      }\n    } else if (forTextureDataUpdate) {\n      wasPreviouslyBound = true;\n\n      this._activateCurrentTexture();\n    }\n\n    if (isTextureForRendering && !forTextureDataUpdate) {\n      this._bindSamplerUniformToChannel(texture._associatedChannel, this._activeChannel);\n    }\n\n    return wasPreviouslyBound;\n  };\n  /**\n   * @param channel\n   * @param texture\n   * @param name\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._bindTexture = function (channel, texture, name) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (texture) {\n      texture._associatedChannel = channel;\n    }\n\n    this._activeChannel = channel;\n    var target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(target, texture);\n  };\n  /**\n   * Unbind all textures from the webGL context\n   */\n\n\n  ThinEngine.prototype.unbindAllTextures = function () {\n    for (var channel = 0; channel < this._maxSimultaneousTextures; channel++) {\n      this._activeChannel = channel;\n\n      this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n      this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n      if (this.webGLVersion > 1) {\n        this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n      }\n    }\n  };\n  /**\n   * Sets a texture to the according uniform.\n   * @param channel The texture channel\n   * @param uniform The uniform to set\n   * @param texture The texture to apply\n   * @param name The name of the uniform in the effect\n   */\n\n\n  ThinEngine.prototype.setTexture = function (channel, uniform, texture, name) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (uniform) {\n      this._boundUniforms[channel] = uniform;\n    }\n\n    this._setTexture(channel, texture);\n  };\n\n  ThinEngine.prototype._bindSamplerUniformToChannel = function (sourceSlot, destination) {\n    var uniform = this._boundUniforms[sourceSlot];\n\n    if (!uniform || uniform._currentState === destination) {\n      return;\n    }\n\n    this._gl.uniform1i(uniform, destination);\n\n    uniform._currentState = destination;\n  };\n\n  ThinEngine.prototype._getTextureWrapMode = function (mode) {\n    switch (mode) {\n      case 1:\n        return this._gl.REPEAT;\n\n      case 0:\n        return this._gl.CLAMP_TO_EDGE;\n\n      case 2:\n        return this._gl.MIRRORED_REPEAT;\n    }\n\n    return this._gl.REPEAT;\n  };\n\n  ThinEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture, name) {\n    if (isPartOfTextureArray === void 0) {\n      isPartOfTextureArray = false;\n    }\n\n    if (depthStencilTexture === void 0) {\n      depthStencilTexture = false;\n    }\n\n    if (name === void 0) {\n      name = \"\";\n    } // Not ready?\n\n\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n        if (this.webGLVersion > 1) {\n          this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n          this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n        }\n      }\n\n      return false;\n    } // Video\n\n\n    if (texture.video) {\n      this._activeChannel = channel;\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n\n    var internalTexture;\n\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n\n    if (!isPartOfTextureArray && internalTexture) {\n      internalTexture._associatedChannel = channel;\n    }\n\n    var needToBind = true;\n\n    if (this._boundTexturesCache[channel] === internalTexture) {\n      if (!isPartOfTextureArray) {\n        this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\n      }\n\n      needToBind = false;\n    }\n\n    this._activeChannel = channel;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    if (needToBind) {\n      this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\n    }\n\n    if (internalTexture && !internalTexture.isMultiview) {\n      // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\n      if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\n        internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\n        var textureWrapMode = texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5 ? 1 : 0;\n        texture.wrapU = textureWrapMode;\n        texture.wrapV = textureWrapMode;\n      }\n\n      if (internalTexture._cachedWrapU !== texture.wrapU) {\n        internalTexture._cachedWrapU = texture.wrapU;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\n      }\n\n      if (internalTexture._cachedWrapV !== texture.wrapV) {\n        internalTexture._cachedWrapV = texture.wrapV;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\n      }\n\n      if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\n        internalTexture._cachedWrapR = texture.wrapR;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\n      }\n\n      this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\n    }\n\n    return true;\n  };\n  /**\n   * Sets an array of texture to the webGL context\n   * @param channel defines the channel where the texture array must be set\n   * @param uniform defines the associated uniform location\n   * @param textures defines the array of textures to bind\n   * @param name name of the channel\n   */\n\n\n  ThinEngine.prototype.setTextureArray = function (channel, uniform, textures, name) {\n    if (channel === undefined || !uniform) {\n      return;\n    }\n\n    if (!this._textureUnits || this._textureUnits.length !== textures.length) {\n      this._textureUnits = new Int32Array(textures.length);\n    }\n\n    for (var i = 0; i < textures.length; i++) {\n      var texture = textures[i].getInternalTexture();\n\n      if (texture) {\n        this._textureUnits[i] = channel + i;\n        texture._associatedChannel = channel + i;\n      } else {\n        this._textureUnits[i] = -1;\n      }\n    }\n\n    this._gl.uniform1iv(uniform, this._textureUnits);\n\n    for (var index = 0; index < textures.length; index++) {\n      this._setTexture(this._textureUnits[index], textures[index], true);\n    }\n  };\n  /**\n   * @param target\n   * @param internalTexture\n   * @param anisotropicFilteringLevel\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._setAnisotropicLevel = function (target, internalTexture, anisotropicFilteringLevel) {\n    var anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\n\n    if (internalTexture.samplingMode !== 11 && internalTexture.samplingMode !== 3 && internalTexture.samplingMode !== 2) {\n      anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\n    }\n\n    if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\n      this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\n\n      internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\n    }\n  };\n\n  ThinEngine.prototype._setTextureParameterFloat = function (target, parameter, value, texture) {\n    this._bindTextureDirectly(target, texture, true, true);\n\n    this._gl.texParameterf(target, parameter, value);\n  };\n\n  ThinEngine.prototype._setTextureParameterInteger = function (target, parameter, value, texture) {\n    if (texture) {\n      this._bindTextureDirectly(target, texture, true, true);\n    }\n\n    this._gl.texParameteri(target, parameter, value);\n  };\n  /**\n   * Unbind all vertex attributes from the webGL context\n   */\n\n\n  ThinEngine.prototype.unbindAllAttributes = function () {\n    if (this._mustWipeVertexAttributes) {\n      this._mustWipeVertexAttributes = false;\n\n      for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n        this.disableAttributeByIndex(i);\n      }\n\n      return;\n    }\n\n    for (var i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\n      if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\n        continue;\n      }\n\n      this.disableAttributeByIndex(i);\n    }\n  };\n  /**\n   * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\n   */\n\n\n  ThinEngine.prototype.releaseEffects = function () {\n    for (var name_1 in this._compiledEffects) {\n      var webGLPipelineContext = this._compiledEffects[name_1].getPipelineContext();\n\n      this._deletePipelineContext(webGLPipelineContext);\n    }\n\n    this._compiledEffects = {};\n  };\n  /**\n   * Dispose and release all associated resources\n   */\n\n\n  ThinEngine.prototype.dispose = function () {\n    var _a;\n\n    this.stopRenderLoop(); // Clear observables\n\n    if (this.onBeforeTextureInitObservable) {\n      this.onBeforeTextureInitObservable.clear();\n    } // Empty texture\n\n\n    if (this._emptyTexture) {\n      this._releaseTexture(this._emptyTexture);\n\n      this._emptyTexture = null;\n    }\n\n    if (this._emptyCubeTexture) {\n      this._releaseTexture(this._emptyCubeTexture);\n\n      this._emptyCubeTexture = null;\n    }\n\n    if (this._dummyFramebuffer) {\n      this._gl.deleteFramebuffer(this._dummyFramebuffer);\n    } // Release effects\n\n\n    this.releaseEffects();\n    (_a = this.releaseComputeEffects) === null || _a === void 0 ? void 0 : _a.call(this); // Unbind\n\n    this.unbindAllAttributes();\n    this._boundUniforms = []; // Events\n\n    if (IsWindowObjectExist()) {\n      if (this._renderingCanvas) {\n        if (!this._doNotHandleContextLost) {\n          this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\n\n          this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\n        }\n\n        window.removeEventListener(\"resize\", this._checkForMobile);\n      }\n    }\n\n    this._workingCanvas = null;\n    this._workingContext = null;\n    this._currentBufferPointers = [];\n    this._renderingCanvas = null;\n    this._currentProgram = null;\n    this._boundRenderFunction = null;\n    Effect.ResetCache(); // Abort active requests\n\n    for (var _i = 0, _b = this._activeRequests; _i < _b.length; _i++) {\n      var request = _b[_i];\n      request.abort();\n    }\n\n    this.onDisposeObservable.notifyObservers(this);\n    this.onDisposeObservable.clear();\n  };\n  /**\n   * Attach a new callback raised when context lost event is fired\n   * @param callback defines the callback to call\n   */\n\n\n  ThinEngine.prototype.attachContextLostEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextlost\", callback, false);\n    }\n  };\n  /**\n   * Attach a new callback raised when context restored event is fired\n   * @param callback defines the callback to call\n   */\n\n\n  ThinEngine.prototype.attachContextRestoredEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextrestored\", callback, false);\n    }\n  };\n  /**\n   * Get the current error code of the webGL context\n   * @returns the error code\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\n   */\n\n\n  ThinEngine.prototype.getError = function () {\n    return this._gl.getError();\n  };\n\n  ThinEngine.prototype._canRenderToFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(1);\n  };\n\n  ThinEngine.prototype._canRenderToHalfFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(2);\n  }; // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\n\n\n  ThinEngine.prototype._canRenderToFramebuffer = function (type) {\n    var gl = this._gl; //clear existing errors\n    // eslint-disable-next-line no-empty\n\n    while (gl.getError() !== gl.NO_ERROR) {}\n\n    var successful = true;\n    var texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n    var fb = gl.createFramebuffer();\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n    var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\n    successful = successful && gl.getError() === gl.NO_ERROR; //try render by clearing frame buffer's color buffer\n\n    if (successful) {\n      gl.clear(gl.COLOR_BUFFER_BIT);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\n\n\n    if (successful) {\n      //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n      var readFormat = gl.RGBA;\n      var readType = gl.UNSIGNED_BYTE;\n      var buffer = new Uint8Array(4);\n      gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //clean up\n\n\n    gl.deleteTexture(texture);\n    gl.deleteFramebuffer(fb);\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null); //clear accumulated errors\n    // eslint-disable-next-line no-empty\n\n    while (!successful && gl.getError() !== gl.NO_ERROR) {}\n\n    return successful;\n  };\n  /**\n   * @param type\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getWebGLTextureType = function (type) {\n    if (this._webGLVersion === 1) {\n      switch (type) {\n        case 1:\n          return this._gl.FLOAT;\n\n        case 2:\n          return this._gl.HALF_FLOAT_OES;\n\n        case 0:\n          return this._gl.UNSIGNED_BYTE;\n\n        case 8:\n          return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n        case 9:\n          return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n        case 10:\n          return this._gl.UNSIGNED_SHORT_5_6_5;\n      }\n\n      return this._gl.UNSIGNED_BYTE;\n    }\n\n    switch (type) {\n      case 3:\n        return this._gl.BYTE;\n\n      case 0:\n        return this._gl.UNSIGNED_BYTE;\n\n      case 4:\n        return this._gl.SHORT;\n\n      case 5:\n        return this._gl.UNSIGNED_SHORT;\n\n      case 6:\n        return this._gl.INT;\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        return this._gl.UNSIGNED_INT;\n\n      case 1:\n        return this._gl.FLOAT;\n\n      case 2:\n        return this._gl.HALF_FLOAT;\n\n      case 8:\n        return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n      case 9:\n        return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n      case 10:\n        return this._gl.UNSIGNED_SHORT_5_6_5;\n\n      case 11:\n        return this._gl.UNSIGNED_INT_2_10_10_10_REV;\n\n      case 12:\n        return this._gl.UNSIGNED_INT_24_8;\n\n      case 13:\n        return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\n\n      case 14:\n        return this._gl.UNSIGNED_INT_5_9_9_9_REV;\n\n      case 15:\n        return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\n    }\n\n    return this._gl.UNSIGNED_BYTE;\n  };\n  /**\n   * @param format\n   * @param useSRGBBuffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getInternalFormat = function (format, useSRGBBuffer) {\n    if (useSRGBBuffer === void 0) {\n      useSRGBBuffer = false;\n    }\n\n    var internalFormat = useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA;\n\n    switch (format) {\n      case 0:\n        internalFormat = this._gl.ALPHA;\n        break;\n\n      case 1:\n        internalFormat = this._gl.LUMINANCE;\n        break;\n\n      case 2:\n        internalFormat = this._gl.LUMINANCE_ALPHA;\n        break;\n\n      case 6:\n        internalFormat = this._gl.RED;\n        break;\n\n      case 7:\n        internalFormat = this._gl.RG;\n        break;\n\n      case 4:\n        internalFormat = useSRGBBuffer ? this._gl.SRGB : this._gl.RGB;\n        break;\n\n      case 5:\n        internalFormat = useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA;\n        break;\n    }\n\n    if (this._webGLVersion > 1) {\n      switch (format) {\n        case 8:\n          internalFormat = this._gl.RED_INTEGER;\n          break;\n\n        case 9:\n          internalFormat = this._gl.RG_INTEGER;\n          break;\n\n        case 10:\n          internalFormat = this._gl.RGB_INTEGER;\n          break;\n\n        case 11:\n          internalFormat = this._gl.RGBA_INTEGER;\n          break;\n      }\n    }\n\n    return internalFormat;\n  };\n  /**\n   * @param type\n   * @param format\n   * @param useSRGBBuffer\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getRGBABufferInternalSizedFormat = function (type, format, useSRGBBuffer) {\n    if (useSRGBBuffer === void 0) {\n      useSRGBBuffer = false;\n    }\n\n    if (this._webGLVersion === 1) {\n      if (format !== undefined) {\n        switch (format) {\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          case 4:\n            return useSRGBBuffer ? this._gl.SRGB : this._gl.RGB;\n        }\n      }\n\n      return this._gl.RGBA;\n    }\n\n    switch (type) {\n      case 3:\n        switch (format) {\n          case 6:\n            return this._gl.R8_SNORM;\n\n          case 7:\n            return this._gl.RG8_SNORM;\n\n          case 4:\n            return this._gl.RGB8_SNORM;\n\n          case 8:\n            return this._gl.R8I;\n\n          case 9:\n            return this._gl.RG8I;\n\n          case 10:\n            return this._gl.RGB8I;\n\n          case 11:\n            return this._gl.RGBA8I;\n\n          default:\n            return this._gl.RGBA8_SNORM;\n        }\n\n      case 0:\n        switch (format) {\n          case 6:\n            return this._gl.R8;\n\n          case 7:\n            return this._gl.RG8;\n\n          case 4:\n            return useSRGBBuffer ? this._gl.SRGB8 : this._gl.RGB8;\n          // By default. Other possibilities are RGB565, SRGB8.\n\n          case 5:\n            return useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA8;\n          // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\n\n          case 8:\n            return this._gl.R8UI;\n\n          case 9:\n            return this._gl.RG8UI;\n\n          case 10:\n            return this._gl.RGB8UI;\n\n          case 11:\n            return this._gl.RGBA8UI;\n\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          default:\n            return this._gl.RGBA8;\n        }\n\n      case 4:\n        switch (format) {\n          case 8:\n            return this._gl.R16I;\n\n          case 9:\n            return this._gl.RG16I;\n\n          case 10:\n            return this._gl.RGB16I;\n\n          case 11:\n            return this._gl.RGBA16I;\n\n          default:\n            return this._gl.RGBA16I;\n        }\n\n      case 5:\n        switch (format) {\n          case 8:\n            return this._gl.R16UI;\n\n          case 9:\n            return this._gl.RG16UI;\n\n          case 10:\n            return this._gl.RGB16UI;\n\n          case 11:\n            return this._gl.RGBA16UI;\n\n          default:\n            return this._gl.RGBA16UI;\n        }\n\n      case 6:\n        switch (format) {\n          case 8:\n            return this._gl.R32I;\n\n          case 9:\n            return this._gl.RG32I;\n\n          case 10:\n            return this._gl.RGB32I;\n\n          case 11:\n            return this._gl.RGBA32I;\n\n          default:\n            return this._gl.RGBA32I;\n        }\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        switch (format) {\n          case 8:\n            return this._gl.R32UI;\n\n          case 9:\n            return this._gl.RG32UI;\n\n          case 10:\n            return this._gl.RGB32UI;\n\n          case 11:\n            return this._gl.RGBA32UI;\n\n          default:\n            return this._gl.RGBA32UI;\n        }\n\n      case 1:\n        switch (format) {\n          case 6:\n            return this._gl.R32F;\n          // By default. Other possibility is R16F.\n\n          case 7:\n            return this._gl.RG32F;\n          // By default. Other possibility is RG16F.\n\n          case 4:\n            return this._gl.RGB32F;\n          // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA32F;\n          // By default. Other possibility is RGBA16F.\n\n          default:\n            return this._gl.RGBA32F;\n        }\n\n      case 2:\n        switch (format) {\n          case 6:\n            return this._gl.R16F;\n\n          case 7:\n            return this._gl.RG16F;\n\n          case 4:\n            return this._gl.RGB16F;\n          // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA16F;\n\n          default:\n            return this._gl.RGBA16F;\n        }\n\n      case 10:\n        return this._gl.RGB565;\n\n      case 13:\n        return this._gl.R11F_G11F_B10F;\n\n      case 14:\n        return this._gl.RGB9_E5;\n\n      case 8:\n        return this._gl.RGBA4;\n\n      case 9:\n        return this._gl.RGB5_A1;\n\n      case 11:\n        switch (format) {\n          case 5:\n            return this._gl.RGB10_A2;\n          // By default. Other possibility is RGB5_A1.\n\n          case 11:\n            return this._gl.RGB10_A2UI;\n\n          default:\n            return this._gl.RGB10_A2;\n        }\n\n    }\n\n    return useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA8;\n  };\n  /**\n   * @param type\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._getRGBAMultiSampleBufferFormat = function (type) {\n    if (type === 1) {\n      return this._gl.RGBA32F;\n    } else if (type === 2) {\n      return this._gl.RGBA16F;\n    }\n\n    return this._gl.RGBA8;\n  };\n  /**\n   * @param url\n   * @param onSuccess\n   * @param onProgress\n   * @param offlineProvider\n   * @param useArrayBuffer\n   * @param onError\n   * @hidden\n   */\n\n\n  ThinEngine.prototype._loadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    var _this = this;\n\n    var request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\n\n    this._activeRequests.push(request);\n\n    request.onCompleteObservable.add(function (request) {\n      _this._activeRequests.splice(_this._activeRequests.indexOf(request), 1);\n    });\n    return request;\n  };\n  /**\n   * Loads a file from a url\n   * @param url url to load\n   * @param onSuccess callback called when the file successfully loads\n   * @param onProgress callback called while file is loading (if the server supports this mode)\n   * @param offlineProvider defines the offline provider for caching\n   * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\n   * @param onError callback called when the file fails to load\n   * @returns a file request object\n   * @hidden\n   */\n\n\n  ThinEngine._FileToolsLoadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    throw _WarnImport(\"FileTools\");\n  };\n  /**\n   * Reads pixels from the current frame buffer. Please note that this function can be slow\n   * @param x defines the x coordinate of the rectangle where pixels must be read\n   * @param y defines the y coordinate of the rectangle where pixels must be read\n   * @param width defines the width of the rectangle where pixels must be read\n   * @param height defines the height of the rectangle where pixels must be read\n   * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\n   * @param flushRenderer true to flush the renderer from the pending commands before reading the pixels\n   * @returns a ArrayBufferView promise (Uint8Array) containing RGBA colors\n   */\n\n\n  ThinEngine.prototype.readPixels = function (x, y, width, height, hasAlpha, flushRenderer) {\n    if (hasAlpha === void 0) {\n      hasAlpha = true;\n    }\n\n    if (flushRenderer === void 0) {\n      flushRenderer = true;\n    }\n\n    var numChannels = hasAlpha ? 4 : 3;\n    var format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\n    var data = new Uint8Array(height * width * numChannels);\n\n    if (flushRenderer) {\n      this.flushFramebuffer();\n    }\n\n    this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\n\n    return Promise.resolve(data);\n  };\n\n  Object.defineProperty(ThinEngine, \"IsSupportedAsync\", {\n    /**\n     * Gets a Promise<boolean> indicating if the engine can be instantiated (ie. if a webGL context can be found)\n     */\n    get: function get() {\n      return Promise.resolve(this.isSupported());\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"IsSupported\", {\n    /**\n     * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\n     */\n    get: function get() {\n      return this.isSupported(); // Backward compat\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\n   * @returns true if the engine can be created\n   * @ignorenaming\n   */\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n\n  ThinEngine.isSupported = function () {\n    if (this._HasMajorPerformanceCaveat !== null) {\n      return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\n    }\n\n    if (this._IsSupported === null) {\n      try {\n        var tempcanvas = this._CreateCanvas(1, 1);\n\n        var gl = tempcanvas.getContext(\"webgl\") || tempcanvas.getContext(\"experimental-webgl\");\n        this._IsSupported = gl != null && !!window.WebGLRenderingContext;\n      } catch (e) {\n        this._IsSupported = false;\n      }\n    }\n\n    return this._IsSupported;\n  };\n\n  Object.defineProperty(ThinEngine, \"HasMajorPerformanceCaveat\", {\n    /**\n     * Gets a boolean indicating if the engine can be instantiated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\n     */\n    get: function get() {\n      if (this._HasMajorPerformanceCaveat === null) {\n        try {\n          var tempcanvas = this._CreateCanvas(1, 1);\n\n          var gl = tempcanvas.getContext(\"webgl\", {\n            failIfMajorPerformanceCaveat: true\n          }) || tempcanvas.getContext(\"experimental-webgl\", {\n            failIfMajorPerformanceCaveat: true\n          });\n          this._HasMajorPerformanceCaveat = !gl;\n        } catch (e) {\n          this._HasMajorPerformanceCaveat = false;\n        }\n      }\n\n      return this._HasMajorPerformanceCaveat;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Find the next highest power of two.\n   * @param x Number to start search from.\n   * @return Next highest power of two.\n   */\n\n  ThinEngine.CeilingPOT = function (x) {\n    x--;\n    x |= x >> 1;\n    x |= x >> 2;\n    x |= x >> 4;\n    x |= x >> 8;\n    x |= x >> 16;\n    x++;\n    return x;\n  };\n  /**\n   * Find the next lowest power of two.\n   * @param x Number to start search from.\n   * @return Next lowest power of two.\n   */\n\n\n  ThinEngine.FloorPOT = function (x) {\n    x = x | x >> 1;\n    x = x | x >> 2;\n    x = x | x >> 4;\n    x = x | x >> 8;\n    x = x | x >> 16;\n    return x - (x >> 1);\n  };\n  /**\n   * Find the nearest power of two.\n   * @param x Number to start search from.\n   * @return Next nearest power of two.\n   */\n\n\n  ThinEngine.NearestPOT = function (x) {\n    var c = ThinEngine.CeilingPOT(x);\n    var f = ThinEngine.FloorPOT(x);\n    return c - x > x - f ? f : c;\n  };\n  /**\n   * Get the closest exponent of two\n   * @param value defines the value to approximate\n   * @param max defines the maximum value to return\n   * @param mode defines how to define the closest value\n   * @returns closest exponent of two of the given value\n   */\n\n\n  ThinEngine.GetExponentOfTwo = function (value, max, mode) {\n    if (mode === void 0) {\n      mode = 2;\n    }\n\n    var pot;\n\n    switch (mode) {\n      case 1:\n        pot = ThinEngine.FloorPOT(value);\n        break;\n\n      case 2:\n        pot = ThinEngine.NearestPOT(value);\n        break;\n\n      case 3:\n      default:\n        pot = ThinEngine.CeilingPOT(value);\n        break;\n    }\n\n    return Math.min(pot, max);\n  };\n  /**\n   * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\n   * @param func - the function to be called\n   * @param requester - the object that will request the next frame. Falls back to window.\n   * @returns frame number\n   */\n\n\n  ThinEngine.QueueNewFrame = function (func, requester) {\n    if (!IsWindowObjectExist()) {\n      if (typeof requestAnimationFrame !== \"undefined\") {\n        return requestAnimationFrame(func);\n      }\n\n      return setTimeout(func, 16);\n    }\n\n    if (!requester) {\n      requester = window;\n    }\n\n    if (requester.requestPostAnimationFrame) {\n      return requester.requestPostAnimationFrame(func);\n    } else if (requester.requestAnimationFrame) {\n      return requester.requestAnimationFrame(func);\n    } else if (requester.msRequestAnimationFrame) {\n      return requester.msRequestAnimationFrame(func);\n    } else if (requester.webkitRequestAnimationFrame) {\n      return requester.webkitRequestAnimationFrame(func);\n    } else if (requester.mozRequestAnimationFrame) {\n      return requester.mozRequestAnimationFrame(func);\n    } else if (requester.oRequestAnimationFrame) {\n      return requester.oRequestAnimationFrame(func);\n    } else {\n      return window.setTimeout(func, 16);\n    }\n  };\n  /**\n   * Gets host document\n   * @returns the host document object\n   */\n\n\n  ThinEngine.prototype.getHostDocument = function () {\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\n      return this._renderingCanvas.ownerDocument;\n    }\n\n    return document;\n  };\n  /** Use this array to turn off some WebGL2 features on known buggy browsers version */\n\n\n  ThinEngine.ExceptionList = [{\n    key: \"Chrome/63.0\",\n    capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\",\n    captureConstraint: 108,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox/58\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox/59\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Chrome/72.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome/73.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome/74.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome/71\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome/72\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }];\n  /** @hidden */\n\n  ThinEngine._TextureLoaders = []; // Updatable statics so stick with vars here\n\n  /**\n   * Gets or sets the epsilon value used by collision engine\n   */\n\n  ThinEngine.CollisionsEpsilon = 0.001; // Statics\n\n  ThinEngine._IsSupported = null;\n  ThinEngine._HasMajorPerformanceCaveat = null;\n  return ThinEngine;\n}();\n\nexport { ThinEngine };","map":{"version":3,"mappings":"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","names":["EngineStore","Effect","_WarnImport","Observable","DepthCullingState","StencilState","AlphaState","InternalTexture","InternalTextureSource","Logger","IsDocumentAvailable","IsWindowObjectExist","WebGLShaderProcessor","WebGL2ShaderProcessor","WebGLDataBuffer","WebGLPipelineContext","PerformanceConfigurator","WebGLHardwareTexture","DrawWrapper","StencilStateComposer","ShaderLanguage","canvasOrContext","antialias","options","adaptToDeviceRatio","Array","isMobile","x","y","z","w","canvas","_creationOptions","_adaptToDeviceRatio","_stencilStateComposer","stencilGlobal","_stencilState","SetMatrixPrecision","useHighPrecisionMatrix","getContext","_renderingCanvas","undefined","deterministicLockstep","lockstepMaxSteps","timeStep","preserveDrawingBuffer","audioEngine","audioEngineOptions","audioContext","_audioContext","audioDestination","_audioDestination","stencil","premultipliedAlpha","xrCompatible","_doNotHandleContextLost","doNotHandleContextLost","navigator","userAgent","_checkForMobile","currentUA","_this","hostInformation","indexOf","document","window","addEventListener","ua","ExceptionList","_i","exception","key","targets","check","RegExp","test","capture","captureConstraint","constraint","regex","matches","exec","length","capturedValue","parseInt","_b","target","disableUniformBuffers","disableVertexArrayObjects","_onContextLost","evt","preventDefault","_contextWasLost","Warn","onContextLostObservable","notifyObservers","_onContextRestored","_restoreEngineAfterContextLost","_initGLContext","bind","powerPreference","_badDesktopOS","disableWebGL2Support","_gl","_webGLVersion","_shaderPlatformName","deleteQuery","e","Error","renderbufferStorageMultisample","attributes","getContextAttributes","pixelStorei","UNPACK_COLORSPACE_CONVERSION_WEBGL","NONE","useHighPrecisionFloats","_highPrecisionShadersAllowed","devicePixelRatio","limitDeviceRatio","_hardwareScalingLevel","Math","min","resize","_isStencilEnable","_initFeatures","i","_caps","maxVertexAttribs","_currentBufferPointers","BufferPointer","_shaderProcessor","webGLVersion","_badOS","versionToLog","ThinEngine","Version","console","log","description","setAttribute","Object","name","parallelShaderCompile","_name","value","ShadersRepository","shaderLanguage","_useReverseDepthBuffer","useReverse","_depthCullingState","depthFunc","_frameId","highPrecisionShaderSupported","forcePOTTextures","_activeRenderLoops","dimensions","_framebufferDimensionsObject","_cachedViewport","_emptyTexture","createRawTexture","Uint8Array","_emptyTexture3D","createRawTexture3D","_emptyTexture2DArray","createRawTexture2DArray","_emptyCubeTexture","faceData","cubeData","createRawCubeTexture","_isWebGPU","activate","_snapshotRenderingMode","mode","snapshotRendering","width","height","OffscreenCanvas","createElement","_CreateCanvas","initEngine","setTimeout","_dummyFramebuffer","depthTest","depthMask","stencilTest","_rebuildEffects","_rebuildComputeEffects","_a","_rebuildInternalTextures","_rebuildRenderTargetWrappers","_rebuildBuffers","wipeCaches","onContextRestoredObservable","doNotHandleTouchAction","currentState","_internalTexturesCache","slice","internalTexture","_rebuild","_renderTargetWrapperCache","renderTargetWrapper","_compiledEffects","effect","_pipelineContext","_wasPreviouslyReady","_prepareEffect","ResetCache","isReady","_uniformBuffers","uniformBuffer","_storageBuffers","storageBuffer","maxTexturesImageUnits","getParameter","MAX_TEXTURE_IMAGE_UNITS","maxCombinedTexturesImageUnits","MAX_COMBINED_TEXTURE_IMAGE_UNITS","maxVertexTextureImageUnits","MAX_VERTEX_TEXTURE_IMAGE_UNITS","maxTextureSize","MAX_TEXTURE_SIZE","maxSamples","MAX_SAMPLES","maxCubemapTextureSize","MAX_CUBE_MAP_TEXTURE_SIZE","maxRenderTextureSize","MAX_RENDERBUFFER_SIZE","MAX_VERTEX_ATTRIBS","maxVaryingVectors","MAX_VARYING_VECTORS","maxFragmentUniformVectors","MAX_FRAGMENT_UNIFORM_VECTORS","maxVertexUniformVectors","MAX_VERTEX_UNIFORM_VECTORS","getExtension","standardDerivatives","maxAnisotropy","astc","bptc","s3tc","s3tc_srgb","pvrtc","etc1","etc2","textureAnisotropicFilterExtension","uintIndices","fragmentDepthSupported","timerQuery","supportOcclusionQuery","canUseTimestampForTimerQuery","drawBuffersExtension","maxMSAASamples","colorBufferFloat","textureFloat","textureHalfFloat","textureHalfFloatRender","textureFloatLinearFiltering","textureFloatRender","textureHalfFloatLinearFiltering","vertexArrayObject","instancedArrays","textureLOD","blendMinMax","multiview","oculusMultiview","depthTextureExtension","canUseGLInstanceID","canUseGLVertexID","supportComputeShaders","supportSRGBBuffers","supportTransformFeedbacks","textureMaxLevel","_glVersion","VERSION","rendererInfo","_glRenderer","UNMASKED_RENDERER_WEBGL","_glVendor","UNMASKED_VENDOR_WEBGL","VENDOR","RENDERER","HALF_FLOAT_OES","RGBA16F","RGBA32F","DEPTH24_STENCIL8","getQuery","getQueryEXT","TIMESTAMP_EXT","QUERY_COUNTER_BITS_EXT","MAX_TEXTURE_MAX_ANISOTROPY_EXT","_canRenderToFloatFramebuffer","COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR","COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT","COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT","COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT","_canRenderToHalfFloatFramebuffer","drawBuffers","drawBuffersWEBGL","DRAW_FRAMEBUFFER","FRAMEBUFFER","UNSIGNED_INT_24_8","UNSIGNED_INT_24_8_WEBGL","vertexArrayObjectExtension","createVertexArray","createVertexArrayOES","bindVertexArray","bindVertexArrayOES","deleteVertexArray","deleteVertexArrayOES","instanceExtension","drawArraysInstanced","drawArraysInstancedANGLE","drawElementsInstanced","drawElementsInstancedANGLE","vertexAttribDivisor","vertexAttribDivisorANGLE","getShaderPrecisionFormat","vertexhighp","VERTEX_SHADER","HIGH_FLOAT","fragmenthighp","FRAGMENT_SHADER","precision","blendMinMaxExtension","MAX","MAX_EXT","MIN","MIN_EXT","sRGBExtension","SRGB","SRGB_EXT","SRGB8","SRGB_ALPHA_EXT","SRGB8_ALPHA8","forceSRGBBufferSupportState","LEQUAL","_maxSimultaneousTextures","slot","_nextFreeTextureSlots","push","_features","forceBitmapOverHTMLImageElement","supportRenderAndCopyToLodForFloatTextures","supportDepthStencilTexture","supportShadowSamplers","uniformBufferHardCheckMatrix","allowTexturePrefiltering","trackUbosInFrame","checkUbosContentBeforeUpload","supportCSM","basisNeedsPOT","support3DTextures","needTypeSuffixInShaderConstants","supportMSAA","supportSSAO2","supportExtendedTextureFormats","supportSwitchCaseInShader","supportSyncTextureRead","needsInvertingBitmap","useUBOBindingCache","needShaderCodeInlining","needToAlwaysBindUniformBuffers","supportRenderPasses","_collectUbosUpdatedInFrame","_workingCanvas","createCanvas","context","_workingContext","_boundTexturesCache","prototype","hasOwnProperty","call","_currentTextureChannel","getGlInfo","vendor","renderer","version","level","renderFunction","index","splice","shouldRender","renderEvenInBackground","_windowIsBackground","beginFrame","endFrame","_frameHandler","_queueNewFrame","_boundRenderFunction","getHostWindow","_renderingQueueLaunched","ownerDocument","defaultView","useScreen","_currentRenderTarget","framebufferWidth","drawingBufferWidth","framebufferHeight","drawingBufferHeight","bindedRenderFunction","requester","QueueNewFrame","_renderLoop","color","backBuffer","depth","useStencilGlobalOnly","stencilStateComposer","applyStates","clearColor","r","g","b","a","COLOR_BUFFER_BIT","useReverseDepthBuffer","GEQUAL","clearDepth","DEPTH_BUFFER_BIT","clearStencil","STENCIL_BUFFER_BIT","clear","_viewportCached","viewport","requiredWidth","requiredHeight","getRenderWidth","getRenderHeight","_viewport","flushFramebuffer","forceSetSize","devicePixelRatio_1","clientWidth","innerWidth","clientHeight","innerHeight","setSize","texture","faceIndex","forceFullscreenViewport","lodLevel","layer","webglRTWrapper","unBindFramebuffer","_bindUnboundFramebuffer","_MSAAFramebuffer","_framebuffer","gl","is2DArray","framebufferTextureLayer","COLOR_ATTACHMENT0","_hardwareTexture","underlyingResource","isCube","framebufferTexture2D","TEXTURE_CUBE_MAP_POSITIVE_X","depthStencilTexture","_depthStencilTexture","attachment","_depthStencilTextureWithStencil","DEPTH_STENCIL_ATTACHMENT","DEPTH_ATTACHMENT","_c","_d","TEXTURE_2D","_e","setViewport","pow","culling","zOffset","force","reverseSide","cullBackFaces","zOffsetUnits","cull","cullFace","BACK","FRONT","setZOffset","setZOffsetUnits","frontFace","CW","CCW","stencilMaterial","framebuffer","_currentFramebuffer","bindFramebuffer","_bindTextureDirectly","generateMipmap","disableGenerateMipMaps","onBeforeUnbind","isMulti","unBindMultiColorAttachmentFramebuffer","READ_FRAMEBUFFER","blitFramebuffer","NEAREST","generateMipMaps","generateMipmaps","flush","bindArrayBuffer","_cachedVertexBuffers","data","_createVertexBuffer","STATIC_DRAW","usage","vbo","createBuffer","dataBuffer","bufferData","ARRAY_BUFFER","Float32Array","_resetVertexBufferBinding","references","DYNAMIC_DRAW","bindIndexBuffer","_cachedIndexBuffer","indices","updatable","_normalizeIndexData","ELEMENT_ARRAY_BUFFER","_resetIndexBufferBinding","is32Bits","BYTES_PER_ELEMENT","bytesPerElement","Uint32Array","Uint16Array","buffer","_vaoRecordInProgress","_unbindVertexArrayObject","_bindBuffer","pipelineContext","blockName","program","uniformLocation","getUniformBlockIndex","uniformBlockBinding","_currentBoundBuffer","bindBuffer","bufferSubData","indx","size","type","normalized","stride","offset","pointer","changed","active","vertexAttribPointer","indexBuffer","_uintIndicesCurrentlySet","vertexBuffers","overrideVertexBuffers","getAttributesNames","unbindAllAttributes","order","getAttributeLocation","ai","vertexBuffer","enableVertexAttribArray","_vertexAttribArraysEnabled","getBuffer","_vertexAttribPointer","getSize","byteStride","byteOffset","getIsInstanced","getInstanceDivisor","_currentInstanceLocations","_currentInstanceBuffers","vao","_mustWipeVertexAttributes","_bindVertexBuffersAttributes","_cachedVertexArrayObject","vertexDeclaration","vertexStrideSize","_cachedEffectForVertexBuffers","attributesCount","getAttributesCount","FLOAT","_bindIndexBufferWithCache","boundBuffer","ul","instancesBuffer","offsetLocation","_deleteBuffer","deleteBuffer","offsetLocations","bindInstancesBuffer","attributesInfo","computeStride","attributeSize","_currentEffect","getAttributeLocationByName","attributeName","attributeType","divisor","attributeLocation","disableInstanceAttribute","shouldClean","disableAttributeByIndex","disableVertexAttribArray","useTriangles","indexStart","indexCount","instancesCount","drawElementsType","verticesStart","verticesCount","drawArraysType","fillMode","_reportDrawCall","drawMode","_drawMode","indexFormat","UNSIGNED_INT","UNSIGNED_SHORT","mult","drawElements","drawArrays","TRIANGLES","POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLE_STRIP","TRIANGLE_FAN","_key","getPipelineContext","_deletePipelineContext","webGLPipelineContext","__SPECTOR_rebuildProgram","deleteProgram","defines","isNDCHalfZRange","s","baseName","attributesNamesOrOptions","uniformsNamesOrEngine","samplers","fallbacks","onCompiled","onError","indexParameters","GLSL","vertex","vertexElement","vertexToken","vertexSource","fragment","fragmentElement","fragmentToken","fragmentSource","globalDefines","_getGlobalDefines","fullDefines","compiledEffect","source","shaderVersion","_compileRawShader","_ConcatenateShader","shader","createShader","error","NO_ERROR","tempError","getError","concat","isContextLost","shaderSource","compileShader","getShaderSource","vertexCode","fragmentCode","transformFeedbackVaryings","vertexShader","fragmentShader","_createShaderProgram","_compileShader","code","shaderProcessingContext","engine","isParallelCompiled","shaderProgram","createProgram","attachShader","linkProgram","_finalizePipelineContext","linked","getProgramParameter","LINK_STATUS","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","vertexCompilationError","fragmentCompilationError","getProgramInfoLog","programLinkError","validateShaderPrograms","validateProgram","validated","VALIDATE_STATUS","programValidationError","deleteShader","vertexSourceCode","fragmentSourceCode","createAsRaw","rawVertexSourceCode","rawFragmentSourceCode","rebuildRebind","webGLRenderingState","createRawShaderProgram","createShaderProgram","COMPLETION_STATUS_KHR","action","oldHandler","uniformsNames","results","getUniformLocation","attributesNames","getAttribLocation","IsWrapper","bindSamplers","onBind","_onBindObservable","uniform","uniform1i","uniform2i","uniform3i","uniform4i","array","uniform1iv","uniform2iv","uniform3iv","uniform4iv","uniform1fv","uniform2fv","uniform3fv","uniform4fv","matrices","uniformMatrix4fv","matrix","uniformMatrix3fv","uniformMatrix2fv","uniform1f","uniform2f","uniform3f","uniform4f","apply","_alphaState","_colorWriteChanged","enable","_colorWrite","colorMask","bruteForce","preventCacheWipeBetweenFrames","_currentProgram","resetTextureCache","reset","_alphaMode","_alphaEquation","_unpackFlipYCached","UNPACK_PREMULTIPLY_ALPHA_WEBGL","samplingMode","magFilter","minFilter","LINEAR","LINEAR_MIPMAP_NEAREST","LINEAR_MIPMAP_LINEAR","NEAREST_MIPMAP_LINEAR","NEAREST_MIPMAP_NEAREST","mag","createTexture","_createTexture","delayGPUTextureCreation","Unknown","fullOptions","format","layers","filters","_getSamplingParameters","TEXTURE_2D_ARRAY","sizedFormat","_getRGBABufferInternalSizedFormat","internalFormat","_getInternalFormat","_getWebGLTextureType","texImage3D","texImage2D","texParameteri","TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","baseWidth","baseHeight","samples","useSRGBBuffer","noMipmap","isWebGPU","url","invertY","scene","onLoad","prepareTexture","prepareTextureProcessFunction","fallback","forcedExtension","mimeType","loaderOptions","fromData","substr","fromBlob","isBase64","Url","originalUrl","_transformTextureUrl","_originalUrl","lastDot","lastIndexOf","extension","substring","toLowerCase","loader","queryStringIndex","split","_TextureLoaders","availableLoader","canLoad","_addPendingData","_useSRGBBuffer","_getUseSRGBBuffer","_buffer","onLoadObserver","onLoadedObservable","add","onInternalError","message","_removePendingData","remove","UseFallbackTexture","_createTextureBase","FallbackTexture","onErrorObservable","callback_1","loadData","loadMipmap","isCompressed","done","loadFailed","_loadFile","offlineProvider","request","responseURL","ArrayBuffer","isView","onload_1","img","decoding","close","_FileToolsLoadImage","imageOrientation","Blob","creationFlags","_prepareWebGLTexture","potWidth","potHeight","continuationCallback","isPot","RGB","RGBA","texelFormat","UNSIGNED_BYTE","_supportsHardwareTextureRescaling","_prepareWorkingCanvas","drawImage","source_1","Temp","_rescaleTexture","_releaseTexture","input","imageBitmapOptions","destination","onComplete","compression","textureType","UNPACK_FLIP_Y_WEBGL","enableUnpackFlipYCached","UNPACK_ALIGNMENT","TEXTURE_CUBE_MAP","is3D","TEXTURE_3D","isMultiview","_getTextureTarget","_setTextureParameterInteger","wrapU","wrapV","wrapR","_getTextureWrapMode","_cachedWrapU","_cachedWrapV","TEXTURE_WRAP_R","_cachedWrapR","generateStencil","bilinearFiltering","comparisonFunction","_comparisonFunction","samplingParameters","TEXTURE_COMPARE_FUNC","TEXTURE_COMPARE_MODE","COMPARE_REF_TO_TEXTURE","lod","compressedTexImage2D","imageData","babylonInternalFormat","useTextureWidthAndHeight","_unpackFlipY","lodMaxWidth","round","LOG2E","lodMaxHeight","max","xOffset","yOffset","texSubImage2D","bindTarget","_uploadDataToTextureDirectly","processFunction","getCaps","needPOTTextures","GetExponentOfTwo","_prepareWebGLTextureContinuation","generateStencilBuffer","generateDepthBuffer","_createRenderBuffer","DEPTH_STENCIL","depthFormat","DEPTH_COMPONENT16","DEPTH_COMPONENT32F","STENCIL_INDEX8","STENCIL_ATTACHMENT","msInternalFormat","unbindBuffer","renderBuffer","createRenderbuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorage","framebufferRenderbuffer","_deleteTexture","unbindAllTextures","_lodTextureHigh","dispose","_lodTextureMid","_lodTextureLow","_irradianceTexture","rtWrapper","deleteTexture","useProgram","_setProgram","getSamplers","getUniform","_boundUniforms","_activeChannel","activeTexture","TEXTURE0","forTextureDataUpdate","wasPreviouslyBound","isTextureForRendering","_associatedChannel","currentTextureBound","_activateCurrentTexture","bindTexture","_bindSamplerUniformToChannel","channel","_setTexture","sourceSlot","_currentState","REPEAT","MIRRORED_REPEAT","isPartOfTextureArray","video","update","delayLoadState","delayLoad","getInternalTexture","emptyCubeTexture","emptyTexture3D","emptyTexture2DArray","emptyTexture","needToBind","_cachedCoordinatesMode","coordinatesMode","textureWrapMode","_setAnisotropicLevel","anisotropicFilteringLevel","textures","_textureUnits","Int32Array","anisotropicFilterExtension","_cachedAnisotropicFilteringLevel","_setTextureParameterFloat","TEXTURE_MAX_ANISOTROPY_EXT","parameter","texParameterf","name_1","stopRenderLoop","onBeforeTextureInitObservable","deleteFramebuffer","releaseEffects","releaseComputeEffects","removeEventListener","_activeRequests","abort","onDisposeObservable","callback","_canRenderToFramebuffer","successful","fb","createFramebuffer","status","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","readFormat","readType","readPixels","UNSIGNED_SHORT_4_4_4_4","UNSIGNED_SHORT_5_5_5_1","UNSIGNED_SHORT_5_6_5","BYTE","SHORT","INT","HALF_FLOAT","UNSIGNED_INT_2_10_10_10_REV","UNSIGNED_INT_10F_11F_11F_REV","UNSIGNED_INT_5_9_9_9_REV","FLOAT_32_UNSIGNED_INT_24_8_REV","ALPHA","LUMINANCE","LUMINANCE_ALPHA","RED","RG","RED_INTEGER","RG_INTEGER","RGB_INTEGER","RGBA_INTEGER","R8_SNORM","RG8_SNORM","RGB8_SNORM","R8I","RG8I","RGB8I","RGBA8I","RGBA8_SNORM","R8","RG8","RGB8","RGBA8","R8UI","RG8UI","RGB8UI","RGBA8UI","R16I","RG16I","RGB16I","RGBA16I","R16UI","RG16UI","RGB16UI","RGBA16UI","R32I","RG32I","RGB32I","RGBA32I","R32UI","RG32UI","RGB32UI","RGBA32UI","R32F","RG32F","RGB32F","R16F","RG16F","RGB16F","RGB565","R11F_G11F_B10F","RGB9_E5","RGBA4","RGB5_A1","RGB10_A2","RGB10_A2UI","onSuccess","onProgress","useArrayBuffer","_FileToolsLoadFile","onCompleteObservable","hasAlpha","flushRenderer","numChannels","Promise","resolve","isSupported","_HasMajorPerformanceCaveat","_IsSupported","tempcanvas","WebGLRenderingContext","failIfMajorPerformanceCaveat","c","CeilingPOT","f","FloorPOT","pot","NearestPOT","func","requestAnimationFrame","requestPostAnimationFrame","msRequestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Engines/thinEngine.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { EngineStore } from \"./engineStore\";\r\nimport type { IInternalTextureLoader } from \"../Materials/Textures/internalTextureLoader\";\r\nimport type { IEffectCreationOptions } from \"../Materials/effect\";\r\nimport { Effect } from \"../Materials/effect\";\r\nimport { _WarnImport } from \"../Misc/devTools\";\r\nimport type { IShaderProcessor } from \"./Processors/iShaderProcessor\";\r\nimport type { ShaderProcessingContext } from \"./Processors/shaderProcessingOptions\";\r\nimport type { UniformBuffer } from \"../Materials/uniformBuffer\";\r\nimport type { Nullable, DataArray, IndicesArray } from \"../types\";\r\nimport type { EngineCapabilities } from \"./engineCapabilities\";\r\nimport { Observable } from \"../Misc/observable\";\r\nimport { DepthCullingState } from \"../States/depthCullingState\";\r\nimport { StencilState } from \"../States/stencilState\";\r\nimport { AlphaState } from \"../States/alphaCullingState\";\r\nimport { Constants } from \"./constants\";\r\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture\";\r\nimport type { IViewportLike, IColor4Like } from \"../Maths/math.like\";\r\nimport type { DataBuffer } from \"../Buffers/dataBuffer\";\r\nimport type { IFileRequest } from \"../Misc/fileRequest\";\r\nimport { Logger } from \"../Misc/logger\";\r\nimport { IsDocumentAvailable, IsWindowObjectExist } from \"../Misc/domManagement\";\r\nimport { WebGLShaderProcessor } from \"./WebGL/webGLShaderProcessors\";\r\nimport { WebGL2ShaderProcessor } from \"./WebGL/webGL2ShaderProcessors\";\r\nimport { WebGLDataBuffer } from \"../Meshes/WebGL/webGLDataBuffer\";\r\nimport type { IPipelineContext } from \"./IPipelineContext\";\r\nimport { WebGLPipelineContext } from \"./WebGL/webGLPipelineContext\";\r\nimport type { VertexBuffer } from \"../Buffers/buffer\";\r\nimport type { InstancingAttributeInfo } from \"./instancingAttributeInfo\";\r\nimport type { ThinTexture } from \"../Materials/Textures/thinTexture\";\r\nimport type { IOfflineProvider } from \"../Offline/IOfflineProvider\";\r\nimport type { IEffectFallbacks } from \"../Materials/iEffectFallbacks\";\r\nimport type { IWebRequest } from \"../Misc/interfaces/iWebRequest\";\r\nimport { PerformanceConfigurator } from \"./performanceConfigurator\";\r\nimport type { EngineFeatures } from \"./engineFeatures\";\r\nimport type { HardwareTextureWrapper } from \"../Materials/Textures/hardwareTextureWrapper\";\r\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture\";\r\nimport { DrawWrapper } from \"../Materials/drawWrapper\";\r\nimport type { IMaterialContext } from \"./IMaterialContext\";\r\nimport type { IDrawContext } from \"./IDrawContext\";\r\nimport type { ICanvas, ICanvasRenderingContext, IImage } from \"./ICanvas\";\r\nimport { StencilStateComposer } from \"../States/stencilStateComposer\";\r\nimport type { StorageBuffer } from \"../Buffers/storageBuffer\";\r\nimport type { IAudioEngineOptions } from \"../Audio/Interfaces/IAudioEngineOptions\";\r\nimport type { IStencilState } from \"../States/IStencilState\";\r\nimport type { InternalTextureCreationOptions, TextureSize } from \"../Materials/Textures/textureCreationOptions\";\r\nimport { ShaderLanguage } from \"../Materials/shaderLanguage\";\r\n\r\ndeclare type WebRequest = import(\"../Misc/webRequest\").WebRequest;\r\ndeclare type LoadFileError = import(\"../Misc/fileTools\").LoadFileError;\r\ndeclare type Observer<T> = import(\"../Misc/observable\").Observer<T>;\r\ndeclare type VideoTexture = import(\"../Materials/Textures/videoTexture\").VideoTexture;\r\ndeclare type RenderTargetTexture = import(\"../Materials/Textures/renderTargetTexture\").RenderTargetTexture;\r\ndeclare type Texture = import(\"../Materials/Textures/texture\").Texture;\r\ndeclare type RenderTargetWrapper = import(\"./renderTargetWrapper\").RenderTargetWrapper;\r\ndeclare type WebGLRenderTargetWrapper = import(\"./WebGL/webGLRenderTargetWrapper\").WebGLRenderTargetWrapper;\r\n\r\n/**\r\n * Defines the interface used by objects working like Scene\r\n * @hidden\r\n */\r\nexport interface ISceneLike {\r\n    _addPendingData(data: any): void;\r\n    _removePendingData(data: any): void;\r\n    offlineProvider: IOfflineProvider;\r\n}\r\n\r\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\r\nclass BufferPointer {\r\n    public active: boolean;\r\n    public index: number;\r\n    public size: number;\r\n    public type: number;\r\n    public normalized: boolean;\r\n    public stride: number;\r\n    public offset: number;\r\n    public buffer: WebGLBuffer;\r\n}\r\n\r\n/**\r\n * Information about the current host\r\n */\r\nexport interface HostInformation {\r\n    /**\r\n     * Defines if the current host is a mobile\r\n     */\r\n    isMobile: boolean;\r\n}\r\n\r\n/** Interface defining initialization parameters for Engine class */\r\nexport interface EngineOptions extends WebGLContextAttributes {\r\n    /**\r\n     * Defines if the engine should no exceed a specified device ratio\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio\r\n     */\r\n    limitDeviceRatio?: number;\r\n    /**\r\n     * Defines if webvr should be enabled automatically\r\n     * @see https://doc.babylonjs.com/how_to/webvr_camera\r\n     */\r\n    autoEnableWebVR?: boolean;\r\n    /**\r\n     * Defines if webgl2 should be turned off even if supported\r\n     * @see https://doc.babylonjs.com/features/webgl2\r\n     */\r\n    disableWebGL2Support?: boolean;\r\n    /**\r\n     * Defines if webaudio should be initialized as well\r\n     * @see https://doc.babylonjs.com/how_to/playing_sounds_and_music\r\n     */\r\n    audioEngine?: boolean;\r\n    /**\r\n     * Specifies options for the audio engine\r\n     */\r\n    audioEngineOptions?: IAudioEngineOptions;\r\n\r\n    /**\r\n     * Defines if animations should run using a deterministic lock step\r\n     * @see https://doc.babylonjs.com/babylon101/animations#deterministic-lockstep\r\n     */\r\n    deterministicLockstep?: boolean;\r\n    /** Defines the maximum steps to use with deterministic lock step mode */\r\n    lockstepMaxSteps?: number;\r\n    /** Defines the seconds between each deterministic lock step */\r\n    timeStep?: number;\r\n    /**\r\n     * Defines that engine should ignore context lost events\r\n     * If this event happens when this parameter is true, you will have to reload the page to restore rendering\r\n     */\r\n\r\n    doNotHandleContextLost?: boolean;\r\n    /**\r\n     * Defines that engine should ignore modifying touch action attribute and style\r\n     * If not handle, you might need to set it up on your side for expected touch devices behavior.\r\n     */\r\n    doNotHandleTouchAction?: boolean;\r\n    /**\r\n     * Defines that engine should compile shaders with high precision floats (if supported). True by default\r\n     */\r\n    useHighPrecisionFloats?: boolean;\r\n    /**\r\n     * Make the canvas XR Compatible for XR sessions\r\n     */\r\n    xrCompatible?: boolean;\r\n\r\n    /**\r\n     * Make the matrix computations to be performed in 64 bits instead of 32 bits. False by default\r\n     */\r\n    useHighPrecisionMatrix?: boolean;\r\n\r\n    /**\r\n     * Will prevent the system from falling back to software implementation if a hardware device cannot be created\r\n     */\r\n    failIfMajorPerformanceCaveat?: boolean;\r\n\r\n    /**\r\n     * Defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    adaptToDeviceRatio?: boolean;\r\n\r\n    /**\r\n     * If sRGB Buffer support is not set during construction, use this value to force a specific state\r\n     * This is added due to an issue when processing textures in chrome/edge/firefox\r\n     * This will not influence NativeEngine and WebGPUEngine which set the behavior to true during construction.\r\n     */\r\n    forceSRGBBufferSupportState?: boolean;\r\n}\r\n\r\n/**\r\n * The base engine class (root of all engines)\r\n */\r\nexport class ThinEngine {\r\n    /** Use this array to turn off some WebGL2 features on known buggy browsers version */\r\n    public static ExceptionList = [\r\n        { key: \"Chrome/63.0\", capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\", captureConstraint: 108, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox/58\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox/59\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Chrome/72.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome/73.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome/74.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome/71\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome/72\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n    ];\r\n\r\n    /** @hidden */\r\n    public static _TextureLoaders: IInternalTextureLoader[] = [];\r\n\r\n    /**\r\n     * Returns the current npm package of the sdk\r\n     */\r\n    // Not mixed with Version for tooling purpose.\r\n    public static get NpmPackage(): string {\r\n        return \"babylonjs@5.3.0\";\r\n    }\r\n\r\n    /**\r\n     * Returns the current version of the framework\r\n     */\r\n    public static get Version(): string {\r\n        return \"5.3.0\";\r\n    }\r\n\r\n    /**\r\n     * Returns a string describing the current engine\r\n     */\r\n    public get description(): string {\r\n        let description = this.name + this.webGLVersion;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            description += \" - Parallel shader compilation\";\r\n        }\r\n\r\n        return description;\r\n    }\r\n\r\n    /** @hidden */\r\n    protected _name = \"WebGL\";\r\n\r\n    /**\r\n     * Gets or sets the name of the engine\r\n     */\r\n    public get name(): string {\r\n        return this._name;\r\n    }\r\n\r\n    public set name(value: string) {\r\n        this._name = value;\r\n    }\r\n\r\n    /**\r\n     * Returns the version of the engine\r\n     */\r\n    public get version(): number {\r\n        return this._webGLVersion;\r\n    }\r\n\r\n    // Updatable statics so stick with vars here\r\n\r\n    /**\r\n     * Gets or sets the epsilon value used by collision engine\r\n     */\r\n    public static CollisionsEpsilon = 0.001;\r\n\r\n    /**\r\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n     */\r\n    public static get ShadersRepository(): string {\r\n        return Effect.ShadersRepository;\r\n    }\r\n    public static set ShadersRepository(value: string) {\r\n        Effect.ShadersRepository = value;\r\n    }\r\n\r\n    protected _shaderProcessor: Nullable<IShaderProcessor>;\r\n\r\n    /**\r\n     * @param shaderLanguage\r\n     * @hidden\r\n     */\r\n    public _getShaderProcessor(shaderLanguage: ShaderLanguage): Nullable<IShaderProcessor> {\r\n        return this._shaderProcessor;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n     */\r\n    public forcePOTTextures = false;\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n     */\r\n    public isFullscreen = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if back faces must be culled. If false, front faces are culled instead (true by default)\r\n     * If non null, this takes precedence over the value from the material\r\n     */\r\n    public cullBackFaces: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foreground\r\n     */\r\n    public renderEvenInBackground = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that cache can be kept between frames\r\n     */\r\n    public preventCacheWipeBetweenFrames = false;\r\n\r\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\r\n    public validateShaderPrograms = false;\r\n\r\n    private _useReverseDepthBuffer = false;\r\n    /**\r\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n     * This can provide greater z depth for distant objects.\r\n     */\r\n    public get useReverseDepthBuffer(): boolean {\r\n        return this._useReverseDepthBuffer;\r\n    }\r\n\r\n    public set useReverseDepthBuffer(useReverse) {\r\n        if (useReverse === this._useReverseDepthBuffer) {\r\n            return;\r\n        }\r\n\r\n        this._useReverseDepthBuffer = useReverse;\r\n\r\n        if (useReverse) {\r\n            this._depthCullingState.depthFunc = Constants.GEQUAL;\r\n        } else {\r\n            this._depthCullingState.depthFunc = Constants.LEQUAL;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Indicates if the z range in NDC space is 0..1 (value: true) or -1..1 (value: false)\r\n     */\r\n    public readonly isNDCHalfZRange = false;\r\n\r\n    /**\r\n     * Indicates that the origin of the texture/framebuffer space is the bottom left corner. If false, the origin is top left\r\n     */\r\n    public readonly hasOriginBottomLeft = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n     */\r\n    public disableUniformBuffers = false;\r\n\r\n    /**\r\n     * An event triggered when the engine is disposed.\r\n     */\r\n    public readonly onDisposeObservable = new Observable<ThinEngine>();\r\n\r\n    private _frameId = 0;\r\n    /**\r\n     * Gets the current frame id\r\n     */\r\n    public get frameId(): number {\r\n        return this._frameId;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _uniformBuffers = new Array<UniformBuffer>();\r\n    /** @hidden */\r\n    public _storageBuffers = new Array<StorageBuffer>();\r\n\r\n    /**\r\n     * Gets a boolean indicating that the engine supports uniform buffers\r\n     * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\r\n     */\r\n    public get supportsUniformBuffers(): boolean {\r\n        return this.webGLVersion > 1 && !this.disableUniformBuffers;\r\n    }\r\n\r\n    // Private Members\r\n\r\n    /** @hidden */\r\n    public _gl: WebGLRenderingContext;\r\n    /** @hidden */\r\n    public _webGLVersion = 1.0;\r\n    protected _renderingCanvas: Nullable<HTMLCanvasElement>;\r\n    protected _windowIsBackground = false;\r\n    protected _creationOptions: EngineOptions;\r\n    protected _audioContext: Nullable<AudioContext>;\r\n    protected _audioDestination: Nullable<AudioDestinationNode | MediaStreamAudioDestinationNode>;\r\n\r\n    /**\r\n     * Gets the options used for engine creation\r\n     * @returns EngineOptions object\r\n     */\r\n    public getCreationOptions() {\r\n        return this._creationOptions;\r\n    }\r\n\r\n    protected _highPrecisionShadersAllowed = true;\r\n    /** @hidden */\r\n    public get _shouldUseHighPrecisionShader(): boolean {\r\n        return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating that only power of 2 textures are supported\r\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n     */\r\n    public get needPOTTextures(): boolean {\r\n        return this._webGLVersion < 2 || this.forcePOTTextures;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _badOS = false;\r\n\r\n    /** @hidden */\r\n    public _badDesktopOS = false;\r\n\r\n    /** @hidden */\r\n    public _hardwareScalingLevel: number;\r\n    /** @hidden */\r\n    public _caps: EngineCapabilities;\r\n    /** @hidden */\r\n    public _features: EngineFeatures;\r\n    protected _isStencilEnable: boolean;\r\n\r\n    private _glVersion: string;\r\n    private _glRenderer: string;\r\n    private _glVendor: string;\r\n\r\n    /** @hidden */\r\n    public _videoTextureSupported: boolean;\r\n\r\n    protected _renderingQueueLaunched = false;\r\n    protected _activeRenderLoops = new Array<() => void>();\r\n\r\n    /**\r\n     * Gets the list of current active render loop functions\r\n     * @returns an array with the current render loop functions\r\n     */\r\n    public get activeRenderLoops(): Array<() => void> {\r\n        return this._activeRenderLoops;\r\n    }\r\n\r\n    // Lost context\r\n    /**\r\n     * Observable signaled when a context lost event is raised\r\n     */\r\n    public onContextLostObservable = new Observable<ThinEngine>();\r\n    /**\r\n     * Observable signaled when a context restored event is raised\r\n     */\r\n    public onContextRestoredObservable = new Observable<ThinEngine>();\r\n    private _onContextLost: (evt: Event) => void;\r\n    private _onContextRestored: (evt: Event) => void;\r\n    protected _contextWasLost = false;\r\n\r\n    /** @hidden */\r\n    public _doNotHandleContextLost = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\r\n     */\r\n    public get doNotHandleContextLost(): boolean {\r\n        return this._doNotHandleContextLost;\r\n    }\r\n\r\n    public set doNotHandleContextLost(value: boolean) {\r\n        this._doNotHandleContextLost = value;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n     */\r\n    public disableVertexArrayObjects = false;\r\n\r\n    // States\r\n    /** @hidden */\r\n    protected _colorWrite = true;\r\n    /** @hidden */\r\n    protected _colorWriteChanged = true;\r\n    /** @hidden */\r\n    protected _depthCullingState = new DepthCullingState();\r\n    /** @hidden */\r\n    protected _stencilStateComposer = new StencilStateComposer();\r\n    /** @hidden */\r\n    protected _stencilState = new StencilState();\r\n    /** @hidden */\r\n    public _alphaState = new AlphaState();\r\n    /** @hidden */\r\n    public _alphaMode = Constants.ALPHA_ADD;\r\n    /** @hidden */\r\n    public _alphaEquation = Constants.ALPHA_DISABLE;\r\n\r\n    // Cache\r\n    /** @hidden */\r\n    public _internalTexturesCache = new Array<InternalTexture>();\r\n    /** @hidden */\r\n    public _renderTargetWrapperCache = new Array<RenderTargetWrapper>();\r\n    /** @hidden */\r\n    protected _activeChannel = 0;\r\n    private _currentTextureChannel = -1;\r\n    /** @hidden */\r\n    protected _boundTexturesCache: { [key: string]: Nullable<InternalTexture> } = {};\r\n    protected _currentEffect: Nullable<Effect>;\r\n    /** @hidden */\r\n    public _currentDrawContext: IDrawContext;\r\n    /** @hidden */\r\n    public _currentMaterialContext: IMaterialContext;\r\n    /** @hidden */\r\n    protected _currentProgram: Nullable<WebGLProgram>;\r\n    protected _compiledEffects: { [key: string]: Effect } = {};\r\n    private _vertexAttribArraysEnabled: boolean[] = [];\r\n    /** @hidden */\r\n    protected _cachedViewport: Nullable<IViewportLike>;\r\n    private _cachedVertexArrayObject: Nullable<WebGLVertexArrayObject>;\r\n    /** @hidden */\r\n    protected _cachedVertexBuffers: any;\r\n    /** @hidden */\r\n    protected _cachedIndexBuffer: Nullable<DataBuffer>;\r\n    /** @hidden */\r\n    protected _cachedEffectForVertexBuffers: Nullable<Effect>;\r\n\r\n    /** @hidden */\r\n    public _currentRenderTarget: Nullable<RenderTargetWrapper>;\r\n    private _uintIndicesCurrentlySet = false;\r\n    protected _currentBoundBuffer = new Array<Nullable<WebGLBuffer>>();\r\n    /** @hidden */\r\n    public _currentFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    /** @hidden */\r\n    public _dummyFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    private _currentBufferPointers = new Array<BufferPointer>();\r\n    private _currentInstanceLocations = new Array<number>();\r\n    private _currentInstanceBuffers = new Array<DataBuffer>();\r\n    private _textureUnits: Int32Array;\r\n\r\n    /** @hidden */\r\n    public _workingCanvas: Nullable<ICanvas>;\r\n    /** @hidden */\r\n    public _workingContext: Nullable<ICanvasRenderingContext>;\r\n\r\n    /** @hidden */\r\n    public _boundRenderFunction: any;\r\n\r\n    private _vaoRecordInProgress = false;\r\n    private _mustWipeVertexAttributes = false;\r\n\r\n    private _emptyTexture: Nullable<InternalTexture>;\r\n    private _emptyCubeTexture: Nullable<InternalTexture>;\r\n    private _emptyTexture3D: Nullable<InternalTexture>;\r\n    private _emptyTexture2DArray: Nullable<InternalTexture>;\r\n\r\n    /** @hidden */\r\n    public _frameHandler: number;\r\n\r\n    private _nextFreeTextureSlots = new Array<number>();\r\n    private _maxSimultaneousTextures = 0;\r\n\r\n    private _activeRequests = new Array<IFileRequest>();\r\n\r\n    /** @hidden */\r\n    private _adaptToDeviceRatio: boolean = false;\r\n\r\n    /** @hidden */\r\n    public _transformTextureUrl: Nullable<(url: string) => string> = null;\r\n\r\n    /**\r\n     * Gets information about the current host\r\n     */\r\n    public hostInformation: HostInformation = {\r\n        isMobile: false,\r\n    };\r\n\r\n    protected get _supportsHardwareTextureRescaling() {\r\n        return false;\r\n    }\r\n\r\n    private _framebufferDimensionsObject: Nullable<{ framebufferWidth: number; framebufferHeight: number }>;\r\n\r\n    /**\r\n     * sets the object from which width and height will be taken from when getting render width and height\r\n     * Will fallback to the gl object\r\n     * @param dimensions the framebuffer width and height that will be used.\r\n     */\r\n    public set framebufferDimensionsObject(dimensions: Nullable<{ framebufferWidth: number; framebufferHeight: number }>) {\r\n        this._framebufferDimensionsObject = dimensions;\r\n    }\r\n\r\n    /**\r\n     * Gets the current viewport\r\n     */\r\n    public get currentViewport(): Nullable<IViewportLike> {\r\n        return this._cachedViewport;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty texture\r\n     */\r\n    public get emptyTexture(): InternalTexture {\r\n        if (!this._emptyTexture) {\r\n            this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, Constants.TEXTUREFORMAT_RGBA, false, false, Constants.TEXTURE_NEAREST_SAMPLINGMODE);\r\n        }\r\n\r\n        return this._emptyTexture;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 3D texture\r\n     */\r\n    public get emptyTexture3D(): InternalTexture {\r\n        if (!this._emptyTexture3D) {\r\n            this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, Constants.TEXTUREFORMAT_RGBA, false, false, Constants.TEXTURE_NEAREST_SAMPLINGMODE);\r\n        }\r\n\r\n        return this._emptyTexture3D;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 2D array texture\r\n     */\r\n    public get emptyTexture2DArray(): InternalTexture {\r\n        if (!this._emptyTexture2DArray) {\r\n            this._emptyTexture2DArray = this.createRawTexture2DArray(\r\n                new Uint8Array(4),\r\n                1,\r\n                1,\r\n                1,\r\n                Constants.TEXTUREFORMAT_RGBA,\r\n                false,\r\n                false,\r\n                Constants.TEXTURE_NEAREST_SAMPLINGMODE\r\n            );\r\n        }\r\n\r\n        return this._emptyTexture2DArray;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty cube texture\r\n     */\r\n    public get emptyCubeTexture(): InternalTexture {\r\n        if (!this._emptyCubeTexture) {\r\n            const faceData = new Uint8Array(4);\r\n            const cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\r\n            this._emptyCubeTexture = this.createRawCubeTexture(\r\n                cubeData,\r\n                1,\r\n                Constants.TEXTUREFORMAT_RGBA,\r\n                Constants.TEXTURETYPE_UNSIGNED_INT,\r\n                false,\r\n                false,\r\n                Constants.TEXTURE_NEAREST_SAMPLINGMODE\r\n            );\r\n        }\r\n\r\n        return this._emptyCubeTexture;\r\n    }\r\n\r\n    /**\r\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n     */\r\n    public premultipliedAlpha: boolean = true;\r\n\r\n    /**\r\n     * Observable event triggered before each texture is initialized\r\n     */\r\n    public onBeforeTextureInitObservable = new Observable<Texture>();\r\n\r\n    /** @hidden */\r\n    protected _isWebGPU: boolean = false;\r\n    /**\r\n     * Gets a boolean indicating if the engine runs in WebGPU or not.\r\n     */\r\n    public get isWebGPU(): boolean {\r\n        return this._isWebGPU;\r\n    }\r\n\r\n    /** @hidden */\r\n    protected _shaderPlatformName: string;\r\n    /**\r\n     * Gets the shader platform name used by the effects.\r\n     */\r\n    public get shaderPlatformName(): string {\r\n        return this._shaderPlatformName;\r\n    }\r\n\r\n    /**\r\n     * Enables or disables the snapshot rendering mode\r\n     * Note that the WebGL engine does not support snapshot rendering so setting the value won't have any effect for this engine\r\n     */\r\n    public get snapshotRendering(): boolean {\r\n        return false;\r\n    }\r\n\r\n    public set snapshotRendering(activate) {\r\n        // WebGL engine does not support snapshot rendering\r\n    }\r\n\r\n    protected _snapshotRenderingMode = Constants.SNAPSHOTRENDERING_STANDARD;\r\n    /**\r\n     * Gets or sets the snapshot rendering mode\r\n     */\r\n    public get snapshotRenderingMode(): number {\r\n        return this._snapshotRenderingMode;\r\n    }\r\n\r\n    public set snapshotRenderingMode(mode: number) {\r\n        this._snapshotRenderingMode = mode;\r\n    }\r\n\r\n    /**\r\n     * Creates a new snapshot at the next frame using the current snapshotRenderingMode\r\n     */\r\n    public snapshotRenderingReset(): void {\r\n        this.snapshotRendering = false;\r\n    }\r\n\r\n    private _checkForMobile: () => void;\r\n\r\n    private static _CreateCanvas(width: number, height: number): ICanvas {\r\n        if (typeof document === \"undefined\") {\r\n            return <ICanvas>(<any>new OffscreenCanvas(width, height));\r\n        }\r\n        const canvas = <ICanvas>(<any>document.createElement(\"canvas\"));\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        return canvas;\r\n    }\r\n\r\n    /**\r\n     * Create a canvas. This method is overridden by other engines\r\n     * @param width width\r\n     * @param height height\r\n     * @return ICanvas interface\r\n     */\r\n    public createCanvas(width: number, height: number): ICanvas {\r\n        return ThinEngine._CreateCanvas(width, height);\r\n    }\r\n\r\n    /**\r\n     * Create an image to use with canvas\r\n     * @return IImage interface\r\n     */\r\n    public createCanvasImage(): IImage {\r\n        return document.createElement(\"img\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new engine\r\n     * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which already used the WebGL context\r\n     * @param antialias defines enable antialiasing (default: false)\r\n     * @param options defines further options to be sent to the getContext() function\r\n     * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    constructor(\r\n        canvasOrContext: Nullable<HTMLCanvasElement | OffscreenCanvas | WebGLRenderingContext | WebGL2RenderingContext>,\r\n        antialias?: boolean,\r\n        options?: EngineOptions,\r\n        adaptToDeviceRatio?: boolean\r\n    ) {\r\n        let canvas: Nullable<HTMLCanvasElement> = null;\r\n\r\n        options = options || {};\r\n\r\n        this._creationOptions = options;\r\n\r\n        // Save this off for use in resize().\r\n        this._adaptToDeviceRatio = adaptToDeviceRatio ?? false;\r\n\r\n        this._stencilStateComposer.stencilGlobal = this._stencilState;\r\n\r\n        PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\r\n\r\n        if (!canvasOrContext) {\r\n            return;\r\n        }\r\n\r\n        adaptToDeviceRatio = adaptToDeviceRatio || options.adaptToDeviceRatio || false;\r\n\r\n        if ((canvasOrContext as any).getContext) {\r\n            canvas = <HTMLCanvasElement>canvasOrContext;\r\n            this._renderingCanvas = canvas;\r\n\r\n            if (antialias !== undefined) {\r\n                options.antialias = antialias;\r\n            }\r\n\r\n            if (options.deterministicLockstep === undefined) {\r\n                options.deterministicLockstep = false;\r\n            }\r\n\r\n            if (options.lockstepMaxSteps === undefined) {\r\n                options.lockstepMaxSteps = 4;\r\n            }\r\n\r\n            if (options.timeStep === undefined) {\r\n                options.timeStep = 1 / 60;\r\n            }\r\n\r\n            if (options.preserveDrawingBuffer === undefined) {\r\n                options.preserveDrawingBuffer = false;\r\n            }\r\n\r\n            if (options.audioEngine === undefined) {\r\n                options.audioEngine = true;\r\n            }\r\n\r\n            if (options.audioEngineOptions !== undefined && options.audioEngineOptions.audioContext !== undefined) {\r\n                this._audioContext = options.audioEngineOptions.audioContext;\r\n            }\r\n\r\n            if (options.audioEngineOptions !== undefined && options.audioEngineOptions.audioDestination !== undefined) {\r\n                this._audioDestination = options.audioEngineOptions.audioDestination;\r\n            }\r\n\r\n            if (options.stencil === undefined) {\r\n                options.stencil = true;\r\n            }\r\n\r\n            if (options.premultipliedAlpha === false) {\r\n                this.premultipliedAlpha = false;\r\n            }\r\n\r\n            if (options.xrCompatible === undefined) {\r\n                options.xrCompatible = true;\r\n            }\r\n\r\n            this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false;\r\n\r\n            // Exceptions\r\n            if (navigator && navigator.userAgent) {\r\n                // Function to check if running on mobile device\r\n                this._checkForMobile = () => {\r\n                    const currentUA = navigator.userAgent;\r\n                    this.hostInformation.isMobile =\r\n                        currentUA.indexOf(\"Mobile\") !== -1 ||\r\n                        // Needed for iOS 13+ detection on iPad (inspired by solution from https://stackoverflow.com/questions/9038625/detect-if-device-is-ios)\r\n                        (currentUA.indexOf(\"Mac\") !== -1 && IsDocumentAvailable() && \"ontouchend\" in document);\r\n                };\r\n\r\n                // Set initial isMobile value\r\n                this._checkForMobile();\r\n\r\n                // Set up event listener to check when window is resized (used to get emulator activation to work properly)\r\n                if (IsWindowObjectExist()) {\r\n                    window.addEventListener(\"resize\", this._checkForMobile);\r\n                }\r\n\r\n                const ua = navigator.userAgent;\r\n                for (const exception of ThinEngine.ExceptionList) {\r\n                    const key = exception.key;\r\n                    const targets = exception.targets;\r\n                    const check = new RegExp(key);\r\n\r\n                    if (check.test(ua)) {\r\n                        if (exception.capture && exception.captureConstraint) {\r\n                            const capture = exception.capture;\r\n                            const constraint = exception.captureConstraint;\r\n\r\n                            const regex = new RegExp(capture);\r\n                            const matches = regex.exec(ua);\r\n\r\n                            if (matches && matches.length > 0) {\r\n                                const capturedValue = parseInt(matches[matches.length - 1]);\r\n                                if (capturedValue >= constraint) {\r\n                                    continue;\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        for (const target of targets) {\r\n                            switch (target) {\r\n                                case \"uniformBuffer\":\r\n                                    this.disableUniformBuffers = true;\r\n                                    break;\r\n                                case \"vao\":\r\n                                    this.disableVertexArrayObjects = true;\r\n                                    break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Context lost\r\n            if (!this._doNotHandleContextLost) {\r\n                this._onContextLost = (evt: Event) => {\r\n                    evt.preventDefault();\r\n                    this._contextWasLost = true;\r\n                    Logger.Warn(\"WebGL context lost.\");\r\n\r\n                    this.onContextLostObservable.notifyObservers(this);\r\n                };\r\n\r\n                this._onContextRestored = () => {\r\n                    this._restoreEngineAfterContextLost(this._initGLContext.bind(this));\r\n                };\r\n\r\n                canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\r\n                canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\r\n\r\n                options.powerPreference = \"high-performance\";\r\n            }\r\n\r\n            // Detect if we are running on a faulty buggy desktop OS.\r\n            this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\r\n            if (this._badDesktopOS) {\r\n                options.xrCompatible = false;\r\n            }\r\n\r\n            // GL\r\n            if (!options.disableWebGL2Support) {\r\n                try {\r\n                    this._gl = <any>(canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options));\r\n                    if (this._gl) {\r\n                        this._webGLVersion = 2.0;\r\n                        this._shaderPlatformName = \"WEBGL2\";\r\n\r\n                        // Prevent weird browsers to lie (yeah that happens!)\r\n                        if (!this._gl.deleteQuery) {\r\n                            this._webGLVersion = 1.0;\r\n                            this._shaderPlatformName = \"WEBGL1\";\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    // Do nothing\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                if (!canvas) {\r\n                    throw new Error(\"The provided canvas is null or undefined.\");\r\n                }\r\n                try {\r\n                    this._gl = <WebGLRenderingContext>(canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options));\r\n                } catch (e) {\r\n                    throw new Error(\"WebGL not supported\");\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                throw new Error(\"WebGL not supported\");\r\n            }\r\n        } else {\r\n            this._gl = <WebGLRenderingContext>canvasOrContext;\r\n            this._renderingCanvas = this._gl.canvas as HTMLCanvasElement;\r\n\r\n            if (this._gl.renderbufferStorageMultisample) {\r\n                this._webGLVersion = 2.0;\r\n                this._shaderPlatformName = \"WEBGL2\";\r\n            } else {\r\n                this._shaderPlatformName = \"WEBGL1\";\r\n            }\r\n\r\n            const attributes = this._gl.getContextAttributes();\r\n            if (attributes) {\r\n                options.stencil = attributes.stencil;\r\n            }\r\n        }\r\n\r\n        // Ensures a consistent color space unpacking of textures cross browser.\r\n        this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n\r\n        if (options.useHighPrecisionFloats !== undefined) {\r\n            this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\r\n        }\r\n\r\n        // Viewport\r\n        const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\r\n\r\n        const limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\r\n        this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\r\n        this.resize();\r\n\r\n        this._isStencilEnable = options.stencil ? true : false;\r\n        this._initGLContext();\r\n        this._initFeatures();\r\n\r\n        // Prepare buffer pointers\r\n        for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n            this._currentBufferPointers[i] = new BufferPointer();\r\n        }\r\n\r\n        // Shader processor\r\n        this._shaderProcessor = this.webGLVersion > 1 ? new WebGL2ShaderProcessor() : new WebGLShaderProcessor();\r\n\r\n        // Detect if we are running on a faulty buggy OS.\r\n        this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent);\r\n\r\n        // Starting with iOS 14, we can trust the browser\r\n        // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\r\n\r\n        // if (matches && matches.length === 2) {\r\n        //     if (parseInt(matches[1]) >= 14) {\r\n        //         this._badOS = false;\r\n        //     }\r\n        // }\r\n\r\n        const versionToLog = `Babylon.js v${ThinEngine.Version}`;\r\n        console.log(versionToLog + ` - ${this.description}`);\r\n\r\n        // Check setAttribute in case of workers\r\n        if (this._renderingCanvas && this._renderingCanvas.setAttribute) {\r\n            this._renderingCanvas.setAttribute(\"data-engine\", versionToLog);\r\n        }\r\n    }\r\n\r\n    protected _restoreEngineAfterContextLost(initEngine: () => void): void {\r\n        // Adding a timeout to avoid race condition at browser level\r\n        setTimeout(async () => {\r\n            this._dummyFramebuffer = null;\r\n\r\n            const depthTest = this._depthCullingState.depthTest; // backup those values because the call to initEngine / wipeCaches will reset them\r\n            const depthFunc = this._depthCullingState.depthFunc;\r\n            const depthMask = this._depthCullingState.depthMask;\r\n            const stencilTest = this._stencilState.stencilTest;\r\n\r\n            // Rebuild context\r\n            await initEngine();\r\n            // Rebuild effects\r\n            this._rebuildEffects();\r\n            this._rebuildComputeEffects?.();\r\n            // Rebuild textures\r\n            this._rebuildInternalTextures();\r\n            // Rebuild textures\r\n            this._rebuildRenderTargetWrappers();\r\n            // Rebuild buffers\r\n            this._rebuildBuffers();\r\n            // Cache\r\n            this.wipeCaches(true);\r\n\r\n            this._depthCullingState.depthTest = depthTest;\r\n            this._depthCullingState.depthFunc = depthFunc;\r\n            this._depthCullingState.depthMask = depthMask;\r\n            this._stencilState.stencilTest = stencilTest;\r\n\r\n            Logger.Warn(this.name + \" context successfully restored.\");\r\n            this.onContextRestoredObservable.notifyObservers(this);\r\n            this._contextWasLost = false;\r\n        }, 0);\r\n    }\r\n\r\n    /**\r\n     * Shared initialization across engines types.\r\n     * @param canvas The canvas associated with this instance of the engine.\r\n     * @param doNotHandleTouchAction Defines that engine should ignore modifying touch action attribute and style\r\n     * @param audioEngine Defines if an audio engine should be created by default\r\n     */\r\n    protected _sharedInit(canvas: HTMLCanvasElement, doNotHandleTouchAction: boolean, audioEngine: boolean) {\r\n        this._renderingCanvas = canvas;\r\n    }\r\n\r\n    /**\r\n     * @param shaderLanguage\r\n     * @hidden\r\n     */\r\n    public _getShaderProcessingContext(shaderLanguage: ShaderLanguage): Nullable<ShaderProcessingContext> {\r\n        return null;\r\n    }\r\n\r\n    private _rebuildInternalTextures(): void {\r\n        const currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\r\n\r\n        for (const internalTexture of currentState) {\r\n            internalTexture._rebuild();\r\n        }\r\n    }\r\n\r\n    private _rebuildRenderTargetWrappers(): void {\r\n        const currentState = this._renderTargetWrapperCache.slice(); // Do a copy because the rebuild will add proxies\r\n\r\n        for (const renderTargetWrapper of currentState) {\r\n            renderTargetWrapper._rebuild();\r\n        }\r\n    }\r\n\r\n    private _rebuildEffects(): void {\r\n        for (const key in this._compiledEffects) {\r\n            const effect = <Effect>this._compiledEffects[key];\r\n\r\n            effect._pipelineContext = null; // because _prepareEffect will try to dispose this pipeline before recreating it and that would lead to webgl errors\r\n            effect._wasPreviouslyReady = false;\r\n            effect._prepareEffect();\r\n        }\r\n\r\n        Effect.ResetCache();\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if all created effects are ready\r\n     * @returns true if all effects are ready\r\n     */\r\n    public areAllEffectsReady(): boolean {\r\n        for (const key in this._compiledEffects) {\r\n            const effect = <Effect>this._compiledEffects[key];\r\n\r\n            if (!effect.isReady()) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    protected _rebuildBuffers(): void {\r\n        // Uniforms\r\n        for (const uniformBuffer of this._uniformBuffers) {\r\n            uniformBuffer._rebuild();\r\n        }\r\n        // Storage buffers\r\n        for (const storageBuffer of this._storageBuffers) {\r\n            storageBuffer._rebuild();\r\n        }\r\n    }\r\n\r\n    protected _initGLContext(): void {\r\n        // Caps\r\n        this._caps = {\r\n            maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\r\n            maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\r\n            maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\r\n            maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\r\n            maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\r\n            maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\r\n            maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\r\n            maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\r\n            maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\r\n            maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\r\n            maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\r\n            parallelShaderCompile: this._gl.getExtension(\"KHR_parallel_shader_compile\") || undefined,\r\n            standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension(\"OES_standard_derivatives\") !== null,\r\n            maxAnisotropy: 1,\r\n            astc: this._gl.getExtension(\"WEBGL_compressed_texture_astc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_astc\"),\r\n            bptc: this._gl.getExtension(\"EXT_texture_compression_bptc\") || this._gl.getExtension(\"WEBKIT_EXT_texture_compression_bptc\"),\r\n            s3tc: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc\"),\r\n            // eslint-disable-next-line @typescript-eslint/naming-convention\r\n            s3tc_srgb: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc_srgb\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc_srgb\"),\r\n            pvrtc: this._gl.getExtension(\"WEBGL_compressed_texture_pvrtc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_pvrtc\"),\r\n            etc1: this._gl.getExtension(\"WEBGL_compressed_texture_etc1\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc1\"),\r\n            etc2:\r\n                this._gl.getExtension(\"WEBGL_compressed_texture_etc\") ||\r\n                this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc\") ||\r\n                this._gl.getExtension(\"WEBGL_compressed_texture_es3_0\"), // also a requirement of OpenGL ES 3\r\n            textureAnisotropicFilterExtension:\r\n                this._gl.getExtension(\"EXT_texture_filter_anisotropic\") ||\r\n                this._gl.getExtension(\"WEBKIT_EXT_texture_filter_anisotropic\") ||\r\n                this._gl.getExtension(\"MOZ_EXT_texture_filter_anisotropic\"),\r\n            uintIndices: this._webGLVersion > 1 || this._gl.getExtension(\"OES_element_index_uint\") !== null,\r\n            fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_frag_depth\") !== null,\r\n            highPrecisionShaderSupported: false,\r\n            timerQuery: this._gl.getExtension(\"EXT_disjoint_timer_query_webgl2\") || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\r\n            supportOcclusionQuery: this._webGLVersion > 1,\r\n            canUseTimestampForTimerQuery: false,\r\n            drawBuffersExtension: false,\r\n            maxMSAASamples: 1,\r\n            colorBufferFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_float\")),\r\n            textureFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_float\") ? true : false,\r\n            textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_half_float\") ? true : false,\r\n            textureHalfFloatRender: false,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            vertexArrayObject: false,\r\n            instancedArrays: false,\r\n            textureLOD: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_shader_texture_lod\") ? true : false,\r\n            blendMinMax: false,\r\n            multiview: this._gl.getExtension(\"OVR_multiview2\"),\r\n            oculusMultiview: this._gl.getExtension(\"OCULUS_multiview\"),\r\n            depthTextureExtension: false,\r\n            canUseGLInstanceID: this._webGLVersion > 1,\r\n            canUseGLVertexID: this._webGLVersion > 1,\r\n            supportComputeShaders: false,\r\n            supportSRGBBuffers: false,\r\n            supportTransformFeedbacks: this._webGLVersion > 1,\r\n            textureMaxLevel: this._webGLVersion > 1,\r\n        };\r\n\r\n        // Infos\r\n        this._glVersion = this._gl.getParameter(this._gl.VERSION);\r\n\r\n        const rendererInfo: any = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\r\n        if (rendererInfo != null) {\r\n            this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\r\n            this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\r\n        }\r\n\r\n        if (!this._glVendor) {\r\n            this._glVendor = this._gl.getParameter(this._gl.VENDOR) || \"Unknown vendor\";\r\n        }\r\n\r\n        if (!this._glRenderer) {\r\n            this._glRenderer = this._gl.getParameter(this._gl.RENDERER) || \"Unknown renderer\";\r\n        }\r\n\r\n        // Constants\r\n        if (this._gl.HALF_FLOAT_OES !== 0x8d61) {\r\n            this._gl.HALF_FLOAT_OES = 0x8d61; // Half floating-point type (16-bit).\r\n        }\r\n        if (this._gl.RGBA16F !== 0x881a) {\r\n            this._gl.RGBA16F = 0x881a; // RGBA 16-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.RGBA32F !== 0x8814) {\r\n            this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.DEPTH24_STENCIL8 !== 35056) {\r\n            this._gl.DEPTH24_STENCIL8 = 35056;\r\n        }\r\n\r\n        // Extensions\r\n        if (this._caps.timerQuery) {\r\n            if (this._webGLVersion === 1) {\r\n                this._gl.getQuery = (<any>this._caps.timerQuery).getQueryEXT.bind(this._caps.timerQuery);\r\n            }\r\n            this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\r\n        }\r\n\r\n        this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension\r\n            ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT)\r\n            : 0;\r\n        this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension(\"OES_texture_float_linear\") ? true : false;\r\n        this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\r\n        this._caps.textureHalfFloatLinearFiltering =\r\n            this._webGLVersion > 1 || (this._caps.textureHalfFloat && this._gl.getExtension(\"OES_texture_half_float_linear\")) ? true : false;\r\n\r\n        // Compressed formats\r\n        if (this._caps.astc) {\r\n            this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR = this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\r\n        }\r\n        if (this._caps.bptc) {\r\n            this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT = this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\r\n        }\r\n        if (this._caps.s3tc_srgb) {\r\n            this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\r\n            this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\r\n        }\r\n\r\n        // Checks if some of the format renders first to allow the use of webgl inspector.\r\n        if (this._webGLVersion > 1) {\r\n            if (this._gl.HALF_FLOAT_OES !== 0x140b) {\r\n                this._gl.HALF_FLOAT_OES = 0x140b;\r\n            }\r\n        }\r\n        this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer();\r\n        // Draw buffers\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.drawBuffersExtension = true;\r\n            this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n        } else {\r\n            const drawBuffersExtension = this._gl.getExtension(\"WEBGL_draw_buffers\");\r\n\r\n            if (drawBuffersExtension !== null) {\r\n                this._caps.drawBuffersExtension = true;\r\n                this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\r\n                this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\r\n\r\n                for (let i = 0; i < 16; i++) {\r\n                    (<any>this._gl)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = (<any>drawBuffersExtension)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\r\n                }\r\n            }\r\n        }\r\n\r\n        // Depth Texture\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.depthTextureExtension = true;\r\n        } else {\r\n            const depthTextureExtension = this._gl.getExtension(\"WEBGL_depth_texture\");\r\n\r\n            if (depthTextureExtension != null) {\r\n                this._caps.depthTextureExtension = true;\r\n                this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\r\n            }\r\n        }\r\n\r\n        // Vertex array object\r\n        if (this.disableVertexArrayObjects) {\r\n            this._caps.vertexArrayObject = false;\r\n        } else if (this._webGLVersion > 1) {\r\n            this._caps.vertexArrayObject = true;\r\n        } else {\r\n            const vertexArrayObjectExtension = this._gl.getExtension(\"OES_vertex_array_object\");\r\n\r\n            if (vertexArrayObjectExtension != null) {\r\n                this._caps.vertexArrayObject = true;\r\n                this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\r\n            }\r\n        }\r\n\r\n        // Instances count\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.instancedArrays = true;\r\n        } else {\r\n            const instanceExtension = <ANGLE_instanced_arrays>this._gl.getExtension(\"ANGLE_instanced_arrays\");\r\n\r\n            if (instanceExtension != null) {\r\n                this._caps.instancedArrays = true;\r\n                this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\r\n                this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\r\n                this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\r\n            } else {\r\n                this._caps.instancedArrays = false;\r\n            }\r\n        }\r\n\r\n        if (this._gl.getShaderPrecisionFormat) {\r\n            const vertexhighp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\r\n            const fragmenthighp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\r\n\r\n            if (vertexhighp && fragmenthighp) {\r\n                this._caps.highPrecisionShaderSupported = vertexhighp.precision !== 0 && fragmenthighp.precision !== 0;\r\n            }\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.blendMinMax = true;\r\n        } else {\r\n            const blendMinMaxExtension = this._gl.getExtension(\"EXT_blend_minmax\");\r\n            if (blendMinMaxExtension != null) {\r\n                this._caps.blendMinMax = true;\r\n                this._gl.MAX = blendMinMaxExtension.MAX_EXT;\r\n                this._gl.MIN = blendMinMaxExtension.MIN_EXT;\r\n            }\r\n        }\r\n\r\n        // sRGB buffers\r\n        // only run this if not already set to true (in the constructor, for example)\r\n        if (!this._caps.supportSRGBBuffers) {\r\n            if (this._webGLVersion > 1) {\r\n                this._caps.supportSRGBBuffers = true;\r\n            } else {\r\n                const sRGBExtension = this._gl.getExtension(\"EXT_sRGB\");\r\n\r\n                if (sRGBExtension != null) {\r\n                    this._caps.supportSRGBBuffers = true;\r\n                    this._gl.SRGB = sRGBExtension.SRGB_EXT;\r\n                    this._gl.SRGB8 = sRGBExtension.SRGB_ALPHA_EXT;\r\n                    this._gl.SRGB8_ALPHA8 = sRGBExtension.SRGB_ALPHA_EXT;\r\n                }\r\n            }\r\n            // take into account the forced state that was provided in options\r\n            // When the issue in angle/chrome is fixed the flag should be taken into account only when it is explicitly defined\r\n            this._caps.supportSRGBBuffers = this._caps.supportSRGBBuffers && !!(this._creationOptions && this._creationOptions.forceSRGBBufferSupportState);\r\n        }\r\n\r\n        // Depth buffer\r\n        this._depthCullingState.depthTest = true;\r\n        this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n        this._depthCullingState.depthMask = true;\r\n\r\n        // Texture maps\r\n        this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\r\n        for (let slot = 0; slot < this._maxSimultaneousTextures; slot++) {\r\n            this._nextFreeTextureSlots.push(slot);\r\n        }\r\n    }\r\n\r\n    protected _initFeatures(): void {\r\n        this._features = {\r\n            forceBitmapOverHTMLImageElement: false,\r\n            supportRenderAndCopyToLodForFloatTextures: this._webGLVersion !== 1,\r\n            supportDepthStencilTexture: this._webGLVersion !== 1,\r\n            supportShadowSamplers: this._webGLVersion !== 1,\r\n            uniformBufferHardCheckMatrix: false,\r\n            allowTexturePrefiltering: this._webGLVersion !== 1,\r\n            trackUbosInFrame: false,\r\n            checkUbosContentBeforeUpload: false,\r\n            supportCSM: this._webGLVersion !== 1,\r\n            basisNeedsPOT: this._webGLVersion === 1,\r\n            support3DTextures: this._webGLVersion !== 1,\r\n            needTypeSuffixInShaderConstants: this._webGLVersion !== 1,\r\n            supportMSAA: this._webGLVersion !== 1,\r\n            supportSSAO2: this._webGLVersion !== 1,\r\n            supportExtendedTextureFormats: this._webGLVersion !== 1,\r\n            supportSwitchCaseInShader: this._webGLVersion !== 1,\r\n            supportSyncTextureRead: true,\r\n            needsInvertingBitmap: true,\r\n            useUBOBindingCache: true,\r\n            needShaderCodeInlining: false,\r\n            needToAlwaysBindUniformBuffers: false,\r\n            supportRenderPasses: false,\r\n            _collectUbosUpdatedInFrame: false,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Gets version of the current webGL context\r\n     * Keep it for back compat - use version instead\r\n     */\r\n    public get webGLVersion(): number {\r\n        return this._webGLVersion;\r\n    }\r\n\r\n    /**\r\n     * Gets a string identifying the name of the class\r\n     * @returns \"Engine\" string\r\n     */\r\n    public getClassName(): string {\r\n        return \"ThinEngine\";\r\n    }\r\n\r\n    /**\r\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n     */\r\n    public get isStencilEnable(): boolean {\r\n        return this._isStencilEnable;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _prepareWorkingCanvas(): void {\r\n        if (this._workingCanvas) {\r\n            return;\r\n        }\r\n\r\n        this._workingCanvas = this.createCanvas(1, 1);\r\n        const context = this._workingCanvas.getContext(\"2d\");\r\n\r\n        if (context) {\r\n            this._workingContext = context;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset the texture cache to empty state\r\n     */\r\n    public resetTextureCache() {\r\n        for (const key in this._boundTexturesCache) {\r\n            if (!Object.prototype.hasOwnProperty.call(this._boundTexturesCache, key)) {\r\n                continue;\r\n            }\r\n            this._boundTexturesCache[key] = null;\r\n        }\r\n\r\n        this._currentTextureChannel = -1;\r\n    }\r\n\r\n    /**\r\n     * Gets an object containing information about the current engine context\r\n     * @returns an object containing the vendor, the renderer and the version of the current engine context\r\n     */\r\n    public getInfo() {\r\n        return this.getGlInfo();\r\n    }\r\n\r\n    /**\r\n     * Gets an object containing information about the current webGL context\r\n     * @returns an object containing the vendor, the renderer and the version of the current webGL context\r\n     */\r\n    public getGlInfo() {\r\n        return {\r\n            vendor: this._glVendor,\r\n            renderer: this._glRenderer,\r\n            version: this._glVersion,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Defines the hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @param level defines the level to use\r\n     */\r\n    public setHardwareScalingLevel(level: number): void {\r\n        this._hardwareScalingLevel = level;\r\n        this.resize();\r\n    }\r\n\r\n    /**\r\n     * Gets the current hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @returns a number indicating the current hardware scaling level\r\n     */\r\n    public getHardwareScalingLevel(): number {\r\n        return this._hardwareScalingLevel;\r\n    }\r\n\r\n    /**\r\n     * Gets the list of loaded textures\r\n     * @returns an array containing all loaded textures\r\n     */\r\n    public getLoadedTexturesCache(): InternalTexture[] {\r\n        return this._internalTexturesCache;\r\n    }\r\n\r\n    /**\r\n     * Gets the object containing all engine capabilities\r\n     * @returns the EngineCapabilities object\r\n     */\r\n    public getCaps(): EngineCapabilities {\r\n        return this._caps;\r\n    }\r\n\r\n    /**\r\n     * stop executing a render loop function and remove it from the execution array\r\n     * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n     */\r\n    public stopRenderLoop(renderFunction?: () => void): void {\r\n        if (!renderFunction) {\r\n            this._activeRenderLoops = [];\r\n            return;\r\n        }\r\n\r\n        const index = this._activeRenderLoops.indexOf(renderFunction);\r\n\r\n        if (index >= 0) {\r\n            this._activeRenderLoops.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _renderLoop(): void {\r\n        if (!this._contextWasLost) {\r\n            let shouldRender = true;\r\n            if (!this.renderEvenInBackground && this._windowIsBackground) {\r\n                shouldRender = false;\r\n            }\r\n\r\n            if (shouldRender) {\r\n                // Start new frame\r\n                this.beginFrame();\r\n\r\n                for (let index = 0; index < this._activeRenderLoops.length; index++) {\r\n                    const renderFunction = this._activeRenderLoops[index];\r\n\r\n                    renderFunction();\r\n                }\r\n\r\n                // Present\r\n                this.endFrame();\r\n            }\r\n        }\r\n\r\n        if (this._activeRenderLoops.length > 0) {\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        } else {\r\n            this._renderingQueueLaunched = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the HTML canvas attached with the current webGL context\r\n     * @returns a HTML canvas\r\n     */\r\n    public getRenderingCanvas(): Nullable<HTMLCanvasElement> {\r\n        return this._renderingCanvas;\r\n    }\r\n\r\n    /**\r\n     * Gets the audio context specified in engine initialization options\r\n     * @returns an Audio Context\r\n     */\r\n    public getAudioContext(): Nullable<AudioContext> {\r\n        return this._audioContext;\r\n    }\r\n\r\n    /**\r\n     * Gets the audio destination specified in engine initialization options\r\n     * @returns an audio destination node\r\n     */\r\n    public getAudioDestination(): Nullable<AudioDestinationNode | MediaStreamAudioDestinationNode> {\r\n        return this._audioDestination;\r\n    }\r\n\r\n    /**\r\n     * Gets host window\r\n     * @returns the host window object\r\n     */\r\n    public getHostWindow(): Nullable<Window> {\r\n        if (!IsWindowObjectExist()) {\r\n            return null;\r\n        }\r\n\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\r\n            return this._renderingCanvas.ownerDocument.defaultView;\r\n        }\r\n\r\n        return window;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render width\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render width\r\n     */\r\n    public getRenderWidth(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render height\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render height\r\n     */\r\n    public getRenderHeight(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\r\n    }\r\n\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @param bindedRenderFunction\r\n     * @param requester\r\n     * @hidden\r\n     */\r\n    protected _queueNewFrame(bindedRenderFunction: any, requester?: any): number {\r\n        return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\r\n    }\r\n\r\n    /**\r\n     * Register and execute a render loop. The engine can have more than one render function\r\n     * @param renderFunction defines the function to continuously execute\r\n     */\r\n    public runRenderLoop(renderFunction: () => void): void {\r\n        if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\r\n            return;\r\n        }\r\n\r\n        this._activeRenderLoops.push(renderFunction);\r\n\r\n        if (!this._renderingQueueLaunched) {\r\n            this._renderingQueueLaunched = true;\r\n            this._boundRenderFunction = this._renderLoop.bind(this);\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clear the current render buffer or the current render target (if any is set up)\r\n     * @param color defines the color to use\r\n     * @param backBuffer defines if the back buffer must be cleared\r\n     * @param depth defines if the depth buffer must be cleared\r\n     * @param stencil defines if the stencil buffer must be cleared\r\n     */\r\n    public clear(color: Nullable<IColor4Like>, backBuffer: boolean, depth: boolean, stencil: boolean = false): void {\r\n        const useStencilGlobalOnly = this.stencilStateComposer.useStencilGlobalOnly;\r\n        this.stencilStateComposer.useStencilGlobalOnly = true; // make sure the stencil mask is coming from the global stencil and not from a material (effect) which would currently be in effect\r\n\r\n        this.applyStates();\r\n\r\n        this.stencilStateComposer.useStencilGlobalOnly = useStencilGlobalOnly;\r\n\r\n        let mode = 0;\r\n        if (backBuffer && color) {\r\n            this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\r\n            mode |= this._gl.COLOR_BUFFER_BIT;\r\n        }\r\n\r\n        if (depth) {\r\n            if (this.useReverseDepthBuffer) {\r\n                this._depthCullingState.depthFunc = this._gl.GEQUAL;\r\n                this._gl.clearDepth(0.0);\r\n            } else {\r\n                this._gl.clearDepth(1.0);\r\n            }\r\n            mode |= this._gl.DEPTH_BUFFER_BIT;\r\n        }\r\n        if (stencil) {\r\n            this._gl.clearStencil(0);\r\n            mode |= this._gl.STENCIL_BUFFER_BIT;\r\n        }\r\n        this._gl.clear(mode);\r\n    }\r\n\r\n    protected _viewportCached = { x: 0, y: 0, z: 0, w: 0 };\r\n\r\n    /**\r\n     * @param x\r\n     * @param y\r\n     * @param width\r\n     * @param height\r\n     * @hidden\r\n     */\r\n    public _viewport(x: number, y: number, width: number, height: number): void {\r\n        if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\r\n            this._viewportCached.x = x;\r\n            this._viewportCached.y = y;\r\n            this._viewportCached.z = width;\r\n            this._viewportCached.w = height;\r\n\r\n            this._gl.viewport(x, y, width, height);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the WebGL's viewport\r\n     * @param viewport defines the viewport element to be used\r\n     * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n     * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n     */\r\n    public setViewport(viewport: IViewportLike, requiredWidth?: number, requiredHeight?: number): void {\r\n        const width = requiredWidth || this.getRenderWidth();\r\n        const height = requiredHeight || this.getRenderHeight();\r\n        const x = viewport.x || 0;\r\n        const y = viewport.y || 0;\r\n\r\n        this._cachedViewport = viewport;\r\n\r\n        this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\r\n    }\r\n\r\n    /**\r\n     * Begin a new frame\r\n     */\r\n    public beginFrame(): void {}\r\n\r\n    /**\r\n     * Enf the current frame\r\n     */\r\n    public endFrame(): void {\r\n        // Force a flush in case we are using a bad OS.\r\n        if (this._badOS) {\r\n            this.flushFramebuffer();\r\n        }\r\n        this._frameId++;\r\n    }\r\n\r\n    /**\r\n     * Resize the view according to the canvas' size\r\n     * @param forceSetSize true to force setting the sizes of the underlying canvas\r\n     */\r\n    public resize(forceSetSize = false): void {\r\n        let width: number;\r\n        let height: number;\r\n\r\n        // Requery hardware scaling level to handle zoomed-in resizing.\r\n        if (this._adaptToDeviceRatio) {\r\n            const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\r\n            const limitDeviceRatio = this._creationOptions.limitDeviceRatio || devicePixelRatio;\r\n            this._hardwareScalingLevel = this._adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\r\n        }\r\n\r\n        if (IsWindowObjectExist()) {\r\n            width = this._renderingCanvas ? this._renderingCanvas.clientWidth || this._renderingCanvas.width : window.innerWidth;\r\n            height = this._renderingCanvas ? this._renderingCanvas.clientHeight || this._renderingCanvas.height : window.innerHeight;\r\n        } else {\r\n            width = this._renderingCanvas ? this._renderingCanvas.width : 100;\r\n            height = this._renderingCanvas ? this._renderingCanvas.height : 100;\r\n        }\r\n\r\n        this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel, forceSetSize);\r\n    }\r\n\r\n    /**\r\n     * Force a specific size of the canvas\r\n     * @param width defines the new canvas' width\r\n     * @param height defines the new canvas' height\r\n     * @param forceSetSize true to force setting the sizes of the underlying canvas\r\n     * @returns true if the size was changed\r\n     */\r\n    public setSize(width: number, height: number, forceSetSize = false): boolean {\r\n        if (!this._renderingCanvas) {\r\n            return false;\r\n        }\r\n\r\n        width = width | 0;\r\n        height = height | 0;\r\n\r\n        if (!forceSetSize && this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\r\n            return false;\r\n        }\r\n\r\n        this._renderingCanvas.width = width;\r\n        this._renderingCanvas.height = height;\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Binds the frame buffer to the specified texture.\r\n     * @param texture The render target wrapper to render to\r\n     * @param faceIndex The face of the texture to render to in case of cube texture\r\n     * @param requiredWidth The width of the target to render to\r\n     * @param requiredHeight The height of the target to render to\r\n     * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n     * @param lodLevel defines the lod level to bind to the frame buffer\r\n     * @param layer defines the 2d array index to bind to frame buffer to\r\n     */\r\n    public bindFramebuffer(\r\n        texture: RenderTargetWrapper,\r\n        faceIndex: number = 0,\r\n        requiredWidth?: number,\r\n        requiredHeight?: number,\r\n        forceFullscreenViewport?: boolean,\r\n        lodLevel = 0,\r\n        layer = 0\r\n    ): void {\r\n        const webglRTWrapper = texture as WebGLRenderTargetWrapper;\r\n\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        }\r\n        this._currentRenderTarget = texture;\r\n        this._bindUnboundFramebuffer(webglRTWrapper._MSAAFramebuffer ? webglRTWrapper._MSAAFramebuffer : webglRTWrapper._framebuffer);\r\n\r\n        const gl = this._gl;\r\n        if (texture.is2DArray) {\r\n            gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture.texture!._hardwareTexture?.underlyingResource, lodLevel, layer);\r\n        } else if (texture.isCube) {\r\n            gl.framebufferTexture2D(\r\n                gl.FRAMEBUFFER,\r\n                gl.COLOR_ATTACHMENT0,\r\n                gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex,\r\n                texture.texture!._hardwareTexture?.underlyingResource,\r\n                lodLevel\r\n            );\r\n        }\r\n\r\n        const depthStencilTexture = texture._depthStencilTexture;\r\n        if (depthStencilTexture) {\r\n            const attachment = texture._depthStencilTextureWithStencil ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\r\n            if (texture.is2DArray) {\r\n                gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel, layer);\r\n            } else if (texture.isCube) {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel);\r\n            } else {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel);\r\n            }\r\n        }\r\n\r\n        if (this._cachedViewport && !forceFullscreenViewport) {\r\n            this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\r\n        } else {\r\n            if (!requiredWidth) {\r\n                requiredWidth = texture.width;\r\n                if (lodLevel) {\r\n                    requiredWidth = requiredWidth / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n            if (!requiredHeight) {\r\n                requiredHeight = texture.height;\r\n                if (lodLevel) {\r\n                    requiredHeight = requiredHeight / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n\r\n            this._viewport(0, 0, requiredWidth, requiredHeight);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    /**\r\n     * Set various states to the webGL context\r\n     * @param culling defines culling state: true to enable culling, false to disable it\r\n     * @param zOffset defines the value to apply to zOffset (0 by default)\r\n     * @param force defines if states must be applied even if cache is up to date\r\n     * @param reverseSide defines if culling must be reversed (CCW if false, CW if true)\r\n     * @param cullBackFaces true to cull back faces, false to cull front faces (if culling is enabled)\r\n     * @param stencil stencil states to set\r\n     * @param zOffsetUnits defines the value to apply to zOffsetUnits (0 by default)\r\n     */\r\n    public setState(culling: boolean, zOffset: number = 0, force?: boolean, reverseSide = false, cullBackFaces?: boolean, stencil?: IStencilState, zOffsetUnits: number = 0): void {\r\n        // Culling\r\n        if (this._depthCullingState.cull !== culling || force) {\r\n            this._depthCullingState.cull = culling;\r\n        }\r\n\r\n        // Cull face\r\n        const cullFace = this.cullBackFaces ?? cullBackFaces ?? true ? this._gl.BACK : this._gl.FRONT;\r\n        if (this._depthCullingState.cullFace !== cullFace || force) {\r\n            this._depthCullingState.cullFace = cullFace;\r\n        }\r\n\r\n        // Z offset\r\n        this.setZOffset(zOffset);\r\n        this.setZOffsetUnits(zOffsetUnits);\r\n\r\n        // Front face\r\n        const frontFace = reverseSide ? this._gl.CW : this._gl.CCW;\r\n        if (this._depthCullingState.frontFace !== frontFace || force) {\r\n            this._depthCullingState.frontFace = frontFace;\r\n        }\r\n\r\n        this._stencilStateComposer.stencilMaterial = stencil;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Factor to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffset(value: number): void {\r\n        this._depthCullingState.zOffset = this.useReverseDepthBuffer ? -value : value;\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Factor\r\n     * @returns the current zOffset Factor state\r\n     */\r\n    public getZOffset(): number {\r\n        const zOffset = this._depthCullingState.zOffset;\r\n        return this.useReverseDepthBuffer ? -zOffset : zOffset;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Units to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffsetUnits(value: number): void {\r\n        this._depthCullingState.zOffsetUnits = this.useReverseDepthBuffer ? -value : value;\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Units\r\n     * @returns the current zOffset Units state\r\n     */\r\n    public getZOffsetUnits(): number {\r\n        const zOffsetUnits = this._depthCullingState.zOffsetUnits;\r\n        return this.useReverseDepthBuffer ? -zOffsetUnits : zOffsetUnits;\r\n    }\r\n\r\n    /**\r\n     * @param framebuffer\r\n     * @hidden\r\n     */\r\n    public _bindUnboundFramebuffer(framebuffer: Nullable<WebGLFramebuffer>) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _currentFrameBufferIsDefaultFrameBuffer() {\r\n        return this._currentFramebuffer === null;\r\n    }\r\n\r\n    /**\r\n     * Generates the mipmaps for a texture\r\n     * @param texture texture to generate the mipmaps for\r\n     */\r\n    public generateMipmaps(texture: InternalTexture): void {\r\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, texture, true);\r\n        this._gl.generateMipmap(this._gl.TEXTURE_2D);\r\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target texture from the webGL context\r\n     * @param texture defines the render target wrapper to unbind\r\n     * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n     * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n     */\r\n    public unBindFramebuffer(texture: RenderTargetWrapper, disableGenerateMipMaps = false, onBeforeUnbind?: () => void): void {\r\n        const webglRTWrapper = texture as WebGLRenderTargetWrapper;\r\n\r\n        this._currentRenderTarget = null;\r\n\r\n        // If MSAA, we need to bitblt back to main texture\r\n        const gl = this._gl;\r\n        if (webglRTWrapper._MSAAFramebuffer) {\r\n            if (texture.isMulti) {\r\n                // This texture is part of a MRT texture, we need to treat all attachments\r\n                this.unBindMultiColorAttachmentFramebuffer(texture, disableGenerateMipMaps, onBeforeUnbind);\r\n                return;\r\n            }\r\n            gl.bindFramebuffer(gl.READ_FRAMEBUFFER, webglRTWrapper._MSAAFramebuffer);\r\n            gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, webglRTWrapper._framebuffer);\r\n            gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\r\n        }\r\n\r\n        if (texture.texture?.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\r\n            this.generateMipmaps(texture.texture);\r\n        }\r\n\r\n        if (onBeforeUnbind) {\r\n            if (webglRTWrapper._MSAAFramebuffer) {\r\n                // Bind the correct framebuffer\r\n                this._bindUnboundFramebuffer(webglRTWrapper._framebuffer);\r\n            }\r\n            onBeforeUnbind();\r\n        }\r\n\r\n        this._bindUnboundFramebuffer(null);\r\n    }\r\n\r\n    /**\r\n     * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n     */\r\n    public flushFramebuffer(): void {\r\n        this._gl.flush();\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target and bind the default framebuffer\r\n     */\r\n    public restoreDefaultFramebuffer(): void {\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        } else {\r\n            this._bindUnboundFramebuffer(null);\r\n        }\r\n        if (this._cachedViewport) {\r\n            this.setViewport(this._cachedViewport);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    // VBOs\r\n\r\n    /** @hidden */\r\n    protected _resetVertexBufferBinding(): void {\r\n        this.bindArrayBuffer(null);\r\n        this._cachedVertexBuffers = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a vertex buffer\r\n     * @param data the data for the vertex buffer\r\n     * @returns the new WebGL static buffer\r\n     */\r\n    public createVertexBuffer(data: DataArray): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\r\n    }\r\n\r\n    private _createVertexBuffer(data: DataArray, usage: number): DataBuffer {\r\n        const vbo = this._gl.createBuffer();\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create vertex buffer\");\r\n        }\r\n\r\n        const dataBuffer = new WebGLDataBuffer(vbo);\r\n        this.bindArrayBuffer(dataBuffer);\r\n\r\n        if (data instanceof Array) {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), usage);\r\n        } else {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, <ArrayBuffer>data, usage);\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n\r\n        dataBuffer.references = 1;\r\n        return dataBuffer;\r\n    }\r\n\r\n    /**\r\n     * Creates a dynamic vertex buffer\r\n     * @param data the data for the dynamic vertex buffer\r\n     * @returns the new WebGL dynamic buffer\r\n     */\r\n    public createDynamicVertexBuffer(data: DataArray): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\r\n    }\r\n\r\n    protected _resetIndexBufferBinding(): void {\r\n        this.bindIndexBuffer(null);\r\n        this._cachedIndexBuffer = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a new index buffer\r\n     * @param indices defines the content of the index buffer\r\n     * @param updatable defines if the index buffer must be updatable\r\n     * @returns a new webGL buffer\r\n     */\r\n    public createIndexBuffer(indices: IndicesArray, updatable?: boolean): DataBuffer {\r\n        const vbo = this._gl.createBuffer();\r\n        const dataBuffer = new WebGLDataBuffer(vbo!);\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create index buffer\");\r\n        }\r\n\r\n        this.bindIndexBuffer(dataBuffer);\r\n\r\n        const data = this._normalizeIndexData(indices);\r\n        this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\r\n        this._resetIndexBufferBinding();\r\n        dataBuffer.references = 1;\r\n        dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\r\n        return dataBuffer;\r\n    }\r\n\r\n    protected _normalizeIndexData(indices: IndicesArray): Uint16Array | Uint32Array {\r\n        const bytesPerElement = (indices as Exclude<IndicesArray, number[]>).BYTES_PER_ELEMENT;\r\n        if (bytesPerElement === 2) {\r\n            return indices as Uint16Array;\r\n        }\r\n\r\n        // Check 32 bit support\r\n        if (this._caps.uintIndices) {\r\n            if (indices instanceof Uint32Array) {\r\n                return indices;\r\n            } else {\r\n                // number[] or Int32Array, check if 32 bit is necessary\r\n                for (let index = 0; index < indices.length; index++) {\r\n                    if (indices[index] >= 65535) {\r\n                        return new Uint32Array(indices);\r\n                    }\r\n                }\r\n\r\n                return new Uint16Array(indices);\r\n            }\r\n        }\r\n\r\n        // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\r\n        return new Uint16Array(indices);\r\n    }\r\n\r\n    /**\r\n     * Bind a webGL buffer to the webGL context\r\n     * @param buffer defines the buffer to bind\r\n     */\r\n    public bindArrayBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this._bindBuffer(buffer, this._gl.ARRAY_BUFFER);\r\n    }\r\n\r\n    /**\r\n     * Bind a specific block at a given index in a specific shader program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param blockName defines the block name\r\n     * @param index defines the index where to bind the block\r\n     */\r\n    public bindUniformBlock(pipelineContext: IPipelineContext, blockName: string, index: number): void {\r\n        const program = (pipelineContext as WebGLPipelineContext).program!;\r\n\r\n        const uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\r\n\r\n        this._gl.uniformBlockBinding(program, uniformLocation, index);\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    protected bindIndexBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this._bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\r\n    }\r\n\r\n    private _bindBuffer(buffer: Nullable<DataBuffer>, target: number): void {\r\n        if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\r\n            this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\r\n            this._currentBoundBuffer[target] = buffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * update the bound buffer with the given data\r\n     * @param data defines the data to update\r\n     */\r\n    public updateArrayBuffer(data: Float32Array): void {\r\n        this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n    }\r\n\r\n    private _vertexAttribPointer(buffer: DataBuffer, indx: number, size: number, type: number, normalized: boolean, stride: number, offset: number): void {\r\n        const pointer = this._currentBufferPointers[indx];\r\n        if (!pointer) {\r\n            return;\r\n        }\r\n\r\n        let changed = false;\r\n        if (!pointer.active) {\r\n            changed = true;\r\n            pointer.active = true;\r\n            pointer.index = indx;\r\n            pointer.size = size;\r\n            pointer.type = type;\r\n            pointer.normalized = normalized;\r\n            pointer.stride = stride;\r\n            pointer.offset = offset;\r\n            pointer.buffer = buffer;\r\n        } else {\r\n            if (pointer.buffer !== buffer) {\r\n                pointer.buffer = buffer;\r\n                changed = true;\r\n            }\r\n            if (pointer.size !== size) {\r\n                pointer.size = size;\r\n                changed = true;\r\n            }\r\n            if (pointer.type !== type) {\r\n                pointer.type = type;\r\n                changed = true;\r\n            }\r\n            if (pointer.normalized !== normalized) {\r\n                pointer.normalized = normalized;\r\n                changed = true;\r\n            }\r\n            if (pointer.stride !== stride) {\r\n                pointer.stride = stride;\r\n                changed = true;\r\n            }\r\n            if (pointer.offset !== offset) {\r\n                pointer.offset = offset;\r\n                changed = true;\r\n            }\r\n        }\r\n\r\n        if (changed || this._vaoRecordInProgress) {\r\n            this.bindArrayBuffer(buffer);\r\n            this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param indexBuffer\r\n     * @hidden\r\n     */\r\n    public _bindIndexBufferWithCache(indexBuffer: Nullable<DataBuffer>): void {\r\n        if (indexBuffer == null) {\r\n            return;\r\n        }\r\n        if (this._cachedIndexBuffer !== indexBuffer) {\r\n            this._cachedIndexBuffer = indexBuffer;\r\n            this.bindIndexBuffer(indexBuffer);\r\n            this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\r\n        }\r\n    }\r\n\r\n    private _bindVertexBuffersAttributes(\r\n        vertexBuffers: { [key: string]: Nullable<VertexBuffer> },\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): void {\r\n        const attributes = effect.getAttributesNames();\r\n\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n\r\n        this.unbindAllAttributes();\r\n\r\n        for (let index = 0; index < attributes.length; index++) {\r\n            const order = effect.getAttributeLocation(index);\r\n\r\n            if (order >= 0) {\r\n                const ai = attributes[index];\r\n                let vertexBuffer: Nullable<VertexBuffer> = null;\r\n\r\n                if (overrideVertexBuffers) {\r\n                    vertexBuffer = overrideVertexBuffers[ai];\r\n                }\r\n\r\n                if (!vertexBuffer) {\r\n                    vertexBuffer = vertexBuffers[ai];\r\n                }\r\n\r\n                if (!vertexBuffer) {\r\n                    continue;\r\n                }\r\n\r\n                this._gl.enableVertexAttribArray(order);\r\n                if (!this._vaoRecordInProgress) {\r\n                    this._vertexAttribArraysEnabled[order] = true;\r\n                }\r\n\r\n                const buffer = vertexBuffer.getBuffer();\r\n                if (buffer) {\r\n                    this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\r\n\r\n                    if (vertexBuffer.getIsInstanced()) {\r\n                        this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\r\n                        if (!this._vaoRecordInProgress) {\r\n                            this._currentInstanceLocations.push(order);\r\n                            this._currentInstanceBuffers.push(buffer);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Records a vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexBuffers defines the list of vertex buffers to store\r\n     * @param indexBuffer defines the index buffer to store\r\n     * @param effect defines the effect to store\r\n     * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\r\n     * @returns the new vertex array object\r\n     */\r\n    public recordVertexArrayObject(\r\n        vertexBuffers: { [key: string]: VertexBuffer },\r\n        indexBuffer: Nullable<DataBuffer>,\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): WebGLVertexArrayObject {\r\n        const vao = this._gl.createVertexArray();\r\n\r\n        this._vaoRecordInProgress = true;\r\n\r\n        this._gl.bindVertexArray(vao);\r\n\r\n        this._mustWipeVertexAttributes = true;\r\n        this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\r\n\r\n        this.bindIndexBuffer(indexBuffer);\r\n\r\n        this._vaoRecordInProgress = false;\r\n        this._gl.bindVertexArray(null);\r\n\r\n        return vao;\r\n    }\r\n\r\n    /**\r\n     * Bind a specific vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexArrayObject defines the vertex array object to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     */\r\n    public bindVertexArrayObject(vertexArrayObject: WebGLVertexArrayObject, indexBuffer: Nullable<DataBuffer>): void {\r\n        if (this._cachedVertexArrayObject !== vertexArrayObject) {\r\n            this._cachedVertexArrayObject = vertexArrayObject;\r\n\r\n            this._gl.bindVertexArray(vertexArrayObject);\r\n            this._cachedVertexBuffers = null;\r\n            this._cachedIndexBuffer = null;\r\n\r\n            this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\r\n            this._mustWipeVertexAttributes = true;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind webGl buffers directly to the webGL context\r\n     * @param vertexBuffer defines the vertex buffer to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n     * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n     * @param effect defines the effect associated with the vertex buffer\r\n     */\r\n    public bindBuffersDirectly(vertexBuffer: DataBuffer, indexBuffer: DataBuffer, vertexDeclaration: number[], vertexStrideSize: number, effect: Effect): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffer;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            const attributesCount = effect.getAttributesCount();\r\n\r\n            this._unbindVertexArrayObject();\r\n            this.unbindAllAttributes();\r\n\r\n            let offset = 0;\r\n            for (let index = 0; index < attributesCount; index++) {\r\n                if (index < vertexDeclaration.length) {\r\n                    const order = effect.getAttributeLocation(index);\r\n\r\n                    if (order >= 0) {\r\n                        this._gl.enableVertexAttribArray(order);\r\n                        this._vertexAttribArraysEnabled[order] = true;\r\n                        this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\r\n                    }\r\n\r\n                    offset += vertexDeclaration[index] * 4;\r\n                }\r\n            }\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    private _unbindVertexArrayObject(): void {\r\n        if (!this._cachedVertexArrayObject) {\r\n            return;\r\n        }\r\n\r\n        this._cachedVertexArrayObject = null;\r\n        this._gl.bindVertexArray(null);\r\n    }\r\n\r\n    /**\r\n     * Bind a list of vertex buffers to the webGL context\r\n     * @param vertexBuffers defines the list of vertex buffers to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param effect defines the effect associated with the vertex buffers\r\n     * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\r\n     */\r\n    public bindBuffers(\r\n        vertexBuffers: { [key: string]: Nullable<VertexBuffer> },\r\n        indexBuffer: Nullable<DataBuffer>,\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffers;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    /**\r\n     * Unbind all instance attributes\r\n     */\r\n    public unbindInstanceAttributes() {\r\n        let boundBuffer;\r\n        for (let i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\r\n            const instancesBuffer = this._currentInstanceBuffers[i];\r\n            if (boundBuffer != instancesBuffer && instancesBuffer.references) {\r\n                boundBuffer = instancesBuffer;\r\n                this.bindArrayBuffer(instancesBuffer);\r\n            }\r\n            const offsetLocation = this._currentInstanceLocations[i];\r\n            this._gl.vertexAttribDivisor(offsetLocation, 0);\r\n        }\r\n        this._currentInstanceBuffers.length = 0;\r\n        this._currentInstanceLocations.length = 0;\r\n    }\r\n\r\n    /**\r\n     * Release and free the memory of a vertex array object\r\n     * @param vao defines the vertex array object to delete\r\n     */\r\n    public releaseVertexArrayObject(vao: WebGLVertexArrayObject) {\r\n        this._gl.deleteVertexArray(vao);\r\n    }\r\n\r\n    /**\r\n     * @param buffer\r\n     * @hidden\r\n     */\r\n    public _releaseBuffer(buffer: DataBuffer): boolean {\r\n        buffer.references--;\r\n\r\n        if (buffer.references === 0) {\r\n            this._deleteBuffer(buffer);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    protected _deleteBuffer(buffer: DataBuffer): void {\r\n        this._gl.deleteBuffer(buffer.underlyingResource);\r\n    }\r\n\r\n    /**\r\n     * Update the content of a webGL buffer used with instantiation and bind it to the webGL context\r\n     * @param instancesBuffer defines the webGL buffer to update and bind\r\n     * @param data defines the data to store in the buffer\r\n     * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     */\r\n    public updateAndBindInstancesBuffer(instancesBuffer: DataBuffer, data: Float32Array, offsetLocations: number[] | InstancingAttributeInfo[]): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n        if (data) {\r\n            this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n        }\r\n\r\n        if ((<any>offsetLocations[0]).index !== undefined) {\r\n            this.bindInstancesBuffer(instancesBuffer, offsetLocations as any, true);\r\n        } else {\r\n            for (let index = 0; index < 4; index++) {\r\n                const offsetLocation = <number>offsetLocations[index];\r\n\r\n                if (!this._vertexAttribArraysEnabled[offsetLocation]) {\r\n                    this._gl.enableVertexAttribArray(offsetLocation);\r\n                    this._vertexAttribArraysEnabled[offsetLocation] = true;\r\n                }\r\n\r\n                this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\r\n                this._gl.vertexAttribDivisor(offsetLocation, 1);\r\n                this._currentInstanceLocations.push(offsetLocation);\r\n                this._currentInstanceBuffers.push(instancesBuffer);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind the content of a webGL buffer used with instantiation\r\n     * @param instancesBuffer defines the webGL buffer to bind\r\n     * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n     */\r\n    public bindInstancesBuffer(instancesBuffer: DataBuffer, attributesInfo: InstancingAttributeInfo[], computeStride = true): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n\r\n        let stride = 0;\r\n        if (computeStride) {\r\n            for (let i = 0; i < attributesInfo.length; i++) {\r\n                const ai = attributesInfo[i];\r\n                stride += ai.attributeSize * 4;\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < attributesInfo.length; i++) {\r\n            const ai = attributesInfo[i];\r\n            if (ai.index === undefined) {\r\n                ai.index = this._currentEffect!.getAttributeLocationByName(ai.attributeName);\r\n            }\r\n\r\n            if (ai.index < 0) {\r\n                continue;\r\n            }\r\n\r\n            if (!this._vertexAttribArraysEnabled[ai.index]) {\r\n                this._gl.enableVertexAttribArray(ai.index);\r\n                this._vertexAttribArraysEnabled[ai.index] = true;\r\n            }\r\n\r\n            this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\r\n            this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\r\n            this._currentInstanceLocations.push(ai.index);\r\n            this._currentInstanceBuffers.push(instancesBuffer);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the name in parameter\r\n     * @param name defines the name of the attribute to disable\r\n     */\r\n    public disableInstanceAttributeByName(name: string) {\r\n        if (!this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        const attributeLocation = this._currentEffect.getAttributeLocationByName(name);\r\n        this.disableInstanceAttribute(attributeLocation);\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableInstanceAttribute(attributeLocation: number) {\r\n        let shouldClean = false;\r\n        let index: number;\r\n        while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\r\n            this._currentInstanceLocations.splice(index, 1);\r\n            this._currentInstanceBuffers.splice(index, 1);\r\n\r\n            shouldClean = true;\r\n            index = this._currentInstanceLocations.indexOf(attributeLocation);\r\n        }\r\n\r\n        if (shouldClean) {\r\n            this._gl.vertexAttribDivisor(attributeLocation, 0);\r\n            this.disableAttributeByIndex(attributeLocation);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableAttributeByIndex(attributeLocation: number) {\r\n        this._gl.disableVertexAttribArray(attributeLocation);\r\n        this._vertexAttribArraysEnabled[attributeLocation] = false;\r\n        this._currentBufferPointers[attributeLocation].active = false;\r\n    }\r\n\r\n    /**\r\n     * Send a draw order\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public draw(useTriangles: boolean, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        this.drawElementsType(useTriangles ? Constants.MATERIAL_TriangleFillMode : Constants.MATERIAL_WireFrameFillMode, indexStart, indexCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of points\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawPointClouds(verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(Constants.MATERIAL_PointFillMode, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawUnIndexed(useTriangles: boolean, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(useTriangles ? Constants.MATERIAL_TriangleFillMode : Constants.MATERIAL_WireFrameFillMode, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawElementsType(fillMode: number, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        // Render\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        const indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n        const mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        if (instancesCount) {\r\n            this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        } else {\r\n            this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawArraysType(fillMode: number, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        if (instancesCount) {\r\n            this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        } else {\r\n            this._gl.drawArrays(drawMode, verticesStart, verticesCount);\r\n        }\r\n    }\r\n\r\n    private _drawMode(fillMode: number): number {\r\n        switch (fillMode) {\r\n            // Triangle views\r\n            case Constants.MATERIAL_TriangleFillMode:\r\n                return this._gl.TRIANGLES;\r\n            case Constants.MATERIAL_PointFillMode:\r\n                return this._gl.POINTS;\r\n            case Constants.MATERIAL_WireFrameFillMode:\r\n                return this._gl.LINES;\r\n            // Draw modes\r\n            case Constants.MATERIAL_PointListDrawMode:\r\n                return this._gl.POINTS;\r\n            case Constants.MATERIAL_LineListDrawMode:\r\n                return this._gl.LINES;\r\n            case Constants.MATERIAL_LineLoopDrawMode:\r\n                return this._gl.LINE_LOOP;\r\n            case Constants.MATERIAL_LineStripDrawMode:\r\n                return this._gl.LINE_STRIP;\r\n            case Constants.MATERIAL_TriangleStripDrawMode:\r\n                return this._gl.TRIANGLE_STRIP;\r\n            case Constants.MATERIAL_TriangleFanDrawMode:\r\n                return this._gl.TRIANGLE_FAN;\r\n            default:\r\n                return this._gl.TRIANGLES;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    protected _reportDrawCall() {\r\n        // Will be implemented by children\r\n    }\r\n\r\n    // Shaders\r\n\r\n    /**\r\n     * @param effect\r\n     * @hidden\r\n     */\r\n    public _releaseEffect(effect: Effect): void {\r\n        if (this._compiledEffects[effect._key]) {\r\n            delete this._compiledEffects[effect._key];\r\n\r\n            const pipelineContext = effect.getPipelineContext();\r\n            if (pipelineContext) {\r\n                this._deletePipelineContext(pipelineContext);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @hidden\r\n     */\r\n    public _deletePipelineContext(pipelineContext: IPipelineContext): void {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (webGLPipelineContext && webGLPipelineContext.program) {\r\n            webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\r\n\r\n            this._gl.deleteProgram(webGLPipelineContext.program);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getGlobalDefines(defines?: { [key: string]: string }): string | undefined {\r\n        if (defines) {\r\n            if (this.isNDCHalfZRange) {\r\n                defines[\"IS_NDC_HALF_ZRANGE\"] = \"\";\r\n            } else {\r\n                delete defines[\"IS_NDC_HALF_ZRANGE\"];\r\n            }\r\n            if (this.useReverseDepthBuffer) {\r\n                defines[\"USE_REVERSE_DEPTHBUFFER\"] = \"\";\r\n            } else {\r\n                delete defines[\"USE_REVERSE_DEPTHBUFFER\"];\r\n            }\r\n            return;\r\n        } else {\r\n            let s = \"\";\r\n            if (this.isNDCHalfZRange) {\r\n                s += \"#define IS_NDC_HALF_ZRANGE\";\r\n            }\r\n            if (this.useReverseDepthBuffer) {\r\n                if (s) {\r\n                    s += \"\\n\";\r\n                }\r\n                s += \"#define USE_REVERSE_DEPTHBUFFER\";\r\n            }\r\n            return s;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create a new effect (used to store vertex/fragment shaders)\r\n     * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n     * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n     * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n     * @param samplers defines an array of string used to represent textures\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param fallbacks defines the list of potential fallbacks to use if shader compilation fails\r\n     * @param onCompiled defines a function to call when the effect creation is successful\r\n     * @param onError defines a function to call when the effect creation has failed\r\n     * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n     * @param shaderLanguage the language the shader is written in (default: GLSL)\r\n     * @returns the new Effect\r\n     */\r\n    public createEffect(\r\n        baseName: any,\r\n        attributesNamesOrOptions: string[] | IEffectCreationOptions,\r\n        uniformsNamesOrEngine: string[] | ThinEngine,\r\n        samplers?: string[],\r\n        defines?: string,\r\n        fallbacks?: IEffectFallbacks,\r\n        onCompiled?: Nullable<(effect: Effect) => void>,\r\n        onError?: Nullable<(effect: Effect, errors: string) => void>,\r\n        indexParameters?: any,\r\n        shaderLanguage = ShaderLanguage.GLSL\r\n    ): Effect {\r\n        const vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\r\n        const fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\r\n        const globalDefines = this._getGlobalDefines()!;\r\n\r\n        let fullDefines = defines ?? (<IEffectCreationOptions>attributesNamesOrOptions).defines ?? \"\";\r\n\r\n        if (globalDefines) {\r\n            fullDefines += globalDefines;\r\n        }\r\n\r\n        const name = vertex + \"+\" + fragment + \"@\" + fullDefines;\r\n        if (this._compiledEffects[name]) {\r\n            const compiledEffect = <Effect>this._compiledEffects[name];\r\n            if (onCompiled && compiledEffect.isReady()) {\r\n                onCompiled(compiledEffect);\r\n            }\r\n\r\n            return compiledEffect;\r\n        }\r\n        const effect = new Effect(\r\n            baseName,\r\n            attributesNamesOrOptions,\r\n            uniformsNamesOrEngine,\r\n            samplers,\r\n            this,\r\n            defines,\r\n            fallbacks,\r\n            onCompiled,\r\n            onError,\r\n            indexParameters,\r\n            name,\r\n            shaderLanguage\r\n        );\r\n        this._compiledEffects[name] = effect;\r\n\r\n        return effect;\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    protected static _ConcatenateShader(source: string, defines: Nullable<string>, shaderVersion: string = \"\"): string {\r\n        return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\r\n    }\r\n\r\n    private _compileShader(source: string, type: string, defines: Nullable<string>, shaderVersion: string): WebGLShader {\r\n        return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\r\n    }\r\n\r\n    private _compileRawShader(source: string, type: string): WebGLShader {\r\n        const gl = this._gl;\r\n\r\n        const shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\r\n\r\n        if (!shader) {\r\n            let error = gl.NO_ERROR;\r\n            let tempError = gl.NO_ERROR;\r\n            while ((tempError = gl.getError()) !== gl.NO_ERROR) {\r\n                error = tempError;\r\n            }\r\n\r\n            throw new Error(\r\n                `Something went wrong while creating a gl ${type} shader object. gl error=${error}, gl isContextLost=${gl.isContextLost()}, _contextWasLost=${this._contextWasLost}`\r\n            );\r\n        }\r\n\r\n        gl.shaderSource(shader, source);\r\n        gl.compileShader(shader);\r\n\r\n        return shader;\r\n    }\r\n\r\n    /**\r\n     * @param shader\r\n     * @hidden\r\n     */\r\n    public _getShaderSource(shader: WebGLShader): Nullable<string> {\r\n        return this._gl.getShaderSource(shader);\r\n    }\r\n\r\n    /**\r\n     * Directly creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createRawShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        const vertexShader = this._compileRawShader(vertexCode, \"vertex\");\r\n        const fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode  defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        defines: Nullable<string>,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        const shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\r\n        const vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\r\n        const fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Inline functions in shader code that are marked to be inlined\r\n     * @param code code to inline\r\n     * @returns inlined code\r\n     */\r\n    public inlineShaderCode(code: string): string {\r\n        // no inlining needed in the WebGL engine\r\n        return code;\r\n    }\r\n\r\n    /**\r\n     * Creates a new pipeline context\r\n     * @param shaderProcessingContext defines the shader processing context used during the processing if available\r\n     * @returns the new pipeline\r\n     */\r\n    public createPipelineContext(shaderProcessingContext: Nullable<ShaderProcessingContext>): IPipelineContext {\r\n        const pipelineContext = new WebGLPipelineContext();\r\n        pipelineContext.engine = this;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            pipelineContext.isParallelCompiled = true;\r\n        }\r\n\r\n        return pipelineContext;\r\n    }\r\n\r\n    /**\r\n     * Creates a new material context\r\n     * @returns the new context\r\n     */\r\n    public createMaterialContext(): IMaterialContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    /**\r\n     * Creates a new draw context\r\n     * @returns the new context\r\n     */\r\n    public createDrawContext(): IDrawContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    protected _createShaderProgram(\r\n        pipelineContext: WebGLPipelineContext,\r\n        vertexShader: WebGLShader,\r\n        fragmentShader: WebGLShader,\r\n        context: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        const shaderProgram = context.createProgram();\r\n        pipelineContext.program = shaderProgram;\r\n\r\n        if (!shaderProgram) {\r\n            throw new Error(\"Unable to create program\");\r\n        }\r\n\r\n        context.attachShader(shaderProgram, vertexShader);\r\n        context.attachShader(shaderProgram, fragmentShader);\r\n\r\n        context.linkProgram(shaderProgram);\r\n\r\n        pipelineContext.context = context;\r\n        pipelineContext.vertexShader = vertexShader;\r\n        pipelineContext.fragmentShader = fragmentShader;\r\n\r\n        if (!pipelineContext.isParallelCompiled) {\r\n            this._finalizePipelineContext(pipelineContext);\r\n        }\r\n\r\n        return shaderProgram;\r\n    }\r\n\r\n    protected _finalizePipelineContext(pipelineContext: WebGLPipelineContext) {\r\n        const context = pipelineContext.context!;\r\n        const vertexShader = pipelineContext.vertexShader!;\r\n        const fragmentShader = pipelineContext.fragmentShader!;\r\n        const program = pipelineContext.program!;\r\n\r\n        const linked = context.getProgramParameter(program, context.LINK_STATUS);\r\n        if (!linked) {\r\n            // Get more info\r\n            // Vertex\r\n            if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(vertexShader);\r\n                if (log) {\r\n                    pipelineContext.vertexCompilationError = log;\r\n                    throw new Error(\"VERTEX SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            // Fragment\r\n            if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(fragmentShader);\r\n                if (log) {\r\n                    pipelineContext.fragmentCompilationError = log;\r\n                    throw new Error(\"FRAGMENT SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            const error = context.getProgramInfoLog(program);\r\n            if (error) {\r\n                pipelineContext.programLinkError = error;\r\n                throw new Error(error);\r\n            }\r\n        }\r\n\r\n        if (this.validateShaderPrograms) {\r\n            context.validateProgram(program);\r\n            const validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\r\n\r\n            if (!validated) {\r\n                const error = context.getProgramInfoLog(program);\r\n                if (error) {\r\n                    pipelineContext.programValidationError = error;\r\n                    throw new Error(error);\r\n                }\r\n            }\r\n        }\r\n\r\n        context.deleteShader(vertexShader);\r\n        context.deleteShader(fragmentShader);\r\n\r\n        pipelineContext.vertexShader = undefined;\r\n        pipelineContext.fragmentShader = undefined;\r\n\r\n        if (pipelineContext.onCompiled) {\r\n            pipelineContext.onCompiled();\r\n            pipelineContext.onCompiled = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @param vertexSourceCode\r\n     * @param fragmentSourceCode\r\n     * @param createAsRaw\r\n     * @param rawVertexSourceCode\r\n     * @param rawFragmentSourceCode\r\n     * @param rebuildRebind\r\n     * @param defines\r\n     * @param transformFeedbackVaryings\r\n     * @param key\r\n     * @hidden\r\n     */\r\n    public _preparePipelineContext(\r\n        pipelineContext: IPipelineContext,\r\n        vertexSourceCode: string,\r\n        fragmentSourceCode: string,\r\n        createAsRaw: boolean,\r\n        rawVertexSourceCode: string,\r\n        rawFragmentSourceCode: string,\r\n        rebuildRebind: any,\r\n        defines: Nullable<string>,\r\n        transformFeedbackVaryings: Nullable<string[]>,\r\n        key: string\r\n    ) {\r\n        const webGLRenderingState = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (createAsRaw) {\r\n            webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        } else {\r\n            webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n        webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @hidden\r\n     */\r\n    public _isRenderingStateCompiled(pipelineContext: IPipelineContext): boolean {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (this._gl.getProgramParameter(webGLPipelineContext.program!, this._caps.parallelShaderCompile!.COMPLETION_STATUS_KHR)) {\r\n            this._finalizePipelineContext(webGLPipelineContext);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * @param pipelineContext\r\n     * @param action\r\n     * @hidden\r\n     */\r\n    public _executeWhenRenderingStateIsCompiled(pipelineContext: IPipelineContext, action: () => void) {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (!webGLPipelineContext.isParallelCompiled) {\r\n            action();\r\n            return;\r\n        }\r\n\r\n        const oldHandler = webGLPipelineContext.onCompiled;\r\n\r\n        if (oldHandler) {\r\n            webGLPipelineContext.onCompiled = () => {\r\n                oldHandler!();\r\n                action();\r\n            };\r\n        } else {\r\n            webGLPipelineContext.onCompiled = action;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param uniformsNames defines the list of uniform names\r\n     * @returns an array of webGL uniform locations\r\n     */\r\n    public getUniforms(pipelineContext: IPipelineContext, uniformsNames: string[]): Nullable<WebGLUniformLocation>[] {\r\n        const results = new Array<Nullable<WebGLUniformLocation>>();\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (let index = 0; index < uniformsNames.length; index++) {\r\n            results.push(this._gl.getUniformLocation(webGLPipelineContext.program!, uniformsNames[index]));\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Gets the list of active attributes for a given webGL program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param attributesNames defines the list of attribute names to get\r\n     * @returns an array of indices indicating the offset of each attribute\r\n     */\r\n    public getAttributes(pipelineContext: IPipelineContext, attributesNames: string[]): number[] {\r\n        const results = [];\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (let index = 0; index < attributesNames.length; index++) {\r\n            try {\r\n                results.push(this._gl.getAttribLocation(webGLPipelineContext.program!, attributesNames[index]));\r\n            } catch (e) {\r\n                results.push(-1);\r\n            }\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Activates an effect, making it the current one (ie. the one used for rendering)\r\n     * @param effect defines the effect to activate\r\n     */\r\n    public enableEffect(effect: Nullable<Effect | DrawWrapper>): void {\r\n        effect = effect !== null && DrawWrapper.IsWrapper(effect) ? effect.effect : effect; // get only the effect, we don't need a Wrapper in the WebGL engine\r\n\r\n        if (!effect || effect === this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        this._stencilStateComposer.stencilMaterial = undefined;\r\n\r\n        effect = effect as Effect;\r\n\r\n        // Use program\r\n        this.bindSamplers(effect);\r\n\r\n        this._currentEffect = effect;\r\n\r\n        if (effect.onBind) {\r\n            effect.onBind(effect);\r\n        }\r\n        if (effect._onBindObservable) {\r\n            effect._onBindObservable.notifyObservers(effect);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (int)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the int number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1i(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2i(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3i(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4i(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1iv(uniform, array);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray2(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray3(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray4(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        if (array.length < 1) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1fv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray2(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray3(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray4(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of float32 (stored as matrices)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrices defines the array of float32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrices(uniform: Nullable<WebGLUniformLocation>, matrices: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix4fv(uniform, false, matrices);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (3x3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix3x3(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix3fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (2x2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix2x2(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix2fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (float)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the float number to store\r\n     * @returns true if the value was transferred\r\n     */\r\n    public setFloat(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1f(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2f(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3f(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4f(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    // States\r\n\r\n    /**\r\n     * Apply all cached states (depth, culling, stencil and alpha)\r\n     */\r\n    public applyStates() {\r\n        this._depthCullingState.apply(this._gl);\r\n        this._stencilStateComposer.apply(this._gl);\r\n        this._alphaState.apply(this._gl);\r\n\r\n        if (this._colorWriteChanged) {\r\n            this._colorWriteChanged = false;\r\n            const enable = this._colorWrite;\r\n            this._gl.colorMask(enable, enable, enable, enable);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    public setColorWrite(enable: boolean): void {\r\n        if (enable !== this._colorWrite) {\r\n            this._colorWriteChanged = true;\r\n            this._colorWrite = enable;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    public getColorWrite(): boolean {\r\n        return this._colorWrite;\r\n    }\r\n\r\n    /**\r\n     * Gets the depth culling state manager\r\n     */\r\n    public get depthCullingState(): DepthCullingState {\r\n        return this._depthCullingState;\r\n    }\r\n\r\n    /**\r\n     * Gets the alpha state manager\r\n     */\r\n    public get alphaState(): AlphaState {\r\n        return this._alphaState;\r\n    }\r\n\r\n    /**\r\n     * Gets the stencil state manager\r\n     */\r\n    public get stencilState(): StencilState {\r\n        return this._stencilState;\r\n    }\r\n\r\n    /**\r\n     * Gets the stencil state composer\r\n     */\r\n    public get stencilStateComposer(): StencilStateComposer {\r\n        return this._stencilStateComposer;\r\n    }\r\n\r\n    // Textures\r\n\r\n    /**\r\n     * Clears the list of texture accessible through engine.\r\n     * This can help preventing texture load conflict due to name collision.\r\n     */\r\n    public clearInternalTexturesCache() {\r\n        this._internalTexturesCache = [];\r\n    }\r\n\r\n    /**\r\n     * Force the entire cache to be cleared\r\n     * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n     * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n     */\r\n    public wipeCaches(bruteForce?: boolean): void {\r\n        if (this.preventCacheWipeBetweenFrames && !bruteForce) {\r\n            return;\r\n        }\r\n        this._currentEffect = null;\r\n        this._viewportCached.x = 0;\r\n        this._viewportCached.y = 0;\r\n        this._viewportCached.z = 0;\r\n        this._viewportCached.w = 0;\r\n\r\n        // Done before in case we clean the attributes\r\n        this._unbindVertexArrayObject();\r\n\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n            this.resetTextureCache();\r\n\r\n            this._stencilStateComposer.reset();\r\n\r\n            this._depthCullingState.reset();\r\n            this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n\r\n            this._alphaState.reset();\r\n            this._alphaMode = Constants.ALPHA_ADD;\r\n            this._alphaEquation = Constants.ALPHA_DISABLE;\r\n\r\n            this._colorWrite = true;\r\n            this._colorWriteChanged = true;\r\n\r\n            this._unpackFlipYCached = null;\r\n\r\n            this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n            this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\r\n\r\n            this._mustWipeVertexAttributes = true;\r\n            this.unbindAllAttributes();\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n        this.bindIndexBuffer(null);\r\n    }\r\n\r\n    /**\r\n     * @param samplingMode\r\n     * @param generateMipMaps\r\n     * @hidden\r\n     */\r\n    public _getSamplingParameters(samplingMode: number, generateMipMaps: boolean): { min: number; mag: number } {\r\n        const gl = this._gl;\r\n        let magFilter = gl.NEAREST;\r\n        let minFilter = gl.NEAREST;\r\n\r\n        switch (samplingMode) {\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPLINEAR:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPNEAREST:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPNEAREST:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPLINEAR:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPNEAREST:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPLINEAR:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_LINEAR:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n        }\r\n\r\n        return {\r\n            min: minFilter,\r\n            mag: magFilter,\r\n        };\r\n    }\r\n\r\n    /** @hidden */\r\n    protected _createTexture(): WebGLTexture {\r\n        const texture = this._gl.createTexture();\r\n\r\n        if (!texture) {\r\n            throw new Error(\"Unable to create texture\");\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _createHardwareTexture(): HardwareTextureWrapper {\r\n        return new WebGLHardwareTexture(this._createTexture(), this._gl);\r\n    }\r\n\r\n    /**\r\n     * Creates an internal texture without binding it to a framebuffer\r\n     * @hidden\r\n     * @param size defines the size of the texture\r\n     * @param options defines the options used to create the texture\r\n     * @param delayGPUTextureCreation true to delay the texture creation the first time it is really needed. false to create it right away\r\n     * @param source source type of the texture\r\n     * @returns a new internal texture\r\n     */\r\n    public _createInternalTexture(\r\n        size: TextureSize,\r\n        options: boolean | InternalTextureCreationOptions,\r\n        delayGPUTextureCreation = true,\r\n        source = InternalTextureSource.Unknown\r\n    ): InternalTexture {\r\n        const fullOptions: InternalTextureCreationOptions = {};\r\n\r\n        if (options !== undefined && typeof options === \"object\") {\r\n            fullOptions.generateMipMaps = options.generateMipMaps;\r\n            fullOptions.type = options.type === undefined ? Constants.TEXTURETYPE_UNSIGNED_INT : options.type;\r\n            fullOptions.samplingMode = options.samplingMode === undefined ? Constants.TEXTURE_TRILINEAR_SAMPLINGMODE : options.samplingMode;\r\n            fullOptions.format = options.format === undefined ? Constants.TEXTUREFORMAT_RGBA : options.format;\r\n        } else {\r\n            fullOptions.generateMipMaps = <boolean>options;\r\n            fullOptions.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n            fullOptions.samplingMode = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE;\r\n            fullOptions.format = Constants.TEXTUREFORMAT_RGBA;\r\n        }\r\n\r\n        if (fullOptions.type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloatLinearFiltering) {\r\n            // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        } else if (fullOptions.type === Constants.TEXTURETYPE_HALF_FLOAT && !this._caps.textureHalfFloatLinearFiltering) {\r\n            // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        }\r\n        if (fullOptions.type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloat) {\r\n            fullOptions.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n            Logger.Warn(\"Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE\");\r\n        }\r\n\r\n        const gl = this._gl;\r\n        const texture = new InternalTexture(this, source);\r\n        const width = (<{ width: number; height: number; layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number; layers?: number }>size).height || <number>size;\r\n        const layers = (<{ width: number; height: number; layers?: number }>size).layers || 0;\r\n        const filters = this._getSamplingParameters(fullOptions.samplingMode, fullOptions.generateMipMaps ? true : false);\r\n        const target = layers !== 0 ? gl.TEXTURE_2D_ARRAY : gl.TEXTURE_2D;\r\n        const sizedFormat = this._getRGBABufferInternalSizedFormat(fullOptions.type, fullOptions.format);\r\n        const internalFormat = this._getInternalFormat(fullOptions.format);\r\n        const type = this._getWebGLTextureType(fullOptions.type);\r\n\r\n        // Bind\r\n        this._bindTextureDirectly(target, texture);\r\n\r\n        if (layers !== 0) {\r\n            texture.is2DArray = true;\r\n            gl.texImage3D(target, 0, sizedFormat, width, height, layers, 0, internalFormat, type, null);\r\n        } else {\r\n            gl.texImage2D(target, 0, sizedFormat, width, height, 0, internalFormat, type, null);\r\n        }\r\n\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, filters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        // MipMaps\r\n        if (fullOptions.generateMipMaps) {\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = width;\r\n        texture.height = height;\r\n        texture.depth = layers;\r\n        texture.isReady = true;\r\n        texture.samples = 1;\r\n        texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\r\n        texture.samplingMode = fullOptions.samplingMode;\r\n        texture.type = fullOptions.type;\r\n        texture.format = fullOptions.format;\r\n\r\n        this._internalTexturesCache.push(texture);\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * @param useSRGBBuffer\r\n     * @param noMipmap\r\n     * @hidden\r\n     */\r\n    public _getUseSRGBBuffer(useSRGBBuffer: boolean, noMipmap: boolean): boolean {\r\n        // Generating mipmaps for sRGB textures is not supported in WebGL1 so we must disable the support if mipmaps is enabled\r\n        return useSRGBBuffer && this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU || noMipmap);\r\n    }\r\n\r\n    protected _createTextureBase(\r\n        url: Nullable<string>,\r\n        noMipmap: boolean,\r\n        invertY: boolean,\r\n        scene: Nullable<ISceneLike>,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,\r\n        onLoad: Nullable<() => void> = null,\r\n        onError: Nullable<(message: string, exception: any) => void> = null,\r\n        prepareTexture: (\r\n            texture: InternalTexture,\r\n            extension: string,\r\n            scene: Nullable<ISceneLike>,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            invertY: boolean,\r\n            noMipmap: boolean,\r\n            isCompressed: boolean,\r\n            processFunction: (\r\n                width: number,\r\n                height: number,\r\n                img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n                extension: string,\r\n                texture: InternalTexture,\r\n                continuationCallback: () => void\r\n            ) => boolean,\r\n            samplingMode: number\r\n        ) => void,\r\n        prepareTextureProcessFunction: (\r\n            width: number,\r\n            height: number,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            extension: string,\r\n            texture: InternalTexture,\r\n            continuationCallback: () => void\r\n        ) => boolean,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null,\r\n        mimeType?: string,\r\n        loaderOptions?: any,\r\n        useSRGBBuffer?: boolean\r\n    ): InternalTexture {\r\n        url = url || \"\";\r\n        const fromData = url.substr(0, 5) === \"data:\";\r\n        const fromBlob = url.substr(0, 5) === \"blob:\";\r\n        const isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n\r\n        const texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n\r\n        const originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n\r\n        if (originalUrl !== url) {\r\n            texture._originalUrl = originalUrl;\r\n        }\r\n\r\n        // establish the file extension, if possible\r\n        const lastDot = url.lastIndexOf(\".\");\r\n        let extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\r\n        let loader: Nullable<IInternalTextureLoader> = null;\r\n\r\n        // Remove query string\r\n        const queryStringIndex = extension.indexOf(\"?\");\r\n\r\n        if (queryStringIndex > -1) {\r\n            extension = extension.split(\"?\")[0];\r\n        }\r\n\r\n        for (const availableLoader of ThinEngine._TextureLoaders) {\r\n            if (availableLoader.canLoad(extension, mimeType)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (scene) {\r\n            scene._addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        texture._useSRGBBuffer = this._getUseSRGBBuffer(!!useSRGBBuffer, noMipmap);\r\n\r\n        if (!this._doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n\r\n        let onLoadObserver: Nullable<Observer<InternalTexture>> = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n\r\n        if (!fallback) {\r\n            this._internalTexturesCache.push(texture);\r\n        }\r\n\r\n        const onInternalError = (message?: string, exception?: any) => {\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    this._createTextureBase(\r\n                        EngineStore.FallbackTexture,\r\n                        noMipmap,\r\n                        texture.invertY,\r\n                        scene,\r\n                        samplingMode,\r\n                        null,\r\n                        onError,\r\n                        prepareTexture,\r\n                        prepareTextureProcessFunction,\r\n                        buffer,\r\n                        texture\r\n                    );\r\n                }\r\n\r\n                message = (message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\");\r\n                texture.onErrorObservable.notifyObservers({ message, exception });\r\n                if (onError) {\r\n                    onError(message, exception);\r\n                }\r\n            } else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`);\r\n                this._createTextureBase(\r\n                    originalUrl,\r\n                    noMipmap,\r\n                    texture.invertY,\r\n                    scene,\r\n                    samplingMode,\r\n                    onLoad,\r\n                    onError,\r\n                    prepareTexture,\r\n                    prepareTextureProcessFunction,\r\n                    buffer,\r\n                    texture,\r\n                    format,\r\n                    forcedExtension,\r\n                    mimeType,\r\n                    loaderOptions,\r\n                    useSRGBBuffer\r\n                );\r\n            }\r\n        };\r\n\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            const callback = (data: ArrayBufferView) => {\r\n                loader!.loadData(\r\n                    data,\r\n                    texture,\r\n                    (width: number, height: number, loadMipmap: boolean, isCompressed: boolean, done: () => void, loadFailed) => {\r\n                        if (loadFailed) {\r\n                            onInternalError(\"TextureLoader failed to load data\");\r\n                        } else {\r\n                            prepareTexture(\r\n                                texture,\r\n                                extension,\r\n                                scene,\r\n                                { width, height },\r\n                                texture.invertY,\r\n                                !loadMipmap,\r\n                                isCompressed,\r\n                                () => {\r\n                                    done();\r\n                                    return false;\r\n                                },\r\n                                samplingMode\r\n                            );\r\n                        }\r\n                    },\r\n                    loaderOptions\r\n                );\r\n            };\r\n\r\n            if (!buffer) {\r\n                this._loadFile(\r\n                    url,\r\n                    (data) => callback(new Uint8Array(data as ArrayBuffer)),\r\n                    undefined,\r\n                    scene ? scene.offlineProvider : undefined,\r\n                    true,\r\n                    (request?: IWebRequest, exception?: any) => {\r\n                        onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                    }\r\n                );\r\n            } else {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    callback(new Uint8Array(buffer));\r\n                } else if (ArrayBuffer.isView(buffer)) {\r\n                    callback(buffer);\r\n                } else {\r\n                    if (onError) {\r\n                        onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            const onload = (img: HTMLImageElement | ImageBitmap) => {\r\n                if (fromBlob && !this._doNotHandleContextLost) {\r\n                    // We need to store the image if we need to rebuild the texture\r\n                    // in case of a webgl context lost\r\n                    texture._buffer = img;\r\n                }\r\n\r\n                prepareTexture(texture, extension, scene, img, texture.invertY, noMipmap, false, prepareTextureProcessFunction, samplingMode);\r\n            };\r\n            // According to the WebGL spec section 6.10, ImageBitmaps must be inverted on creation.\r\n            // So, we pass imageOrientation to _FileToolsLoadImage() as it may create an ImageBitmap.\r\n\r\n            if (!fromData || isBase64) {\r\n                if (buffer && (typeof (<HTMLImageElement>buffer).decoding === \"string\" || (<ImageBitmap>buffer).close)) {\r\n                    onload(<HTMLImageElement>buffer);\r\n                } else {\r\n                    ThinEngine._FileToolsLoadImage(\r\n                        url,\r\n                        onload,\r\n                        onInternalError,\r\n                        scene ? scene.offlineProvider : null,\r\n                        mimeType,\r\n                        texture.invertY && this._features.needsInvertingBitmap ? { imageOrientation: \"flipY\" } : undefined\r\n                    );\r\n                }\r\n            } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\r\n                ThinEngine._FileToolsLoadImage(\r\n                    buffer,\r\n                    onload,\r\n                    onInternalError,\r\n                    scene ? scene.offlineProvider : null,\r\n                    mimeType,\r\n                    texture.invertY && this._features.needsInvertingBitmap ? { imageOrientation: \"flipY\" } : undefined\r\n                );\r\n            } else if (buffer) {\r\n                onload(buffer);\r\n            }\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @param creationFlags specific flags to use when creating the texture (Constants.TEXTURE_CREATIONFLAG_STORAGE for storage textures, for eg)\r\n     * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    public createTexture(\r\n        url: Nullable<string>,\r\n        noMipmap: boolean,\r\n        invertY: boolean,\r\n        scene: Nullable<ISceneLike>,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,\r\n        onLoad: Nullable<() => void> = null,\r\n        onError: Nullable<(message: string, exception: any) => void> = null,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null,\r\n        mimeType?: string,\r\n        loaderOptions?: any,\r\n        creationFlags?: number,\r\n        useSRGBBuffer?: boolean\r\n    ): InternalTexture {\r\n        return this._createTextureBase(\r\n            url,\r\n            noMipmap,\r\n            invertY,\r\n            scene,\r\n            samplingMode,\r\n            onLoad,\r\n            onError,\r\n            this._prepareWebGLTexture.bind(this),\r\n            (potWidth, potHeight, img, extension, texture, continuationCallback) => {\r\n                const gl = this._gl;\r\n                const isPot = img.width === potWidth && img.height === potHeight;\r\n\r\n                const internalFormat = format\r\n                    ? this._getInternalFormat(format, texture._useSRGBBuffer)\r\n                    : extension === \".jpg\" && !texture._useSRGBBuffer\r\n                    ? gl.RGB\r\n                    : texture._useSRGBBuffer\r\n                    ? gl.SRGB8_ALPHA8\r\n                    : gl.RGBA;\r\n                let texelFormat = format ? this._getInternalFormat(format) : extension === \".jpg\" && !texture._useSRGBBuffer ? gl.RGB : gl.RGBA;\r\n\r\n                if (texture._useSRGBBuffer && this.webGLVersion === 1) {\r\n                    texelFormat = internalFormat;\r\n                }\r\n\r\n                if (isPot) {\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, img as any);\r\n                    return false;\r\n                }\r\n\r\n                const maxTextureSize = this._caps.maxTextureSize;\r\n\r\n                if (img.width > maxTextureSize || img.height > maxTextureSize || !this._supportsHardwareTextureRescaling) {\r\n                    this._prepareWorkingCanvas();\r\n                    if (!this._workingCanvas || !this._workingContext) {\r\n                        return false;\r\n                    }\r\n\r\n                    this._workingCanvas.width = potWidth;\r\n                    this._workingCanvas.height = potHeight;\r\n\r\n                    this._workingContext.drawImage(img as any, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, this._workingCanvas as TexImageSource);\r\n\r\n                    texture.width = potWidth;\r\n                    texture.height = potHeight;\r\n\r\n                    return false;\r\n                } else {\r\n                    // Using shaders when possible to rescale because canvas.drawImage is lossy\r\n                    const source = new InternalTexture(this, InternalTextureSource.Temp);\r\n                    this._bindTextureDirectly(gl.TEXTURE_2D, source, true);\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, texelFormat, gl.UNSIGNED_BYTE, img as any);\r\n\r\n                    this._rescaleTexture(source, texture, scene, internalFormat, () => {\r\n                        this._releaseTexture(source);\r\n                        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n\r\n                        continuationCallback();\r\n                    });\r\n                }\r\n\r\n                return true;\r\n            },\r\n            buffer,\r\n            fallback,\r\n            format,\r\n            forcedExtension,\r\n            mimeType,\r\n            loaderOptions,\r\n            useSRGBBuffer\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Loads an image as an HTMLImageElement.\r\n     * @param input url string, ArrayBuffer, or Blob to load\r\n     * @param onLoad callback called when the image successfully loads\r\n     * @param onError callback called when the image fails to load\r\n     * @param offlineProvider offline provider for caching\r\n     * @param mimeType optional mime type\r\n     * @param imageBitmapOptions optional the options to use when creating an ImageBitmap\r\n     * @returns the HTMLImageElement of the loaded image\r\n     * @hidden\r\n     */\r\n    public static _FileToolsLoadImage(\r\n        input: string | ArrayBuffer | ArrayBufferView | Blob,\r\n        onLoad: (img: HTMLImageElement | ImageBitmap) => void,\r\n        onError: (message?: string, exception?: any) => void,\r\n        offlineProvider: Nullable<IOfflineProvider>,\r\n        mimeType?: string,\r\n        imageBitmapOptions?: ImageBitmapOptions\r\n    ): Nullable<HTMLImageElement> {\r\n        throw _WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * @param source\r\n     * @param destination\r\n     * @param scene\r\n     * @param internalFormat\r\n     * @param onComplete\r\n     * @hidden\r\n     */\r\n    public _rescaleTexture(source: InternalTexture, destination: InternalTexture, scene: Nullable<any>, internalFormat: number, onComplete: () => void): void {}\r\n\r\n    /**\r\n     * Creates a raw texture\r\n     * @param data defines the data to store in the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param format defines the format of the data\r\n     * @param generateMipMaps defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n     * @param compression defines the compression used (null by default)\r\n     * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n     * @returns the raw texture inside an InternalTexture\r\n     */\r\n    public createRawTexture(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        type: number = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw cube texture\r\n     * @param data defines the array of data to use to create each face\r\n     * @param size defines the size of the textures\r\n     * @param format defines the format of the data\r\n     * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n     * @param generateMipMaps  defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compression used (null by default)\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    public createRawCubeTexture(\r\n        data: Nullable<ArrayBufferView[]>,\r\n        size: number,\r\n        format: number,\r\n        type: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 3D texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the depth of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 3D texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture3D(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        depth: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        textureType = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 2D array texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the number of layers of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture2DArray(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        depth: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        textureType = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    private _unpackFlipYCached: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * In case you are sharing the context with other applications, it might\r\n     * be interested to not cache the unpack flip y state to ensure a consistent\r\n     * value would be set.\r\n     */\r\n    public enableUnpackFlipYCached = true;\r\n\r\n    /**\r\n     * @param value\r\n     * @hidden\r\n     */\r\n    public _unpackFlipY(value: boolean): void {\r\n        if (this._unpackFlipYCached !== value) {\r\n            this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\r\n\r\n            if (this.enableUnpackFlipYCached) {\r\n                this._unpackFlipYCached = value;\r\n            }\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getUnpackAlignement(): number {\r\n        return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\r\n    }\r\n\r\n    private _getTextureTarget(texture: InternalTexture): number {\r\n        if (texture.isCube) {\r\n            return this._gl.TEXTURE_CUBE_MAP;\r\n        } else if (texture.is3D) {\r\n            return this._gl.TEXTURE_3D;\r\n        } else if (texture.is2DArray || texture.isMultiview) {\r\n            return this._gl.TEXTURE_2D_ARRAY;\r\n        }\r\n        return this._gl.TEXTURE_2D;\r\n    }\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param samplingMode defines the required sampling mode\r\n     * @param texture defines the texture to update\r\n     * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n     */\r\n    public updateTextureSamplingMode(samplingMode: number, texture: InternalTexture, generateMipMaps: boolean = false): void {\r\n        const target = this._getTextureTarget(texture);\r\n        const filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\r\n\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (generateMipMaps) {\r\n            texture.generateMipMaps = true;\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n\r\n        texture.samplingMode = samplingMode;\r\n    }\r\n\r\n    /**\r\n     * Update the dimensions of a texture\r\n     * @param texture texture to update\r\n     * @param width new width of the texture\r\n     * @param height new height of the texture\r\n     * @param depth new depth of the texture\r\n     */\r\n    public updateTextureDimensions(texture: InternalTexture, width: number, height: number, depth: number = 1): void {}\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param texture defines the texture to update\r\n     * @param wrapU defines the texture wrap mode of the u coordinates\r\n     * @param wrapV defines the texture wrap mode of the v coordinates\r\n     * @param wrapR defines the texture wrap mode of the r coordinates\r\n     */\r\n    public updateTextureWrappingMode(texture: InternalTexture, wrapU: Nullable<number>, wrapV: Nullable<number> = null, wrapR: Nullable<number> = null): void {\r\n        const target = this._getTextureTarget(texture);\r\n\r\n        if (wrapU !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\r\n            texture._cachedWrapU = wrapU;\r\n        }\r\n        if (wrapV !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\r\n            texture._cachedWrapV = wrapV;\r\n        }\r\n        if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\r\n            texture._cachedWrapR = wrapR;\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n    }\r\n\r\n    /**\r\n     * @param internalTexture\r\n     * @param size\r\n     * @param generateStencil\r\n     * @param bilinearFiltering\r\n     * @param comparisonFunction\r\n     * @param samples\r\n     * @hidden\r\n     */\r\n    public _setupDepthStencilTexture(\r\n        internalTexture: InternalTexture,\r\n        size: number | { width: number; height: number; layers?: number },\r\n        generateStencil: boolean,\r\n        bilinearFiltering: boolean,\r\n        comparisonFunction: number,\r\n        samples = 1\r\n    ): void {\r\n        const width = (<{ width: number; height: number; layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number; layers?: number }>size).height || <number>size;\r\n        const layers = (<{ width: number; height: number; layers?: number }>size).layers || 0;\r\n\r\n        internalTexture.baseWidth = width;\r\n        internalTexture.baseHeight = height;\r\n        internalTexture.width = width;\r\n        internalTexture.height = height;\r\n        internalTexture.is2DArray = layers > 0;\r\n        internalTexture.depth = layers;\r\n        internalTexture.isReady = true;\r\n        internalTexture.samples = samples;\r\n        internalTexture.generateMipMaps = false;\r\n        internalTexture.samplingMode = bilinearFiltering ? Constants.TEXTURE_BILINEAR_SAMPLINGMODE : Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        internalTexture.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n        internalTexture._comparisonFunction = comparisonFunction;\r\n\r\n        const gl = this._gl;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        const samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        if (comparisonFunction === 0) {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, Constants.LEQUAL);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\r\n        } else {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param internalFormat\r\n     * @param width\r\n     * @param height\r\n     * @param data\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadCompressedDataToTextureDirectly(\r\n        texture: InternalTexture,\r\n        internalFormat: number,\r\n        width: number,\r\n        height: number,\r\n        data: ArrayBufferView,\r\n        faceIndex: number = 0,\r\n        lod: number = 0\r\n    ) {\r\n        const gl = this._gl;\r\n\r\n        let target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        if (texture._useSRGBBuffer) {\r\n            switch (internalFormat) {\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:\r\n                    internalFormat = gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:\r\n                    internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:\r\n                    if (this._caps.s3tc_srgb) {\r\n                        internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\r\n                    } else {\r\n                        // S3TC sRGB extension not supported\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:\r\n                    if (this._caps.s3tc_srgb) {\r\n                        internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\r\n                    } else {\r\n                        // S3TC sRGB extension not supported\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                default:\r\n                    // We don't support a sRGB format corresponding to internalFormat, so revert to non sRGB format\r\n                    texture._useSRGBBuffer = false;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, <DataView>data);\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param imageData\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @param babylonInternalFormat\r\n     * @param useTextureWidthAndHeight\r\n     * @hidden\r\n     */\r\n    public _uploadDataToTextureDirectly(\r\n        texture: InternalTexture,\r\n        imageData: ArrayBufferView,\r\n        faceIndex: number = 0,\r\n        lod: number = 0,\r\n        babylonInternalFormat?: number,\r\n        useTextureWidthAndHeight = false\r\n    ): void {\r\n        const gl = this._gl;\r\n\r\n        const textureType = this._getWebGLTextureType(texture.type);\r\n        const format = this._getInternalFormat(texture.format);\r\n        const internalFormat =\r\n            babylonInternalFormat === undefined\r\n                ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format, texture._useSRGBBuffer)\r\n                : this._getInternalFormat(babylonInternalFormat, texture._useSRGBBuffer);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        let target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        const lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\r\n        const lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\r\n        const width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\r\n        const height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\r\n\r\n        gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\r\n    }\r\n\r\n    /**\r\n     * Update a portion of an internal texture\r\n     * @param texture defines the texture to update\r\n     * @param imageData defines the data to store into the texture\r\n     * @param xOffset defines the x coordinates of the update rectangle\r\n     * @param yOffset defines the y coordinates of the update rectangle\r\n     * @param width defines the width of the update rectangle\r\n     * @param height defines the height of the update rectangle\r\n     * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n     * @param lod defines the lod level to update (0 by default)\r\n     * @param generateMipMaps defines whether to generate mipmaps or not\r\n     */\r\n    public updateTextureData(\r\n        texture: InternalTexture,\r\n        imageData: ArrayBufferView,\r\n        xOffset: number,\r\n        yOffset: number,\r\n        width: number,\r\n        height: number,\r\n        faceIndex: number = 0,\r\n        lod: number = 0,\r\n        generateMipMaps = false\r\n    ): void {\r\n        const gl = this._gl;\r\n\r\n        const textureType = this._getWebGLTextureType(texture.type);\r\n        const format = this._getInternalFormat(texture.format);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        let target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        this._bindTextureDirectly(target, texture, true);\r\n\r\n        gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\r\n\r\n        if (generateMipMaps) {\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @param imageData\r\n     * @param faceIndex\r\n     * @param lod\r\n     * @hidden\r\n     */\r\n    public _uploadArrayBufferViewToTexture(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0): void {\r\n        const gl = this._gl;\r\n        const bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\r\n\r\n        this._bindTextureDirectly(bindTarget, texture, true);\r\n\r\n        this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\r\n\r\n        this._bindTextureDirectly(bindTarget, null, true);\r\n    }\r\n\r\n    protected _prepareWebGLTextureContinuation(texture: InternalTexture, scene: Nullable<ISceneLike>, noMipmap: boolean, isCompressed: boolean, samplingMode: number): void {\r\n        const gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        const filters = this._getSamplingParameters(samplingMode, !noMipmap);\r\n\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (!noMipmap && !isCompressed) {\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n\r\n        // this.resetTextureCache();\r\n        if (scene) {\r\n            scene._removePendingData(texture);\r\n        }\r\n\r\n        texture.onLoadedObservable.notifyObservers(texture);\r\n        texture.onLoadedObservable.clear();\r\n    }\r\n\r\n    private _prepareWebGLTexture(\r\n        texture: InternalTexture,\r\n        extension: string,\r\n        scene: Nullable<ISceneLike>,\r\n        img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n        invertY: boolean,\r\n        noMipmap: boolean,\r\n        isCompressed: boolean,\r\n        processFunction: (\r\n            width: number,\r\n            height: number,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            extension: string,\r\n            texture: InternalTexture,\r\n            continuationCallback: () => void\r\n        ) => boolean,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE\r\n    ): void {\r\n        const maxTextureSize = this.getCaps().maxTextureSize;\r\n        const potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.width, maxTextureSize) : img.width);\r\n        const potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.height, maxTextureSize) : img.height);\r\n\r\n        const gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        if (!texture._hardwareTexture) {\r\n            //  this.resetTextureCache();\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n        this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\r\n\r\n        texture.baseWidth = img.width;\r\n        texture.baseHeight = img.height;\r\n        texture.width = potWidth;\r\n        texture.height = potHeight;\r\n        texture.isReady = true;\r\n\r\n        if (\r\n            processFunction(potWidth, potHeight, img, extension, texture, () => {\r\n                this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n            })\r\n        ) {\r\n            // Returning as texture needs extra async steps\r\n            return;\r\n        }\r\n\r\n        this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n    }\r\n\r\n    /**\r\n     * @param generateStencilBuffer\r\n     * @param generateDepthBuffer\r\n     * @param width\r\n     * @param height\r\n     * @param samples\r\n     * @hidden\r\n     */\r\n    public _setupFramebufferDepthAttachments(\r\n        generateStencilBuffer: boolean,\r\n        generateDepthBuffer: boolean,\r\n        width: number,\r\n        height: number,\r\n        samples = 1\r\n    ): Nullable<WebGLRenderbuffer> {\r\n        const gl = this._gl;\r\n\r\n        // Create the depth/stencil buffer\r\n        if (generateStencilBuffer && generateDepthBuffer) {\r\n            return this._createRenderBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\r\n        }\r\n        if (generateDepthBuffer) {\r\n            let depthFormat = gl.DEPTH_COMPONENT16;\r\n            if (this._webGLVersion > 1) {\r\n                depthFormat = gl.DEPTH_COMPONENT32F;\r\n            }\r\n\r\n            return this._createRenderBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\r\n        }\r\n        if (generateStencilBuffer) {\r\n            return this._createRenderBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * @param width\r\n     * @param height\r\n     * @param samples\r\n     * @param internalFormat\r\n     * @param msInternalFormat\r\n     * @param attachment\r\n     * @param unbindBuffer\r\n     * @hidden\r\n     */\r\n    public _createRenderBuffer(\r\n        width: number,\r\n        height: number,\r\n        samples: number,\r\n        internalFormat: number,\r\n        msInternalFormat: number,\r\n        attachment: number,\r\n        unbindBuffer = true\r\n    ): Nullable<WebGLRenderbuffer> {\r\n        const gl = this._gl;\r\n        const renderBuffer = gl.createRenderbuffer();\r\n\r\n        gl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\r\n\r\n        if (samples > 1 && gl.renderbufferStorageMultisample) {\r\n            gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\r\n        } else {\r\n            gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\r\n        }\r\n\r\n        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, renderBuffer);\r\n\r\n        if (unbindBuffer) {\r\n            gl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n        }\r\n\r\n        return renderBuffer;\r\n    }\r\n\r\n    /**\r\n     * @param texture\r\n     * @hidden\r\n     */\r\n    public _releaseTexture(texture: InternalTexture): void {\r\n        this._deleteTexture(texture._hardwareTexture?.underlyingResource);\r\n\r\n        // Unbind channels\r\n        this.unbindAllTextures();\r\n\r\n        const index = this._internalTexturesCache.indexOf(texture);\r\n        if (index !== -1) {\r\n            this._internalTexturesCache.splice(index, 1);\r\n        }\r\n\r\n        // Integrated fixed lod samplers.\r\n        if (texture._lodTextureHigh) {\r\n            texture._lodTextureHigh.dispose();\r\n        }\r\n        if (texture._lodTextureMid) {\r\n            texture._lodTextureMid.dispose();\r\n        }\r\n        if (texture._lodTextureLow) {\r\n            texture._lodTextureLow.dispose();\r\n        }\r\n\r\n        // Integrated irradiance map.\r\n        if (texture._irradianceTexture) {\r\n            texture._irradianceTexture.dispose();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param rtWrapper\r\n     * @hidden\r\n     */\r\n    public _releaseRenderTargetWrapper(rtWrapper: RenderTargetWrapper): void {\r\n        const index = this._renderTargetWrapperCache.indexOf(rtWrapper);\r\n        if (index !== -1) {\r\n            this._renderTargetWrapperCache.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    protected _deleteTexture(texture: Nullable<WebGLTexture>): void {\r\n        if (texture) {\r\n            this._gl.deleteTexture(texture);\r\n        }\r\n    }\r\n\r\n    protected _setProgram(program: WebGLProgram): void {\r\n        if (this._currentProgram !== program) {\r\n            this._gl.useProgram(program);\r\n            this._currentProgram = program;\r\n        }\r\n    }\r\n\r\n    protected _boundUniforms: { [key: number]: WebGLUniformLocation } = {};\r\n\r\n    /**\r\n     * Binds an effect to the webGL context\r\n     * @param effect defines the effect to bind\r\n     */\r\n    public bindSamplers(effect: Effect): void {\r\n        const webGLPipelineContext = effect.getPipelineContext() as WebGLPipelineContext;\r\n        this._setProgram(webGLPipelineContext.program!);\r\n        const samplers = effect.getSamplers();\r\n        for (let index = 0; index < samplers.length; index++) {\r\n            const uniform = effect.getUniform(samplers[index]);\r\n\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    }\r\n\r\n    private _activateCurrentTexture() {\r\n        if (this._currentTextureChannel !== this._activeChannel) {\r\n            this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\r\n            this._currentTextureChannel = this._activeChannel;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param target\r\n     * @param texture\r\n     * @param forTextureDataUpdate\r\n     * @param force\r\n     * @hidden\r\n     */\r\n    public _bindTextureDirectly(target: number, texture: Nullable<InternalTexture>, forTextureDataUpdate = false, force = false): boolean {\r\n        let wasPreviouslyBound = false;\r\n        const isTextureForRendering = texture && texture._associatedChannel > -1;\r\n        if (forTextureDataUpdate && isTextureForRendering) {\r\n            this._activeChannel = texture!._associatedChannel;\r\n        }\r\n\r\n        const currentTextureBound = this._boundTexturesCache[this._activeChannel];\r\n\r\n        if (currentTextureBound !== texture || force) {\r\n            this._activateCurrentTexture();\r\n\r\n            if (texture && texture.isMultiview) {\r\n                //this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\r\n                console.error(target, texture);\r\n                throw \"_bindTextureDirectly called with a multiview texture!\";\r\n            } else {\r\n                this._gl.bindTexture(target, texture?._hardwareTexture?.underlyingResource ?? null);\r\n            }\r\n\r\n            this._boundTexturesCache[this._activeChannel] = texture;\r\n\r\n            if (texture) {\r\n                texture._associatedChannel = this._activeChannel;\r\n            }\r\n        } else if (forTextureDataUpdate) {\r\n            wasPreviouslyBound = true;\r\n            this._activateCurrentTexture();\r\n        }\r\n\r\n        if (isTextureForRendering && !forTextureDataUpdate) {\r\n            this._bindSamplerUniformToChannel(texture!._associatedChannel, this._activeChannel);\r\n        }\r\n\r\n        return wasPreviouslyBound;\r\n    }\r\n\r\n    /**\r\n     * @param channel\r\n     * @param texture\r\n     * @param name\r\n     * @hidden\r\n     */\r\n    public _bindTexture(channel: number, texture: Nullable<InternalTexture>, name: string): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (texture) {\r\n            texture._associatedChannel = channel;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\r\n        this._bindTextureDirectly(target, texture);\r\n    }\r\n\r\n    /**\r\n     * Unbind all textures from the webGL context\r\n     */\r\n    public unbindAllTextures(): void {\r\n        for (let channel = 0; channel < this._maxSimultaneousTextures; channel++) {\r\n            this._activeChannel = channel;\r\n            this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n            this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n            if (this.webGLVersion > 1) {\r\n                this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a texture to the according uniform.\r\n     * @param channel The texture channel\r\n     * @param uniform The uniform to set\r\n     * @param texture The texture to apply\r\n     * @param name The name of the uniform in the effect\r\n     */\r\n    public setTexture(channel: number, uniform: Nullable<WebGLUniformLocation>, texture: Nullable<ThinTexture>, name: string): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (uniform) {\r\n            this._boundUniforms[channel] = uniform;\r\n        }\r\n\r\n        this._setTexture(channel, texture);\r\n    }\r\n\r\n    private _bindSamplerUniformToChannel(sourceSlot: number, destination: number) {\r\n        const uniform = this._boundUniforms[sourceSlot];\r\n        if (!uniform || uniform._currentState === destination) {\r\n            return;\r\n        }\r\n        this._gl.uniform1i(uniform, destination);\r\n        uniform._currentState = destination;\r\n    }\r\n\r\n    private _getTextureWrapMode(mode: number): number {\r\n        switch (mode) {\r\n            case Constants.TEXTURE_WRAP_ADDRESSMODE:\r\n                return this._gl.REPEAT;\r\n            case Constants.TEXTURE_CLAMP_ADDRESSMODE:\r\n                return this._gl.CLAMP_TO_EDGE;\r\n            case Constants.TEXTURE_MIRROR_ADDRESSMODE:\r\n                return this._gl.MIRRORED_REPEAT;\r\n        }\r\n        return this._gl.REPEAT;\r\n    }\r\n\r\n    protected _setTexture(channel: number, texture: Nullable<ThinTexture>, isPartOfTextureArray = false, depthStencilTexture = false, name = \"\"): boolean {\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n                if (this.webGLVersion > 1) {\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n                }\r\n            }\r\n            return false;\r\n        }\r\n\r\n        // Video\r\n        if ((<VideoTexture>texture).video) {\r\n            this._activeChannel = channel;\r\n            (<VideoTexture>texture).update();\r\n        } else if (texture.delayLoadState === Constants.DELAYLOADSTATE_NOTLOADED) {\r\n            // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n\r\n        let internalTexture: InternalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = (<RenderTargetTexture>texture).depthStencilTexture!;\r\n        } else if (texture.isReady()) {\r\n            internalTexture = <InternalTexture>texture.getInternalTexture();\r\n        } else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        } else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        } else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        } else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n\r\n        if (!isPartOfTextureArray && internalTexture) {\r\n            internalTexture._associatedChannel = channel;\r\n        }\r\n\r\n        let needToBind = true;\r\n        if (this._boundTexturesCache[channel] === internalTexture) {\r\n            if (!isPartOfTextureArray) {\r\n                this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\r\n            }\r\n\r\n            needToBind = false;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        if (needToBind) {\r\n            this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\r\n        }\r\n\r\n        if (internalTexture && !internalTexture.isMultiview) {\r\n            // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\r\n            if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\r\n                internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\r\n\r\n                const textureWrapMode =\r\n                    texture.coordinatesMode !== Constants.TEXTURE_CUBIC_MODE && texture.coordinatesMode !== Constants.TEXTURE_SKYBOX_MODE\r\n                        ? Constants.TEXTURE_WRAP_ADDRESSMODE\r\n                        : Constants.TEXTURE_CLAMP_ADDRESSMODE;\r\n                texture.wrapU = textureWrapMode;\r\n                texture.wrapV = textureWrapMode;\r\n            }\r\n\r\n            if (internalTexture._cachedWrapU !== texture.wrapU) {\r\n                internalTexture._cachedWrapU = texture.wrapU;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\r\n            }\r\n\r\n            if (internalTexture._cachedWrapV !== texture.wrapV) {\r\n                internalTexture._cachedWrapV = texture.wrapV;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\r\n            }\r\n\r\n            if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\r\n                internalTexture._cachedWrapR = texture.wrapR;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\r\n            }\r\n\r\n            this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Sets an array of texture to the webGL context\r\n     * @param channel defines the channel where the texture array must be set\r\n     * @param uniform defines the associated uniform location\r\n     * @param textures defines the array of textures to bind\r\n     * @param name name of the channel\r\n     */\r\n    public setTextureArray(channel: number, uniform: Nullable<WebGLUniformLocation>, textures: ThinTexture[], name: string): void {\r\n        if (channel === undefined || !uniform) {\r\n            return;\r\n        }\r\n\r\n        if (!this._textureUnits || this._textureUnits.length !== textures.length) {\r\n            this._textureUnits = new Int32Array(textures.length);\r\n        }\r\n        for (let i = 0; i < textures.length; i++) {\r\n            const texture = textures[i].getInternalTexture();\r\n\r\n            if (texture) {\r\n                this._textureUnits[i] = channel + i;\r\n                texture._associatedChannel = channel + i;\r\n            } else {\r\n                this._textureUnits[i] = -1;\r\n            }\r\n        }\r\n        this._gl.uniform1iv(uniform, this._textureUnits);\r\n\r\n        for (let index = 0; index < textures.length; index++) {\r\n            this._setTexture(this._textureUnits[index], textures[index], true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param target\r\n     * @param internalTexture\r\n     * @param anisotropicFilteringLevel\r\n     * @hidden\r\n     */\r\n    public _setAnisotropicLevel(target: number, internalTexture: InternalTexture, anisotropicFilteringLevel: number) {\r\n        const anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\r\n        if (\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST &&\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR &&\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR\r\n        ) {\r\n            anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\r\n        }\r\n\r\n        if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\r\n            this._setTextureParameterFloat(\r\n                target,\r\n                anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT,\r\n                Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy),\r\n                internalTexture\r\n            );\r\n            internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\r\n        }\r\n    }\r\n\r\n    private _setTextureParameterFloat(target: number, parameter: number, value: number, texture: InternalTexture): void {\r\n        this._bindTextureDirectly(target, texture, true, true);\r\n        this._gl.texParameterf(target, parameter, value);\r\n    }\r\n\r\n    private _setTextureParameterInteger(target: number, parameter: number, value: number, texture?: InternalTexture) {\r\n        if (texture) {\r\n            this._bindTextureDirectly(target, texture, true, true);\r\n        }\r\n        this._gl.texParameteri(target, parameter, value);\r\n    }\r\n\r\n    /**\r\n     * Unbind all vertex attributes from the webGL context\r\n     */\r\n    public unbindAllAttributes() {\r\n        if (this._mustWipeVertexAttributes) {\r\n            this._mustWipeVertexAttributes = false;\r\n\r\n            for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n                this.disableAttributeByIndex(i);\r\n            }\r\n            return;\r\n        }\r\n\r\n        for (let i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\r\n            if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\r\n                continue;\r\n            }\r\n\r\n            this.disableAttributeByIndex(i);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n     */\r\n    public releaseEffects() {\r\n        for (const name in this._compiledEffects) {\r\n            const webGLPipelineContext = this._compiledEffects[name].getPipelineContext() as WebGLPipelineContext;\r\n            this._deletePipelineContext(webGLPipelineContext);\r\n        }\r\n\r\n        this._compiledEffects = {};\r\n    }\r\n\r\n    /**\r\n     * Dispose and release all associated resources\r\n     */\r\n    public dispose(): void {\r\n        this.stopRenderLoop();\r\n\r\n        // Clear observables\r\n        if (this.onBeforeTextureInitObservable) {\r\n            this.onBeforeTextureInitObservable.clear();\r\n        }\r\n\r\n        // Empty texture\r\n        if (this._emptyTexture) {\r\n            this._releaseTexture(this._emptyTexture);\r\n            this._emptyTexture = null;\r\n        }\r\n        if (this._emptyCubeTexture) {\r\n            this._releaseTexture(this._emptyCubeTexture);\r\n            this._emptyCubeTexture = null;\r\n        }\r\n\r\n        if (this._dummyFramebuffer) {\r\n            this._gl.deleteFramebuffer(this._dummyFramebuffer);\r\n        }\r\n\r\n        // Release effects\r\n        this.releaseEffects();\r\n        this.releaseComputeEffects?.();\r\n\r\n        // Unbind\r\n        this.unbindAllAttributes();\r\n        this._boundUniforms = [];\r\n\r\n        // Events\r\n        if (IsWindowObjectExist()) {\r\n            if (this._renderingCanvas) {\r\n                if (!this._doNotHandleContextLost) {\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\r\n                }\r\n\r\n                window.removeEventListener(\"resize\", this._checkForMobile);\r\n            }\r\n        }\r\n\r\n        this._workingCanvas = null;\r\n        this._workingContext = null;\r\n        this._currentBufferPointers = [];\r\n        this._renderingCanvas = null;\r\n        this._currentProgram = null;\r\n        this._boundRenderFunction = null;\r\n\r\n        Effect.ResetCache();\r\n\r\n        // Abort active requests\r\n        for (const request of this._activeRequests) {\r\n            request.abort();\r\n        }\r\n\r\n        this.onDisposeObservable.notifyObservers(this);\r\n        this.onDisposeObservable.clear();\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context lost event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextLostEvent(callback: (event: WebGLContextEvent) => void): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextlost\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context restored event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextRestoredEvent(callback: (event: WebGLContextEvent) => void): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextrestored\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the current error code of the webGL context\r\n     * @returns the error code\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n     */\r\n    public getError(): number {\r\n        return this._gl.getError();\r\n    }\r\n\r\n    private _canRenderToFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(Constants.TEXTURETYPE_FLOAT);\r\n    }\r\n\r\n    private _canRenderToHalfFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(Constants.TEXTURETYPE_HALF_FLOAT);\r\n    }\r\n\r\n    // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\r\n    private _canRenderToFramebuffer(type: number): boolean {\r\n        const gl = this._gl;\r\n\r\n        //clear existing errors\r\n        // eslint-disable-next-line no-empty\r\n        while (gl.getError() !== gl.NO_ERROR) {}\r\n\r\n        let successful = true;\r\n\r\n        const texture = gl.createTexture();\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n\r\n        const fb = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\r\n        const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n\r\n        successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\r\n        successful = successful && gl.getError() === gl.NO_ERROR;\r\n\r\n        //try render by clearing frame buffer's color buffer\r\n        if (successful) {\r\n            gl.clear(gl.COLOR_BUFFER_BIT);\r\n            successful = successful && gl.getError() === gl.NO_ERROR;\r\n        }\r\n\r\n        //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\r\n        if (successful) {\r\n            //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            const readFormat = gl.RGBA;\r\n            const readType = gl.UNSIGNED_BYTE;\r\n            const buffer = new Uint8Array(4);\r\n            gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\r\n            successful = successful && gl.getError() === gl.NO_ERROR;\r\n        }\r\n\r\n        //clean up\r\n        gl.deleteTexture(texture);\r\n        gl.deleteFramebuffer(fb);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n        //clear accumulated errors\r\n        // eslint-disable-next-line no-empty\r\n        while (!successful && gl.getError() !== gl.NO_ERROR) {}\r\n\r\n        return successful;\r\n    }\r\n\r\n    /**\r\n     * @param type\r\n     * @hidden\r\n     */\r\n    public _getWebGLTextureType(type: number): number {\r\n        if (this._webGLVersion === 1) {\r\n            switch (type) {\r\n                case Constants.TEXTURETYPE_FLOAT:\r\n                    return this._gl.FLOAT;\r\n                case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                    return this._gl.HALF_FLOAT_OES;\r\n                case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                    return this._gl.UNSIGNED_BYTE;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                    return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                    return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                    return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            }\r\n            return this._gl.UNSIGNED_BYTE;\r\n        }\r\n\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_BYTE:\r\n                return this._gl.BYTE;\r\n            case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                return this._gl.UNSIGNED_BYTE;\r\n            case Constants.TEXTURETYPE_SHORT:\r\n                return this._gl.SHORT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT:\r\n                return this._gl.UNSIGNED_SHORT;\r\n            case Constants.TEXTURETYPE_INT:\r\n                return this._gl.INT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INTEGER: // Refers to UNSIGNED_INT\r\n                return this._gl.UNSIGNED_INT;\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                return this._gl.FLOAT;\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                return this._gl.HALF_FLOAT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:\r\n                return this._gl.UNSIGNED_INT_2_10_10_10_REV;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_24_8:\r\n                return this._gl.UNSIGNED_INT_24_8;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:\r\n                return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:\r\n                return this._gl.UNSIGNED_INT_5_9_9_9_REV;\r\n            case Constants.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV:\r\n                return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\r\n        }\r\n\r\n        return this._gl.UNSIGNED_BYTE;\r\n    }\r\n\r\n    /**\r\n     * @param format\r\n     * @param useSRGBBuffer\r\n     * @hidden\r\n     */\r\n    public _getInternalFormat(format: number, useSRGBBuffer = false): number {\r\n        let internalFormat = useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA;\r\n\r\n        switch (format) {\r\n            case Constants.TEXTUREFORMAT_ALPHA:\r\n                internalFormat = this._gl.ALPHA;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                internalFormat = this._gl.LUMINANCE;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                internalFormat = this._gl.LUMINANCE_ALPHA;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RED:\r\n                internalFormat = this._gl.RED;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RG:\r\n                internalFormat = this._gl.RG;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RGB:\r\n                internalFormat = useSRGBBuffer ? this._gl.SRGB : this._gl.RGB;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RGBA:\r\n                internalFormat = useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA;\r\n                break;\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            switch (format) {\r\n                case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                    internalFormat = this._gl.RED_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                    internalFormat = this._gl.RG_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                    internalFormat = this._gl.RGB_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                    internalFormat = this._gl.RGBA_INTEGER;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        return internalFormat;\r\n    }\r\n\r\n    /**\r\n     * @param type\r\n     * @param format\r\n     * @param useSRGBBuffer\r\n     * @hidden\r\n     */\r\n    public _getRGBABufferInternalSizedFormat(type: number, format?: number, useSRGBBuffer = false): number {\r\n        if (this._webGLVersion === 1) {\r\n            if (format !== undefined) {\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_ALPHA:\r\n                        return this._gl.ALPHA;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                        return this._gl.LUMINANCE;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return useSRGBBuffer ? this._gl.SRGB : this._gl.RGB;\r\n                }\r\n            }\r\n            return this._gl.RGBA;\r\n        }\r\n\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R8I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG8I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB8I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA8I;\r\n                    default:\r\n                        return this._gl.RGBA8_SNORM;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R8;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG8;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return useSRGBBuffer ? this._gl.SRGB8 : this._gl.RGB8; // By default. Other possibilities are RGB565, SRGB8.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA8; // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R8UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG8UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB8UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA8UI;\r\n                    case Constants.TEXTUREFORMAT_ALPHA:\r\n                        return this._gl.ALPHA;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                        return this._gl.LUMINANCE;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    default:\r\n                        return this._gl.RGBA8;\r\n                }\r\n            case Constants.TEXTURETYPE_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R16I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG16I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB16I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA16I;\r\n                    default:\r\n                        return this._gl.RGBA16I;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R16UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG16UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB16UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA16UI;\r\n                    default:\r\n                        return this._gl.RGBA16UI;\r\n                }\r\n            case Constants.TEXTURETYPE_INT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R32I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG32I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB32I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA32I;\r\n                    default:\r\n                        return this._gl.RGBA32I;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_INTEGER: // Refers to UNSIGNED_INT\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R32UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG32UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB32UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA32UI;\r\n                    default:\r\n                        return this._gl.RGBA32UI;\r\n                }\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R32F; // By default. Other possibility is R16F.\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG32F; // By default. Other possibility is RG16F.\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB32F; // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGBA32F; // By default. Other possibility is RGBA16F.\r\n                    default:\r\n                        return this._gl.RGBA32F;\r\n                }\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R16F;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG16F;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB16F; // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGBA16F;\r\n                    default:\r\n                        return this._gl.RGBA16F;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                return this._gl.RGB565;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:\r\n                return this._gl.R11F_G11F_B10F;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:\r\n                return this._gl.RGB9_E5;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                return this._gl.RGBA4;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                return this._gl.RGB5_A1;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGB10_A2; // By default. Other possibility is RGB5_A1.\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGB10_A2UI;\r\n                    default:\r\n                        return this._gl.RGB10_A2;\r\n                }\r\n        }\r\n\r\n        return useSRGBBuffer ? this._gl.SRGB8_ALPHA8 : this._gl.RGBA8;\r\n    }\r\n\r\n    /**\r\n     * @param type\r\n     * @hidden\r\n     */\r\n    public _getRGBAMultiSampleBufferFormat(type: number): number {\r\n        if (type === Constants.TEXTURETYPE_FLOAT) {\r\n            return this._gl.RGBA32F;\r\n        } else if (type === Constants.TEXTURETYPE_HALF_FLOAT) {\r\n            return this._gl.RGBA16F;\r\n        }\r\n\r\n        return this._gl.RGBA8;\r\n    }\r\n\r\n    /**\r\n     * @param url\r\n     * @param onSuccess\r\n     * @param onProgress\r\n     * @param offlineProvider\r\n     * @param useArrayBuffer\r\n     * @param onError\r\n     * @hidden\r\n     */\r\n    public _loadFile(\r\n        url: string,\r\n        onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void,\r\n        onProgress?: (data: any) => void,\r\n        offlineProvider?: IOfflineProvider,\r\n        useArrayBuffer?: boolean,\r\n        onError?: (request?: IWebRequest, exception?: any) => void\r\n    ): IFileRequest {\r\n        const request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\r\n        this._activeRequests.push(request);\r\n        request.onCompleteObservable.add((request) => {\r\n            this._activeRequests.splice(this._activeRequests.indexOf(request), 1);\r\n        });\r\n        return request;\r\n    }\r\n\r\n    /**\r\n     * Loads a file from a url\r\n     * @param url url to load\r\n     * @param onSuccess callback called when the file successfully loads\r\n     * @param onProgress callback called while file is loading (if the server supports this mode)\r\n     * @param offlineProvider defines the offline provider for caching\r\n     * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n     * @param onError callback called when the file fails to load\r\n     * @returns a file request object\r\n     * @hidden\r\n     */\r\n    public static _FileToolsLoadFile(\r\n        url: string,\r\n        onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void,\r\n        onProgress?: (ev: ProgressEvent) => void,\r\n        offlineProvider?: IOfflineProvider,\r\n        useArrayBuffer?: boolean,\r\n        onError?: (request?: WebRequest, exception?: LoadFileError) => void\r\n    ): IFileRequest {\r\n        throw _WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n     * @param x defines the x coordinate of the rectangle where pixels must be read\r\n     * @param y defines the y coordinate of the rectangle where pixels must be read\r\n     * @param width defines the width of the rectangle where pixels must be read\r\n     * @param height defines the height of the rectangle where pixels must be read\r\n     * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n     * @param flushRenderer true to flush the renderer from the pending commands before reading the pixels\r\n     * @returns a ArrayBufferView promise (Uint8Array) containing RGBA colors\r\n     */\r\n    public readPixels(x: number, y: number, width: number, height: number, hasAlpha = true, flushRenderer = true): Promise<ArrayBufferView> {\r\n        const numChannels = hasAlpha ? 4 : 3;\r\n        const format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\r\n        const data = new Uint8Array(height * width * numChannels);\r\n        if (flushRenderer) {\r\n            this.flushFramebuffer();\r\n        }\r\n        this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\r\n        return Promise.resolve(data);\r\n    }\r\n\r\n    // Statics\r\n\r\n    private static _IsSupported: Nullable<boolean> = null;\r\n    private static _HasMajorPerformanceCaveat: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * Gets a Promise<boolean> indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     */\r\n    public static get IsSupportedAsync(): Promise<boolean> {\r\n        return Promise.resolve(this.isSupported());\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     */\r\n    public static get IsSupported(): boolean {\r\n        return this.isSupported(); // Backward compat\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     * @returns true if the engine can be created\r\n     * @ignorenaming\r\n     */\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    public static isSupported(): boolean {\r\n        if (this._HasMajorPerformanceCaveat !== null) {\r\n            return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\r\n        }\r\n\r\n        if (this._IsSupported === null) {\r\n            try {\r\n                const tempcanvas = this._CreateCanvas(1, 1);\r\n                const gl = tempcanvas.getContext(\"webgl\") || (tempcanvas as any).getContext(\"experimental-webgl\");\r\n\r\n                this._IsSupported = gl != null && !!window.WebGLRenderingContext;\r\n            } catch (e) {\r\n                this._IsSupported = false;\r\n            }\r\n        }\r\n\r\n        return this._IsSupported;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n     */\r\n    public static get HasMajorPerformanceCaveat(): boolean {\r\n        if (this._HasMajorPerformanceCaveat === null) {\r\n            try {\r\n                const tempcanvas = this._CreateCanvas(1, 1);\r\n                const gl =\r\n                    tempcanvas.getContext(\"webgl\", { failIfMajorPerformanceCaveat: true }) ||\r\n                    (tempcanvas as any).getContext(\"experimental-webgl\", { failIfMajorPerformanceCaveat: true });\r\n\r\n                this._HasMajorPerformanceCaveat = !gl;\r\n            } catch (e) {\r\n                this._HasMajorPerformanceCaveat = false;\r\n            }\r\n        }\r\n\r\n        return this._HasMajorPerformanceCaveat;\r\n    }\r\n\r\n    /**\r\n     * Find the next highest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next highest power of two.\r\n     */\r\n    public static CeilingPOT(x: number): number {\r\n        x--;\r\n        x |= x >> 1;\r\n        x |= x >> 2;\r\n        x |= x >> 4;\r\n        x |= x >> 8;\r\n        x |= x >> 16;\r\n        x++;\r\n        return x;\r\n    }\r\n\r\n    /**\r\n     * Find the next lowest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next lowest power of two.\r\n     */\r\n    public static FloorPOT(x: number): number {\r\n        x = x | (x >> 1);\r\n        x = x | (x >> 2);\r\n        x = x | (x >> 4);\r\n        x = x | (x >> 8);\r\n        x = x | (x >> 16);\r\n        return x - (x >> 1);\r\n    }\r\n\r\n    /**\r\n     * Find the nearest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next nearest power of two.\r\n     */\r\n    public static NearestPOT(x: number): number {\r\n        const c = ThinEngine.CeilingPOT(x);\r\n        const f = ThinEngine.FloorPOT(x);\r\n        return c - x > x - f ? f : c;\r\n    }\r\n\r\n    /**\r\n     * Get the closest exponent of two\r\n     * @param value defines the value to approximate\r\n     * @param max defines the maximum value to return\r\n     * @param mode defines how to define the closest value\r\n     * @returns closest exponent of two of the given value\r\n     */\r\n    public static GetExponentOfTwo(value: number, max: number, mode = Constants.SCALEMODE_NEAREST): number {\r\n        let pot;\r\n\r\n        switch (mode) {\r\n            case Constants.SCALEMODE_FLOOR:\r\n                pot = ThinEngine.FloorPOT(value);\r\n                break;\r\n            case Constants.SCALEMODE_NEAREST:\r\n                pot = ThinEngine.NearestPOT(value);\r\n                break;\r\n            case Constants.SCALEMODE_CEILING:\r\n            default:\r\n                pot = ThinEngine.CeilingPOT(value);\r\n                break;\r\n        }\r\n\r\n        return Math.min(pot, max);\r\n    }\r\n\r\n    /**\r\n     * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\r\n     * @param func - the function to be called\r\n     * @param requester - the object that will request the next frame. Falls back to window.\r\n     * @returns frame number\r\n     */\r\n    public static QueueNewFrame(func: () => void, requester?: any): number {\r\n        if (!IsWindowObjectExist()) {\r\n            if (typeof requestAnimationFrame !== \"undefined\") {\r\n                return requestAnimationFrame(func);\r\n            }\r\n\r\n            return setTimeout(func, 16) as unknown as number;\r\n        }\r\n\r\n        if (!requester) {\r\n            requester = window;\r\n        }\r\n\r\n        if (requester.requestPostAnimationFrame) {\r\n            return requester.requestPostAnimationFrame(func);\r\n        } else if (requester.requestAnimationFrame) {\r\n            return requester.requestAnimationFrame(func);\r\n        } else if (requester.msRequestAnimationFrame) {\r\n            return requester.msRequestAnimationFrame(func);\r\n        } else if (requester.webkitRequestAnimationFrame) {\r\n            return requester.webkitRequestAnimationFrame(func);\r\n        } else if (requester.mozRequestAnimationFrame) {\r\n            return requester.mozRequestAnimationFrame(func);\r\n        } else if (requester.oRequestAnimationFrame) {\r\n            return requester.oRequestAnimationFrame(func);\r\n        } else {\r\n            return window.setTimeout(func, 16);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    public getHostDocument(): Nullable<Document> {\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\r\n            return this._renderingCanvas.ownerDocument;\r\n        }\r\n\r\n        return document;\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}