{"ast":null,"code":"import \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.object.define-property.js\";\nimport \"core-js/modules/es.function.bind.js\";\n\n/**\n * Implementation based on https://medium.com/@shrekshao_71662/dual-depth-peeling-implementation-in-webgl-11baa061ba4b\n */\nimport { MultiRenderTarget } from \"../Materials/Textures/multiRenderTarget.js\";\nimport { Color4 } from \"../Maths/math.color.js\";\nimport { SmartArray } from \"../Misc/smartArray.js\";\nimport { ThinTexture } from \"../Materials/Textures/thinTexture.js\";\nimport { EffectRenderer, EffectWrapper } from \"../Materials/effectRenderer.js\";\nimport { Logger } from \"../Misc/logger.js\";\nimport { Material } from \"../Materials/material.js\";\nimport \"../Shaders/postprocess.vertex.js\";\nimport \"../Shaders/oitFinal.fragment.js\";\nimport \"../Shaders/oitBackBlend.fragment.js\";\n\nvar DepthPeelingEffectConfiguration =\n/** @class */\nfunction () {\n  function DepthPeelingEffectConfiguration() {\n    /**\n     * Is this effect enabled\n     */\n    this.enabled = true;\n    /**\n     * Name of the configuration\n     */\n\n    this.name = \"depthPeeling\";\n    /**\n     * Textures that should be present in the MRT for this effect to work\n     */\n\n    this.texturesRequired = [4];\n  }\n\n  return DepthPeelingEffectConfiguration;\n}();\n/**\n * The depth peeling renderer that performs\n * Order independant transparency (OIT).\n * This should not be instanciated directly, as it is part of a scene component\n */\n\n\nvar DepthPeelingRenderer =\n/** @class */\nfunction () {\n  /**\n   * Instanciates the depth peeling renderer\n   * @param scene Scene to attach to\n   * @param passCount Number of depth layers to peel\n   * @returns The depth peeling renderer\n   */\n  function DepthPeelingRenderer(scene, passCount) {\n    if (passCount === void 0) {\n      passCount = 5;\n    }\n\n    this._thinTextures = [];\n    this._currentPingPongState = 0;\n    this._layoutCacheFormat = [[true], [true, true], [true, true, true]];\n    this._layoutCache = [];\n    this._candidateSubMeshes = new SmartArray(10);\n    this._excludedSubMeshes = new SmartArray(10);\n    this._colorCache = [new Color4(DepthPeelingRenderer._DEPTH_CLEAR_VALUE, DepthPeelingRenderer._DEPTH_CLEAR_VALUE, 0, 0), new Color4(-DepthPeelingRenderer._MIN_DEPTH, DepthPeelingRenderer._MAX_DEPTH, 0, 0), new Color4(0, 0, 0, 0)];\n    this._scene = scene;\n    this._engine = scene.getEngine();\n    this._passCount = passCount; //  We need a depth texture for opaque\n\n    if (!scene.enablePrePassRenderer()) {\n      Logger.Warn(\"Depth peeling for order independant transparency could not enable PrePass, aborting.\");\n      return;\n    }\n\n    for (var i = 0; i < this._layoutCacheFormat.length; ++i) {\n      this._layoutCache[i] = this._engine.buildTextureLayout(this._layoutCacheFormat[i]);\n    }\n\n    this._renderPassIds = [];\n    this.useRenderPasses = false;\n    this._prePassEffectConfiguration = new DepthPeelingEffectConfiguration();\n\n    this._createTextures();\n\n    this._createEffects();\n  }\n\n  Object.defineProperty(DepthPeelingRenderer.prototype, \"passCount\", {\n    /**\n     * Number of depth peeling passes. As we are using dual depth peeling, each pass two levels of transparency are processed.\n     */\n    get: function get() {\n      return this._passCount;\n    },\n    set: function set(count) {\n      if (this._passCount === count) {\n        return;\n      }\n\n      this._passCount = count;\n\n      this._createRenderPassIds();\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DepthPeelingRenderer.prototype, \"useRenderPasses\", {\n    /**\n     * Instructs the renderer to use render passes. It is an optimization that makes the rendering faster for some engines (like WebGPU) but that consumes more memory, so it is disabled by default.\n     */\n    get: function get() {\n      return this._useRenderPasses;\n    },\n    set: function set(usePasses) {\n      if (this._useRenderPasses === usePasses) {\n        return;\n      }\n\n      this._useRenderPasses = usePasses;\n\n      this._createRenderPassIds();\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  DepthPeelingRenderer.prototype._createRenderPassIds = function () {\n    this._releaseRenderPassIds();\n\n    if (this._useRenderPasses) {\n      for (var i = 0; i < this._passCount + 1; ++i) {\n        if (!this._renderPassIds[i]) {\n          this._renderPassIds[i] = this._engine.createRenderPassId(\"DepthPeelingRenderer - pass #\".concat(i));\n        }\n      }\n    }\n  };\n\n  DepthPeelingRenderer.prototype._releaseRenderPassIds = function () {\n    for (var i = 0; i < this._renderPassIds.length; ++i) {\n      this._engine.releaseRenderPassId(this._renderPassIds[i]);\n    }\n\n    this._renderPassIds = [];\n  };\n\n  DepthPeelingRenderer.prototype._createTextures = function () {\n    var size = {\n      width: this._engine.getRenderWidth(),\n      height: this._engine.getRenderHeight()\n    }; // 2 for ping pong\n\n    this._depthMrts = [new MultiRenderTarget(\"depthPeelingDepth0\", size, 1, this._scene), new MultiRenderTarget(\"depthPeelingDepth1\", size, 1, this._scene)];\n    this._colorMrts = [new MultiRenderTarget(\"depthPeelingColor0\", size, 1, this._scene, {\n      generateDepthBuffer: false\n    }), new MultiRenderTarget(\"depthPeelingColor1\", size, 1, this._scene, {\n      generateDepthBuffer: false\n    })];\n    this._blendBackMrt = new MultiRenderTarget(\"depthPeelingBack\", size, 1, this._scene, {\n      generateDepthBuffer: false\n    }); // 0 is a depth texture\n    // 1 is a color texture\n\n    var optionsArray = [{\n      format: 7,\n      samplingMode: 1,\n      type: this._engine.getCaps().textureFloatLinearFiltering ? 1 : 2\n    }, {\n      format: 5,\n      samplingMode: 1,\n      type: 2\n    }];\n\n    for (var i = 0; i < 2; i++) {\n      var depthTexture = this._engine._createInternalTexture(size, optionsArray[0], false);\n\n      var frontColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\n\n      var backColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\n\n      this._depthMrts[i].setInternalTexture(depthTexture, 0);\n\n      this._depthMrts[i].setInternalTexture(frontColorTexture, 1);\n\n      this._depthMrts[i].setInternalTexture(backColorTexture, 2);\n\n      this._colorMrts[i].setInternalTexture(frontColorTexture, 0);\n\n      this._colorMrts[i].setInternalTexture(backColorTexture, 1);\n\n      this._thinTextures.push(new ThinTexture(depthTexture), new ThinTexture(frontColorTexture), new ThinTexture(backColorTexture));\n    }\n  };\n\n  DepthPeelingRenderer.prototype._disposeTextures = function () {\n    for (var i = 0; i < this._thinTextures.length; i++) {\n      if (i === 6) {\n        // Do not dispose the shared texture with the prepass\n        continue;\n      }\n\n      this._thinTextures[i].dispose();\n    }\n\n    for (var i = 0; i < 2; i++) {\n      this._depthMrts[i].dispose(true);\n\n      this._colorMrts[i].dispose(true);\n\n      this._blendBackMrt.dispose(true);\n    }\n\n    this._thinTextures = [];\n    this._colorMrts = [];\n    this._depthMrts = [];\n  };\n\n  DepthPeelingRenderer.prototype._updateTextures = function () {\n    if (this._depthMrts[0].getSize().width !== this._engine.getRenderWidth() || this._depthMrts[0].getSize().height !== this._engine.getRenderHeight()) {\n      this._disposeTextures();\n\n      this._createTextures();\n    }\n\n    return this._updateTextureReferences();\n  };\n\n  DepthPeelingRenderer.prototype._updateTextureReferences = function () {\n    var _a;\n\n    var prePassRenderer = this._scene.prePassRenderer;\n\n    if (!prePassRenderer) {\n      return false;\n    } // Retrieve opaque color texture\n\n\n    var textureIndex = prePassRenderer.getIndex(4);\n    var prePassTexture = ((_a = prePassRenderer.defaultRT.textures) === null || _a === void 0 ? void 0 : _a.length) ? prePassRenderer.defaultRT.textures[textureIndex].getInternalTexture() : null;\n\n    if (!prePassTexture) {\n      return false;\n    }\n\n    if (this._blendBackTexture !== prePassTexture) {\n      this._blendBackTexture = prePassTexture;\n\n      this._blendBackMrt.setInternalTexture(this._blendBackTexture, 0);\n\n      if (this._thinTextures[6]) {\n        this._thinTextures[6].dispose();\n      }\n\n      this._thinTextures[6] = new ThinTexture(this._blendBackTexture);\n\n      prePassRenderer.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget);\n    }\n\n    return true;\n  };\n\n  DepthPeelingRenderer.prototype._createEffects = function () {\n    this._blendBackEffectWrapper = new EffectWrapper({\n      fragmentShader: \"oitBackBlend\",\n      useShaderStore: true,\n      engine: this._engine,\n      samplerNames: [\"uBackColor\"],\n      uniformNames: []\n    });\n    this._blendBackEffectWrapperPingPong = new EffectWrapper({\n      fragmentShader: \"oitBackBlend\",\n      useShaderStore: true,\n      engine: this._engine,\n      samplerNames: [\"uBackColor\"],\n      uniformNames: []\n    });\n    this._finalEffectWrapper = new EffectWrapper({\n      fragmentShader: \"oitFinal\",\n      useShaderStore: true,\n      engine: this._engine,\n      samplerNames: [\"uFrontColor\", \"uBackColor\"],\n      uniformNames: []\n    });\n    this._effectRenderer = new EffectRenderer(this._engine);\n  };\n  /**\n   * Links to the prepass renderer\n   * @param prePassRenderer The scene PrePassRenderer\n   */\n\n\n  DepthPeelingRenderer.prototype.setPrePassRenderer = function (prePassRenderer) {\n    prePassRenderer.addEffectConfiguration(this._prePassEffectConfiguration);\n  };\n  /**\n   * Binds depth peeling textures on an effect\n   * @param effect The effect to bind textures on\n   */\n\n\n  DepthPeelingRenderer.prototype.bind = function (effect) {\n    effect.setTexture(\"oitDepthSampler\", this._thinTextures[this._currentPingPongState * 3]);\n    effect.setTexture(\"oitFrontColorSampler\", this._thinTextures[this._currentPingPongState * 3 + 1]);\n  };\n\n  DepthPeelingRenderer.prototype._renderSubMeshes = function (transparentSubMeshes) {\n    var mapMaterialContext;\n\n    if (this._useRenderPasses) {\n      mapMaterialContext = {};\n    }\n\n    for (var j = 0; j < transparentSubMeshes.length; j++) {\n      var material = transparentSubMeshes.data[j].getMaterial();\n      var previousShaderHotSwapping = true;\n      var previousBFC = false;\n      var subMesh = transparentSubMeshes.data[j];\n      var drawWrapper = void 0;\n      var firstDraw = false;\n\n      if (this._useRenderPasses) {\n        drawWrapper = subMesh._getDrawWrapper();\n        firstDraw = !drawWrapper;\n      }\n\n      if (material) {\n        previousShaderHotSwapping = material.allowShaderHotSwapping;\n        previousBFC = material.backFaceCulling;\n        material.allowShaderHotSwapping = false;\n        material.backFaceCulling = false;\n      }\n\n      subMesh.render(false);\n\n      if (firstDraw) {\n        // first time we draw this submesh: we replace the material context\n        drawWrapper = subMesh._getDrawWrapper(); // we are sure it is now non empty as we just rendered the submesh\n\n        if (drawWrapper.materialContext) {\n          var newMaterialContext = mapMaterialContext[drawWrapper.materialContext.uniqueId];\n\n          if (!newMaterialContext) {\n            newMaterialContext = mapMaterialContext[drawWrapper.materialContext.uniqueId] = this._engine.createMaterialContext();\n          }\n\n          subMesh._getDrawWrapper().materialContext = newMaterialContext;\n        }\n      }\n\n      if (material) {\n        material.allowShaderHotSwapping = previousShaderHotSwapping;\n        material.backFaceCulling = previousBFC;\n      }\n    }\n  };\n\n  DepthPeelingRenderer.prototype._finalCompose = function (writeId) {\n    this._engine.restoreDefaultFramebuffer();\n\n    this._engine.setAlphaMode(0);\n\n    this._engine.applyStates();\n\n    this._engine.enableEffect(this._finalEffectWrapper._drawWrapper);\n\n    this._finalEffectWrapper.effect.setTexture(\"uFrontColor\", this._thinTextures[writeId * 3 + 1]);\n\n    this._finalEffectWrapper.effect.setTexture(\"uBackColor\", this._thinTextures[6]);\n\n    this._effectRenderer.render(this._finalEffectWrapper);\n  };\n  /**\n   * Renders transparent submeshes with depth peeling\n   * @param transparentSubMeshes List of transparent meshes to render\n   * @returns The array of submeshes that could not be handled by this renderer\n   */\n\n\n  DepthPeelingRenderer.prototype.render = function (transparentSubMeshes) {\n    this._candidateSubMeshes.length = 0;\n    this._excludedSubMeshes.length = 0;\n\n    if (!this._blendBackEffectWrapper.effect.isReady() || !this._blendBackEffectWrapperPingPong.effect.isReady() || !this._finalEffectWrapper.effect.isReady() || !this._updateTextures()) {\n      return this._excludedSubMeshes;\n    }\n\n    for (var i = 0; i < transparentSubMeshes.length; i++) {\n      var material = transparentSubMeshes.data[i].getMaterial();\n\n      if (material && (material.fillMode === Material.TriangleFanDrawMode || material.fillMode === Material.TriangleFillMode || material.fillMode === Material.TriangleStripDrawMode)) {\n        this._candidateSubMeshes.push(transparentSubMeshes.data[i]);\n      } else {\n        this._excludedSubMeshes.push(transparentSubMeshes.data[i]);\n      }\n    }\n\n    if (!this._candidateSubMeshes.length) {\n      this._finalCompose(1);\n\n      return this._excludedSubMeshes;\n    }\n\n    var currentRenderPassId = this._engine.currentRenderPassId;\n    this._scene.prePassRenderer._enabled = false;\n\n    if (this._useRenderPasses) {\n      this._engine.currentRenderPassId = this._renderPassIds[0];\n    } // Clears\n\n\n    this._engine.bindFramebuffer(this._depthMrts[0].renderTarget);\n\n    this._engine.bindAttachments(this._layoutCache[0]);\n\n    this._engine.clear(this._colorCache[0], true, false, false);\n\n    this._engine.bindFramebuffer(this._depthMrts[1].renderTarget);\n\n    this._engine.bindAttachments(this._layoutCache[0]);\n\n    this._engine.clear(this._colorCache[1], true, false, false);\n\n    this._engine.bindFramebuffer(this._colorMrts[0].renderTarget);\n\n    this._engine.bindAttachments(this._layoutCache[1]);\n\n    this._engine.clear(this._colorCache[2], true, false, false);\n\n    this._engine.bindFramebuffer(this._colorMrts[1].renderTarget);\n\n    this._engine.bindAttachments(this._layoutCache[1]);\n\n    this._engine.clear(this._colorCache[2], true, false, false); // Draw depth for first pass\n\n\n    this._engine.bindFramebuffer(this._depthMrts[0].renderTarget);\n\n    this._engine.bindAttachments(this._layoutCache[0]);\n\n    this._engine.setAlphaMode(11); // in WebGPU, when using MIN or MAX equation, the src / dst color factors should not use SRC_ALPHA and the src / dst alpha factors must be 1 else WebGPU will throw a validation error\n\n\n    this._engine.setAlphaEquation(3);\n\n    this._engine.depthCullingState.depthMask = false;\n    this._engine.depthCullingState.depthTest = true;\n\n    this._engine.applyStates();\n\n    this._currentPingPongState = 1; // Render\n\n    this._renderSubMeshes(this._candidateSubMeshes);\n\n    this._scene.resetCachedMaterial(); // depth peeling ping-pong\n\n\n    var readId = 0;\n    var writeId = 0;\n\n    for (var i = 0; i < this._passCount; i++) {\n      readId = i % 2;\n      writeId = 1 - readId;\n      this._currentPingPongState = readId;\n\n      if (this._useRenderPasses) {\n        this._engine.currentRenderPassId = this._renderPassIds[i + 1];\n      } // Clears\n\n\n      this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget);\n\n      this._engine.bindAttachments(this._layoutCache[0]);\n\n      this._engine.clear(this._colorCache[0], true, false, false);\n\n      this._engine.bindFramebuffer(this._colorMrts[writeId].renderTarget);\n\n      this._engine.bindAttachments(this._layoutCache[1]);\n\n      this._engine.clear(this._colorCache[2], true, false, false);\n\n      this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget);\n\n      this._engine.bindAttachments(this._layoutCache[2]);\n\n      this._engine.setAlphaMode(11); // the value does not matter (as MAX operation does not use them) but the src and dst color factors should not use SRC_ALPHA else WebGPU will throw a validation error\n\n\n      this._engine.setAlphaEquation(3);\n\n      this._engine.depthCullingState.depthTest = false;\n\n      this._engine.applyStates(); // Render\n\n\n      this._renderSubMeshes(this._candidateSubMeshes);\n\n      this._scene.resetCachedMaterial(); // Back color\n\n\n      this._engine.bindFramebuffer(this._blendBackMrt.renderTarget);\n\n      this._engine.bindAttachments(this._layoutCache[0]);\n\n      this._engine.setAlphaEquation(0);\n\n      this._engine.setAlphaMode(17);\n\n      this._engine.applyStates();\n\n      var blendBackEffectWrapper = writeId === 0 || !this._useRenderPasses ? this._blendBackEffectWrapper : this._blendBackEffectWrapperPingPong;\n\n      this._engine.enableEffect(blendBackEffectWrapper._drawWrapper);\n\n      blendBackEffectWrapper.effect.setTexture(\"uBackColor\", this._thinTextures[writeId * 3 + 2]);\n\n      this._effectRenderer.render(blendBackEffectWrapper);\n    }\n\n    this._engine.currentRenderPassId = currentRenderPassId; // Final composition on default FB\n\n    this._finalCompose(writeId);\n\n    this._scene.prePassRenderer._enabled = true;\n    this._engine.depthCullingState.depthMask = true;\n    this._engine.depthCullingState.depthTest = true;\n    return this._excludedSubMeshes;\n  };\n  /**\n   * Disposes the depth peeling renderer and associated ressources\n   */\n\n\n  DepthPeelingRenderer.prototype.dispose = function () {\n    this._disposeTextures();\n\n    this._blendBackEffectWrapper.dispose();\n\n    this._finalEffectWrapper.dispose();\n\n    this._effectRenderer.dispose();\n\n    this._releaseRenderPassIds();\n  };\n\n  DepthPeelingRenderer._DEPTH_CLEAR_VALUE = -99999.0;\n  DepthPeelingRenderer._MIN_DEPTH = 0;\n  DepthPeelingRenderer._MAX_DEPTH = 1;\n  return DepthPeelingRenderer;\n}();\n\nexport { DepthPeelingRenderer };","map":{"version":3,"mappings":"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","names":["MultiRenderTarget","Color4","SmartArray","ThinTexture","EffectRenderer","EffectWrapper","Logger","Material","scene","passCount","DepthPeelingRenderer","_DEPTH_CLEAR_VALUE","_MIN_DEPTH","_MAX_DEPTH","_scene","_engine","getEngine","_passCount","enablePrePassRenderer","Warn","i","_layoutCacheFormat","length","_layoutCache","buildTextureLayout","_renderPassIds","useRenderPasses","_prePassEffectConfiguration","DepthPeelingEffectConfiguration","_createTextures","_createEffects","Object","count","_createRenderPassIds","_useRenderPasses","usePasses","_releaseRenderPassIds","createRenderPassId","releaseRenderPassId","size","width","getRenderWidth","height","getRenderHeight","_depthMrts","_colorMrts","generateDepthBuffer","_blendBackMrt","optionsArray","format","samplingMode","type","getCaps","textureFloatLinearFiltering","depthTexture","_createInternalTexture","frontColorTexture","backColorTexture","setInternalTexture","_thinTextures","push","dispose","getSize","_disposeTextures","_updateTextureReferences","prePassRenderer","textureIndex","getIndex","prePassTexture","defaultRT","textures","_a","getInternalTexture","_blendBackTexture","renderTarget","_shareDepth","_blendBackEffectWrapper","fragmentShader","useShaderStore","engine","samplerNames","uniformNames","_blendBackEffectWrapperPingPong","_finalEffectWrapper","_effectRenderer","addEffectConfiguration","effect","setTexture","_currentPingPongState","transparentSubMeshes","mapMaterialContext","j","material","data","getMaterial","previousShaderHotSwapping","previousBFC","subMesh","drawWrapper","firstDraw","_getDrawWrapper","allowShaderHotSwapping","backFaceCulling","render","materialContext","newMaterialContext","uniqueId","createMaterialContext","writeId","restoreDefaultFramebuffer","setAlphaMode","applyStates","enableEffect","_drawWrapper","_candidateSubMeshes","_excludedSubMeshes","isReady","_updateTextures","fillMode","TriangleFanDrawMode","TriangleFillMode","TriangleStripDrawMode","_finalCompose","currentRenderPassId","_enabled","bindFramebuffer","bindAttachments","clear","_colorCache","setAlphaEquation","depthCullingState","depthMask","depthTest","_renderSubMeshes","resetCachedMaterial","readId","blendBackEffectWrapper"],"sourceRoot":"","sources":["../../../../../lts/core/generated/Rendering/depthPeelingRenderer.ts"],"sourcesContent":["/**\r\n * Implementation based on https://medium.com/@shrekshao_71662/dual-depth-peeling-implementation-in-webgl-11baa061ba4b\r\n */\r\nimport { Constants } from \"../Engines/constants\";\r\nimport type { Engine } from \"../Engines/engine\";\r\nimport type { Effect } from \"../Materials/effect\";\r\nimport { MultiRenderTarget } from \"../Materials/Textures/multiRenderTarget\";\r\nimport type { InternalTextureCreationOptions } from \"../Materials/Textures/textureCreationOptions\";\r\nimport { Color4 } from \"../Maths/math.color\";\r\nimport type { SubMesh } from \"../Meshes/subMesh\";\r\nimport { SmartArray } from \"../Misc/smartArray\";\r\nimport type { Scene } from \"../scene\";\r\nimport { ThinTexture } from \"../Materials/Textures/thinTexture\";\r\nimport { EffectRenderer, EffectWrapper } from \"../Materials/effectRenderer\";\r\nimport type { PrePassEffectConfiguration } from \"./prePassEffectConfiguration\";\r\nimport type { PrePassRenderer } from \"./prePassRenderer\";\r\nimport type { InternalTexture } from \"../Materials/Textures/internalTexture\";\r\nimport { Logger } from \"../Misc/logger\";\r\nimport type { IMaterialContext } from \"../Engines/IMaterialContext\";\r\nimport type { DrawWrapper } from \"../Materials/drawWrapper\";\r\nimport { Material } from \"../Materials/material\";\r\n\r\nimport \"../Shaders/postprocess.vertex\";\r\nimport \"../Shaders/oitFinal.fragment\";\r\nimport \"../Shaders/oitBackBlend.fragment\";\r\n\r\nclass DepthPeelingEffectConfiguration implements PrePassEffectConfiguration {\r\n    /**\r\n     * Is this effect enabled\r\n     */\r\n    public enabled = true;\r\n\r\n    /**\r\n     * Name of the configuration\r\n     */\r\n    public name = \"depthPeeling\";\r\n\r\n    /**\r\n     * Textures that should be present in the MRT for this effect to work\r\n     */\r\n    public readonly texturesRequired: number[] = [Constants.PREPASS_COLOR_TEXTURE_TYPE];\r\n}\r\n\r\n/**\r\n * The depth peeling renderer that performs\r\n * Order independant transparency (OIT).\r\n * This should not be instanciated directly, as it is part of a scene component\r\n */\r\nexport class DepthPeelingRenderer {\r\n    private _scene: Scene;\r\n    private _engine: Engine;\r\n    private _depthMrts: MultiRenderTarget[];\r\n    private _thinTextures: ThinTexture[] = [];\r\n    private _colorMrts: MultiRenderTarget[];\r\n    private _blendBackMrt: MultiRenderTarget;\r\n\r\n    private _blendBackEffectWrapper: EffectWrapper;\r\n    private _blendBackEffectWrapperPingPong: EffectWrapper;\r\n    private _finalEffectWrapper: EffectWrapper;\r\n    private _effectRenderer: EffectRenderer;\r\n\r\n    private _currentPingPongState: number = 0;\r\n    private _prePassEffectConfiguration: DepthPeelingEffectConfiguration;\r\n\r\n    private _blendBackTexture: InternalTexture;\r\n    private _layoutCacheFormat = [[true], [true, true], [true, true, true]];\r\n    private _layoutCache: number[][] = [];\r\n    private _renderPassIds: number[];\r\n    private _candidateSubMeshes: SmartArray<SubMesh> = new SmartArray(10);\r\n    private _excludedSubMeshes: SmartArray<SubMesh> = new SmartArray(10);\r\n\r\n    private static _DEPTH_CLEAR_VALUE = -99999.0;\r\n    private static _MIN_DEPTH = 0;\r\n    private static _MAX_DEPTH = 1;\r\n\r\n    private _colorCache = [\r\n        new Color4(DepthPeelingRenderer._DEPTH_CLEAR_VALUE, DepthPeelingRenderer._DEPTH_CLEAR_VALUE, 0, 0),\r\n        new Color4(-DepthPeelingRenderer._MIN_DEPTH, DepthPeelingRenderer._MAX_DEPTH, 0, 0),\r\n        new Color4(0, 0, 0, 0),\r\n    ];\r\n\r\n    private _passCount: number;\r\n    /**\r\n     * Number of depth peeling passes. As we are using dual depth peeling, each pass two levels of transparency are processed.\r\n     */\r\n    public get passCount(): number {\r\n        return this._passCount;\r\n    }\r\n\r\n    public set passCount(count: number) {\r\n        if (this._passCount === count) {\r\n            return;\r\n        }\r\n        this._passCount = count;\r\n        this._createRenderPassIds();\r\n    }\r\n\r\n    private _useRenderPasses: boolean;\r\n    /**\r\n     * Instructs the renderer to use render passes. It is an optimization that makes the rendering faster for some engines (like WebGPU) but that consumes more memory, so it is disabled by default.\r\n     */\r\n    public get useRenderPasses() {\r\n        return this._useRenderPasses;\r\n    }\r\n\r\n    public set useRenderPasses(usePasses: boolean) {\r\n        if (this._useRenderPasses === usePasses) {\r\n            return;\r\n        }\r\n        this._useRenderPasses = usePasses;\r\n        this._createRenderPassIds();\r\n    }\r\n\r\n    /**\r\n     * Instanciates the depth peeling renderer\r\n     * @param scene Scene to attach to\r\n     * @param passCount Number of depth layers to peel\r\n     * @returns The depth peeling renderer\r\n     */\r\n    constructor(scene: Scene, passCount: number = 5) {\r\n        this._scene = scene;\r\n        this._engine = scene.getEngine();\r\n        this._passCount = passCount;\r\n\r\n        //  We need a depth texture for opaque\r\n        if (!scene.enablePrePassRenderer()) {\r\n            Logger.Warn(\"Depth peeling for order independant transparency could not enable PrePass, aborting.\");\r\n            return;\r\n        }\r\n\r\n        for (let i = 0; i < this._layoutCacheFormat.length; ++i) {\r\n            this._layoutCache[i] = this._engine.buildTextureLayout(this._layoutCacheFormat[i]);\r\n        }\r\n\r\n        this._renderPassIds = [];\r\n        this.useRenderPasses = false;\r\n\r\n        this._prePassEffectConfiguration = new DepthPeelingEffectConfiguration();\r\n        this._createTextures();\r\n        this._createEffects();\r\n    }\r\n\r\n    private _createRenderPassIds(): void {\r\n        this._releaseRenderPassIds();\r\n        if (this._useRenderPasses) {\r\n            for (let i = 0; i < this._passCount + 1; ++i) {\r\n                if (!this._renderPassIds[i]) {\r\n                    this._renderPassIds[i] = this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${i}`);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _releaseRenderPassIds(): void {\r\n        for (let i = 0; i < this._renderPassIds.length; ++i) {\r\n            this._engine.releaseRenderPassId(this._renderPassIds[i]);\r\n        }\r\n        this._renderPassIds = [];\r\n    }\r\n\r\n    private _createTextures() {\r\n        const size = {\r\n            width: this._engine.getRenderWidth(),\r\n            height: this._engine.getRenderHeight(),\r\n        };\r\n\r\n        // 2 for ping pong\r\n        this._depthMrts = [new MultiRenderTarget(\"depthPeelingDepth0\", size, 1, this._scene), new MultiRenderTarget(\"depthPeelingDepth1\", size, 1, this._scene)];\r\n        this._colorMrts = [\r\n            new MultiRenderTarget(\"depthPeelingColor0\", size, 1, this._scene, { generateDepthBuffer: false }),\r\n            new MultiRenderTarget(\"depthPeelingColor1\", size, 1, this._scene, { generateDepthBuffer: false }),\r\n        ];\r\n        this._blendBackMrt = new MultiRenderTarget(\"depthPeelingBack\", size, 1, this._scene, { generateDepthBuffer: false });\r\n\r\n        // 0 is a depth texture\r\n        // 1 is a color texture\r\n        const optionsArray = [\r\n            {\r\n                format: Constants.TEXTUREFORMAT_RG,\r\n                samplingMode: Constants.TEXTURE_NEAREST_SAMPLINGMODE,\r\n                type: this._engine.getCaps().textureFloatLinearFiltering ? Constants.TEXTURETYPE_FLOAT : Constants.TEXTURETYPE_HALF_FLOAT,\r\n            } as InternalTextureCreationOptions,\r\n            {\r\n                format: Constants.TEXTUREFORMAT_RGBA,\r\n                samplingMode: Constants.TEXTURE_NEAREST_SAMPLINGMODE,\r\n                type: Constants.TEXTURETYPE_HALF_FLOAT,\r\n            } as InternalTextureCreationOptions,\r\n        ];\r\n\r\n        for (let i = 0; i < 2; i++) {\r\n            const depthTexture = this._engine._createInternalTexture(size, optionsArray[0], false);\r\n            const frontColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\r\n            const backColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\r\n\r\n            this._depthMrts[i].setInternalTexture(depthTexture, 0);\r\n            this._depthMrts[i].setInternalTexture(frontColorTexture, 1);\r\n            this._depthMrts[i].setInternalTexture(backColorTexture, 2);\r\n\r\n            this._colorMrts[i].setInternalTexture(frontColorTexture, 0);\r\n            this._colorMrts[i].setInternalTexture(backColorTexture, 1);\r\n\r\n            this._thinTextures.push(new ThinTexture(depthTexture), new ThinTexture(frontColorTexture), new ThinTexture(backColorTexture));\r\n        }\r\n    }\r\n\r\n    private _disposeTextures() {\r\n        for (let i = 0; i < this._thinTextures.length; i++) {\r\n            if (i === 6) {\r\n                // Do not dispose the shared texture with the prepass\r\n                continue;\r\n            }\r\n            this._thinTextures[i].dispose();\r\n        }\r\n\r\n        for (let i = 0; i < 2; i++) {\r\n            this._depthMrts[i].dispose(true);\r\n            this._colorMrts[i].dispose(true);\r\n            this._blendBackMrt.dispose(true);\r\n        }\r\n\r\n        this._thinTextures = [];\r\n        this._colorMrts = [];\r\n        this._depthMrts = [];\r\n    }\r\n\r\n    private _updateTextures() {\r\n        if (this._depthMrts[0].getSize().width !== this._engine.getRenderWidth() || this._depthMrts[0].getSize().height !== this._engine.getRenderHeight()) {\r\n            this._disposeTextures();\r\n            this._createTextures();\r\n        }\r\n        return this._updateTextureReferences();\r\n    }\r\n\r\n    private _updateTextureReferences() {\r\n        const prePassRenderer = this._scene.prePassRenderer;\r\n\r\n        if (!prePassRenderer) {\r\n            return false;\r\n        }\r\n\r\n        // Retrieve opaque color texture\r\n        const textureIndex = prePassRenderer.getIndex(Constants.PREPASS_COLOR_TEXTURE_TYPE);\r\n        const prePassTexture = prePassRenderer.defaultRT.textures?.length ? prePassRenderer.defaultRT.textures[textureIndex].getInternalTexture() : null;\r\n\r\n        if (!prePassTexture) {\r\n            return false;\r\n        }\r\n\r\n        if (this._blendBackTexture !== prePassTexture) {\r\n            this._blendBackTexture = prePassTexture;\r\n            this._blendBackMrt.setInternalTexture(this._blendBackTexture, 0);\r\n\r\n            if (this._thinTextures[6]) {\r\n                this._thinTextures[6].dispose();\r\n            }\r\n            this._thinTextures[6] = new ThinTexture(this._blendBackTexture);\r\n\r\n            prePassRenderer.defaultRT.renderTarget!._shareDepth(this._depthMrts[0].renderTarget!);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    private _createEffects() {\r\n        this._blendBackEffectWrapper = new EffectWrapper({\r\n            fragmentShader: \"oitBackBlend\",\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: [\"uBackColor\"],\r\n            uniformNames: [],\r\n        });\r\n        this._blendBackEffectWrapperPingPong = new EffectWrapper({\r\n            fragmentShader: \"oitBackBlend\",\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: [\"uBackColor\"],\r\n            uniformNames: [],\r\n        });\r\n\r\n        this._finalEffectWrapper = new EffectWrapper({\r\n            fragmentShader: \"oitFinal\",\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: [\"uFrontColor\", \"uBackColor\"],\r\n            uniformNames: [],\r\n        });\r\n\r\n        this._effectRenderer = new EffectRenderer(this._engine);\r\n    }\r\n\r\n    /**\r\n     * Links to the prepass renderer\r\n     * @param prePassRenderer The scene PrePassRenderer\r\n     */\r\n    public setPrePassRenderer(prePassRenderer: PrePassRenderer) {\r\n        prePassRenderer.addEffectConfiguration(this._prePassEffectConfiguration);\r\n    }\r\n\r\n    /**\r\n     * Binds depth peeling textures on an effect\r\n     * @param effect The effect to bind textures on\r\n     */\r\n    public bind(effect: Effect) {\r\n        effect.setTexture(\"oitDepthSampler\", this._thinTextures[this._currentPingPongState * 3]);\r\n        effect.setTexture(\"oitFrontColorSampler\", this._thinTextures[this._currentPingPongState * 3 + 1]);\r\n    }\r\n\r\n    private _renderSubMeshes(transparentSubMeshes: SmartArray<SubMesh>) {\r\n        let mapMaterialContext: { [uniqueId: number]: IMaterialContext | undefined };\r\n        if (this._useRenderPasses) {\r\n            mapMaterialContext = {};\r\n        }\r\n        for (let j = 0; j < transparentSubMeshes.length; j++) {\r\n            const material = transparentSubMeshes.data[j].getMaterial();\r\n            let previousShaderHotSwapping = true;\r\n            let previousBFC = false;\r\n\r\n            const subMesh = transparentSubMeshes.data[j];\r\n            let drawWrapper: DrawWrapper | undefined;\r\n            let firstDraw = false;\r\n\r\n            if (this._useRenderPasses) {\r\n                drawWrapper = subMesh._getDrawWrapper();\r\n                firstDraw = !drawWrapper;\r\n            }\r\n\r\n            if (material) {\r\n                previousShaderHotSwapping = material.allowShaderHotSwapping;\r\n                previousBFC = material.backFaceCulling;\r\n                material.allowShaderHotSwapping = false;\r\n                material.backFaceCulling = false;\r\n            }\r\n\r\n            subMesh.render(false);\r\n\r\n            if (firstDraw) {\r\n                // first time we draw this submesh: we replace the material context\r\n                drawWrapper = subMesh._getDrawWrapper()!; // we are sure it is now non empty as we just rendered the submesh\r\n                if (drawWrapper.materialContext) {\r\n                    let newMaterialContext = mapMaterialContext![drawWrapper.materialContext.uniqueId];\r\n                    if (!newMaterialContext) {\r\n                        newMaterialContext = mapMaterialContext![drawWrapper.materialContext.uniqueId] = this._engine.createMaterialContext();\r\n                    }\r\n                    subMesh._getDrawWrapper()!.materialContext = newMaterialContext;\r\n                }\r\n            }\r\n\r\n            if (material) {\r\n                material.allowShaderHotSwapping = previousShaderHotSwapping;\r\n                material.backFaceCulling = previousBFC;\r\n            }\r\n        }\r\n    }\r\n\r\n    private _finalCompose(writeId: number) {\r\n        this._engine.restoreDefaultFramebuffer();\r\n\r\n        this._engine.setAlphaMode(Constants.ALPHA_DISABLE);\r\n        this._engine.applyStates();\r\n\r\n        this._engine.enableEffect(this._finalEffectWrapper._drawWrapper);\r\n        this._finalEffectWrapper.effect.setTexture(\"uFrontColor\", this._thinTextures[writeId * 3 + 1]);\r\n        this._finalEffectWrapper.effect.setTexture(\"uBackColor\", this._thinTextures[6]);\r\n        this._effectRenderer.render(this._finalEffectWrapper);\r\n    }\r\n\r\n    /**\r\n     * Renders transparent submeshes with depth peeling\r\n     * @param transparentSubMeshes List of transparent meshes to render\r\n     * @returns The array of submeshes that could not be handled by this renderer\r\n     */\r\n    public render(transparentSubMeshes: SmartArray<SubMesh>): SmartArray<SubMesh> {\r\n        this._candidateSubMeshes.length = 0;\r\n        this._excludedSubMeshes.length = 0;\r\n        if (\r\n            !this._blendBackEffectWrapper.effect.isReady() ||\r\n            !this._blendBackEffectWrapperPingPong.effect.isReady() ||\r\n            !this._finalEffectWrapper.effect.isReady() ||\r\n            !this._updateTextures()\r\n        ) {\r\n            return this._excludedSubMeshes;\r\n        }\r\n\r\n        for (let i = 0; i < transparentSubMeshes.length; i++) {\r\n            const material = transparentSubMeshes.data[i].getMaterial();\r\n\r\n            if (\r\n                material &&\r\n                (material.fillMode === Material.TriangleFanDrawMode || material.fillMode === Material.TriangleFillMode || material.fillMode === Material.TriangleStripDrawMode)\r\n            ) {\r\n                this._candidateSubMeshes.push(transparentSubMeshes.data[i]);\r\n            } else {\r\n                this._excludedSubMeshes.push(transparentSubMeshes.data[i]);\r\n            }\r\n        }\r\n\r\n        if (!this._candidateSubMeshes.length) {\r\n            this._finalCompose(1);\r\n            return this._excludedSubMeshes;\r\n        }\r\n\r\n        const currentRenderPassId = this._engine.currentRenderPassId;\r\n\r\n        (this._scene.prePassRenderer! as any)._enabled = false;\r\n\r\n        if (this._useRenderPasses) {\r\n            this._engine.currentRenderPassId = this._renderPassIds[0];\r\n        }\r\n\r\n        // Clears\r\n        this._engine.bindFramebuffer(this._depthMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n        this._engine.clear(this._colorCache[0], true, false, false);\r\n\r\n        this._engine.bindFramebuffer(this._depthMrts[1].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n        this._engine.clear(this._colorCache[1], true, false, false);\r\n\r\n        this._engine.bindFramebuffer(this._colorMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[1]);\r\n        this._engine.clear(this._colorCache[2], true, false, false);\r\n\r\n        this._engine.bindFramebuffer(this._colorMrts[1].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[1]);\r\n        this._engine.clear(this._colorCache[2], true, false, false);\r\n\r\n        // Draw depth for first pass\r\n        this._engine.bindFramebuffer(this._depthMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n\r\n        this._engine.setAlphaMode(Constants.ALPHA_ONEONE_ONEONE); // in WebGPU, when using MIN or MAX equation, the src / dst color factors should not use SRC_ALPHA and the src / dst alpha factors must be 1 else WebGPU will throw a validation error\r\n        this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_MAX);\r\n        this._engine.depthCullingState.depthMask = false;\r\n        this._engine.depthCullingState.depthTest = true;\r\n        this._engine.applyStates();\r\n\r\n        this._currentPingPongState = 1;\r\n        // Render\r\n        this._renderSubMeshes(this._candidateSubMeshes);\r\n\r\n        this._scene.resetCachedMaterial();\r\n\r\n        // depth peeling ping-pong\r\n        let readId = 0;\r\n        let writeId = 0;\r\n\r\n        for (let i = 0; i < this._passCount; i++) {\r\n            readId = i % 2;\r\n            writeId = 1 - readId;\r\n            this._currentPingPongState = readId;\r\n\r\n            if (this._useRenderPasses) {\r\n                this._engine.currentRenderPassId = this._renderPassIds[i + 1];\r\n            }\r\n\r\n            // Clears\r\n            this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[0]);\r\n            this._engine.clear(this._colorCache[0], true, false, false);\r\n\r\n            this._engine.bindFramebuffer(this._colorMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[1]);\r\n            this._engine.clear(this._colorCache[2], true, false, false);\r\n\r\n            this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[2]);\r\n\r\n            this._engine.setAlphaMode(Constants.ALPHA_ONEONE_ONEONE); // the value does not matter (as MAX operation does not use them) but the src and dst color factors should not use SRC_ALPHA else WebGPU will throw a validation error\r\n            this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_MAX);\r\n            this._engine.depthCullingState.depthTest = false;\r\n            this._engine.applyStates();\r\n\r\n            // Render\r\n            this._renderSubMeshes(this._candidateSubMeshes);\r\n\r\n            this._scene.resetCachedMaterial();\r\n\r\n            // Back color\r\n            this._engine.bindFramebuffer(this._blendBackMrt.renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[0]);\r\n            this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_ADD);\r\n            this._engine.setAlphaMode(Constants.ALPHA_LAYER_ACCUMULATE);\r\n            this._engine.applyStates();\r\n\r\n            const blendBackEffectWrapper = writeId === 0 || !this._useRenderPasses ? this._blendBackEffectWrapper : this._blendBackEffectWrapperPingPong;\r\n            this._engine.enableEffect(blendBackEffectWrapper._drawWrapper);\r\n            blendBackEffectWrapper.effect.setTexture(\"uBackColor\", this._thinTextures[writeId * 3 + 2]);\r\n            this._effectRenderer.render(blendBackEffectWrapper);\r\n        }\r\n\r\n        this._engine.currentRenderPassId = currentRenderPassId;\r\n\r\n        // Final composition on default FB\r\n        this._finalCompose(writeId);\r\n\r\n        (this._scene.prePassRenderer! as any)._enabled = true;\r\n        this._engine.depthCullingState.depthMask = true;\r\n        this._engine.depthCullingState.depthTest = true;\r\n\r\n        return this._excludedSubMeshes;\r\n    }\r\n\r\n    /**\r\n     * Disposes the depth peeling renderer and associated ressources\r\n     */\r\n    public dispose() {\r\n        this._disposeTextures();\r\n        this._blendBackEffectWrapper.dispose();\r\n        this._finalEffectWrapper.dispose();\r\n        this._effectRenderer.dispose();\r\n        this._releaseRenderPassIds();\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}